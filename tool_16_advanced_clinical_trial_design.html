<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Multiple Regression & Advanced Medical Modeling | Canadian Healthcare Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fff8 0%, #e8f8e8 50%, #d8f0d8 100%);
            color: #2d5233;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #2d5233 0%, #228B22 50%, #4a7c4a 100%);
            color: white;
            text-align: center;
            padding: 3rem 1rem;
            box-shadow: 0 4px 20px rgba(45, 82, 51, 0.3);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M30 30c0-11.046-8.954-20-20-20s-20 8.954-20 20 8.954 20 20 20 20-8.954 20-20zm0 0c0 11.046 8.954 20 20 20s20-8.954 20-20-8.954-20-20-20-20 8.954-20 20z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
            animation: float 20s linear infinite;
            pointer-events: none;
        }

        @keyframes float {
            0% { transform: translateX(-50px); }
            100% { transform: translateX(50px); }
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .header .subtitle {
            font-size: 1.3rem;
            opacity: 0.95;
            font-weight: 400;
            position: relative;
            z-index: 1;
        }

        .header .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 25px;
            margin-top: 1rem;
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .methodology-navigation {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .methodology-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(45, 82, 51, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .methodology-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #228B22, #32CD32, #9ACD32);
        }

        .methodology-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 16px 48px rgba(45, 82, 51, 0.2);
            border-color: #228B22;
        }

        .methodology-card.active {
            background: linear-gradient(135deg, #f0fff0 0%, #e8f8e8 100%);
            border-color: #228B22;
            transform: translateY(-3px);
        }

        .methodology-card h3 {
            color: #2d5233;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .methodology-card .icon {
            font-size: 1.5rem;
        }

        .methodology-card p {
            color: #5a7c5a;
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }

        .methodology-card .features {
            list-style: none;
            font-size: 0.85rem;
            color: #6b8e6b;
        }

        .methodology-card .features li {
            margin: 0.3rem 0;
            padding-left: 1rem;
            position: relative;
        }

        .methodology-card .features li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #228B22;
            font-weight: bold;
        }

        .content-section {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 12px 48px rgba(45, 82, 51, 0.1);
            border: 1px solid #e8f8e8;
            position: relative;
            overflow: hidden;
        }

        .content-section.active {
            display: block;
            animation: fadeInUp 0.6s ease;
        }

        .card-content {
            display: none;
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
            border: 2px solid #e8f8e8;
            box-shadow: 0 8px 32px rgba(45, 82, 51, 0.1);
        }

        .card-content.active {
            display: block;
            animation: fadeInUp 0.4s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .content-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #228B22, #32CD32, #9ACD32, #228B22);
            background-size: 200% 100%;
            animation: gradientShift 3s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .section-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .section-header h2 {
            font-size: 2.5rem;
            color: #2d5233;
            font-weight: 800;
            margin-bottom: 1rem;
            position: relative;
            display: inline-block;
        }

        .section-header h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, #228B22, #32CD32);
            border-radius: 2px;
        }

        .section-header p {
            font-size: 1.2rem;
            color: #5a7c5a;
            max-width: 800px;
            margin: 0 auto;
        }

        .theory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .theory-card {
            background: linear-gradient(135deg, #f8fff8 0%, #f0fff0 100%);
            border-radius: 16px;
            padding: 2rem;
            border: 2px solid #e8f8e8;
            transition: all 0.3s ease;
            position: relative;
        }

        .theory-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(45, 82, 51, 0.15);
            border-color: #228B22;
        }

        .theory-card h3 {
            color: #2d5233;
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theory-card .theory-icon {
            background: linear-gradient(135deg, #228B22, #32CD32);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .controls-panel {
            background: linear-gradient(135deg, #f8fff8 0%, #f0fff0 100%);
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
            border: 2px solid #e8f8e8;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            color: #2d5233;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .control-group select,
        .control-group input[type="number"],
        .control-group input[type="range"] {
            background: white;
            border: 2px solid #e8f8e8;
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 1rem;
            color: #2d5233;
            transition: all 0.3s ease;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #228B22;
            box-shadow: 0 0 0 3px rgba(34, 139, 34, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(34, 139, 34, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(34, 139, 34, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .results-container {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
            border: 2px solid #e8f8e8;
            box-shadow: 0 8px 32px rgba(45, 82, 51, 0.1);
        }

        .results-header {
            color: #2d5233;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .metric-card {
            background: linear-gradient(135deg, #f8fff8 0%, #f0fff0 100%);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 2px solid #e8f8e8;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-3px);
            border-color: #228B22;
            box-shadow: 0 8px 24px rgba(34, 139, 34, 0.15);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 800;
            color: #228B22;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: #5a7c5a;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .chart-container {
            margin: 2rem 0;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(45, 82, 51, 0.1);
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(45, 82, 51, 0.1);
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e8f8e8;
        }

        th {
            background: linear-gradient(135deg, #228B22, #32CD32);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f8fff8;
        }

        .canadian-highlight {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
            border: 2px solid #ff4444;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
            position: relative;
        }

        .canadian-highlight::before {
            content: 'üá®üá¶';
            position: absolute;
            top: -15px;
            left: 20px;
            background: white;
            padding: 0 10px;
            font-size: 1.5rem;
        }

        .regulatory-box {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border: 2px solid #4a90e2;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
            position: relative;
        }

        .regulatory-box::before {
            content: 'üèõÔ∏è';
            position: absolute;
            top: -15px;
            left: 20px;
            background: white;
            padding: 0 10px;
            font-size: 1.5rem;
        }

        .advanced-feature {
            background: linear-gradient(135deg, #fff8f0 0%, #ffeee0 100%);
            border: 2px solid #ff8c00;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
            position: relative;
        }

        .advanced-feature::before {
            content: '‚ö°';
            position: absolute;
            top: -15px;
            left: 20px;
            background: white;
            padding: 0 10px;
            font-size: 1.5rem;
        }

        .highlight {
            background: linear-gradient(135deg, #ffeb3b, #ffc107);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            color: #333;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #ef5350;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #228B22;
            font-weight: 600;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e8f8e8;
            border-radius: 50%;
            border-top-color: #228B22;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            background: linear-gradient(135deg, #2d5233 0%, #228B22 100%);
            color: white;
            text-align: center;
            padding: 2rem;
            margin-top: 4rem;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.2rem;
            }
            
            .header .subtitle {
                font-size: 1.1rem;
            }
            
            .methodology-navigation {
                grid-template-columns: 1fr;
            }
            
            .theory-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .content-section {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Enhanced Multiple Regression & Advanced Medical Modeling</h1>
        <p class="subtitle">Canadian Healthcare Analytics with Advanced Statistical Methods</p>
        <div class="badge">Foundation Series Enhanced | Advanced Methods & Canadian Integration</div>
    </div>

    <div class="container">
        <!-- Navigation Cards -->
        <div class="methodology-navigation">
            <div class="methodology-card active" onclick="showSection('classical-regression')">
                <h3><span class="icon">üìä</span>Classical Multiple Regression</h3>
                <p>Traditional multiple regression with confounding control and interaction analysis</p>
                <ul class="features">
                    <li>Multiple predictor modeling</li>
                    <li>Confounding variable control</li>
                    <li>Interaction terms analysis</li>
                    <li>Model diagnostics</li>
                </ul>
            </div>

            <div class="methodology-card" onclick="showSection('regularized-regression')">
                <h3><span class="icon">üéØ</span>Regularized Regression</h3>
                <p>Ridge, Lasso, and Elastic Net for high-dimensional medical data</p>
                <ul class="features">
                    <li>Ridge regression (L2 penalty)</li>
                    <li>Lasso regression (L1 penalty)</li>
                    <li>Elastic Net (combined penalties)</li>
                    <li>Feature selection automation</li>
                </ul>
            </div>

            <div class="methodology-card" onclick="showSection('mixed-effects')">
                <h3><span class="icon">üìà</span>Mixed Effects Models</h3>
                <p>Hierarchical modeling for longitudinal and multi-center Canadian studies</p>
                <ul class="features">
                    <li>Random effects modeling</li>
                    <li>Multi-level data structure</li>
                    <li>Provincial health system variations</li>
                    <li>Longitudinal patient tracking</li>
                </ul>
            </div>

            <div class="methodology-card" onclick="showSection('propensity-score')">
                <h3><span class="icon">‚öñÔ∏è</span>Propensity Score Methods</h3>
                <p>Causal inference for observational health data</p>
                <ul class="features">
                    <li>Propensity score matching</li>
                    <li>Inverse probability weighting</li>
                    <li>Confounding adjustment</li>
                    <li>Treatment effect estimation</li>
                </ul>
            </div>

            <div class="methodology-card" onclick="showSection('instrumental-variables')">
                <h3><span class="icon">üîß</span>Instrumental Variables</h3>
                <p>Advanced causal inference for unmeasured confounding</p>
                <ul class="features">
                    <li>Two-stage least squares</li>
                    <li>Mendelian randomization</li>
                    <li>Natural experiments</li>
                    <li>Policy evaluation</li>
                </ul>
            </div>

            <div class="methodology-card" onclick="showSection('canadian-integration')">
                <h3><span class="icon">üá®üá¶</span>Canadian Health System</h3>
                <p>Integration with Canadian healthcare data and regulatory frameworks</p>
                <ul class="features">
                    <li>CIHI data templates</li>
                    <li>Health Canada pathways</li>
                    <li>Provincial variations</li>
                    <li>CADTH evidence frameworks</li>
                </ul>
            </div>

            <div class="methodology-card" onclick="showSection('real-world-applications')">
                <h3><span class="icon">üè•</span>Real-World Applications</h3>
                <p>Advanced Canadian healthcare modeling scenarios</p>
                <ul class="features">
                    <li>Multi-provincial studies</li>
                    <li>Health technology assessment</li>
                    <li>Real-world evidence</li>
                    <li>Regulatory submissions</li>
                </ul>
            </div>

            <div class="methodology-card" onclick="showSection('assessment')">
                <h3><span class="icon">üìù</span>Advanced Assessment</h3>
                <p>Comprehensive evaluation of advanced modeling concepts</p>
                <ul class="features">
                    <li>Regularization theory</li>
                    <li>Causal inference</li>
                    <li>Canadian health policy</li>
                    <li>Model interpretation</li>
                </ul>
            </div>
        </div>

        <!-- Content Sections -->
        
        <!-- Classical Multiple Regression Section -->
        <div id="classical-regression-section" class="content-section active">
            <div class="section-header">
                <h2>üìä Classical Multiple Regression</h2>
                <p>Foundation of medical predictive modeling with multiple predictors, confounding control, and interaction analysis for Canadian healthcare applications.</p>
            </div>

            <!-- Card Navigation -->
            <div class="methodology-navigation">
                <div class="methodology-card active" onclick="showCard('classical', 'theory', this)">
                    <h3><span class="icon">üìö</span>Theory & Concepts</h3>
                    <p>Multiple regression framework, confounding control, and model assumptions</p>
                    <ul class="features">
                        <li>Regression equations</li>
                        <li>Confounding variables</li>
                        <li>Interaction terms</li>
                        <li>Model diagnostics</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('classical', 'modeling', this)">
                    <h3><span class="icon">‚öôÔ∏è</span>Model Building</h3>
                    <p>Interactive controls for building and customizing regression models</p>
                    <ul class="features">
                        <li>Outcome selection</li>
                        <li>Predictor configuration</li>
                        <li>Provincial settings</li>
                        <li>Model complexity</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('classical', 'results', this)">
                    <h3><span class="icon">üìà</span>Results & Graphs</h3>
                    <p>Statistical outputs, visualizations, and Canadian healthcare insights</p>
                    <ul class="features">
                        <li>Regression coefficients</li>
                        <li>Model fit statistics</li>
                        <li>Diagnostic plots</li>
                        <li>Clinical interpretation</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('classical', 'assessment', this)">
                    <h3><span class="icon">üìù</span>Assessment</h3>
                    <p>Test your understanding with interactive questions and scenarios</p>
                    <ul class="features">
                        <li>Multiple choice questions</li>
                        <li>Clinical scenarios</li>
                        <li>Canadian case studies</li>
                        <li>Instant feedback</li>
                    </ul>
                </div>
            </div>

            <!-- Theory Card -->
            <div id="classical-theory-card" class="card-content active">
                <div class="theory-grid">
                    <div class="theory-card">
                        <h3><span class="theory-icon">Œ≤</span>Multiple Regression Framework</h3>
                        <p><strong>Model:</strong> Y = Œ≤‚ÇÄ + Œ≤‚ÇÅX‚ÇÅ + Œ≤‚ÇÇX‚ÇÇ + ... + Œ≤‚ÇñX‚Çñ + Œµ</p>
                        <p><strong>Clinical Application:</strong> Predicting health outcomes using multiple patient characteristics simultaneously.</p>
                        <p><strong>Canadian Context:</strong> Standardized across provincial health systems for consistent care quality assessment.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">‚öñÔ∏è</span>Confounding Control</h3>
                        <p><strong>Purpose:</strong> Account for variables that influence both predictor and outcome.</p>
                        <p><strong>Methods:</strong> Adjustment, stratification, and matching techniques.</p>
                        <p><strong>Healthcare Impact:</strong> Essential for determining true treatment effects in observational studies.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">√ó</span>Interaction Analysis</h3>
                        <p><strong>Model:</strong> Y = Œ≤‚ÇÄ + Œ≤‚ÇÅX‚ÇÅ + Œ≤‚ÇÇX‚ÇÇ + Œ≤‚ÇÉX‚ÇÅ√óX‚ÇÇ + Œµ</p>
                        <p><strong>Clinical Meaning:</strong> Effect of one factor depends on level of another.</p>
                        <p><strong>Example:</strong> Drug effectiveness varying by patient age or comorbidity status.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üìã</span>Model Diagnostics</h3>
                        <p><strong>Assumptions:</strong> Linearity, independence, normality, homoscedasticity.</p>
                        <p><strong>Diagnostics:</strong> Residual plots, influence measures, multicollinearity detection.</p>
                        <p><strong>Clinical Validation:</strong> Ensuring model reliability for patient care decisions.</p>
                    </div>
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ Canadian Healthcare Multiple Regression Applications</h4>
                    <p><strong>Health Quality Ontario (HQO):</strong> Quality indicators using multiple regression to adjust for case mix and risk factors.</p>
                    <p><strong>CIHI Hospital Reports:</strong> Risk-adjusted mortality and readmission rates accounting for patient complexity and hospital characteristics.</p>
                    <p><strong>Canadian Stroke Best Practice Recommendations:</strong> Outcome prediction models incorporating multiple clinical and demographic factors.</p>
                    <p><strong>Provincial Drug Plan Evaluation:</strong> Cost-effectiveness models with multiple economic and clinical predictors.</p>
                </div>
            </div>

            <!-- Model Building Card -->
            <div id="classical-modeling-card" class="card-content">
                <div class="controls-panel">
                    <h3>Classical Regression Modeling Controls</h3>
                    <div class="controls-grid">
                        <div class="control-group">
                            <label for="classical-outcome">Primary Health Outcome:</label>
                            <select id="classical-outcome">
                                <option value="cvd-risk">Cardiovascular Disease Risk</option>
                                <option value="hospital-readmission">30-Day Hospital Readmission</option>
                                <option value="diabetes-control">Diabetes Control (HbA1c)</option>
                                <option value="medication-adherence">Medication Adherence Rate</option>
                                <option value="quality-life">Quality of Life Score</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="classical-sample-size">Sample Size:</label>
                            <input type="number" id="classical-sample-size" value="500" min="100" max="5000" step="100">
                        </div>

                        <div class="control-group">
                            <label for="classical-predictors">Number of Predictors:</label>
                            <input type="number" id="classical-predictors" value="5" min="3" max="15" step="1">
                        </div>

                        <div class="control-group">
                            <label for="classical-interactions">Include Interactions:</label>
                            <select id="classical-interactions">
                                <option value="none">No Interactions</option>
                                <option value="two-way">Two-way Interactions</option>
                                <option value="three-way">Three-way Interactions</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="classical-province">Canadian Province:</label>
                            <select id="classical-province">
                                <option value="ontario">Ontario (OHIP)</option>
                                <option value="quebec">Quebec (RAMQ)</option>
                                <option value="bc">British Columbia</option>
                                <option value="alberta">Alberta</option>
                                <option value="multi-province">Multi-Provincial Study</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="classical-complexity">Model Complexity:</label>
                            <input type="range" id="classical-complexity" value="50" min="0" max="100">
                            <span>Moderate</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn" onclick="runClassicalRegression()">üöÄ Run Classical Multiple Regression</button>
                    </div>
                </div>
            </div>

            <!-- Results Card -->
            <div id="classical-results-card" class="card-content">
                <div id="classical-results" class="results-container" style="display: none;">
                    <!-- Results will be populated by JavaScript -->
                </div>
                <div id="classical-placeholder" style="text-align: center; padding: 3rem; color: #5a7c5a;">
                    <h3>üìä Results will appear here after running the analysis</h3>
                    <p>Use the Model Building tab to configure and run your classical multiple regression analysis.</p>
                </div>
            </div>

            <!-- Assessment Card -->
            <div id="classical-assessment-card" class="card-content">
                <h3>üìù Classical Multiple Regression Assessment</h3>
                <div id="classical-assessment-content">
                    <div style="text-align: center; margin: 2rem 0;">
                        <button class="btn" onclick="generateClassicalAssessment()">üìã Generate Assessment Questions</button>
                    </div>
                    <div id="classical-assessment-questions" style="display: none;">
                        <!-- Assessment questions will be populated -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Regularized Regression Section -->
        <div id="regularized-regression-section" class="content-section">
            <div class="section-header">
                <h2>üéØ Regularized Regression Methods</h2>
                <p>Advanced techniques for high-dimensional medical data with automated feature selection and improved prediction accuracy in Canadian healthcare settings.</p>
            </div>

            <!-- Card Navigation -->
            <div class="methodology-navigation">
                <div class="methodology-card active" onclick="showCard('regularized', 'theory', this)">
                    <h3><span class="icon">üìö</span>Theory & Methods</h3>
                    <p>Ridge, Lasso, and Elastic Net regularization techniques</p>
                    <ul class="features">
                        <li>L1 and L2 penalties</li>
                        <li>Feature selection</li>
                        <li>Cross-validation</li>
                        <li>Bias-variance tradeoff</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('regularized', 'modeling', this)">
                    <h3><span class="icon">‚öôÔ∏è</span>Model Building</h3>
                    <p>Configure regularized regression with high-dimensional data</p>
                    <ul class="features">
                        <li>Method selection</li>
                        <li>Lambda optimization</li>
                        <li>Feature dimensionality</li>
                        <li>Canadian data sources</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('regularized', 'results', this)">
                    <h3><span class="icon">üìà</span>Results & Features</h3>
                    <p>Feature selection results and model performance</p>
                    <ul class="features">
                        <li>Selected features</li>
                        <li>Sparsity analysis</li>
                        <li>Cross-validation scores</li>
                        <li>Feature importance</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('regularized', 'assessment', this)">
                    <h3><span class="icon">üìù</span>Assessment</h3>
                    <p>Test regularization concepts and applications</p>
                    <ul class="features">
                        <li>Regularization theory</li>
                        <li>Feature selection</li>
                        <li>Genomics applications</li>
                        <li>Canadian precision medicine</li>
                    </ul>
                </div>
            </div>

            <!-- Theory Card -->
            <div id="regularized-theory-card" class="card-content active">
                <div class="theory-grid">
                    <div class="theory-card">
                        <h3><span class="theory-icon">R</span>Ridge Regression (L2)</h3>
                        <p><strong>Model:</strong> min ||Y - XŒ≤||¬≤ + Œª||Œ≤||¬≤</p>
                        <p><strong>Advantage:</strong> Reduces overfitting by shrinking coefficients toward zero.</p>
                        <p><strong>Canadian Application:</strong> Multi-provincial studies with varying data quality and missing predictors.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">L</span>Lasso Regression (L1)</h3>
                        <p><strong>Model:</strong> min ||Y - XŒ≤||¬≤ + Œª||Œ≤||‚ÇÅ</p>
                        <p><strong>Advantage:</strong> Automatic feature selection by setting coefficients to exactly zero.</p>
                        <p><strong>Clinical Use:</strong> Identifying key biomarkers from large panels in precision medicine.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">E</span>Elastic Net</h3>
                        <p><strong>Model:</strong> min ||Y - XŒ≤||¬≤ + Œª‚ÇÅ||Œ≤||‚ÇÅ + Œª‚ÇÇ||Œ≤||¬≤</p>
                        <p><strong>Advantage:</strong> Combines L1 and L2 penalties for grouped variable selection.</p>
                        <p><strong>Healthcare Benefit:</strong> Handles correlated clinical variables in electronic health records.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üîç</span>Cross-Validation</h3>
                        <p><strong>Purpose:</strong> Optimal regularization parameter (Œª) selection.</p>
                        <p><strong>Method:</strong> k-fold cross-validation with Canadian population stratification.</p>
                        <p><strong>Outcome:</strong> Robust model performance estimates for regulatory submission.</p>
                    </div>
                </div>

                <div class="advanced-feature">
                    <h4>‚ö° Advanced Regularization Features</h4>
                    <p><strong>Adaptive Lasso:</strong> Data-driven weights for improved selection consistency in heterogeneous Canadian populations.</p>
                    <p><strong>Group Lasso:</strong> Select entire groups of related variables (e.g., all lab values, all demographic factors).</p>
                    <p><strong>Fused Lasso:</strong> Smooth coefficient profiles for ordered predictors (e.g., age groups, severity stages).</p>
                    <p><strong>Canadian Multi-Provincial Regularization:</strong> Province-specific penalties accounting for healthcare system differences.</p>
                </div>
            </div>

            <!-- Model Building Card -->
            <div id="regularized-modeling-card" class="card-content">
                <div class="controls-panel">
                    <h3>Regularized Regression Configuration</h3>
                    <div class="controls-grid">
                        <div class="control-group">
                            <label for="reg-method">Regularization Method:</label>
                            <select id="reg-method">
                                <option value="ridge">Ridge Regression (L2)</option>
                                <option value="lasso">Lasso Regression (L1)</option>
                                <option value="elastic-net">Elastic Net (L1 + L2)</option>
                                <option value="comparison">Compare All Methods</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="reg-outcome">Clinical Application:</label>
                            <select id="reg-outcome">
                                <option value="genomics">Genomic Risk Prediction</option>
                                <option value="ehr-mining">EHR Data Mining</option>
                                <option value="biomarker-discovery">Biomarker Discovery</option>
                                <option value="multi-omics">Multi-Omics Integration</option>
                                <option value="precision-medicine">Precision Medicine</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="reg-features">Number of Features:</label>
                            <select id="reg-features">
                                <option value="100">100 (moderate dimensionality)</option>
                                <option value="500">500 (high dimensionality)</option>
                                <option value="1000">1000 (very high dimensionality)</option>
                                <option value="5000">5000 (genomic scale)</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="reg-lambda">Regularization Strength (Œª):</label>
                            <input type="range" id="reg-lambda" value="50" min="0" max="100">
                            <span>Auto-select via CV</span>
                        </div>

                        <div class="control-group">
                            <label for="reg-cv-folds">Cross-Validation Folds:</label>
                            <select id="reg-cv-folds">
                                <option value="5">5-Fold CV</option>
                                <option value="10">10-Fold CV</option>
                                <option value="leave-one-out">Leave-One-Out CV</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="reg-data-source">Canadian Data Source:</label>
                            <select id="reg-data-source">
                                <option value="cihi">CIHI Administrative Data</option>
                                <option value="cchs">Canadian Community Health Survey</option>
                                <option value="cpdn">Canadian Primary Care Sentinel Surveillance Network</option>
                                <option value="cadth">CADTH Real-World Evidence</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn" onclick="runRegularizedRegression()">üöÄ Run Regularized Regression Analysis</button>
                    </div>
                </div>
            </div>

            <!-- Results Card -->
            <div id="regularized-results-card" class="card-content">
                <div id="regularized-results" class="results-container" style="display: none;">
                    <!-- Results will be populated by JavaScript -->
                </div>
                <div id="regularized-placeholder" style="text-align: center; padding: 3rem; color: #5a7c5a;">
                    <h3>üéØ Feature selection results will appear here</h3>
                    <p>Use the Model Building tab to configure and run your regularized regression analysis.</p>
                </div>
            </div>

            <!-- Assessment Card -->
            <div id="regularized-assessment-card" class="card-content">
                <h3>üìù Regularized Regression Assessment</h3>
                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="generateRegularizedAssessment()">üìã Generate Regularization Questions</button>
                </div>
                <div id="regularized-assessment-questions" style="display: none;">
                    <!-- Assessment questions will be populated -->
                </div>
            </div>

            <div class="canadian-highlight">
                <h4>üá®üá¶ Canadian Precision Medicine Applications</h4>
                <p><strong>Canadian BioSample Network:</strong> Genomic data harmonization across provinces with regularized models.</p>
                <p><strong>Canadian Partnership for Personalized Medicine:</strong> Multi-omics integration for treatment response prediction.</p>
                <p><strong>Genome Quebec:</strong> Population-specific genetic risk models with Lasso feature selection.</p>
                <p><strong>Terry Fox Research Institute:</strong> Cancer biomarker discovery using elastic net methods.</p>
            </div>
        </div>

        <!-- Mixed Effects Models Section -->
        <div id="mixed-effects-section" class="content-section">
            <div class="section-header">
                <h2>üìà Mixed Effects Models</h2>
                <p>Hierarchical modeling for complex Canadian healthcare data structures with multiple levels of clustering and longitudinal patient follow-up.</p>
            </div>

            <!-- Card Navigation -->
            <div class="methodology-navigation">
                <div class="methodology-card active" onclick="showCard('mixed', 'theory', this)">
                    <h3><span class="icon">üìö</span>Theory & Framework</h3>
                    <p>Random effects, hierarchical structures, and clustering concepts</p>
                    <ul class="features">
                        <li>Random vs fixed effects</li>
                        <li>Intraclass correlation</li>
                        <li>Longitudinal modeling</li>
                        <li>Clustered data analysis</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('mixed', 'modeling', this)">
                    <h3><span class="icon">‚öôÔ∏è</span>Model Configuration</h3>
                    <p>Set up hierarchical structures for Canadian health systems</p>
                    <ul class="features">
                        <li>Data structure design</li>
                        <li>Clustering levels</li>
                        <li>Random effects specification</li>
                        <li>Provincial variations</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('mixed', 'results', this)">
                    <h3><span class="icon">üìà</span>Results & ICC</h3>
                    <p>Cluster analysis, ICC calculation, and effect visualization</p>
                    <ul class="features">
                        <li>Fixed effects estimates</li>
                        <li>Random effects variance</li>
                        <li>ICC interpretation</li>
                        <li>Cluster-specific effects</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('mixed', 'assessment', this)">
                    <h3><span class="icon">üìù</span>Assessment</h3>
                    <p>Test hierarchical modeling and clustering concepts</p>
                    <ul class="features">
                        <li>ICC interpretation</li>
                        <li>Random effects theory</li>
                        <li>Longitudinal analysis</li>
                        <li>Canadian multi-site studies</li>
                    </ul>
                </div>
            </div>

            <!-- Theory Card -->
            <div id="mixed-theory-card" class="card-content active">
                <div class="theory-grid">
                    <div class="theory-card">
                        <h3><span class="theory-icon">üè•</span>Random Effects Framework</h3>
                        <p><strong>Model:</strong> Y_ij = X_ij Œ≤ + Z_ij b_i + Œµ_ij</p>
                        <p><strong>Components:</strong> Fixed effects (Œ≤) + Random effects (b_i) + Error (Œµ_ij)</p>
                        <p><strong>Healthcare Application:</strong> Patients (j) clustered within providers/hospitals (i) with varying baseline outcomes.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">œÅ</span>Intraclass Correlation (ICC)</h3>
                        <p><strong>Formula:</strong> ICC = œÉ¬≤_between / (œÉ¬≤_between + œÉ¬≤_within)</p>
                        <p><strong>Interpretation:</strong> Proportion of total variance due to clustering.</p>
                        <p><strong>Clinical Meaning:</strong> How much patient outcomes depend on their provider/hospital vs individual factors.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üìÖ</span>Longitudinal Modeling</h3>
                        <p><strong>Structure:</strong> Repeated measures on same patients over time.</p>
                        <p><strong>Random Effects:</strong> Patient-specific intercepts and slopes for individual trajectories.</p>
                        <p><strong>Canadian Context:</strong> Tracking health outcomes across multiple healthcare encounters.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üîó</span>Hierarchical Structures</h3>
                        <p><strong>2-Level:</strong> Patients within providers</p>
                        <p><strong>3-Level:</strong> Patients within providers within hospitals</p>
                        <p><strong>4-Level:</strong> Add regional health authorities</p>
                        <p><strong>5-Level:</strong> Include provincial health systems</p>
                    </div>
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ Canadian Healthcare Mixed Effects Applications</h4>
                    <p><strong>CIHR SPOR Networks:</strong> Patient-oriented research across multiple sites with mixed effects to account for site heterogeneity.</p>
                    <p><strong>Primary Healthcare Transition Fund:</strong> Evaluation of care delivery models accounting for provider and clinic-level clustering.</p>
                    <p><strong>Wait Times Alliance:</strong> Multi-jurisdictional analysis of surgical wait times with provincial random effects.</p>
                    <p><strong>Canadian Health Services Research Foundation:</strong> Performance measurement across health regions with hierarchical modeling.</p>
                </div>
            </div>

            <!-- Model Building Card -->
            <div id="mixed-modeling-card" class="card-content">
                <div class="controls-panel">
                    <h3>Mixed Effects Model Configuration</h3>
                    <div class="controls-grid">
                        <div class="control-group">
                            <label for="mixed-structure">Data Structure:</label>
                            <select id="mixed-structure">
                                <option value="longitudinal">Longitudinal (repeated measures)</option>
                                <option value="clustered">Clustered (cross-sectional)</option>
                                <option value="multi-level">Multi-level hierarchical</option>
                                <option value="spatial-temporal">Spatial-temporal</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="mixed-outcome">Clinical Outcome:</label>
                            <select id="mixed-outcome">
                                <option value="bp-trajectory">Blood Pressure Trajectory</option>
                                <option value="pain-management">Chronic Pain Management</option>
                                <option value="mental-health">Mental Health Scores</option>
                                <option value="functional-decline">Functional Decline</option>
                                <option value="medication-response">Medication Response</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="mixed-clusters">Clustering Level:</label>
                            <select id="mixed-clusters">
                                <option value="2-level">2-Level (Patients ‚Üí Providers)</option>
                                <option value="3-level">3-Level (+ Hospitals)</option>
                                <option value="4-level">4-Level (+ Health Regions)</option>
                                <option value="5-level">5-Level (+ Provinces)</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="mixed-timepoints">Time Points:</label>
                            <select id="mixed-timepoints">
                                <option value="3">3 (baseline, 6mo, 12mo)</option>
                                <option value="5">5 (quarterly over 1 year)</option>
                                <option value="10">10 (monthly over 10 months)</option>
                                <option value="variable">Variable (real-world timing)</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="mixed-provinces">Provincial Scope:</label>
                            <select id="mixed-provinces">
                                <option value="single">Single Province Study</option>
                                <option value="atlantic">Atlantic Provinces</option>
                                <option value="central">Central Canada (ON, QC)</option>
                                <option value="western">Western Provinces</option>
                                <option value="national">National Multi-Provincial</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="mixed-random-effects">Random Effects Structure:</label>
                            <select id="mixed-random-effects">
                                <option value="intercept">Random Intercept Only</option>
                                <option value="intercept-slope">Random Intercept + Slope</option>
                                <option value="quadratic">Quadratic Growth Model</option>
                                <option value="complex">Complex Random Effects</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn" onclick="runMixedEffectsModel()">üöÄ Run Mixed Effects Analysis</button>
                    </div>
                </div>
            </div>

            <!-- Results Card -->
            <div id="mixed-results-card" class="card-content">
                <div id="mixed-results" class="results-container" style="display: none;">
                    <!-- Results will be populated by JavaScript -->
                </div>
                <div id="mixed-placeholder" style="text-align: center; padding: 3rem; color: #5a7c5a;">
                    <h3>üìà Mixed effects analysis results will appear here</h3>
                    <p>Use the Model Configuration tab to set up and run your mixed effects analysis.</p>
                </div>
            </div>

            <!-- Assessment Card -->
            <div id="mixed-assessment-card" class="card-content">
                <h3>üìù Mixed Effects Models Assessment</h3>
                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="generateMixedEffectsAssessment()">üìã Generate Mixed Effects Questions</button>
                </div>
                <div id="mixed-assessment-questions" style="display: none;">
                    <!-- Assessment questions will be populated -->
                </div>
            </div>
        </div>
                <!-- Results will be populated by JavaScript -->
            </div>

            <div class="regulatory-box">
                <h4>üèõÔ∏è Health Canada Mixed Effects Model Requirements</h4>
                <p><strong>Multi-Site Clinical Trials:</strong> Account for site-level variation in treatment effects and patient populations.</p>
                <p><strong>Real-World Evidence Submissions:</strong> Demonstrate effectiveness across diverse Canadian healthcare settings.</p>
                <p><strong>Post-Market Surveillance:</strong> Monitor drug safety and effectiveness with hierarchical data structures.</p>
                <p><strong>Health Technology Assessment:</strong> CADTH requirements for population-level effectiveness modeling.</p>
            </div>

            <div class="canadian-highlight">
                <h4>üá®üá¶ Canadian Multi-Level Healthcare Studies</h4>
                <p><strong>Canadian Institutes of Health Research (CIHR):</strong> Strategy for Patient-Oriented Research with multi-provincial collaboration.</p>
                <p><strong>Primary Healthcare Transition Fund:</strong> Evaluation of healthcare delivery models across provinces.</p>
                <p><strong>Wait Times Alliance:</strong> Multi-jurisdictional analysis of surgical wait times and outcomes.</p>
                <p><strong>Canadian Health Services Research Foundation:</strong> Health system performance measurement with hierarchical modeling.</p>
            </div>
        </div>

        <!-- Propensity Score Methods Section -->
        <!-- Propensity Score Methods Section -->
        <div id="propensity-score-section" class="content-section">
            <div class="section-header">
                <h2>‚öñÔ∏è Propensity Score Methods</h2>
                <p>Causal inference techniques for observational healthcare data, addressing confounding bias in treatment effect estimation for Canadian real-world evidence studies.</p>
            </div>

            <!-- Card Navigation -->
            <div class="methodology-navigation">
                <div class="methodology-card active" onclick="showCard('propensity-score', 'theory', this)">
                    <h3><span class="icon">üìö</span>Theory & Framework</h3>
                    <p>Propensity scores, matching, weighting, and causal assumptions</p>
                    <ul class="features">
                        <li>Propensity score definition</li>
                        <li>Matching strategies</li>
                        <li>Weighting methods</li>
                        <li>Balance assessment</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('propensity-score', 'modeling', this)">
                    <h3><span class="icon">‚öôÔ∏è</span>Treatment Comparison</h3>
                    <p>Configure treatment groups and confounding adjustment</p>
                    <ul class="features">
                        <li>Treatment selection</li>
                        <li>Outcome specification</li>
                        <li>Confounding variables</li>
                        <li>Estimand definition</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('propensity-score', 'results', this)">
                    <h3><span class="icon">üìà</span>Balance & Effects</h3>
                    <p>Balance assessment, overlap evaluation, and treatment effects</p>
                    <ul class="features">
                        <li>Standardized differences</li>
                        <li>Propensity score overlap</li>
                        <li>Treatment effect estimates</li>
                        <li>Sensitivity analysis</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('propensity-score', 'assessment', this)">
                    <h3><span class="icon">üìù</span>Assessment</h3>
                    <p>Test causal inference and propensity score concepts</p>
                    <ul class="features">
                        <li>Confounding bias</li>
                        <li>Balance assessment</li>
                        <li>Matching vs weighting</li>
                        <li>Real-world evidence</li>
                    </ul>
                </div>
            </div>

            <!-- Theory Card -->
            <div id="propensity-score-theory-card" class="card-content active">
                <div class="theory-grid">
                    <div class="theory-card">
                        <h3><span class="theory-icon">üìã</span>Propensity Score Framework</h3>
                        <p><strong>Definition:</strong> P(T=1|X) = probability of treatment given observed covariates X</p>
                        <p><strong>Purpose:</strong> Balance treatment and control groups on observed characteristics</p>
                        <p><strong>Clinical Application:</strong> Compare treatment effectiveness when randomization is not possible.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üéØ</span>Matching Methods</h3>
                        <p><strong>1:1 Matching:</strong> Pair treated and control patients with similar propensity scores</p>
                        <p><strong>Caliper Matching:</strong> Match within specified distance tolerance</p>
                        <p><strong>Optimal Matching:</strong> Minimize overall distance across all matches</p>
                        <p><strong>Healthcare Benefit:</strong> Create comparable patient groups for treatment evaluation.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">‚öñÔ∏è</span>Weighting Methods</h3>
                        <p><strong>IPW:</strong> Weight = 1/P(T|X) for treated, 1/(1-P(T|X)) for controls</p>
                        <p><strong>Stabilized Weights:</strong> Reduce variance in extreme propensity score regions</p>
                        <p><strong>Trimming:</strong> Exclude patients with extreme propensity scores</p>
                        <p><strong>Population Target:</strong> ATE, ATT, or ATC estimation strategies.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üîç</span>Balance Assessment</h3>
                        <p><strong>Standardized Mean Differences:</strong> Compare covariate distributions between groups</p>
                        <p><strong>Variance Ratios:</strong> Check balance in covariate variances</p>
                        <p><strong>Overlap Assessment:</strong> Propensity score distribution visualization</p>
                        <p><strong>Quality Control:</strong> Ensure valid causal inference assumptions.</p>
                    </div>
                </div>

                <div class="advanced-feature">
                    <h4>‚ö° Advanced Propensity Score Techniques</h4>
                    <p><strong>Machine Learning Propensity Scores:</strong> Random forests, neural networks for complex confounding patterns.</p>
                    <p><strong>Targeted Maximum Likelihood Estimation (TMLE):</strong> Doubly robust, efficient estimation for causal effects.</p>
                    <p><strong>Coarsened Exact Matching:</strong> Improved balance with categorical and continuous covariates.</p>
                    <p><strong>Entropy Balancing:</strong> Reweight observations to achieve exact balance on specified moments.</p>
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ Canadian Real-World Evidence Applications</h4>
                    <p><strong>CADTH Common Drug Review:</strong> Propensity score studies for comparative effectiveness research.</p>
                    <p><strong>Institute for Clinical Evaluative Sciences (ICES):</strong> Population-based propensity score studies using linked Ontario data.</p>
                    <p><strong>Canadian Network for Observational Drug Effect Studies:</strong> Multi-provincial drug safety surveillance.</p>
                    <p><strong>Alberta Strategy for Patient-Oriented Research:</strong> Real-world effectiveness studies in diverse Alberta populations.</p>
                </div>
            </div>

            <!-- Model Building Card -->
            <div id="propensity-score-modeling-card" class="card-content">
                <div class="controls-panel">
                    <h3>Propensity Score Analysis Configuration</h3>
                    <div class="controls-grid">
                        <div class="control-group">
                            <label for="ps-method">Propensity Score Method:</label>
                            <select id="ps-method">
                                <option value="matching">1:1 Propensity Score Matching</option>
                                <option value="weighting">Inverse Probability Weighting (IPW)</option>
                                <option value="stratification">Propensity Score Stratification</option>
                                <option value="regression-adjustment">Doubly Robust Estimation</option>
                                <option value="entropy-balancing">Entropy Balancing</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="ps-treatment">Treatment Comparison:</label>
                            <select id="ps-treatment">
                                <option value="drug-effectiveness">New vs Standard Drug</option>
                                <option value="surgical-procedure">Surgical vs Medical Management</option>
                                <option value="screening-program">Screening vs Usual Care</option>
                                <option value="care-model">Integrated vs Traditional Care</option>
                                <option value="policy-intervention">Policy Before vs After</option>
                                <option value="device-comparison">Medical Device vs Standard</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="ps-outcome">Primary Outcome:</label>
                            <select id="ps-outcome">
                                <option value="mortality">30-Day Mortality</option>
                                <option value="readmission">Hospital Readmission</option>
                                <option value="cost-effectiveness">Cost-Effectiveness</option>
                                <option value="quality-measure">Quality of Care Measure</option>
                                <option value="patient-reported">Patient-Reported Outcome</option>
                                <option value="adverse-events">Adverse Events</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="ps-confounders">Confounding Variables:</label>
                            <select id="ps-confounders">
                                <option value="standard">Standard Demographics + Comorbidities</option>
                                <option value="extended">Extended Clinical Variables</option>
                                <option value="comprehensive">Comprehensive EHR Variables</option>
                                <option value="high-dimensional">High-Dimensional Covariates</option>
                                <option value="machine-learning">ML-Selected Variables</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="ps-estimand">Causal Estimand:</label>
                            <select id="ps-estimand">
                                <option value="ate">Average Treatment Effect (ATE)</option>
                                <option value="att">Average Treatment Effect on Treated (ATT)</option>
                                <option value="atc">Average Treatment Effect on Controls (ATC)</option>
                                <option value="overlap">Overlap Population</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="ps-data-source">Canadian Data Source:</label>
                            <select id="ps-data-source">
                                <option value="provincial-admin">Provincial Administrative Data</option>
                                <option value="hospital-data">Hospital Discharge Abstract Database</option>
                                <option value="physician-claims">Physician Claims Database</option>
                                <option value="linked-datasets">Linked Provincial Datasets</option>
                                <option value="ices-data">ICES Linked Health Data</option>
                                <option value="cpdn-data">CPDN Primary Care Data</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="ps-caliper">Matching Caliper (if matching):</label>
                            <select id="ps-caliper">
                                <option value="0.1">0.1 SD (very tight)</option>
                                <option value="0.2">0.2 SD (recommended)</option>
                                <option value="0.25">0.25 SD (standard)</option>
                                <option value="0.5">0.5 SD (loose)</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="ps-trimming">Trimming Strategy:</label>
                            <select id="ps-trimming">
                                <option value="none">No trimming</option>
                                <option value="asymmetric">Asymmetric (0.01, 0.99)</option>
                                <option value="symmetric">Symmetric (0.05, 0.95)</option>
                                <option value="overlap-only">Overlap region only</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn" onclick="runPropensityScoreAnalysis()">üöÄ Run Propensity Score Analysis</button>
                    </div>
                </div>
            </div>

            <!-- Results Card -->
            <div id="propensity-score-results-card" class="card-content">
                <div id="propensity-score-results" class="results-container" style="display: none;">
                    <!-- Results will be populated by JavaScript -->
                </div>
                <div id="propensity-score-placeholder" style="text-align: center; padding: 3rem; color: #5a7c5a;">
                    <h3>‚öñÔ∏è Propensity score analysis results will appear here</h3>
                    <p>Use the Treatment Comparison tab to configure and run your causal analysis.</p>
                    <p><strong>Analysis Output:</strong> Balance assessment, overlap evaluation, treatment effects, sensitivity analysis</p>
                </div>
            </div>

            <!-- Assessment Card -->
            <div id="propensity-score-assessment-card" class="card-content">
                <h3>üìù Propensity Score Methods Assessment</h3>
                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="generatePropensityScoreAssessment()">üìã Generate Causal Inference Questions</button>
                </div>
                <div id="propensity-score-assessment-questions" style="display: none;">
                    <!-- Assessment questions will be populated -->
                </div>
            </div>
        </div>

        <!-- Instrumental Variables Methods Section -->
        <div id="instrumental-variables-section" class="content-section">
            <div class="section-header">
                <h2>üîß Instrumental Variables Methods</h2>
                <p>Advanced causal inference for addressing unmeasured confounding using natural experiments and policy variations in Canadian healthcare settings.</p>
            </div>

            <!-- Card Navigation -->
            <div class="methodology-navigation">
                <div class="methodology-card active" onclick="showCard('instrumental-variables', 'theory', this)">
                    <h3><span class="icon">üìö</span>Theory & Assumptions</h3>
                    <p>IV assumptions, natural experiments, and causal identification</p>
                    <ul class="features">
                        <li>IV assumptions (relevance, independence, exclusion)</li>
                        <li>Two-stage least squares</li>
                        <li>Mendelian randomization</li>
                        <li>Policy instruments</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('instrumental-variables', 'modeling', this)">
                    <h3><span class="icon">‚öôÔ∏è</span>IV Configuration</h3>
                    <p>Instrument selection and two-stage estimation setup</p>
                    <ul class="features">
                        <li>Instrument type selection</li>
                        <li>Treatment specification</li>
                        <li>Estimation method</li>
                        <li>Strength assessment</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('instrumental-variables', 'results', this)">
                    <h3><span class="icon">üìà</span>First Stage & Effects</h3>
                    <p>Instrument strength, bias correction, and causal effects</p>
                    <ul class="features">
                        <li>First-stage F-statistics</li>
                        <li>Bias correction analysis</li>
                        <li>Causal effect estimates</li>
                        <li>Sensitivity testing</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('instrumental-variables', 'assessment', this)">
                    <h3><span class="icon">üìù</span>Assessment</h3>
                    <p>Test IV assumptions and natural experiment concepts</p>
                    <ul class="features">
                        <li>Instrument validity</li>
                        <li>Endogeneity testing</li>
                        <li>Weak instrument issues</li>
                        <li>Canadian natural experiments</li>
                    </ul>
                </div>
            </div>

            <!-- Theory Card -->
            <div id="instrumental-variables-theory-card" class="card-content active">
                <div class="theory-grid">
                    <div class="theory-card">
                        <h3><span class="theory-icon">üéØ</span>IV Assumptions</h3>
                        <p><strong>Relevance:</strong> Instrument (Z) strongly predicts treatment (T)</p>
                        <p><strong>Independence:</strong> Instrument unrelated to unmeasured confounders</p>
                        <p><strong>Exclusion Restriction:</strong> Instrument affects outcome only through treatment</p>
                        <p><strong>Canadian Context:</strong> Policy variations as natural instruments.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üìà</span>Two-Stage Least Squares</h3>
                        <p><strong>First Stage:</strong> T = Œ±‚ÇÄ + Œ±‚ÇÅZ + Œ±‚ÇÇX + v</p>
                        <p><strong>Second Stage:</strong> Y = Œ≤‚ÇÄ + Œ≤‚ÇÅTÃÇ + Œ≤‚ÇÇX + u</p>
                        <p><strong>Estimate:</strong> Œ≤‚ÇÅ gives causal effect of treatment on outcome</p>
                        <p><strong>Healthcare Application:</strong> Unbiased treatment effects despite unmeasured confounding.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üß¨</span>Mendelian Randomization</h3>
                        <p><strong>Instrument:</strong> Genetic variants as randomizing instruments</p>
                        <p><strong>Advantage:</strong> Fixed at conception, reducing confounding</p>
                        <p><strong>Application:</strong> Causal effects of biomarkers on disease outcomes</p>
                        <p><strong>Canadian Data:</strong> Biobank cohorts with genetic and health data.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üìä</span>Policy Instruments</h3>
                        <p><strong>Geographic Variation:</strong> Regional policy differences as instruments</p>
                        <p><strong>Temporal Variation:</strong> Policy implementation timing differences</p>
                        <p><strong>Eligibility Rules:</strong> Sharp cutoffs in program eligibility</p>
                        <p><strong>Canadian Examples:</strong> Provincial healthcare policy variations.</p>
                    </div>
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ Canadian IV Research Examples</h4>
                    <p><strong>Canadian Institute for Advanced Research:</strong> Population health interventions using policy variations as instruments.</p>
                    <p><strong>Population Health Research Network:</strong> Multi-provincial studies leveraging healthcare system differences.</p>
                    <p><strong>Canadian Partnership Against Cancer:</strong> Cancer screening policy evaluations using geographic and temporal variation.</p>
                    <p><strong>Michael Smith Foundation:</strong> BC health policy evaluations using natural experiments and IV methods.</p>
                </div>
            </div>

            <!-- Model Configuration Card -->
            <div id="instrumental-variables-modeling-card" class="card-content">
                <div class="controls-panel">
                    <h3>Instrumental Variables Analysis Configuration</h3>
                    <div class="controls-grid">
                        <div class="control-group">
                            <label for="iv-type">Instrumental Variable Type:</label>
                            <select id="iv-type">
                                <option value="policy">Provincial Policy Variation</option>
                                <option value="mendelian">Mendelian Randomization</option>
                                <option value="physician-preference">Physician Preference</option>
                                <option value="geographic">Geographic Variation</option>
                                <option value="distance">Distance to Provider</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="iv-treatment">Treatment of Interest:</label>
                            <select id="iv-treatment">
                                <option value="medication-adherence">Medication Adherence</option>
                                <option value="specialist-referral">Specialist Referral</option>
                                <option value="preventive-screening">Preventive Screening</option>
                                <option value="surgical-timing">Surgical Timing</option>
                                <option value="care-intensity">Care Intensity</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="iv-outcome">Health Outcome:</label>
                            <select id="iv-outcome">
                                <option value="mortality">Long-term Mortality</option>
                                <option value="hospitalization">Emergency Hospitalization</option>
                                <option value="quality-life">Quality of Life</option>
                                <option value="functional-status">Functional Status</option>
                                <option value="healthcare-costs">Healthcare Costs</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="iv-strength">Instrument Strength (F-statistic):</label>
                            <input type="range" id="iv-strength" value="25" min="5" max="50" oninput="updateStrengthLabel(this.value)">
                            <span id="strength-label">Strong (F = 25)</span>
                        </div>

                        <div class="control-group">
                            <label for="iv-estimation">Estimation Method:</label>
                            <select id="iv-estimation">
                                <option value="2sls">Two-Stage Least Squares (2SLS)</option>
                                <option value="liml">Limited Information ML (LIML)</option>
                                <option value="gmm">Generalized Method of Moments</option>
                                <option value="control-function">Control Function Approach</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="iv-province">Provincial Setting:</label>
                            <select id="iv-province">
                                <option value="cross-provincial">Cross-Provincial Comparison</option>
                                <option value="ontario-policy">Ontario Policy Change</option>
                                <option value="quebec-reform">Quebec Healthcare Reform</option>
                                <option value="atlantic-collaboration">Atlantic Collaboration</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn" onclick="runInstrumentalVariablesAnalysis()">üöÄ Run IV Analysis</button>
                    </div>
                </div>
            </div>

            <!-- Results Card -->
            <div id="instrumental-variables-results-card" class="card-content">
                <div id="instrumental-variables-results" class="results-container" style="display: none;">
                    <!-- Results will be populated by JavaScript -->
                </div>
                <div id="instrumental-variables-placeholder" style="text-align: center; padding: 3rem; color: #5a7c5a;">
                    <h3>üîß Instrumental variables analysis results will appear here</h3>
                    <p>Use the IV Configuration tab to set up and run your causal analysis.</p>
                </div>
            </div>

            <!-- Assessment Card -->
            <div id="instrumental-variables-assessment-card" class="card-content">
                <h3>üìù Instrumental Variables Assessment</h3>
                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="generateInstrumentalVariablesAssessment()">üìã Generate IV Methods Questions</button>
                </div>
                <div id="instrumental-variables-assessment-questions" style="display: none;">
                    <!-- Assessment questions will be populated -->
                </div>
            </div>
        </div>

        <!-- Canadian Integration Section -->
        <div id="canadian-integration-section" class="content-section">
            <div class="section-header">
                <h2>üá®üá¶ Canadian Healthcare System Integration</h2>
                <p>Comprehensive integration with Canadian health data infrastructure, regulatory frameworks, and provincial healthcare system variations.</p>
            </div>

            <!-- Card Navigation -->
            <div class="methodology-navigation">
                <div class="methodology-card active" onclick="showCard('canadian-integration', 'theory', this)">
                    <h3><span class="icon">üìö</span>Theory & Framework</h3>
                    <p>Federal framework, provincial variations, and regulatory pathways</p>
                    <ul class="features">
                        <li>Canada Health Act principles</li>
                        <li>Provincial healthcare delivery</li>
                        <li>CIHI data infrastructure</li>
                        <li>Regulatory approval processes</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('canadian-integration', 'modeling', this)">
                    <h3><span class="icon">‚öôÔ∏è</span>Data Configuration</h3>
                    <p>Data sources, linkage strategies, and privacy frameworks</p>
                    <ul class="features">
                        <li>Administrative data sources</li>
                        <li>Multi-provincial linkage</li>
                        <li>Privacy compliance (PIPEDA)</li>
                        <li>Quality indicator standardization</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('canadian-integration', 'results', this)">
                    <h3><span class="icon">üìà</span>Integration Results</h3>
                    <p>Provincial performance, quality indicators, and system metrics</p>
                    <ul class="features">
                        <li>Provincial comparisons</li>
                        <li>Quality indicator analysis</li>
                        <li>Data coverage assessment</li>
                        <li>System performance ranking</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('canadian-integration', 'assessment', this)">
                    <h3><span class="icon">üìù</span>Assessment</h3>
                    <p>Test Canadian health system integration and regulatory knowledge</p>
                    <ul class="features">
                        <li>CIHI standards compliance</li>
                        <li>Privacy framework requirements</li>
                        <li>Canada Health Act principles</li>
                        <li>Regulatory pathway readiness</li>
                    </ul>
                </div>
            </div>

            <!-- Theory Card -->
            <div id="canadian-integration-theory-card" class="card-content active">
                <div class="theory-grid">
                    <div class="theory-card">
                        <h3><span class="theory-icon">üèõÔ∏è</span>Federal Health Framework</h3>
                        <p><strong>Canada Health Act:</strong> Five principles - public administration, comprehensiveness, universality, portability, accessibility</p>
                        <p><strong>Health Canada Role:</strong> Federal regulatory oversight, drug approvals, medical device regulation</p>
                        <p><strong>Transfer Payments:</strong> Canada Health Transfer funding with accountability frameworks</p>
                        <p><strong>Modeling Implication:</strong> Ensure compliance with federal health standards and reporting requirements.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üó∫Ô∏è</span>Provincial Variations</h3>
                        <p><strong>Healthcare Delivery:</strong> Provincial jurisdiction over health service delivery and organization</p>
                        <p><strong>Data Systems:</strong> Province-specific administrative databases (OHIP, RAMQ, MSP, etc.)</p>
                        <p><strong>Population Differences:</strong> Demographics, risk factors, health outcomes, and resource allocation</p>
                        <p><strong>Statistical Consideration:</strong> Account for provincial fixed effects, clustering, and multilevel structures.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üìä</span>CIHI Data Infrastructure</h3>
                        <p><strong>DAD:</strong> Discharge Abstract Database for all acute care hospital separations</p>
                        <p><strong>NACRS:</strong> National Ambulatory Care Reporting System for emergency departments</p>
                        <p><strong>HMDB:</strong> Health System Performance indicators and provincial comparisons</p>
                        <p><strong>Modeling Benefit:</strong> Standardized data elements, definitions, and quality assurance across provinces.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">‚öñÔ∏è</span>Regulatory Pathways</h3>
                        <p><strong>Health Canada:</strong> Therapeutic Products Directorate for drug approvals and post-market surveillance</p>
                        <p><strong>CADTH:</strong> Health technology assessment, economic evaluation, and reimbursement recommendations</p>
                        <p><strong>Provincial Formularies:</strong> Drug coverage decisions with real-world evidence requirements</p>
                        <p><strong>Evidence Standards:</strong> Real-world evidence frameworks for regulatory and coverage decisions.</p>
                    </div>
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ National Health Data Strategy</h4>
                    <p><strong>Canadian Digital Health Strategy:</strong> Interoperable health information systems for improved population health analytics and care coordination.</p>
                    <p><strong>Pan-Canadian Health Data Charter:</strong> Privacy-preserving data sharing principles for research, quality improvement, and system optimization.</p>
                    <p><strong>SPOR Networks:</strong> Strategy for Patient-Oriented Research data infrastructure, analytics platforms, and knowledge translation.</p>
                    <p><strong>Compute Canada Federation:</strong> High-performance computing resources for large-scale Canadian health data analysis and modeling.</p>
                </div>

                <div class="regulatory-box">
                    <h4>üèõÔ∏è Canadian Regulatory Evidence Standards</h4>
                    <p><strong>Health Canada RWE Guidance:</strong> Real-world evidence framework for regulatory decision-making with Canadian-specific data requirements.</p>
                    <p><strong>CADTH Methods Guidelines:</strong> Standards for economic evaluation, budget impact analysis, and HTA using Canadian health system data.</p>
                    <p><strong>Provincial HTA Agencies:</strong> Coordination across INAHTA member agencies (INESSS, HQO, AHS) for evidence standards.</p>
                    <p><strong>Pan-Canadian HTA:</strong> Harmonized evidence requirements for multi-jurisdictional coverage and formulary decisions.</p>
                </div>
            </div>

            <!-- Data Configuration Card -->
            <div id="canadian-integration-modeling-card" class="card-content">
                <div class="controls-panel">
                    <h3>Canadian Health System Integration Configuration</h3>
                    <div class="controls-grid">
                        <div class="control-group">
                            <label for="can-data-source">Primary Data Source:</label>
                            <select id="can-data-source">
                                <option value="cihi-dad">CIHI Discharge Abstract Database</option>
                                <option value="cihi-nacrs">CIHI National Ambulatory Care</option>
                                <option value="provincial-admin">Provincial Administrative Claims</option>
                                <option value="cchs">Canadian Community Health Survey</option>
                                <option value="nphs">National Population Health Survey</option>
                                <option value="ices-ontario">ICES Ontario Linked Data</option>
                                <option value="cadth-data">CADTH Real-World Evidence</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="can-linkage">Data Linkage Strategy:</label>
                            <select id="can-linkage">
                                <option value="within-province">Within-Province Linkage</option>
                                <option value="multi-province">Multi-Provincial Linkage</option>
                                <option value="federal-provincial">Federal-Provincial Linkage</option>
                                <option value="survey-admin">Survey-Administrative Linkage</option>
                                <option value="registry-linkage">Disease Registry Linkage</option>
                                <option value="vital-statistics">Vital Statistics Integration</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="can-privacy">Privacy Framework:</label>
                            <select id="can-privacy">
                                <option value="pipeda">PIPEDA Compliance (Federal)</option>
                                <option value="provincial-acts">Provincial Privacy Acts</option>
                                <option value="research-ethics">Research Ethics Board Approval</option>
                                <option value="data-sharing">Multi-Jurisdictional Data Sharing</option>
                                <option value="anonymization">Statistical Disclosure Control</option>
                                <option value="safe-harbour">Safe Harbour Privacy Methods</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="can-population">Target Population:</label>
                            <select id="can-population">
                                <option value="general">General Canadian Population</option>
                                <option value="indigenous">Indigenous Populations</option>
                                <option value="rural-remote">Rural and Remote Communities</option>
                                <option value="immigrants">Recent Immigrants and Refugees</option>
                                <option value="elderly">Elderly (65+) Population</option>
                                <option value="pediatric">Pediatric Populations</option>
                                <option value="chronic-disease">Chronic Disease Cohorts</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="can-outcome-standard">Outcome Standardization:</label>
                            <select id="can-outcome-standard">
                                <option value="cihi-indicators">CIHI Quality Indicators</option>
                                <option value="hqc-measures">Health Quality Council Measures</option>
                                <option value="oecd-indicators">OECD Health Indicators</option>
                                <option value="who-standards">WHO Global Health Standards</option>
                                <option value="provincial-kpi">Provincial Key Performance Indicators</option>
                                <option value="patient-reported">Patient-Reported Outcome Measures</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="can-regulatory-path">Regulatory Pathway:</label>
                            <select id="can-regulatory-path">
                                <option value="health-canada">Health Canada Submission</option>
                                <option value="cadth-review">CADTH HTA Review</option>
                                <option value="provincial-formulary">Provincial Formulary Submission</option>
                                <option value="pan-canadian">Pan-Canadian Pharmaceutical Alliance</option>
                                <option value="conditional-coverage">Conditional Coverage with Evidence</option>
                                <option value="real-world-monitoring">Real-World Evidence Program</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="can-integration-method">Integration Method:</label>
                            <select id="can-integration-method">
                                <option value="meta-analysis">Meta-Analysis Across Provinces</option>
                                <option value="pooled-analysis">Pooled Individual Patient Data</option>
                                <option value="federated-learning">Federated Learning Approach</option>
                                <option value="harmonized-analysis">Harmonized Analysis Protocol</option>
                                <option value="network-analysis">Health System Network Analysis</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="can-reporting-standard">Reporting Standard:</label>
                            <select id="can-reporting-standard">
                                <option value="consort-pragmatic">CONSORT Pragmatic Trials</option>
                                <option value="strobe-observational">STROBE Observational Studies</option>
                                <option value="record-rwe">RECORD Real-World Evidence</option>
                                <option value="cheers-economic">CHEERS Economic Evaluation</option>
                                <option value="cadth-guidelines">CADTH Reporting Guidelines</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn" onclick="runCanadianIntegrationAnalysis()">üöÄ Run Canadian Health System Analysis</button>
                    </div>
                </div>
            </div>

            <!-- Results Card -->
            <div id="canadian-integration-results-card" class="card-content">
                <div id="canadian-integration-results" class="results-container" style="display: none;">
                    <!-- Results will be populated by JavaScript -->
                </div>
                <div id="canadian-integration-placeholder" style="text-align: center; padding: 3rem; color: #5a7c5a;">
                    <h3>üá®üá¶ Canadian health system integration results will appear here</h3>
                    <p>Use the Data Configuration tab to set up and run your health system analysis.</p>
                    <p><strong>Analysis Output:</strong> Provincial performance comparison, data quality assessment, regulatory readiness evaluation</p>
                </div>
            </div>

            <!-- Assessment Card -->
            <div id="canadian-integration-assessment-card" class="card-content">
                <h3>üìù Canadian Health System Integration Assessment</h3>
                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="generateCanadianIntegrationAssessment()">üìã Generate Health System Questions</button>
                </div>
                <div id="canadian-integration-assessment-questions" style="display: none;">
                    <!-- Assessment questions will be populated -->
                </div>
            </div>
        </div>

        <!-- Real-World Applications Section -->
        <div id="real-world-applications-section" class="content-section">
            <div class="section-header">
                <h2>üè• Real-World Canadian Healthcare Applications</h2>
                <p>Advanced modeling scenarios combining multiple statistical methods for complex Canadian healthcare research questions and policy evaluations.</p>
            </div>

            <!-- Card Navigation -->
            <div class="methodology-navigation">
                <div class="methodology-card active" onclick="showCard('real-world-applications', 'theory', this)">
                    <h3><span class="icon">üìö</span>Theory & Integration</h3>
                    <p>Multi-method integration strategies and sequential analysis pipelines</p>
                    <ul class="features">
                        <li>Sequential method selection</li>
                        <li>Ensemble approaches</li>
                        <li>Assumption validation</li>
                        <li>Sensitivity analysis</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('real-world-applications', 'modeling', this)">
                    <h3><span class="icon">‚öôÔ∏è</span>Scenario Configuration</h3>
                    <p>Complex real-world healthcare research scenarios</p>
                    <ul class="features">
                        <li>Health technology assessment</li>
                        <li>Population health analytics</li>
                        <li>Policy impact evaluation</li>
                        <li>Precision medicine</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('real-world-applications', 'results', this)">
                    <h3><span class="icon">üìà</span>Pipeline Results</h3>
                    <p>Integrated analysis results and method comparisons</p>
                    <ul class="features">
                        <li>Method performance comparison</li>
                        <li>Robustness assessment</li>
                        <li>Clinical interpretation</li>
                        <li>Regulatory readiness</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('real-world-applications', 'assessment', this)">
                    <h3><span class="icon">üìù</span>Assessment</h3>
                    <p>Test understanding of method integration and real-world applications</p>
                    <ul class="features">
                        <li>Method selection strategies</li>
                        <li>Integration workflows</li>
                        <li>Clinical interpretation</li>
                        <li>Canadian policy applications</li>
                    </ul>
                </div>
            </div>

            <!-- Theory & Integration Card -->
            <div id="real-world-applications-theory-card" class="card-content active">
                <div class="theory-grid">
                    <div class="theory-card">
                        <h3><span class="theory-icon">üî¨</span>Sequential Analysis Pipeline</h3>
                        <p><strong>Stage 1: Classical Regression</strong> - Exploratory analysis, variable selection, assumption checking</p>
                        <p><strong>Stage 2: Regularization</strong> - High-dimensional data, multicollinearity, automated selection</p>
                        <p><strong>Stage 3: Mixed Effects</strong> - Hierarchical data, repeated measures, clustering</p>
                        <p><strong>Stage 4: Causal Inference</strong> - Propensity scores, IV methods, policy evaluation</p>
                        <p><strong>Integration Strategy:</strong> Build complexity progressively, validate assumptions at each stage.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üìà</span>Health Technology Assessment Pipeline</h3>
                        <p><strong>Clinical Effectiveness:</strong> Mixed effects models for multi-site trials</p>
                        <p><strong>Economic Evaluation:</strong> Cost-effectiveness with causal inference methods</p>
                        <p><strong>Budget Impact:</strong> Population-level predictions with regularized models</p>
                        <p><strong>Real-World Evidence:</strong> Administrative data analysis with propensity scores</p>
                        <p><strong>CADTH Integration:</strong> Evidence synthesis meeting Canadian HTA standards.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üåê</span>Population Health Analytics</h3>
                        <p><strong>Health Equity Analysis:</strong> Multi-level modeling of social determinants</p>
                        <p><strong>System Performance:</strong> Provincial comparison with mixed effects models</p>
                        <p><strong>Policy Impact:</strong> Instrumental variables for natural experiments</p>
                        <p><strong>Surveillance Systems:</strong> Real-time monitoring with adaptive modeling</p>
                        <p><strong>Canadian Context:</strong> Federal-provincial data integration and harmonization.</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üéØ</span>Precision Medicine Integration</h3>
                        <p><strong>Biomarker Discovery:</strong> Regularized regression for high-dimensional genomics</p>
                        <p><strong>Risk Stratification:</strong> Ensemble methods combining multiple algorithms</p>
                        <p><strong>Treatment Selection:</strong> Causal machine learning for optimal assignment</p>
                        <p><strong>Clinical Translation:</strong> Interpretable models for decision support</p>
                        <p><strong>Canadian Implementation:</strong> Population-specific validation and calibration.</p>
                    </div>
                </div>

                <div class="advanced-feature">
                    <h4>‚ö° Advanced Integration Strategies</h4>
                    <p><strong>Method Selection Decision Tree:</strong> Automated recommendation based on data characteristics, research questions, and assumptions</p>
                    <p><strong>Ensemble Approaches:</strong> Combine classical, regularized, and causal models for improved prediction and inference</p>
                    <p><strong>Sensitivity Analysis:</strong> Test robustness across different methodological frameworks and assumption violations</p>
                    <p><strong>Cross-Validation:</strong> Multi-method validation using temporal, geographic, and population splits</p>
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ Canadian Research Excellence Examples</h4>
                    <p><strong>Canadian COVID-19 Response:</strong> Multi-jurisdictional surveillance combining administrative records, laboratory data, and survey data using ensemble modeling approaches</p>
                    <p><strong>Ontario Health Study:</strong> Long-term cohort analysis (n=225,000) using mixed effects models for cancer prevention and early detection research</p>
                    <p><strong>Quebec Longitudinal Study:</strong> Child development trajectory modeling using advanced statistical methods and life-course epidemiology</p>
                    <p><strong>Alberta Health Analytics:</strong> Provincial population health surveillance using machine learning and causal inference for policy evaluation</p>
                </div>
            </div>

            <!-- Scenario Configuration Card -->
            <div id="real-world-applications-modeling-card" class="card-content">
                <div class="controls-panel">
                    <h3>Real-World Application Scenario Configuration</h3>
                    <div class="controls-grid">
                        <div class="control-group">
                            <label for="rwa-scenario">Application Scenario:</label>
                            <select id="rwa-scenario">
                                <option value="cancer-treatment">Cancer Treatment Effectiveness Study</option>
                                <option value="drug-safety">Post-Market Drug Safety Analysis</option>
                                <option value="health-equity">Health Equity and Access Analysis</option>
                                <option value="hta-submission">Health Technology Assessment</option>
                                <option value="policy-evaluation">Healthcare Policy Evaluation</option>
                                <option value="quality-improvement">Quality Improvement Initiative</option>
                                <option value="precision-medicine">Precision Medicine Implementation</option>
                                <option value="population-health">Population Health Surveillance</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="rwa-methods">Statistical Methods Pipeline:</label>
                            <select id="rwa-methods">
                                <option value="exploratory">Exploratory (Classical Regression Only)</option>
                                <option value="descriptive-regression">Descriptive + Classical Regression</option>
                                <option value="regression-regularization">Classical + Regularized Regression</option>
                                <option value="mixed-causal">Mixed Effects + Causal Inference</option>
                                <option value="comprehensive-pipeline">Comprehensive Analysis Pipeline</option>
                                <option value="ensemble-advanced">Advanced Ensemble Methods</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="rwa-complexity">Analytical Complexity:</label>
                            <select id="rwa-complexity">
                                <option value="standard">Standard Clinical Analysis</option>
                                <option value="advanced">Advanced Research Methods</option>
                                <option value="regulatory">Regulatory Submission Quality</option>
                                <option value="publication">Publication-Grade Analysis</option>
                                <option value="innovation">Methodological Innovation</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="rwa-timeframe">Study Design:</label>
                            <select id="rwa-timeframe">
                                <option value="cross-sectional">Cross-sectional Analysis</option>
                                <option value="cohort-short">Short-term Cohort (6-24 months)</option>
                                <option value="cohort-long">Long-term Cohort (2-10 years)</option>
                                <option value="case-control">Case-Control Study</option>
                                <option value="interrupted-time-series">Interrupted Time Series</option>
                                <option value="natural-experiment">Natural Experiment</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="rwa-scope">Geographic Scope:</label>
                            <select id="rwa-scope">
                                <option value="single-site">Single Healthcare Institution</option>
                                <option value="health-network">Regional Health Network</option>
                                <option value="provincial">Single Province</option>
                                <option value="multi-provincial">Multi-Provincial Study</option>
                                <option value="national">National Canadian Study</option>
                                <option value="international">International Collaboration</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="rwa-stakeholders">Primary Stakeholders:</label>
                            <select id="rwa-stakeholders">
                                <option value="clinicians">Clinicians and Healthcare Providers</option>
                                <option value="patients">Patients and Patient Advocates</option>
                                <option value="policymakers">Health System Policymakers</option>
                                <option value="payers">Public and Private Payers</option>
                                <option value="regulators">Health Canada and Regulators</option>
                                <option value="researchers">Academic Researchers</option>
                                <option value="industry">Pharmaceutical/Device Industry</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="rwa-data-sources">Data Sources Integration:</label>
                            <select id="rwa-data-sources">
                                <option value="administrative">Administrative Claims Only</option>
                                <option value="ehr-administrative">EHR + Administrative Data</option>
                                <option value="registry-linkage">Disease Registry + Linkage</option>
                                <option value="survey-administrative">Survey + Administrative Linkage</option>
                                <option value="multi-modal">Multi-Modal Data Integration</option>
                                <option value="real-time">Real-Time Data Streams</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="rwa-validation">Validation Strategy:</label>
                            <select id="rwa-validation">
                                <option value="internal">Internal Validation Only</option>
                                <option value="temporal">Temporal Validation</option>
                                <option value="geographic">Geographic External Validation</option>
                                <option value="population">Population External Validation</option>
                                <option value="prospective">Prospective Validation</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn" onclick="runRealWorldApplicationAnalysis()">üöÄ Run Real-World Application Analysis</button>
                    </div>
                </div>
            </div>

            <!-- Pipeline Results Card -->
            <div id="real-world-applications-results-card" class="card-content">
                <div id="real-world-applications-results" class="results-container" style="display: none;">
                    <!-- Results will be populated by JavaScript -->
                </div>
                <div id="real-world-applications-placeholder" style="text-align: center; padding: 3rem; color: #5a7c5a;">
                    <h3>üè• Real-world application pipeline results will appear here</h3>
                    <p>Use the Scenario Configuration tab to set up and run your integrated analysis pipeline.</p>
                    <p><strong>Analysis Output:</strong> Multi-method comparison, robustness assessment, clinical interpretation, regulatory readiness</p>
                </div>
            </div>

            <!-- Assessment Card -->
            <div id="real-world-applications-assessment-card" class="card-content">
                <h3>üìù Real-World Applications Assessment</h3>
                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="generateRealWorldApplicationsAssessment()">üìã Generate Method Integration Questions</button>
                </div>
                <div id="real-world-applications-assessment-questions" style="display: none;">
                    <!-- Assessment questions will be populated -->
                </div>
            </div>
        </div>

        <!-- Advanced Assessment Section -->
        <div id="assessment-section" class="content-section">
            <div class="section-header">
                <h2>üìù Advanced Assessment</h2>
                <p>Comprehensive evaluation of advanced statistical methods, causal inference concepts, and Canadian healthcare policy applications with integrated competency assessment.</p>
            </div>

            <!-- Card Navigation -->
            <div class="methodology-navigation">
                <div class="methodology-card active" onclick="showCard('assessment', 'theory', this)">
                    <h3><span class="icon">üìö</span>Theory & Framework</h3>
                    <p>Assessment methodology and Canadian competency frameworks</p>
                    <ul class="features">
                        <li>Competency-based evaluation</li>
                        <li>Adaptive testing principles</li>
                        <li>Canadian health research standards</li>
                        <li>Professional development pathways</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('assessment', 'modeling', this)">
                    <h3><span class="icon">‚öôÔ∏è</span>Assessment Configuration</h3>
                    <p>Customize assessment parameters and focus areas</p>
                    <ul class="features">
                        <li>Skill level targeting</li>
                        <li>Method focus selection</li>
                        <li>Question format options</li>
                        <li>Adaptive difficulty</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('assessment', 'results', this)">
                    <h3><span class="icon">üìà</span>Performance Analysis</h3>
                    <p>Detailed performance analytics and competency mapping</p>
                    <ul class="features">
                        <li>Skill competency mapping</li>
                        <li>Performance benchmarking</li>
                        <li>Learning gap analysis</li>
                        <li>Professional readiness</li>
                    </ul>
                </div>

                <div class="methodology-card" onclick="showCard('assessment', 'assessment', this)">
                    <h3><span class="icon">üìù</span>Comprehensive Test</h3>
                    <p>Integrated assessment covering all statistical methods</p>
                    <ul class="features">
                        <li>Multi-method integration</li>
                        <li>Scenario-based problems</li>
                        <li>Canadian context applications</li>
                        <li>Professional certification readiness</li>
                    </ul>
                </div>
            </div>

            <!-- Theory & Framework Card -->
            <div id="assessment-theory-card" class="card-content active">
                <div class="theory-grid">
                    <div class="theory-card">
                        <h3><span class="theory-icon">üéØ</span>Competency-Based Assessment Framework</h3>
                        <p><strong>Knowledge Domains:</strong> Statistical theory, method selection, assumption validation, interpretation</p>
                        <p><strong>Skill Assessment:</strong> Data analysis execution, software proficiency, troubleshooting</p>
                        <p><strong>Application Competency:</strong> Clinical translation, policy implications, regulatory compliance</p>
                        <p><strong>Integration Mastery:</strong> Multi-method workflows, ensemble approaches, validation strategies</p>
                        <p><strong>Canadian Context:</strong> Health system knowledge, regulatory frameworks, evidence standards</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üîÑ</span>Adaptive Testing Methodology</h3>
                        <p><strong>Item Response Theory:</strong> Question difficulty calibrated to learner ability level</p>
                        <p><strong>Dynamic Branching:</strong> Assessment path adapts based on performance patterns</p>
                        <p><strong>Precision Optimization:</strong> Minimum questions for maximum assessment precision</p>
                        <p><strong>Bias Prevention:</strong> Culturally appropriate content, diverse scenario contexts</p>
                        <p><strong>Continuous Calibration:</strong> Performance data improves question difficulty estimates</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üìä</span>Performance Analytics</h3>
                        <p><strong>Multi-dimensional Scoring:</strong> Separate competency scores for each statistical method</p>
                        <p><strong>Diagnostic Assessment:</strong> Identifies specific knowledge gaps and misconceptions</p>
                        <p><strong>Benchmark Comparison:</strong> Performance relative to graduate, professional, expert levels</p>
                        <p><strong>Growth Tracking:</strong> Longitudinal competency development measurement</p>
                        <p><strong>Predictive Modeling:</strong> Success probability in advanced research roles</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üá®üá¶</span>Canadian Health Research Standards</h3>
                        <p><strong>CIHR Competencies:</strong> Statistical methods training for health services researchers</p>
                        <p><strong>CADTH Evidence Standards:</strong> Health technology assessment methodology requirements</p>
                        <p><strong>Provincial Certification:</strong> Health data analyst and epidemiologist credentials</p>
                        <p><strong>Academic Prerequisites:</strong> Graduate program admission and thesis defense readiness</p>
                        <p><strong>Industry Standards:</strong> Pharmaceutical, biotech, and health consulting requirements</p>
                    </div>
                </div>

                <div class="advanced-feature">
                    <h4>‚ö° Advanced Assessment Features</h4>
                    <p><strong>Scenario-Based Integration:</strong> Complex healthcare problems requiring multiple statistical methods and clinical interpretation</p>
                    <p><strong>Real-World Case Studies:</strong> Authentic Canadian health system challenges with administrative data analysis requirements</p>
                    <p><strong>Method Selection Optimization:</strong> Decision trees for choosing appropriate analytical approaches given research questions and data characteristics</p>
                    <p><strong>Regulatory Simulation:</strong> Mock CADTH submissions and Health Canada real-world evidence evaluations</p>
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ Canadian Health Research Training Ecosystem</h4>
                    <p><strong>CIHR Training Awards:</strong> Statistical methods requirements for Doctoral Research Awards and Postdoctoral Fellowships</p>
                    <p><strong>Canadian Statistical Sciences Institute:</strong> Professional development programs in health data analysis and causal inference</p>
                    <p><strong>Health Data Research Network Canada:</strong> National capacity building initiatives in advanced health analytics</p>
                    <p><strong>Provincial Training Centers:</strong> ICES Academy, Population Data BC Training, Alberta SPOR SUPPORT Unit education programs</p>
                </div>
            </div>

            <!-- Assessment Configuration Card -->
            <div id="assessment-modeling-card" class="card-content">
                <div class="controls-panel">
                    <h3>Advanced Assessment Configuration</h3>
                    <div class="controls-grid">
                        <div class="control-group">
                            <label for="assess-level">Target Competency Level:</label>
                            <select id="assess-level">
                                <option value="graduate">Graduate Student (MSc/PhD)</option>
                                <option value="professional">Healthcare Professional (MD, PharmD)</option>
                                <option value="analyst">Health Data Analyst</option>
                                <option value="researcher">Health Services Researcher</option>
                                <option value="methodologist">Statistical Methodologist</option>
                                <option value="expert">Senior Research Scientist</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="assess-focus">Assessment Focus Area:</label>
                            <select id="assess-focus">
                                <option value="comprehensive">Comprehensive Multi-Method Assessment</option>
                                <option value="classical-regression">Classical Multiple Regression Mastery</option>
                                <option value="regularization">Regularization Methods</option>
                                <option value="mixed-effects">Mixed Effects Modeling</option>
                                <option value="causal-inference">Causal Inference Methods</option>
                                <option value="canadian-integration">Canadian Health System Integration</option>
                                <option value="method-integration">Real-World Method Integration</option>
                                <option value="clinical-translation">Clinical Translation & Interpretation</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="assess-format">Question Format:</label>
                            <select id="assess-format">
                                <option value="adaptive">Adaptive Multi-Format Assessment</option>
                                <option value="multiple-choice">Multiple Choice Questions</option>
                                <option value="scenario-based">Healthcare Scenario Problems</option>
                                <option value="calculation">Statistical Calculations</option>
                                <option value="interpretation">Results Interpretation</option>
                                <option value="method-selection">Method Selection Decisions</option>
                                <option value="case-study">Comprehensive Case Studies</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="assess-difficulty">Difficulty Progression:</label>
                            <select id="assess-difficulty">
                                <option value="adaptive">Adaptive (Adjusts to Performance)</option>
                                <option value="progressive">Progressive (Easy to Hard)</option>
                                <option value="uniform">Uniform Difficulty</option>
                                <option value="challenging">Challenging Questions Only</option>
                                <option value="certification">Certification/Exam Simulation</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="assess-questions">Assessment Length:</label>
                            <select id="assess-questions">
                                <option value="10">Quick Assessment (10 questions)</option>
                                <option value="20">Standard Assessment (20 questions)</option>
                                <option value="35">Comprehensive Assessment (35 questions)</option>
                                <option value="50">Expert Certification (50 questions)</option>
                                <option value="adaptive-length">Adaptive Length (Precision-Based)</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="assess-context">Canadian Context Emphasis:</label>
                            <select id="assess-context">
                                <option value="high">High (50%+ Canadian content)</option>
                                <option value="moderate">Moderate (25% Canadian content)</option>
                                <option value="light">Light (10% Canadian content)</option>
                                <option value="international">International Perspective</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="assess-timing">Assessment Timing:</label>
                            <select id="assess-timing">
                                <option value="unlimited">Unlimited Time (Learning Mode)</option>
                                <option value="generous">Generous Time (150% standard)</option>
                                <option value="standard">Standard Time (3 min/question)</option>
                                <option value="exam">Exam Conditions (2 min/question)</option>
                                <option value="rapid">Rapid Assessment (90 sec/question)</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="assess-feedback">Feedback Type:</label>
                            <select id="assess-feedback">
                                <option value="detailed">Detailed Explanations + Learning Resources</option>
                                <option value="standard">Standard Answer Explanations</option>
                                <option value="minimal">Correct Answer Only</option>
                                <option value="delayed">Performance Summary Only (Post-Assessment)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn" onclick="generateAdvancedAssessment()">üöÄ Generate Advanced Assessment</button>
                    </div>
                </div>
            </div>

            <!-- Performance Analysis Card -->
            <div id="assessment-results-card" class="card-content">
                <div id="assessment-performance-results" class="results-container" style="display: none;">
                    <!-- Performance analysis will be populated by JavaScript -->
                </div>
                <div id="assessment-results-placeholder" style="text-align: center; padding: 3rem; color: #5a7c5a;">
                    <h3>üìä Assessment performance analysis will appear here</h3>
                    <p>Complete an assessment to see detailed competency analysis and professional development recommendations.</p>
                    <p><strong>Performance Metrics:</strong> Skill competency mapping, benchmarking, learning gap analysis, Canadian health research readiness</p>
                </div>
            </div>

            <!-- Comprehensive Assessment Card -->
            <div id="assessment-assessment-card" class="card-content">
                <div id="assessment-questions" class="results-container" style="display: none;">
                    <!-- Assessment questions will be populated by JavaScript -->
                </div>
                <div id="assessment-placeholder" style="text-align: center; padding: 3rem; color: #5a7c5a;">
                    <h3>üìù Comprehensive advanced assessment will appear here</h3>
                    <p>Use the Assessment Configuration tab to customize and generate your comprehensive evaluation.</p>
                    <p><strong>Assessment Features:</strong> Multi-method integration, adaptive difficulty, Canadian healthcare context, professional certification readiness</p>
                </div>
            </div>
        </div>
        
    </div>

    <div class="footer">
        <p>&copy; 2025 Enhanced Medical Biostatistics Foundation Series | Advanced Methods & Canadian Healthcare Integration</p>
        <p>Developed for Canadian Healthcare Analytics | Foundation Tool #4 Enhanced</p>
    </div>

    <script>
        // Mathematical utility functions - must be defined first
        // Normal cumulative distribution function for p-value calculations
        function normalCDF(x) {
            // Approximation of the normal CDF using the error function
            return 0.5 * (1 + erf(x / Math.sqrt(2)));
        }

        // Error function approximation for normal CDF
        function erf(x) {
            // Abramowitz and Stegun approximation
            const a1 =  0.254829592;
            const a2 = -0.284496736;
            const a3 =  1.421413741;
            const a4 = -1.453152027;
            const a5 =  1.061405429;
            const p  =  0.3275911;

            const sign = x < 0 ? -1 : 1;
            x = Math.abs(x);

            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);

            return sign * y;
        }

        let currentChart = null;
        let currentData = {};

        // Navigation functionality
        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all cards
            const cards = document.querySelectorAll('.methodology-card');
            cards.forEach(card => {
                card.classList.remove('active');
            });

            // Show selected section
            const selectedSection = document.getElementById(sectionName + '-section');
            if (selectedSection) {
                selectedSection.classList.add('active');
                
                // Only show card navigation for sections that have it implemented
                const sectionsWithCards = ['classical-regression', 'regularized-regression', 'mixed-effects', 'propensity-score', 'instrumental-variables', 'canadian-integration', 'real-world-applications', 'assessment'];
                const cleanSectionName = sectionName.replace('-section', '');
                
                if (sectionsWithCards.includes(cleanSectionName)) {
                    // Show the first card (theory) by default for sections with card navigation
                    showCard(cleanSectionName, 'theory');
                }
            }

            // Add active class to clicked card
            if (typeof event !== 'undefined' && event && event.target) {
                const targetCard = event.target.closest('.methodology-card');
                if (targetCard) {
                    targetCard.classList.add('active');
                }
            }
        }

        // Card navigation within sections
        function showCard(section, cardType, clickedElement) {
            console.log(`Switching to ${section}-${cardType} card`);
            
            // Check if the card exists first
            const selectedCard = document.getElementById(`${section}-${cardType}-card`);
            if (!selectedCard) {
                console.log(`Card navigation not implemented yet for section: ${section}`);
                return;
            }
            
            // Hide all cards in the section
            const sectionCards = document.querySelectorAll(`[id^="${section}-"][id$="-card"]`);
            sectionCards.forEach(card => {
                card.classList.remove('active');
            });

            // Remove active class from all navigation cards in this section
            const sectionElement = document.getElementById(`${section}-regression-section`) || document.getElementById(`${section}-section`);
            if (sectionElement) {
                const navCards = sectionElement.querySelectorAll('.methodology-card');
                navCards.forEach(card => {
                    card.classList.remove('active');
                });
            }

            // Show selected card
            selectedCard.classList.add('active');
            console.log(`Activated card: ${section}-${cardType}-card`);

            // Add active class to clicked navigation card
            if (clickedElement && clickedElement.classList) {
                clickedElement.classList.add('active');
            } else if (typeof event !== 'undefined' && event && event.target) {
                const targetCard = event.target.closest('.methodology-card');
                if (targetCard) {
                    targetCard.classList.add('active');
                }
            } else {
                // Programmatic call - find and activate the appropriate navigation card
                if (sectionElement) {
                    const navCards = sectionElement.querySelectorAll('.methodology-card');
                    navCards.forEach((navCard, index) => {
                        const cardTypes = ['theory', 'modeling', 'results', 'assessment'];
                        const cardIndex = cardTypes.indexOf(cardType);
                        if (index === cardIndex && cardIndex !== -1) {
                            navCard.classList.add('active');
                        }
                    });
                }
            }
        }

        // Classical Regression Implementation
        function runClassicalRegression() {
            console.log('üöÄ Running Classical Multiple Regression Analysis...');
            
            try {
                const outcome = document.getElementById('classical-outcome').value;
                const sampleSize = parseInt(document.getElementById('classical-sample-size').value);
                const numPredictors = parseInt(document.getElementById('classical-predictors').value);
                const interactions = document.getElementById('classical-interactions').value;
                const province = document.getElementById('classical-province').value;
                const complexity = parseInt(document.getElementById('classical-complexity').value);

                // Generate synthetic healthcare data
                const data = generateCanadianHealthcareData(outcome, sampleSize, numPredictors, province);
                
                // Run multiple regression analysis
                const regressionResults = performMultipleRegression(data, interactions, complexity);
                
                // Display results
                displayClassicalResults(outcome, province, regressionResults, data);
                
                console.log('‚úÖ Classical regression analysis completed successfully');

            } catch (error) {
                console.error('‚ùå Error in classical regression:', error);
                displayError('classical-results', 'Classical regression analysis failed: ' + error.message);
            }
        }

        function generateCanadianHealthcareData(outcome, sampleSize, numPredictors, province) {
            console.log(`üìä Generating Canadian healthcare data for ${outcome} in ${province}...`);
            
            const data = {
                outcome: [],
                predictors: {},
                provinceData: getProvinceCharacteristics(province),
                outcomeInfo: getOutcomeCharacteristics(outcome)
            };

            // Define predictor names based on outcome
            const predictorNames = {
                'cvd-risk': ['age', 'bmi', 'systolic_bp', 'cholesterol', 'smoking', 'diabetes'],
                'hospital-readmission': ['age', 'comorbidities', 'los_initial', 'discharge_location', 'medication_count', 'social_support'],
                'diabetes-control': ['age', 'duration_diabetes', 'medication_adherence', 'bmi', 'exercise_frequency', 'education_level'],
                'medication-adherence': ['age', 'pill_burden', 'cognitive_status', 'insurance_coverage', 'pharmacy_access', 'caregiver_support'],
                'quality-life': ['age', 'chronic_conditions', 'pain_level', 'functional_status', 'social_connections', 'mental_health']
            };

            const selectedPredictors = predictorNames[outcome] || predictorNames['cvd-risk'];
            
            // Initialize predictor arrays
            selectedPredictors.slice(0, numPredictors).forEach(pred => {
                data.predictors[pred] = [];
            });

            // Generate data points
            for (let i = 0; i < sampleSize; i++) {
                // Generate predictor values
                Object.keys(data.predictors).forEach(pred => {
                    data.predictors[pred][i] = generatePredictorValue(pred, province);
                });

                // Generate outcome value based on predictors
                data.outcome[i] = generateOutcomeValue(outcome, data.predictors, i, province);
            }

            return data;
        }

        function generatePredictorValue(predictor, province) {
            // Canadian-specific adjustments
            const provinceAdjustments = {
                'ontario': { age: 1.02, bmi: 1.05, income: 1.1 },
                'quebec': { age: 0.98, bmi: 0.95, income: 0.95 },
                'bc': { age: 1.03, bmi: 0.98, income: 1.15 },
                'alberta': { age: 0.96, bmi: 1.02, income: 1.2 },
                'multi-province': { age: 1.0, bmi: 1.0, income: 1.0 }
            };

            const adj = provinceAdjustments[province] || provinceAdjustments['multi-province'];

            switch (predictor) {
                case 'age':
                    return Math.max(18, Math.min(95, Math.random() * 60 + 35)) * (adj.age || 1);
                case 'bmi':
                    return Math.max(15, Math.min(50, Math.random() * 15 + 22)) * (adj.bmi || 1);
                case 'systolic_bp':
                    return Math.max(90, Math.min(200, Math.random() * 40 + 120));
                case 'cholesterol':
                    return Math.max(3.0, Math.min(8.0, Math.random() * 2 + 4));
                case 'smoking':
                    return Math.random() < 0.15 ? 1 : 0; // 15% smoking rate in Canada
                case 'diabetes':
                    return Math.random() < 0.08 ? 1 : 0; // 8% diabetes rate
                case 'comorbidities':
                    return Math.floor(Math.random() * 8);
                case 'los_initial':
                    return Math.max(1, Math.floor(Math.random() * 14) + 1);
                case 'medication_count':
                    return Math.floor(Math.random() * 15) + 1;
                case 'pill_burden':
                    return Math.floor(Math.random() * 20) + 1;
                case 'pain_level':
                    return Math.floor(Math.random() * 11); // 0-10 scale
                default:
                    return Math.random() * 100;
            }
        }

        function generateOutcomeValue(outcome, predictors, index, province) {
            let baseValue = 0;
            const noise = (Math.random() - 0.5) * 2; // Random noise
            
            // Provincial health system effects
            const provincialEffects = {
                'ontario': 0.02,
                'quebec': -0.01,
                'bc': 0.03,
                'alberta': 0.01,
                'multi-province': 0
            };

            const provincialEffect = provincialEffects[province] || 0;

            switch (outcome) {
                case 'cvd-risk':
                    // CVD risk score (0-1)
                    baseValue = 0.1 + 
                        (predictors['age'][index] - 50) * 0.002 +
                        (predictors['bmi'][index] - 25) * 0.01 +
                        (predictors['systolic_bp'][index] - 120) * 0.001 +
                        (predictors['cholesterol'][index] - 5) * 0.05 +
                        predictors['smoking'][index] * 0.1 +
                        predictors['diabetes'][index] * 0.15 +
                        provincialEffect;
                    return Math.max(0, Math.min(1, baseValue + noise * 0.1));
                
                case 'hospital-readmission':
                    // 30-day readmission probability (0-1)
                    baseValue = 0.05 +
                        (predictors['age'][index] - 65) * 0.001 +
                        predictors['comorbidities'][index] * 0.02 +
                        (predictors['los_initial'][index] - 5) * 0.005 +
                        (predictors['medication_count'][index] - 8) * 0.003 +
                        provincialEffect;
                    return Math.max(0, Math.min(1, baseValue + noise * 0.05));
                
                case 'diabetes-control':
                    // HbA1c level
                    baseValue = 7.0 +
                        (predictors['age'][index] - 55) * 0.005 +
                        (predictors['bmi'][index] - 28) * 0.02 +
                        (1 - predictors['medication_adherence'][index] / 100) * 2 +
                        provincialEffect;
                    return Math.max(5.5, Math.min(12, baseValue + noise * 0.3));
                
                default:
                    return Math.random() * 100 + noise * 10;
            }
        }

        function performMultipleRegression(data, interactions, complexity) {
            console.log('üìà Performing multiple regression analysis...');
            
            const results = {
                coefficients: {},
                rSquared: 0,
                adjustedRSquared: 0,
                fStatistic: 0,
                pValue: 0,
                residuals: [],
                standardErrors: {},
                tStatistics: {},
                pValues: {},
                confidenceIntervals: {},
                vifValues: {},
                diagnostics: {}
            };

            // Calculate basic regression metrics
            const predictorNames = Object.keys(data.predictors);
            const n = data.outcome.length;
            const k = predictorNames.length;

            // Calculate means
            const meanY = data.outcome.reduce((a, b) => a + b, 0) / n;
            const meanX = {};
            predictorNames.forEach(pred => {
                meanX[pred] = data.predictors[pred].reduce((a, b) => a + b, 0) / n;
            });

            // Calculate coefficients (simplified OLS)
            predictorNames.forEach(pred => {
                const numerator = data.predictors[pred].reduce((sum, x, i) => {
                    return sum + (x - meanX[pred]) * (data.outcome[i] - meanY);
                }, 0);
                
                const denominator = data.predictors[pred].reduce((sum, x) => {
                    return sum + Math.pow(x - meanX[pred], 2);
                }, 0);
                
                results.coefficients[pred] = numerator / denominator;
                results.standardErrors[pred] = Math.random() * 0.1 + 0.05; // Simplified
                results.tStatistics[pred] = results.coefficients[pred] / results.standardErrors[pred];
                results.pValues[pred] = 2 * (1 - normalCDF(Math.abs(results.tStatistics[pred])));
                
                // 95% confidence intervals
                const margin = 1.96 * results.standardErrors[pred];
                results.confidenceIntervals[pred] = [
                    results.coefficients[pred] - margin,
                    results.coefficients[pred] + margin
                ];
                
                // VIF values (simplified)
                results.vifValues[pred] = 1 + Math.random() * 2;
            });

            // Calculate R-squared
            const totalSumSquares = data.outcome.reduce((sum, y) => {
                return sum + Math.pow(y - meanY, 2);
            }, 0);

            // Generate predicted values and residuals
            for (let i = 0; i < n; i++) {
                let predicted = 0;
                predictorNames.forEach(pred => {
                    predicted += results.coefficients[pred] * data.predictors[pred][i];
                });
                results.residuals[i] = data.outcome[i] - predicted;
            }

            const residualSumSquares = results.residuals.reduce((sum, r) => sum + r * r, 0);
            results.rSquared = 1 - (residualSumSquares / totalSumSquares);
            results.adjustedRSquared = 1 - ((1 - results.rSquared) * (n - 1) / (n - k - 1));

            // F-statistic
            results.fStatistic = (results.rSquared / k) / ((1 - results.rSquared) / (n - k - 1));
            results.pValue = 1 - fCDF(results.fStatistic, k, n - k - 1);

            return results;
        }

        function displayClassicalResults(outcome, province, results, data) {
            const outcomeInfo = getOutcomeCharacteristics(outcome);
            const provinceInfo = getProvinceCharacteristics(province);
            
            // Show the results card and hide placeholder
            document.getElementById('classical-placeholder').style.display = 'none';
            document.getElementById('classical-results').style.display = 'block';
            
            // Switch to results card automatically
            showCard('classical', 'results');
            
            document.getElementById('classical-results').innerHTML = `
                <div class="results-header">
                    <h3>üìä Classical Multiple Regression Results</h3>
                    <p><strong>Outcome:</strong> ${outcomeInfo.name} | <strong>Setting:</strong> ${provinceInfo.name}</p>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${(results.rSquared * 100).toFixed(1)}%</div>
                        <div class="metric-label">R-Squared</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${(results.adjustedRSquared * 100).toFixed(1)}%</div>
                        <div class="metric-label">Adjusted R-Squared</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.fStatistic.toFixed(2)}</div>
                        <div class="metric-label">F-Statistic</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.pValue < 0.001 ? '<0.001' : results.pValue.toFixed(3)}</div>
                        <div class="metric-label">P-Value</div>
                    </div>
                </div>

                <h4>Regression Coefficients</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Predictor</th>
                            <th>Coefficient</th>
                            <th>Std Error</th>
                            <th>t-Statistic</th>
                            <th>P-Value</th>
                            <th>95% CI</th>
                            <th>VIF</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.keys(results.coefficients).map(pred => `
                            <tr>
                                <td><strong>${formatPredictorName(pred)}</strong></td>
                                <td>${results.coefficients[pred].toFixed(4)}</td>
                                <td>${results.standardErrors[pred].toFixed(4)}</td>
                                <td>${results.tStatistics[pred].toFixed(2)}</td>
                                <td>${results.pValues[pred] < 0.001 ? '<0.001' : results.pValues[pred].toFixed(3)}</td>
                                <td>[${results.confidenceIntervals[pred][0].toFixed(3)}, ${results.confidenceIntervals[pred][1].toFixed(3)}]</td>
                                <td class="${results.vifValues[pred] > 5 ? 'highlight' : ''}">${results.vifValues[pred].toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <div class="chart-container">
                    <h4>Model Visualization</h4>
                    <div class="chart-wrapper">
                        <canvas id="classicalRegressionChart"></canvas>
                    </div>
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ ${provinceInfo.name} Healthcare Context</h4>
                    <p><strong>Healthcare System:</strong> ${provinceInfo.system}</p>
                    <p><strong>Population:</strong> ${provinceInfo.population}</p>
                    <p><strong>Model Application:</strong> ${provinceInfo.application}</p>
                    <p><strong>Regulatory Considerations:</strong> ${provinceInfo.regulatory}</p>
                </div>

                <div class="regulatory-box">
                    <h4>üèõÔ∏è Health Canada Regulatory Implications</h4>
                    <p><strong>Model Validation:</strong> ${getValidationRequirements(outcome)}</p>
                    <p><strong>Evidence Standards:</strong> ${getEvidenceStandards(results.pValue, results.rSquared)}</p>
                    <p><strong>Clinical Significance:</strong> ${getClinicalSignificance(outcome, results.coefficients)}</p>
                </div>

                <div class="advanced-feature">
                    <h4>‚ö° Advanced Diagnostic Summary</h4>
                    <p><strong>Multicollinearity:</strong> ${assessMulticollinearity(results.vifValues)}</p>
                    <p><strong>Model Fit:</strong> ${assessModelFit(results.rSquared, results.adjustedRSquared)}</p>
                    <p><strong>Clinical Applicability:</strong> ${assessClinicalApplicability(outcome, results)}</p>
                    <p><strong>Next Steps:</strong> ${recommendNextSteps(results)}</p>
                </div>
            `;

            // Create visualization
            createClassicalRegressionVisualization(data, results, outcome);
        }

        function createClassicalRegressionVisualization(data, results, outcome) {
            const ctx = document.getElementById('classicalRegressionChart');
            if (!ctx) return;

            // Create a simple scatter plot with regression line
            const predictorNames = Object.keys(results.coefficients);
            const firstPredictor = predictorNames[0];
            
            // Generate points for visualization
            const points = [];
            for (let i = 0; i < Math.min(100, data.outcome.length); i++) {
                points.push({
                    x: data.predictors[firstPredictor][i],
                    y: data.outcome[i]
                });
            }

            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: `${formatPredictorName(firstPredictor)} vs ${outcome}`,
                        data: points,
                        backgroundColor: 'rgba(34, 139, 34, 0.6)',
                        borderColor: 'rgba(34, 139, 34, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: formatPredictorName(firstPredictor)
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: getOutcomeCharacteristics(outcome).name
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Multiple Regression: ${getOutcomeCharacteristics(outcome).name}`
                        }
                    }
                }
            });
        }

        // Assessment generation for classical regression
        function generateClassicalAssessment() {
            // Comprehensive question pool covering all concepts
            const questionPools = {
                confounding: [
                    {
                        question: "In a Canadian multi-provincial study of hospital readmission rates, which variable would be considered a confounder when examining the relationship between hospital size and readmission rates?",
                        options: [
                            "A) Patient age (affects both hospital choice and readmission risk)",
                            "B) Hospital location (urban vs rural)", 
                            "C) Number of hospital beds",
                            "D) Hospital administrative costs"
                        ],
                        correct: "A",
                        explanation: "Age is a confounder because it influences both where patients seek care (hospital size) and their likelihood of readmission."
                    },
                    {
                        question: "When controlling for confounding in observational health studies, you should include variables that:",
                        options: [
                            "A) Are significantly correlated with the outcome only",
                            "B) Are significantly correlated with the exposure only",
                            "C) Are associated with both exposure and outcome",
                            "D) Have the highest p-values in univariate analysis"
                        ],
                        correct: "C",
                        explanation: "True confounders must be associated with both the exposure and outcome to create bias that needs adjustment."
                    },
                    {
                        question: "In a study comparing OHIP vs RAMQ patient outcomes, which represents residual confounding?",
                        options: [
                            "A) Unmeasured socioeconomic factors that vary by province",
                            "B) Patient age differences between provinces", 
                            "C) Different coding practices between health systems",
                            "D) Measured comorbidity differences"
                        ],
                        correct: "A",
                        explanation: "Residual confounding occurs when important confounders are unmeasured or imperfectly measured."
                    }
                ],
                interactions: [
                    {
                        question: "In a model: Outcome = Œ≤‚ÇÄ + Œ≤‚ÇÅ(Age) + Œ≤‚ÇÇ(Treatment) + Œ≤‚ÇÉ(Age √ó Treatment), what does a significant Œ≤‚ÇÉ indicate?",
                        options: [
                            "A) Age and treatment are correlated",
                            "B) Treatment effect varies by patient age",
                            "C) Age effect varies by treatment group", 
                            "D) Both B and C are correct"
                        ],
                        correct: "D",
                        explanation: "A significant interaction term indicates the effect of one variable depends on the level of another - works both ways."
                    },
                    {
                        question: "In Canadian healthcare, when would you expect a Province √ó Treatment interaction?",
                        options: [
                            "A) When treatment protocols are standardized nationally",
                            "B) When treatment effectiveness varies across provincial health systems",
                            "C) When all provinces have identical patient populations",
                            "D) When treatment costs are uniform across Canada"
                        ],
                        correct: "B",
                        explanation: "Province √ó Treatment interactions occur when treatment effectiveness differs across provincial healthcare systems due to implementation or patient factors."
                    },
                    {
                        question: "If Age √ó Sex interaction is significant in a diabetes management study, how should you interpret main effects?",
                        options: [
                            "A) Interpret age and sex main effects as usual",
                            "B) Age and sex main effects represent effects when the other variable equals zero",
                            "C) Ignore main effects and focus only on interaction",
                            "D) Main effects represent average effects across all groups"
                        ],
                        correct: "B",
                        explanation: "With significant interactions, main effects represent conditional effects when the interacting variable equals its reference level."
                    }
                ],
                diagnostics: [
                    {
                        question: "A VIF value of 12.5 for 'previous hospitalizations' in your Canadian health model indicates:",
                        options: [
                            "A) The predictor is highly significant",
                            "B) Serious multicollinearity requiring attention",
                            "C) The model explains 85% of variance",
                            "D) Normal correlation levels"
                        ],
                        correct: "B",
                        explanation: "VIF > 10 indicates severe multicollinearity that can make coefficient estimates unstable and difficult to interpret."
                    },
                    {
                        question: "Which assumption violation would be MOST problematic for inference in a longitudinal Canadian health study?",
                        options: [
                            "A) Slight departure from normality with large sample size",
                            "B) Independence assumption violation due to repeated measures",
                            "C) Minor heteroscedasticity in residuals",
                            "D) Perfect correlation between two predictors"
                        ],
                        correct: "B",
                        explanation: "Violation of independence (e.g., from repeated measures) invalidates standard errors and p-values, requiring mixed effects models."
                    },
                    {
                        question: "In residual vs fitted plots for a hospital readmission model, what pattern suggests heteroscedasticity?",
                        options: [
                            "A) Random cloud of points around zero",
                            "B) Funnel shape with increasing variance",
                            "C) Perfect horizontal line at zero",
                            "D) Normal distribution of residuals"
                        ],
                        correct: "B",
                        explanation: "A funnel pattern indicates heteroscedasticity - variance of residuals changes with fitted values."
                    }
                ],
                canadian_applications: [
                    {
                        question: "Health Quality Ontario uses risk-adjusted models for hospital performance. What is the primary purpose of case-mix adjustment?",
                        options: [
                            "A) To increase hospital revenues",
                            "B) To account for differences in patient complexity across hospitals",
                            "C) To reduce the number of hospital beds needed",
                            "D) To standardize treatment protocols"
                        ],
                        correct: "B",
                        explanation: "Case-mix adjustment accounts for patient complexity differences so hospital comparisons are fair and not biased by patient populations served."
                    },
                    {
                        question: "CIHI's risk-adjusted mortality indicators use multiple regression to:",
                        options: [
                            "A) Predict individual patient survival",
                            "B) Compare hospital performance after accounting for patient factors",
                            "C) Determine optimal treatment protocols",
                            "D) Calculate hospital funding allocations"
                        ],
                        correct: "B",
                        explanation: "CIHI uses risk adjustment to enable fair comparisons of hospital performance by accounting for differences in patient case mix."
                    },
                    {
                        question: "In pan-Canadian health research, why might you include Province as a predictor variable?",
                        options: [
                            "A) To increase sample size",
                            "B) To account for systematic differences in healthcare delivery across provinces",
                            "C) To satisfy Health Canada requirements",
                            "D) To reduce data collection costs"
                        ],
                        correct: "B",
                        explanation: "Provincial indicators capture systematic differences in healthcare systems, policies, and population characteristics that could affect outcomes."
                    }
                ],
                model_interpretation: [
                    {
                        question: "In a cardiovascular risk model, the coefficient for 'Age' is 0.12 (p<0.001). This means:",
                        options: [
                            "A) Each year of age increases CV risk by 12%",
                            "B) Each year of age increases CV risk by 0.12 units (on the outcome scale)",
                            "C) Age explains 12% of variance in CV risk",
                            "D) The correlation between age and CV risk is 0.12"
                        ],
                        correct: "B",
                        explanation: "Regression coefficients represent the change in outcome (on its original scale) per unit change in the predictor, holding other variables constant."
                    },
                    {
                        question: "A 95% confidence interval for treatment effect is [0.05, 0.35]. What can you conclude?",
                        options: [
                            "A) The treatment effect is definitely 0.2",
                            "B) There's a 95% chance the true effect is between 0.05 and 0.35",
                            "C) The treatment has a statistically significant positive effect",
                            "D) 95% of patients will experience benefit between 0.05 and 0.35"
                        ],
                        correct: "C",
                        explanation: "Since the CI doesn't include 0, the treatment effect is statistically significant. The CI gives a range of plausible values for the true effect."
                    }
                ]
            };

            // Randomly select questions from each concept area
            const selectedQuestions = [];
            
            // Select 1-2 questions from each concept area
            Object.keys(questionPools).forEach(concept => {
                const conceptQuestions = questionPools[concept];
                const numToSelect = Math.min(2, conceptQuestions.length);
                const shuffled = [...conceptQuestions].sort(() => 0.5 - Math.random());
                selectedQuestions.push(...shuffled.slice(0, numToSelect));
            });

            // Shuffle the final selection
            const finalQuestions = selectedQuestions.sort(() => 0.5 - Math.random()).slice(0, 8); // Take 8 questions total

            document.getElementById('classical-assessment-questions').style.display = 'block';
            document.getElementById('classical-assessment-questions').innerHTML = `
                <h4>üìù Classical Multiple Regression Assessment</h4>
                <p><strong>Instructions:</strong> This assessment covers confounding control, interactions, model diagnostics, and Canadian healthcare applications. You need 70% to pass.</p>
                
                ${finalQuestions.map((q, index) => `
                    <div class="theory-card" style="margin: 1.5rem 0;">
                        <h5>Question ${index + 1}</h5>
                        <p><strong>${q.question}</strong></p>
                        <div style="margin: 1rem 0;">
                            ${q.options.map(option => `
                                <label style="display: block; margin: 0.5rem 0; cursor: pointer;">
                                    <input type="radio" name="classical_q${index + 1}" value="${option.charAt(0)}" style="margin-right: 0.5rem;">
                                    ${option}
                                </label>
                            `).join('')}
                        </div>
                        <div class="question-explanation" id="classical_explanation_${index + 1}" style="display: none; background: #e8f8e8; padding: 1rem; margin-top: 1rem; border-radius: 8px;">
                            <strong>Correct Answer:</strong> ${q.correct})<br>
                            <strong>Explanation:</strong> ${q.explanation}
                        </div>
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="gradeClassicalAssessment()">üìä Check Answers</button>
                    <button class="btn" onclick="showClassicalAnswers()" style="margin-left: 1rem; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);">üëÅÔ∏è Show All Answers</button>
                    <button class="btn" onclick="generateClassicalAssessment()" style="margin-left: 1rem; background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);">üîÑ Generate New Questions</button>
                </div>
                
                <div id="classical-assessment-results" style="display: none;">
                    <!-- Results will be shown here -->
                </div>
            `;

            // Store the correct answers globally for grading
            window.classicalAssessmentAnswers = finalQuestions.map(q => q.correct);
        }

        function gradeClassicalAssessment() {
            const correctAnswers = window.classicalAssessmentAnswers || [];
            let score = 0;
            const totalQuestions = correctAnswers.length;
            
            for (let i = 1; i <= totalQuestions; i++) {
                const selected = document.querySelector(`input[name="classical_q${i}"]:checked`);
                if (selected && selected.value === correctAnswers[i-1]) {
                    score++;
                }
            }
            
            const percentage = (score / totalQuestions) * 100;
            const passed = percentage >= 70;
            
            document.getElementById('classical-assessment-results').style.display = 'block';
            document.getElementById('classical-assessment-results').innerHTML = `
                <div class="results-header">
                    <h4>üìä Classical Regression Assessment Results</h4>
                    <p><strong>Score:</strong> ${score}/${totalQuestions} (${percentage.toFixed(1)}%) | <strong>Status:</strong> ${passed ? '‚úÖ Passed' : '‚ùå Needs Improvement'}</p>
                </div>
                
                <div class="canadian-highlight">
                    <h4>üá®üá¶ Canadian Healthcare Analytics Competency</h4>
                    <p><strong>Performance Level:</strong> ${percentage >= 90 ? 'Expert - Ready for complex multi-provincial studies' : percentage >= 80 ? 'Advanced - Ready for clinical research applications' : percentage >= 70 ? 'Competent - Solid foundation in regression analysis' : 'Developing - Review core concepts and practice'}</p>
                    
                    <h5>Concept Mastery Assessment:</h5>
                    <div class="theory-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Confounding Control</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Interaction Analysis</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Model Diagnostics</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Canadian Applications</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                    </div>
                    
                    <p><strong>Next Steps:</strong> ${
                        percentage >= 85 ? 'Ready for advanced methods like mixed effects models and causal inference techniques.' :
                        percentage >= 70 ? 'Continue with regularized regression and consider reviewing interaction interpretation.' :
                        'Focus on understanding confounding and model assumptions before proceeding to advanced methods.'
                    }</p>
                </div>
            `;
        }

        function showClassicalAnswers() {
            const totalQuestions = window.classicalAssessmentAnswers ? window.classicalAssessmentAnswers.length : 5;
            for (let i = 1; i <= totalQuestions; i++) {
                const explanationDiv = document.getElementById(`classical_explanation_${i}`);
                if (explanationDiv) {
                    explanationDiv.style.display = 'block';
                }
            }
        }

        // Assessment generation for regularized regression
        function generateRegularizedAssessment() {
            // Comprehensive question pool covering all regularization concepts
            const questionPools = {
                feature_selection: [
                    {
                        question: "In Lasso regression for Canadian genomic studies, which statement about feature selection is CORRECT?",
                        options: [
                            "A) Lasso always selects more features than Ridge regression",
                            "B) Lasso sets some coefficients to exactly zero, providing automatic feature selection", 
                            "C) Lasso cannot handle correlated features in genomic data",
                            "D) Lasso regularization parameter Œª should always be set to 1.0"
                        ],
                        correct: "B",
                        explanation: "Lasso's L1 penalty creates exact sparsity by setting coefficients to zero, automatically selecting relevant features."
                    },
                    {
                        question: "In a Canadian biomarker discovery study with 10,000 protein markers, you want to identify the 20 most important. Which method is MOST appropriate?",
                        options: [
                            "A) Ridge regression (will include all markers with small coefficients)",
                            "B) Lasso regression (will select a sparse subset automatically)",
                            "C) Ordinary least squares (will give unbiased estimates)",
                            "D) Forward stepwise selection (more reliable than Lasso)"
                        ],
                        correct: "B",
                        explanation: "Lasso is specifically designed for sparse feature selection in high-dimensional settings like biomarker discovery."
                    },
                    {
                        question: "When using Lasso for feature selection in EHR mining, why might you prefer Adaptive Lasso?",
                        options: [
                            "A) It's always faster to compute",
                            "B) It provides better feature selection consistency by using data-driven weights",
                            "C) It doesn't require cross-validation",
                            "D) It works only with Canadian health data"
                        ],
                        correct: "B",
                        explanation: "Adaptive Lasso uses initial coefficient estimates to weight the penalty, leading to better selection consistency and reduced bias for important features."
                    }
                ],
                regularization_methods: [
                    {
                        question: "When analyzing multi-omics data from Canadian Precision Medicine initiatives, what is the main advantage of Elastic Net over pure Lasso?",
                        options: [
                            "A) Elastic Net is always faster to compute",
                            "B) Elastic Net can select groups of correlated features together",
                            "C) Elastic Net never requires cross-validation",
                            "D) Elastic Net only works with Canadian population data"
                        ],
                        correct: "B",
                        explanation: "Elastic Net combines L1 and L2 penalties, allowing selection of correlated feature groups, crucial for multi-omics where features are naturally correlated."
                    },
                    {
                        question: "Ridge regression shrinks coefficients toward zero but never sets them exactly to zero. This property is MOST problematic when:",
                        options: [
                            "A) Working with Canadian administrative health data",
                            "B) You need to identify a small number of key biomarkers for clinical decision-making",
                            "C) Sample size is smaller than number of predictors",
                            "D) Predictors are highly correlated"
                        ],
                        correct: "B",
                        explanation: "When clinical interpretability requires identifying specific key biomarkers, Ridge's inability to exclude irrelevant features is problematic - Lasso would be preferred."
                    },
                    {
                        question: "In a genomics study with highly correlated SNPs, which regularization approach would you choose?",
                        options: [
                            "A) Lasso (selects one SNP from correlated groups randomly)",
                            "B) Ridge (includes all SNPs with similar small coefficients)", 
                            "C) Elastic Net (balances selection with grouping effects)",
                            "D) No regularization (OLS is unbiased)"
                        ],
                        correct: "C",
                        explanation: "Elastic Net handles correlated features better than Lasso by including groups of correlated predictors, while still providing sparsity."
                    }
                ],
                cross_validation: [
                    {
                        question: "In high-dimensional EHR mining with 5000+ features from CIHI data, which cross-validation strategy is MOST appropriate for regularization parameter selection?",
                        options: [
                            "A) Leave-one-out cross-validation for maximum precision",
                            "B) 10-fold cross-validation with stratified sampling by province",
                            "C) No cross-validation needed - use default Œª = 0.1", 
                            "D) Single train-test split to save computational time"
                        ],
                        correct: "B",
                        explanation: "10-fold CV with stratification ensures robust Œª selection while maintaining computational efficiency and representing Canadian population diversity."
                    },
                    {
                        question: "When using nested cross-validation for hyperparameter tuning in Canadian genomics studies, what does the outer CV loop estimate?",
                        options: [
                            "A) The optimal Œª parameter",
                            "B) Feature selection stability",
                            "C) Unbiased generalization performance of the entire modeling pipeline",
                            "D) The number of relevant genomic features"
                        ],
                        correct: "C",
                        explanation: "Outer CV provides unbiased performance estimates by treating hyperparameter selection as part of the modeling pipeline."
                    },
                    {
                        question: "In time series health data, why is standard k-fold CV inappropriate for tuning regularization parameters?",
                        options: [
                            "A) It's computationally too expensive",
                            "B) It violates temporal order and creates data leakage",
                            "C) Regularization doesn't work with time series",
                            "D) Canadian health data requires special CV methods"
                        ],
                        correct: "B",
                        explanation: "Random CV folds violate temporal order, using future data to predict past outcomes, creating unrealistic performance estimates."
                    }
                ],
                high_dimensional: [
                    {
                        question: "In a Canadian multi-site genomics study, your Lasso model selects 50 SNPs out of 500,000. What is the sparsity level?",
                        options: [
                            "A) 0.01% (very sparse model)",
                            "B) 10% (moderately sparse)", 
                            "C) 99.99% (extremely sparse model)",
                            "D) 50% (balanced selection)"
                        ],
                        correct: "C",
                        explanation: "Sparsity = (unselected features / total features) √ó 100% = (499,950 / 500,000) √ó 100% = 99.99%"
                    },
                    {
                        question: "When working with high-dimensional Canadian health data (p >> n), why is regularization essential?",
                        options: [
                            "A) To reduce computational costs only",
                            "B) To prevent overfitting and enable model estimation when p > n",
                            "C) To satisfy Health Canada regulatory requirements",
                            "D) To ensure all features have positive coefficients"
                        ],
                        correct: "B",
                        explanation: "When features exceed samples, OLS cannot be estimated. Regularization provides a unique solution and prevents overfitting."
                    },
                    {
                        question: "In pharmacogenomics studies using Canadian population data, what's a key consideration for feature selection?",
                        options: [
                            "A) Select the maximum number of features possible",
                            "B) Focus only on previously validated genetic variants",
                            "C) Balance statistical significance with clinical interpretability and replication",
                            "D) Ignore population ancestry differences"
                        ],
                        correct: "C",
                        explanation: "Clinical translation requires balancing statistical evidence with biological plausibility and replication across populations."
                    }
                ],
                canadian_precision_medicine: [
                    {
                        question: "The Canadian Partnership for Personalized Medicine uses regularized models for treatment response prediction. What's a key advantage over traditional approaches?",
                        options: [
                            "A) Lower computational costs",
                            "B) Ability to integrate high-dimensional omics data with clinical variables",
                            "C) Guaranteed causal inference",
                            "D) Elimination of population stratification needs"
                        ],
                        correct: "B",
                        explanation: "Regularized methods excel at handling high-dimensional genomic/molecular data while incorporating traditional clinical predictors."
                    },
                    {
                        question: "When developing precision medicine models for Health Canada submission, which validation strategy is MOST important?",
                        options: [
                            "A) Internal cross-validation only",
                            "B) External validation in independent Canadian patient populations",
                            "C) Validation in international populations only",
                            "D) Theoretical validation based on biological knowledge"
                        ],
                        correct: "B",
                        explanation: "External validation in independent Canadian populations demonstrates generalizability to the target healthcare setting."
                    }
                ]
            };

            // Randomly select questions from each concept area
            const selectedQuestions = [];
            
            // Select 1-2 questions from each concept area
            Object.keys(questionPools).forEach(concept => {
                const conceptQuestions = questionPools[concept];
                const numToSelect = Math.min(2, conceptQuestions.length);
                const shuffled = [...conceptQuestions].sort(() => 0.5 - Math.random());
                selectedQuestions.push(...shuffled.slice(0, numToSelect));
            });

            // Shuffle the final selection and take 8 questions
            const finalQuestions = selectedQuestions.sort(() => 0.5 - Math.random()).slice(0, 8);

            document.getElementById('regularized-assessment-questions').style.display = 'block';
            document.getElementById('regularized-assessment-questions').innerHTML = `
                <h4>üìù Regularization Methods Assessment</h4>
                <p><strong>Instructions:</strong> This assessment covers feature selection, regularization methods, cross-validation, high-dimensional data, and Canadian precision medicine applications. You need 70% to pass.</p>
                
                ${finalQuestions.map((q, index) => `
                    <div class="theory-card" style="margin: 1.5rem 0;">
                        <h5>Question ${index + 1}</h5>
                        <p><strong>${q.question}</strong></p>
                        <div style="margin: 1rem 0;">
                            ${q.options.map(option => `
                                <label style="display: block; margin: 0.5rem 0; cursor: pointer;">
                                    <input type="radio" name="reg_q${index + 1}" value="${option.charAt(0)}" style="margin-right: 0.5rem;">
                                    ${option}
                                </label>
                            `).join('')}
                        </div>
                        <div class="question-explanation" id="reg_explanation_${index + 1}" style="display: none; background: #e8f8e8; padding: 1rem; margin-top: 1rem; border-radius: 8px;">
                            <strong>Correct Answer:</strong> ${q.correct})<br>
                            <strong>Explanation:</strong> ${q.explanation}
                        </div>
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="gradeRegularizedAssessment()">üìä Check Answers</button>
                    <button class="btn" onclick="showRegularizedAnswers()" style="margin-left: 1rem; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);">üëÅÔ∏è Show All Answers</button>
                    <button class="btn" onclick="generateRegularizedAssessment()" style="margin-left: 1rem; background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);">üîÑ Generate New Questions</button>
                </div>
                
                <div id="regularized-assessment-results" style="display: none;">
                    <!-- Results will be shown here -->
                </div>
            `;

            // Store the correct answers globally for grading
            window.regularizedAssessmentAnswers = finalQuestions.map(q => q.correct);
        }

        function gradeRegularizedAssessment() {
            const correctAnswers = window.regularizedAssessmentAnswers || [];
            let score = 0;
            const totalQuestions = correctAnswers.length;
            
            for (let i = 1; i <= totalQuestions; i++) {
                const selected = document.querySelector(`input[name="reg_q${i}"]:checked`);
                if (selected && selected.value === correctAnswers[i-1]) {
                    score++;
                }
            }
            
            const percentage = (score / totalQuestions) * 100;
            const passed = percentage >= 70;
            
            document.getElementById('regularized-assessment-results').style.display = 'block';
            document.getElementById('regularized-assessment-results').innerHTML = `
                <div class="results-header">
                    <h4>üìä Regularization Assessment Results</h4>
                    <p><strong>Score:</strong> ${score}/${totalQuestions} (${percentage.toFixed(1)}%) | <strong>Status:</strong> ${passed ? '‚úÖ Passed' : '‚ùå Needs Improvement'}</p>
                </div>
                
                <div class="canadian-highlight">
                    <h4>üá®üá¶ Canadian Precision Medicine Competency</h4>
                    <p><strong>Performance Level:</strong> ${percentage >= 90 ? 'Expert - Ready for genomics and precision medicine projects' : percentage >= 80 ? 'Advanced - Ready for high-dimensional biomarker discovery' : percentage >= 70 ? 'Competent - Solid foundation in regularization methods' : 'Developing - Review regularization fundamentals'}</p>
                    
                    <h5>Concept Mastery Assessment:</h5>
                    <div class="theory-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Feature Selection</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Regularization Methods</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Cross-Validation</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>High-Dimensional Data</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Precision Medicine</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                    </div>
                    
                    <p><strong>Next Steps:</strong> ${
                        percentage >= 85 ? 'Ready for advanced applications like multi-omics integration and pharmacogenomics studies.' :
                        percentage >= 70 ? 'Continue with mixed effects models and causal inference methods.' :
                        'Focus on understanding L1/L2 penalties and cross-validation before tackling high-dimensional applications.'
                    }</p>
                    
                    <p><strong>Canadian Context:</strong> ${
                        percentage >= 80 ? 'Well-prepared for Canadian precision medicine initiatives and regulatory submissions.' :
                        percentage >= 70 ? 'Good foundation - review Canadian biobank data and Health Canada guidelines.' :
                        'Study Canadian precision medicine frameworks and data governance requirements.'
                    }</p>
                </div>
            `;
        }

        function showRegularizedAnswers() {
            const totalQuestions = window.regularizedAssessmentAnswers ? window.regularizedAssessmentAnswers.length : 5;
            for (let i = 1; i <= totalQuestions; i++) {
                const explanationDiv = document.getElementById(`reg_explanation_${i}`);
                if (explanationDiv) {
                    explanationDiv.style.display = 'block';
                }
            }
        }

        // Assessment template for Mixed Effects Models (ready for implementation)
        function generateMixedEffectsAssessment() {
            // Comprehensive question pools for Mixed Effects Models
            const questionPools = {
                random_effects: [
                    {
                        question: "In a Canadian multi-provider study, an ICC of 0.15 for patient satisfaction scores means:",
                        options: [
                            "A) 15% of patients are satisfied",
                            "B) 15% of variance is due to differences between providers",
                            "C) The model explains 15% of total variance",
                            "D) 15% of providers have above-average performance"
                        ],
                        correct: "B",
                        explanation: "ICC represents the proportion of total variance attributable to clustering (between-provider differences)."
                    },
                    {
                        question: "When would you use random intercepts but not random slopes in a Canadian longitudinal study?",
                        options: [
                            "A) When baseline differences exist between clinics but treatment effects are similar",
                            "B) When all clinics have identical patient populations",
                            "C) When you want to model individual patient trajectories",
                            "D) When there are no clustering effects"
                        ],
                        correct: "A",
                        explanation: "Random intercepts capture baseline differences between clusters when slopes (treatment effects) are assumed constant across clusters."
                    },
                    {
                        question: "In a 3-level model (Patients ‚Üí Providers ‚Üí Hospitals), which variance component represents between-hospital variation?",
                        options: [
                            "A) Level 1 (patient-level) variance",
                            "B) Level 2 (provider-level) variance", 
                            "C) Level 3 (hospital-level) variance",
                            "D) Residual error variance"
                        ],
                        correct: "C",
                        explanation: "Level 3 variance captures variation between hospitals after accounting for provider and patient differences."
                    }
                ],
                longitudinal: [
                    {
                        question: "In longitudinal blood pressure studies across Canadian clinics, why is a mixed effects model preferred over repeated measures ANOVA?",
                        options: [
                            "A) Handles missing data naturally and allows for variable visit timing",
                            "B) Is computationally faster with large datasets",
                            "C) Provides more accurate p-values",
                            "D) Requires fewer statistical assumptions"
                        ],
                        correct: "A",
                        explanation: "Mixed effects models handle unbalanced designs, missing data, and irregular timing common in real-world longitudinal healthcare data."
                    },
                    {
                        question: "A patient's HbA1c trajectory shows random intercept = +0.8 and random slope = -0.3. This indicates:",
                        options: [
                            "A) Higher baseline HbA1c but faster improvement than average",
                            "B) Lower baseline HbA1c but slower improvement than average",
                            "C) Better than average outcomes at all timepoints",
                            "D) Worse than average outcomes at all timepoints"
                        ],
                        correct: "A",
                        explanation: "Positive intercept = higher baseline; negative slope = steeper decline (faster improvement) compared to population average."
                    },
                    {
                        question: "In a Canadian mental health study tracking depression scores, when would you include time-varying covariates?",
                        options: [
                            "A) When patient characteristics never change",
                            "B) When medication changes, life events, or treatment modifications occur during follow-up",
                            "C) When you have missing baseline data",
                            "D) When the outcome is measured at regular intervals only"
                        ],
                        correct: "B",
                        explanation: "Time-varying covariates capture changes in patient status that occur during follow-up and may influence trajectory."
                    }
                ],
                clustering_effects: [
                    {
                        question: "CIHI data shows hospital readmission rates with ICC=0.08. What does this suggest for quality improvement?",
                        options: [
                            "A) Focus only on individual patient factors",
                            "B) 8% improvement is the maximum possible",
                            "C) Hospital-level interventions could meaningfully impact readmission rates",
                            "D) Clustering should be ignored in analysis"
                        ],
                        correct: "C",
                        explanation: "ICC=0.08 indicates meaningful hospital-level clustering, suggesting hospital-level quality improvement initiatives could be effective."
                    },
                    {
                        question: "In a pan-Canadian study, you find significant random effects for provinces. This suggests:",
                        options: [
                            "A) Provincial health systems have similar performance",
                            "B) There are systematic differences between provincial healthcare delivery",
                            "C) All provinces should use identical protocols",
                            "D) Provincial variation is due to measurement error"
                        ],
                        correct: "B",
                        explanation: "Significant provincial random effects indicate systematic differences in outcomes across provincial health systems."
                    }
                ],
                model_selection: [
                    {
                        question: "Comparing nested mixed effects models for Canadian health data, which criterion is MOST appropriate?",
                        options: [
                            "A) Always use the most complex model",
                            "B) Likelihood ratio test for models with same fixed effects",
                            "C) R-squared comparison like in linear regression",
                            "D) Choose based on number of parameters only"
                        ],
                        correct: "B",
                        explanation: "For nested models with identical fixed effects, likelihood ratio tests appropriately compare random effects structures."
                    },
                    {
                        question: "When should you consider a more complex random effects structure in Canadian healthcare studies?",
                        options: [
                            "A) Always use the simplest possible model",
                            "B) When AIC/BIC support complexity and it's clinically meaningful",
                            "C) When you have unlimited computational resources",
                            "D) When sample size is small"
                        ],
                        correct: "B",
                        explanation: "Model complexity should be justified by both statistical criteria (AIC/BIC) and clinical/theoretical meaningfulness."
                    }
                ],
                canadian_applications: [
                    {
                        question: "The Canadian COVID-19 Response used mixed effects models to analyze provincial intervention effectiveness. Why was clustering important?",
                        options: [
                            "A) To increase sample size artificially",
                            "B) To account for systematic differences in provincial policies and populations",
                            "C) To reduce computational burden",
                            "D) To eliminate the need for randomization"
                        ],
                        correct: "B",
                        explanation: "Clustering accounts for systematic differences between provinces that could confound intervention effects."
                    },
                    {
                        question: "In SPOR (Strategy for Patient-Oriented Research) multi-site studies, why are site-level random effects essential?",
                        options: [
                            "A) To meet funding requirements",
                            "B) To account for site-specific implementation differences and local contexts",
                            "C) To increase statistical power",
                            "D) To reduce Type II error only"
                        ],
                        correct: "B",
                        explanation: "Site-level random effects capture implementation variations and local contexts that affect intervention effectiveness."
                    }
                ]
            };

            // Randomly select questions from each concept area
            const selectedQuestions = [];
            
            // Select 1-2 questions from each concept area
            Object.keys(questionPools).forEach(concept => {
                const conceptQuestions = questionPools[concept];
                const numToSelect = Math.min(2, conceptQuestions.length);
                const shuffled = [...conceptQuestions].sort(() => 0.5 - Math.random());
                selectedQuestions.push(...shuffled.slice(0, numToSelect));
            });

            // Shuffle the final selection and take 8 questions
            const finalQuestions = selectedQuestions.sort(() => 0.5 - Math.random()).slice(0, 8);

            document.getElementById('mixed-assessment-questions').style.display = 'block';
            document.getElementById('mixed-assessment-questions').innerHTML = `
                <h4>üìù Mixed Effects Models Assessment</h4>
                <p><strong>Instructions:</strong> This assessment covers random effects, longitudinal modeling, clustering effects, model selection, and Canadian healthcare applications. You need 70% to pass.</p>
                
                ${finalQuestions.map((q, index) => `
                    <div class="theory-card" style="margin: 1.5rem 0;">
                        <h5>Question ${index + 1}</h5>
                        <p><strong>${q.question}</strong></p>
                        <div style="margin: 1rem 0;">
                            ${q.options.map(option => `
                                <label style="display: block; margin: 0.5rem 0; cursor: pointer;">
                                    <input type="radio" name="mixed_q${index + 1}" value="${option.charAt(0)}" style="margin-right: 0.5rem;">
                                    ${option}
                                </label>
                            `).join('')}
                        </div>
                        <div class="question-explanation" id="mixed_explanation_${index + 1}" style="display: none; background: #e8f8e8; padding: 1rem; margin-top: 1rem; border-radius: 8px;">
                            <strong>Correct Answer:</strong> ${q.correct})<br>
                            <strong>Explanation:</strong> ${q.explanation}
                        </div>
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="gradeMixedEffectsAssessment()">üìä Check Answers</button>
                    <button class="btn" onclick="showMixedEffectsAnswers()" style="margin-left: 1rem; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);">üëÅÔ∏è Show All Answers</button>
                    <button class="btn" onclick="generateMixedEffectsAssessment()" style="margin-left: 1rem; background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);">üîÑ Generate New Questions</button>
                </div>
                
                <div id="mixed-assessment-results" style="display: none;">
                    <!-- Results will be shown here -->
                </div>
            `;

            // Store the correct answers globally for grading
            window.mixedEffectsAssessmentAnswers = finalQuestions.map(q => q.correct);
        }

        function gradeMixedEffectsAssessment() {
            const correctAnswers = window.mixedEffectsAssessmentAnswers || [];
            let score = 0;
            const totalQuestions = correctAnswers.length;
            
            for (let i = 1; i <= totalQuestions; i++) {
                const selected = document.querySelector(`input[name="mixed_q${i}"]:checked`);
                if (selected && selected.value === correctAnswers[i-1]) {
                    score++;
                }
            }
            
            const percentage = (score / totalQuestions) * 100;
            const passed = percentage >= 70;
            
            document.getElementById('mixed-assessment-results').style.display = 'block';
            document.getElementById('mixed-assessment-results').innerHTML = `
                <div class="results-header">
                    <h4>üìä Mixed Effects Models Assessment Results</h4>
                    <p><strong>Score:</strong> ${score}/${totalQuestions} (${percentage.toFixed(1)}%) | <strong>Status:</strong> ${passed ? '‚úÖ Passed' : '‚ùå Needs Improvement'}</p>
                </div>
                
                <div class="canadian-highlight">
                    <h4>üá®üá¶ Canadian Healthcare Hierarchical Modeling Competency</h4>
                    <p><strong>Performance Level:</strong> ${percentage >= 90 ? 'Expert - Ready for complex multi-level Canadian studies' : percentage >= 80 ? 'Advanced - Ready for longitudinal and clustered analyses' : percentage >= 70 ? 'Competent - Solid foundation in mixed effects modeling' : 'Developing - Review clustering concepts and ICC interpretation'}</p>
                    
                    <h5>Concept Mastery Assessment:</h5>
                    <div class="theory-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Random Effects</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Longitudinal Modeling</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Clustering Effects</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Model Selection</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Canadian Applications</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                    </div>
                    
                    <p><strong>Next Steps:</strong> ${
                        percentage >= 85 ? 'Ready for advanced causal inference methods and real-world applications.' :
                        percentage >= 70 ? 'Continue with propensity score methods and instrumental variables.' :
                        'Focus on understanding ICC interpretation and random effects structure before advanced methods.'
                    }</p>
                    
                    <p><strong>Canadian Research Readiness:</strong> ${
                        percentage >= 80 ? 'Well-prepared for CIHR SPOR studies and multi-site Canadian research.' :
                        percentage >= 70 ? 'Good foundation - review Canadian multi-jurisdictional study examples.' :
                        'Study Canadian healthcare hierarchical structures and clustering examples.'
                    }</p>
                </div>
            `;
        }

        function showMixedEffectsAnswers() {
            const totalQuestions = window.mixedEffectsAssessmentAnswers ? window.mixedEffectsAssessmentAnswers.length : 5;
            for (let i = 1; i <= totalQuestions; i++) {
                const explanationDiv = document.getElementById(`mixed_explanation_${i}`);
                if (explanationDiv) {
                    explanationDiv.style.display = 'block';
                }
            }
        }

        // Assessment for Propensity Score Methods
        function generatePropensityScoreAssessment() {
            // Comprehensive question pools for Propensity Score Methods
            const questionPools = {
                propensity_score_theory: [
                    {
                        question: "The propensity score P(T=1|X) represents:",
                        options: [
                            "A) The probability that treatment is effective given covariates",
                            "B) The probability of receiving treatment given observed covariates",
                            "C) The probability of a good outcome given treatment", 
                            "D) The correlation between treatment and covariates"
                        ],
                        correct: "B",
                        explanation: "Propensity score is the conditional probability of receiving treatment given observed covariates, used to balance groups."
                    },
                    {
                        question: "In Canadian observational studies, when are propensity score methods MOST needed?",
                        options: [
                            "A) When treatment assignment is completely random",
                            "B) When there are systematic differences between treated and untreated patients",
                            "C) When sample size is very large",
                            "D) When the outcome is binary"
                        ],
                        correct: "B",
                        explanation: "Propensity score methods address selection bias when treatment assignment is non-random and groups differ systematically."
                    },
                    {
                        question: "The fundamental assumption for valid propensity score analysis is:",
                        options: [
                            "A) Strong ignorability (no unmeasured confounders)",
                            "B) Linear relationship between treatment and outcome",
                            "C) Normal distribution of outcomes",
                            "D) Equal sample sizes in treatment groups"
                        ],
                        correct: "A",
                        explanation: "Strong ignorability assumes all confounders are observed and measured - violations lead to hidden bias."
                    }
                ],
                matching_vs_weighting: [
                    {
                        question: "In a Canadian drug effectiveness study with 10,000 treated and 2,000 control patients, which method would you choose?",
                        options: [
                            "A) 1:1 matching (would discard most treated patients)",
                            "B) Inverse probability weighting (retains all patients)",
                            "C) Stratification (loses power with small control group)",
                            "D) Covariate adjustment without propensity scores"
                        ],
                        correct: "B",
                        explanation: "IPW retains all patients and is efficient with unbalanced treatment groups, unlike matching which discards data."
                    },
                    {
                        question: "The main advantage of doubly robust estimation is:",
                        options: [
                            "A) It's computationally faster than other methods",
                            "B) It provides consistent estimates if either the propensity score or outcome model is correct",
                            "C) It requires fewer covariates",
                            "D) It works only with Canadian administrative data"
                        ],
                        correct: "B",
                        explanation: "Doubly robust methods provide protection against model misspecification by correctly specifying either the PS or outcome model."
                    },
                    {
                        question: "When using caliper matching in Canadian healthcare studies, a caliper of 0.2 standard deviations means:",
                        options: [
                            "A) Matches must have propensity scores within 0.2 of each other",
                            "B) Matches must have propensity scores within 0.2 standard deviations",
                            "C) 20% of patients will be matched",
                            "D) The standard error is reduced by 20%"
                        ],
                        correct: "B",
                        explanation: "Caliper matching requires matched pairs to have propensity scores within a specified standard deviation distance."
                    }
                ],
                balance_assessment: [
                    {
                        question: "Standardized mean difference (SMD) of 0.05 between treatment groups after matching indicates:",
                        options: [
                            "A) Poor balance requiring larger caliper",
                            "B) Excellent balance (SMD < 0.1 is good)",
                            "C) Statistical significance at p=0.05",
                            "D) 5% of patients are unmatched"
                        ],
                        correct: "B",
                        explanation: "SMD < 0.1 indicates good balance; SMD < 0.05 indicates excellent balance between treatment groups after adjustment."
                    },
                    {
                        question: "In overlap assessment for Canadian healthcare data, poor overlap suggests:",
                        options: [
                            "A) Perfect balance between treatment groups",
                            "B) Some patients have little chance of receiving alternative treatment",
                            "C) The propensity score model is excellent",
                            "D) No confounding bias exists"
                        ],
                        correct: "B",
                        explanation: "Poor overlap indicates some patients have very high or low probability of treatment, limiting valid comparisons."
                    },
                    {
                        question: "After propensity score matching, you should check balance by:",
                        options: [
                            "A) Testing for significance of treatment effect",
                            "B) Comparing standardized differences and variance ratios",
                            "C) Checking the R-squared of the propensity score model",
                            "D) Counting the number of matched pairs"
                        ],
                        correct: "B",
                        explanation: "Balance is assessed by comparing covariate distributions using standardized differences and variance ratios, not significance tests."
                    }
                ],
                canadian_applications: [
                    {
                        question: "ICES Ontario uses propensity score methods for drug effectiveness studies because:",
                        options: [
                            "A) Administrative data lacks randomization but has comprehensive coverage",
                            "B) It's required by Health Canada regulations",
                            "C) It reduces healthcare costs",
                            "D) It's faster than randomized trials"
                        ],
                        correct: "A",
                        explanation: "Administrative data provides large, comprehensive samples but lacks randomization, requiring PS methods to address selection bias."
                    },
                    {
                        question: "In CADTH drug reviews, when would propensity score studies be most valuable?",
                        options: [
                            "A) When high-quality RCT evidence exists",
                            "B) For rare diseases or populations excluded from trials",
                            "C) Only for generic drug approvals",
                            "D) When drugs are used exactly as in trials"
                        ],
                        correct: "B",
                        explanation: "PS studies provide real-world evidence for populations and conditions often excluded from RCTs, filling evidence gaps."
                    },
                    {
                        question: "The Canadian Network for Observational Drug Effect Studies (CNODES) uses propensity scores to:",
                        options: [
                            "A) Replace the need for clinical trials",
                            "B) Study drug safety and effectiveness in real-world Canadian populations",
                            "C) Reduce healthcare spending",
                            "D) Speed up drug approval processes"
                        ],
                        correct: "B",
                        explanation: "CNODES uses PS methods to generate real-world evidence about drug effects in diverse Canadian populations using linked data."
                    }
                ],
                causal_inference: [
                    {
                        question: "The Average Treatment Effect on the Treated (ATT) is most relevant when:",
                        options: [
                            "A) Deciding whether to approve a new treatment for general population",
                            "B) Evaluating benefit for patients who actually received the treatment",
                            "C) Calculating population-level health benefits",
                            "D) Setting healthcare policy for all Canadians"
                        ],
                        correct: "B",
                        explanation: "ATT estimates effects among those who received treatment, relevant for evaluating treatment benefit in the treated population."
                    },
                    {
                        question: "Sensitivity analysis in propensity score studies tests:",
                        options: [
                            "A) Different sample sizes",
                            "B) Alternative matching algorithms",
                            "C) Impact of potential unmeasured confounders",
                            "D) Different outcome definitions"
                        ],
                        correct: "C",
                        explanation: "Sensitivity analysis examines how robust treatment effect estimates are to potential unmeasured confounding."
                    }
                ]
            };

            // Randomly select questions from each concept area
            const selectedQuestions = [];
            
            // Select 1-2 questions from each concept area
            Object.keys(questionPools).forEach(concept => {
                const conceptQuestions = questionPools[concept];
                const numToSelect = Math.min(2, conceptQuestions.length);
                const shuffled = [...conceptQuestions].sort(() => 0.5 - Math.random());
                selectedQuestions.push(...shuffled.slice(0, numToSelect));
            });

            // Shuffle the final selection and take 8 questions
            const finalQuestions = selectedQuestions.sort(() => 0.5 - Math.random()).slice(0, 8);

            document.getElementById('propensity-score-assessment-questions').style.display = 'block';
            document.getElementById('propensity-score-assessment-questions').innerHTML = `
                <h4>üìù Propensity Score Methods Assessment</h4>
                <p><strong>Instructions:</strong> This assessment covers propensity score theory, matching vs weighting, balance assessment, Canadian applications, and causal inference. You need 70% to pass.</p>
                
                ${finalQuestions.map((q, index) => `
                    <div class="theory-card" style="margin: 1.5rem 0;">
                        <h5>Question ${index + 1}</h5>
                        <p><strong>${q.question}</strong></p>
                        <div style="margin: 1rem 0;">
                            ${q.options.map(option => `
                                <label style="display: block; margin: 0.5rem 0; cursor: pointer;">
                                    <input type="radio" name="ps_q${index + 1}" value="${option.charAt(0)}" style="margin-right: 0.5rem;">
                                    ${option}
                                </label>
                            `).join('')}
                        </div>
                        <div class="question-explanation" id="ps_explanation_${index + 1}" style="display: none; background: #e8f8e8; padding: 1rem; margin-top: 1rem; border-radius: 8px;">
                            <strong>Correct Answer:</strong> ${q.correct})<br>
                            <strong>Explanation:</strong> ${q.explanation}
                        </div>
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="gradePropensityScoreAssessment()">üìä Check Answers</button>
                    <button class="btn" onclick="showPropensityScoreAnswers()" style="margin-left: 1rem; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);">üëÅÔ∏è Show All Answers</button>
                    <button class="btn" onclick="generatePropensityScoreAssessment()" style="margin-left: 1rem; background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);">üîÑ Generate New Questions</button>
                </div>
                
                <div id="propensity-score-assessment-results" style="display: none;">
                    <!-- Results will be shown here -->
                </div>
            `;

            // Store the correct answers globally for grading
            window.propensityScoreAssessmentAnswers = finalQuestions.map(q => q.correct);
        }

        function gradePropensityScoreAssessment() {
            const correctAnswers = window.propensityScoreAssessmentAnswers || [];
            let score = 0;
            const totalQuestions = correctAnswers.length;
            
            for (let i = 1; i <= totalQuestions; i++) {
                const selected = document.querySelector(`input[name="ps_q${i}"]:checked`);
                if (selected && selected.value === correctAnswers[i-1]) {
                    score++;
                }
            }
            
            const percentage = (score / totalQuestions) * 100;
            const passed = percentage >= 70;
            
            document.getElementById('propensity-score-assessment-results').style.display = 'block';
            document.getElementById('propensity-score-assessment-results').innerHTML = `
                <div class="results-header">
                    <h4>üìä Propensity Score Assessment Results</h4>
                    <p><strong>Score:</strong> ${score}/${totalQuestions} (${percentage.toFixed(1)}%) | <strong>Status:</strong> ${passed ? '‚úÖ Passed' : '‚ùå Needs Improvement'}</p>
                </div>
                
                <div class="canadian-highlight">
                    <h4>üá®üá¶ Canadian Causal Inference Competency</h4>
                    <p><strong>Performance Level:</strong> ${percentage >= 90 ? 'Expert - Ready for complex causal inference and CADTH submissions' : percentage >= 80 ? 'Advanced - Ready for real-world evidence studies' : percentage >= 70 ? 'Competent - Solid foundation in propensity score methods' : 'Developing - Review confounding bias and balance assessment'}</p>
                    
                    <h5>Concept Mastery Assessment:</h5>
                    <div class="theory-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>PS Theory</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Matching vs Weighting</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Balance Assessment</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Canadian Applications</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Causal Inference</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                    </div>
                    
                    <p><strong>Next Steps:</strong> ${
                        percentage >= 85 ? 'Ready for instrumental variables and advanced causal methods.' :
                        percentage >= 70 ? 'Continue with instrumental variables or focus on real-world applications.' :
                        'Focus on understanding confounding bias and balance assessment before advanced methods.'
                    }</p>
                    
                    <p><strong>Canadian RWE Readiness:</strong> ${
                        percentage >= 80 ? 'Well-prepared for ICES studies, CADTH submissions, and CNODES research.' :
                        percentage >= 70 ? 'Good foundation - review Canadian administrative data applications.' :
                        'Study Canadian real-world evidence frameworks and regulatory requirements.'
                    }</p>
                </div>
            `;
        }

        function showPropensityScoreAnswers() {
            const totalQuestions = window.propensityScoreAssessmentAnswers ? window.propensityScoreAssessmentAnswers.length : 5;
            for (let i = 1; i <= totalQuestions; i++) {
                const explanationDiv = document.getElementById(`ps_explanation_${i}`);
                if (explanationDiv) {
                    explanationDiv.style.display = 'block';
                }
            }
        }

        // Function to update strength label for IV configuration
        function updateStrengthLabel(value) {
            const strengthLabel = document.getElementById('strength-label');
            if (strengthLabel) {
                if (value < 10) {
                    strengthLabel.textContent = `Weak (F = ${value})`;
                    strengthLabel.style.color = '#dc3545';
                } else if (value < 20) {
                    strengthLabel.textContent = `Moderate (F = ${value})`;
                    strengthLabel.style.color = '#ffc107';
                } else {
                    strengthLabel.textContent = `Strong (F = ${value})`;
                    strengthLabel.style.color = '#28a745';
                }
            }
        }

        // Assessment for Instrumental Variables Methods
        function generateInstrumentalVariablesAssessment() {
            // Comprehensive question pools for Instrumental Variables Methods
            const questionPools = {
                iv_assumptions: [
                    {
                        question: "The relevance assumption for instrumental variables requires that:",
                        options: [
                            "A) The instrument is correlated with the outcome",
                            "B) The instrument strongly predicts treatment assignment",
                            "C) The instrument has no effect on confounders",
                            "D) The treatment causes the outcome"
                        ],
                        correct: "B",
                        explanation: "Relevance requires the instrument to strongly predict treatment (F-stat > 10), ensuring the first stage has sufficient power."
                    },
                    {
                        question: "Violation of the exclusion restriction assumption means:",
                        options: [
                            "A) The instrument affects the outcome through pathways other than treatment",
                            "B) The instrument is weakly correlated with treatment", 
                            "C) The sample size is too small",
                            "D) There are observed confounders"
                        ],
                        correct: "A",
                        explanation: "Exclusion restriction requires the instrument affects outcome ONLY through treatment - direct effects violate this assumption."
                    },
                    {
                        question: "In a Canadian study using distance to specialist as an instrument for treatment intensity, what would violate the independence assumption?",
                        options: [
                            "A) Distance affects patient compliance",
                            "B) Rural patients have different health baseline than urban patients",
                            "C) Distance affects treatment choice",
                            "D) Specialists are located in major cities"
                        ],
                        correct: "B",
                        explanation: "Independence is violated if distance correlates with unmeasured confounders like baseline health differences between rural/urban populations."
                    }
                ],
                weak_instruments: [
                    {
                        question: "A first-stage F-statistic of 6.2 in your Canadian IV study suggests:",
                        options: [
                            "A) Excellent instrument strength", 
                            "B) Weak instrument bias concerns (F < 10)",
                            "C) Perfect identification of causal effects",
                            "D) No need for sensitivity analysis"
                        ],
                        correct: "B",
                        explanation: "F-statistic < 10 indicates weak instruments, leading to bias toward OLS estimates and large standard errors."
                    },
                    {
                        question: "Weak instrument bias in IV estimation typically:",
                        options: [
                            "A) Biases estimates toward zero",
                            "B) Biases estimates toward OLS (ordinary least squares)",
                            "C) Eliminates all confounding bias",
                            "D) Only affects standard errors, not point estimates"
                        ],
                        correct: "B",
                        explanation: "Weak instruments cause IV estimates to be biased toward confounded OLS estimates, undermining the purpose of IV analysis."
                    },
                    {
                        question: "To address weak instrument concerns in Canadian health policy studies, you should:",
                        options: [
                            "A) Ignore the F-statistic if sample size is large",
                            "B) Use LIML instead of 2SLS and conduct sensitivity analysis",
                            "C) Always use more instruments regardless of validity",
                            "D) Reduce the sample size to improve instrument strength"
                        ],
                        correct: "B",
                        explanation: "LIML is less biased with weak instruments than 2SLS, and sensitivity analysis tests robustness to instrument strength."
                    }
                ],
                mendelian_randomization: [
                    {
                        question: "In Mendelian randomization studies using Canadian biobank data, genetic variants serve as instruments because:",
                        options: [
                            "A) They are randomly distributed in the population",
                            "B) They are fixed at conception and typically unconfounded",
                            "C) They always have large effects on outcomes",
                            "D) They are easier to measure than other variables"
                        ],
                        correct: "B",
                        explanation: "Genetic variants are 'nature's randomization' - fixed at conception and typically unrelated to lifestyle/environmental confounders."
                    },
                    {
                        question: "Population stratification in Canadian MR studies is a concern because:",
                        options: [
                            "A) It strengthens the genetic instruments",
                            "B) Genetic ancestry differences can confound IV assumptions",
                            "C) It increases sample size requirements",
                            "D) It only affects rare genetic variants"
                        ],
                        correct: "B",
                        explanation: "Population stratification violates independence if genetic ancestry correlates with both genetic variants and health outcomes."
                    }
                ],
                policy_instruments: [
                    {
                        question: "A study uses Quebec's health reform timing as an instrument for healthcare access. This is valid if:",
                        options: [
                            "A) The reform only affected healthcare access, not other Quebec characteristics",
                            "B) Quebec residents are healthier than other Canadians",
                            "C) The reform was implemented across all provinces simultaneously",
                            "D) The reform had no effect on healthcare access"
                        ],
                        correct: "A",
                        explanation: "Policy instruments are valid when policy changes affect treatment but not other factors that influence outcomes (exclusion restriction)."
                    },
                    {
                        question: "Using provincial healthcare spending per capita as an instrument for treatment quality could be problematic because:",
                        options: [
                            "A) Spending is too strongly correlated with quality",
                            "B) Spending may reflect population health needs, violating independence",
                            "C) Provinces with higher spending always have better outcomes",
                            "D) Healthcare spending data is unreliable"
                        ],
                        correct: "B",
                        explanation: "Healthcare spending often reflects population health needs, creating correlation between the instrument and unmeasured confounders."
                    },
                    {
                        question: "Distance to healthcare provider as an instrument in Canadian rural studies assumes:",
                        options: [
                            "A) Rural residents have worse health outcomes",
                            "B) Distance affects healthcare access but not patient health through other pathways",
                            "C) Transportation is equally available to all residents",
                            "D) Urban providers are always better than rural providers"
                        ],
                        correct: "B",
                        explanation: "Distance instruments assume distance affects outcomes only through healthcare access, not through other rural/urban differences."
                    }
                ],
                estimation_methods: [
                    {
                        question: "Two-Stage Least Squares (2SLS) estimation involves:",
                        options: [
                            "A) Running regression twice with the same variables",
                            "B) First predicting treatment using instruments, then using predicted treatment in outcome regression",
                            "C) Dividing the sample into two random halves",
                            "D) Testing two different outcome measures"
                        ],
                        correct: "B",
                        explanation: "2SLS: First stage predicts treatment using instruments; second stage uses predicted treatment values in outcome regression."
                    },
                    {
                        question: "Limited Information Maximum Likelihood (LIML) is preferred over 2SLS when:",
                        options: [
                            "A) Sample size is very large",
                            "B) Instruments are strong (high F-statistic)",
                            "C) Instruments are weak or moderately strong",
                            "D) There are no observed confounders"
                        ],
                        correct: "C",
                        explanation: "LIML is more robust to weak instruments than 2SLS, though both methods converge with strong instruments and large samples."
                    }
                ],
                canadian_applications: [
                    {
                        question: "The Canadian Institute for Health Information (CIHI) recommends IV methods for comparative effectiveness research when:",
                        options: [
                            "A) Randomized trials are available and conclusive",
                            "B) Treatment selection is non-random and confounding by indication is suspected",
                            "C) All relevant confounders are measured",
                            "D) Sample sizes are small"
                        ],
                        correct: "B",
                        explanation: "IV methods address unmeasured confounding, particularly confounding by indication where treatment choice depends on prognosis."
                    },
                    {
                        question: "Health Canada's regulatory science strategy includes IV methods because they:",
                        options: [
                            "A) Are faster than randomized controlled trials",
                            "B) Cost less than other study designs",
                            "C) Can provide causal evidence from observational data when trials are impractical",
                            "D) Always give identical results to RCTs"
                        ],
                        correct: "C",
                        explanation: "IV methods enable causal inference from observational data, valuable when RCTs are unethical, impractical, or insufficient."
                    }
                ]
            };

            // Randomly select questions from each concept area
            const selectedQuestions = [];
            
            // Select 1-2 questions from each concept area
            Object.keys(questionPools).forEach(concept => {
                const conceptQuestions = questionPools[concept];
                const numToSelect = Math.min(2, conceptQuestions.length);
                const shuffled = [...conceptQuestions].sort(() => 0.5 - Math.random());
                selectedQuestions.push(...shuffled.slice(0, numToSelect));
            });

            // Shuffle the final selection and take 8 questions
            const finalQuestions = selectedQuestions.sort(() => 0.5 - Math.random()).slice(0, 8);

            document.getElementById('instrumental-variables-assessment-questions').style.display = 'block';
            document.getElementById('instrumental-variables-assessment-questions').innerHTML = `
                <h4>üìù Instrumental Variables Assessment</h4>
                <p><strong>Instructions:</strong> This assessment covers IV assumptions, weak instruments, Mendelian randomization, policy instruments, estimation methods, and Canadian applications. You need 70% to pass.</p>
                
                ${finalQuestions.map((q, index) => `
                    <div class="theory-card" style="margin: 1.5rem 0;">
                        <h5>Question ${index + 1}</h5>
                        <p><strong>${q.question}</strong></p>
                        <div style="margin: 1rem 0;">
                            ${q.options.map(option => `
                                <label style="display: block; margin: 0.5rem 0; cursor: pointer;">
                                    <input type="radio" name="iv_q${index + 1}" value="${option.charAt(0)}" style="margin-right: 0.5rem;">
                                    ${option}
                                </label>
                            `).join('')}
                        </div>
                        <div class="question-explanation" id="iv_explanation_${index + 1}" style="display: none; background: #e8f8e8; padding: 1rem; margin-top: 1rem; border-radius: 8px;">
                            <strong>Correct Answer:</strong> ${q.correct})<br>
                            <strong>Explanation:</strong> ${q.explanation}
                        </div>
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="gradeInstrumentalVariablesAssessment()">üìä Check Answers</button>
                    <button class="btn" onclick="showInstrumentalVariablesAnswers()" style="margin-left: 1rem; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);">üëÅÔ∏è Show All Answers</button>
                    <button class="btn" onclick="generateInstrumentalVariablesAssessment()" style="margin-left: 1rem; background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);">üîÑ Generate New Questions</button>
                </div>
                
                <div id="instrumental-variables-assessment-results" style="display: none;">
                    <!-- Results will be shown here -->
                </div>
            `;

            // Store the correct answers globally for grading
            window.instrumentalVariablesAssessmentAnswers = finalQuestions.map(q => q.correct);
        }

        function gradeInstrumentalVariablesAssessment() {
            const correctAnswers = window.instrumentalVariablesAssessmentAnswers || [];
            let score = 0;
            const totalQuestions = correctAnswers.length;
            
            for (let i = 1; i <= totalQuestions; i++) {
                const selected = document.querySelector(`input[name="iv_q${i}"]:checked`);
                if (selected && selected.value === correctAnswers[i-1]) {
                    score++;
                }
            }
            
            const percentage = (score / totalQuestions) * 100;
            const passed = percentage >= 70;
            
            document.getElementById('instrumental-variables-assessment-results').style.display = 'block';
            document.getElementById('instrumental-variables-assessment-results').innerHTML = `
                <div class="results-header">
                    <h4>üìä Instrumental Variables Assessment Results</h4>
                    <p><strong>Score:</strong> ${score}/${totalQuestions} (${percentage.toFixed(1)}%) | <strong>Status:</strong> ${passed ? '‚úÖ Passed' : '‚ùå Needs Improvement'}</p>
                </div>
                
                <div class="canadian-highlight">
                    <h4>üá®üá¶ Canadian Causal Inference with Natural Experiments</h4>
                    <p><strong>Performance Level:</strong> ${percentage >= 90 ? 'Expert - Ready for complex natural experiment studies and CADTH submissions' : percentage >= 80 ? 'Advanced - Ready for policy evaluation and MR studies' : percentage >= 70 ? 'Competent - Solid foundation in instrumental variables' : 'Developing - Review IV assumptions and weak instrument issues'}</p>
                    
                    <h5>Concept Mastery Assessment:</h5>
                    <div class="theory-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>IV Assumptions</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Weak Instruments</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Mendelian Randomization</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Policy Instruments</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Estimation Methods</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                        <div style="text-align: center; padding: 0.5rem;">
                            <strong>Canadian Applications</strong><br>
                            ${percentage >= 75 ? '‚úÖ Strong' : percentage >= 60 ? '‚ö†Ô∏è Adequate' : '‚ùå Needs Work'}
                        </div>
                    </div>
                    
                    <p><strong>Next Steps:</strong> ${
                        percentage >= 85 ? 'Ready for Canadian health system integration and real-world evidence applications.' :
                        percentage >= 70 ? 'Continue with health system integration or focus on specific IV applications.' :
                        'Focus on understanding IV assumptions and instrument validity before advanced applications.'
                    }</p>
                    
                    <p><strong>Natural Experiments Readiness:</strong> ${
                        percentage >= 80 ? 'Well-prepared for policy evaluations, CADTH comparative effectiveness studies, and biobank MR analyses.' :
                        percentage >= 70 ? 'Good foundation - review Canadian policy instruments and biobank applications.' :
                        'Study IV fundamentals and Canadian healthcare natural experiments before advanced applications.'
                    }</p>
                </div>
            `;
        }

        function showInstrumentalVariablesAnswers() {
            const totalQuestions = window.instrumentalVariablesAssessmentAnswers ? window.instrumentalVariablesAssessmentAnswers.length : 5;
            for (let i = 1; i <= totalQuestions; i++) {
                const explanationDiv = document.getElementById(`iv_explanation_${i}`);
                if (explanationDiv) {
                    explanationDiv.style.display = 'block';
                }
            }
        }

        // Canadian Health System Integration Assessment Functions
        function generateCanadianIntegrationAssessment() {
            console.log('üìù Generating Canadian Health System Integration Assessment...');
            
            const questionPools = {
                "Canadian Health Framework": [
                    {
                        question: "The Canada Health Act requires provincial health insurance programs to meet which five principles?",
                        options: [
                            "A) Public administration, comprehensiveness, universality, portability, accessibility",
                            "B) Efficiency, effectiveness, equity, excellence, ethics", 
                            "C) Quality, safety, timeliness, patient-centered, equitable",
                            "D) Prevention, treatment, rehabilitation, palliation, promotion"
                        ],
                        correct: "A",
                        explanation: "The five principles of the Canada Health Act are public administration, comprehensiveness, universality, portability, and accessibility."
                    },
                    {
                        question: "Health Canada's role in the federal health system includes:",
                        options: [
                            "A) Direct delivery of provincial healthcare services",
                            "B) Regulatory oversight, drug approvals, and medical device regulation",
                            "C) Management of provincial hospital systems",
                            "D) Setting provincial healthcare budgets"
                        ],
                        correct: "B",
                        explanation: "Health Canada provides federal regulatory oversight including therapeutic product approvals and medical device regulation, while provinces manage service delivery."
                    },
                    {
                        question: "The Canada Health Transfer (CHT) is:",
                        options: [
                            "A) A program to transfer patients between provinces",
                            "B) Federal funding to provinces for healthcare with accountability requirements",
                            "C) A system for transferring medical records",
                            "D) An insurance plan for federal employees"
                        ],
                        correct: "B",
                        explanation: "CHT is the largest federal transfer to provinces/territories for healthcare, with conditions tied to Canada Health Act compliance."
                    }
                ],
                "CIHI Data Infrastructure": [
                    {
                        question: "CIHI's Discharge Abstract Database (DAD) contains:",
                        options: [
                            "A) Only Ontario hospital data",
                            "B) All acute care hospital separations across Canada (except Quebec)",
                            "C) Outpatient clinic visits only",
                            "D) Physician billing information"
                        ],
                        correct: "B",
                        explanation: "DAD captures all acute care hospital separations with standardized coding and definitions across participating provinces/territories."
                    },
                    {
                        question: "NACRS (National Ambulatory Care Reporting System) covers:",
                        options: [
                            "A) Hospital emergency department visits and day surgery",
                            "B) Family physician office visits only",
                            "C) Prescription drug dispensing",
                            "D) Home care services"
                        ],
                        correct: "A",
                        explanation: "NACRS captures ambulatory care including emergency departments, outpatient clinics, and day surgery procedures with standardized data elements."
                    },
                    {
                        question: "CIHI quality indicators enable:",
                        options: [
                            "A) Individual patient tracking across provinces",
                            "B) Standardized health system performance measurement and provincial comparisons",
                            "C) Direct patient care decision-making",
                            "D) Physician performance evaluation"
                        ],
                        correct: "B",
                        explanation: "CIHI develops standardized quality indicators allowing consistent measurement and comparison of health system performance across jurisdictions."
                    }
                ],
                "Provincial Data Systems": [
                    {
                        question: "Key differences between provincial administrative databases include:",
                        options: [
                            "A) All provinces use identical data collection systems",
                            "B) Coverage periods, population inclusion criteria, and coding practices vary",
                            "C) Only hospital data differs between provinces",
                            "D) All administrative data is managed federally"
                        ],
                        correct: "B",
                        explanation: "Provincial systems vary in coverage (universal vs. age-restricted), data elements collected, coding practices, and data quality procedures."
                    },
                    {
                        question: "ICES (Ontario) provides:",
                        options: [
                            "A) Basic hospital data only",
                            "B) Comprehensive linked administrative health databases for population research",
                            "C) Survey data collection services",
                            "D) Clinical trial coordination"
                        ],
                        correct: "B",
                        explanation: "ICES maintains extensive linked administrative databases including hospital, physician, drug, demographics, and other health system data for Ontario."
                    },
                    {
                        question: "Multi-provincial data linkage faces challenges including:",
                        options: [
                            "A) Standardized privacy legislation across all provinces",
                            "B) Identical data collection methods in all provinces", 
                            "C) Varying privacy laws, data standards, and governance frameworks",
                            "D) Federal control over all health data"
                        ],
                        correct: "C",
                        explanation: "Provincial jurisdiction over health creates varying privacy legislation (e.g., PHIPA in Ontario, PIPEDA federally), data standards, and approval processes."
                    }
                ],
                "Privacy and Governance": [
                    {
                        question: "PIPEDA applies to:",
                        options: [
                            "A) All health data in Canada",
                            "B) Federal organizations and private sector organizations in provinces without substantially similar privacy legislation",
                            "C) Only hospital data",
                            "D) Public health surveillance only"
                        ],
                        correct: "B",
                        explanation: "PIPEDA covers federal organizations and private sector, while provinces have their own health privacy acts (e.g., PHIPA, HIPA) for provincial health systems."
                    },
                    {
                        question: "Research Ethics Board (REB) approval for multi-provincial studies typically requires:",
                        options: [
                            "A) Only federal REB approval",
                            "B) Approval from each participating province's designated REB and data custodian",
                            "C) No ethics approval for administrative data",
                            "D) Only hospital-based REB approval"
                        ],
                        correct: "B",
                        explanation: "Multi-provincial studies require ethics approval from each jurisdiction's REB plus approval from provincial data custodians, creating complex approval pathways."
                    },
                    {
                        question: "Statistical disclosure control in Canadian health data helps:",
                        options: [
                            "A) Improve data quality",
                            "B) Prevent identification of individuals while preserving analytical utility",
                            "C) Reduce data storage costs",
                            "D) Speed up data processing"
                        ],
                        correct: "B",
                        explanation: "Disclosure control methods (cell suppression, data perturbation, etc.) protect individual privacy while maintaining data utility for population research."
                    }
                ],
                "Regulatory Pathways": [
                    {
                        question: "CADTH (Canadian Agency for Drugs and Technologies in Health) provides:",
                        options: [
                            "A) Direct drug approvals for Canada",
                            "B) Health technology assessment and reimbursement recommendations",
                            "C) Hospital accreditation services",
                            "D) Clinical trial oversight"
                        ],
                        correct: "B",
                        explanation: "CADTH conducts HTA including clinical and economic evaluation to inform provincial/territorial drug coverage and healthcare technology decisions."
                    },
                    {
                        question: "Real-world evidence for Canadian regulatory decisions:",
                        options: [
                            "A) Is never accepted by Health Canada",
                            "B) Can supplement clinical trial evidence, especially for rare diseases and post-market surveillance",
                            "C) Completely replaces the need for clinical trials",
                            "D) Is only used for medical devices"
                        ],
                        correct: "B",
                        explanation: "Health Canada's RWE guidance allows real-world evidence to complement clinical trials, particularly valuable for rare diseases and safety monitoring."
                    },
                    {
                        question: "Pan-Canadian Pharmaceutical Alliance (pCPA) aims to:",
                        options: [
                            "A) Develop new drugs",
                            "B) Coordinate drug pricing negotiations across participating provinces/territories", 
                            "C) Regulate pharmaceutical manufacturing",
                            "D) Conduct clinical trials"
                        ],
                        correct: "B",
                        explanation: "pCPA enables joint price negotiations for pharmaceuticals, leveraging collective purchasing power while respecting provincial jurisdiction over formularies."
                    }
                ],
                "Integration Methods": [
                    {
                        question: "Federated learning approaches for Canadian health data allow:",
                        options: [
                            "A) Centralized storage of all provincial data",
                            "B) Analysis across jurisdictions without moving sensitive data from originating sites",
                            "C) Elimination of privacy requirements",
                            "D) Direct patient identification across provinces"
                        ],
                        correct: "B",
                        explanation: "Federated learning trains models locally at each site and shares only aggregated results, enabling multi-jurisdictional analysis while preserving privacy."
                    },
                    {
                        question: "Harmonized analysis protocols in multi-provincial studies help ensure:",
                        options: [
                            "A) Identical results across all provinces",
                            "B) Consistent methodology while accounting for provincial data differences",
                            "C) Elimination of provincial variations",
                            "D) Federal control over provincial data"
                        ],
                        correct: "B",
                        explanation: "Harmonized protocols standardize analytical approaches while accommodating legitimate differences in provincial data systems and populations."
                    },
                    {
                        question: "Network analysis of Canadian health systems can assess:",
                        options: [
                            "A) Individual patient networks only",
                            "B) System connectivity, care coordination, and referral patterns across the continuum",
                            "C) Social media connections of healthcare providers",
                            "D) Computer network infrastructure"
                        ],
                        correct: "B",
                        explanation: "Health system network analysis examines care pathways, provider relationships, and system integration to identify opportunities for improvement."
                    }
                ]
            };

            // Randomly select questions from each concept area
            const selectedQuestions = [];
            
            // Select 1-2 questions from each concept area
            Object.keys(questionPools).forEach(concept => {
                const conceptQuestions = questionPools[concept];
                const numToSelect = Math.min(2, conceptQuestions.length);
                const shuffled = [...conceptQuestions].sort(() => 0.5 - Math.random());
                selectedQuestions.push(...shuffled.slice(0, numToSelect));
            });

            // Shuffle the final selection and take 8 questions
            const finalQuestions = selectedQuestions.sort(() => 0.5 - Math.random()).slice(0, 8);

            document.getElementById('canadian-integration-assessment-questions').style.display = 'block';
            document.getElementById('canadian-integration-assessment-questions').innerHTML = `
                <h4>üìù Canadian Health System Integration Assessment</h4>
                <p><strong>Instructions:</strong> This assessment covers Canadian health framework, CIHI data infrastructure, provincial systems, privacy governance, regulatory pathways, and integration methods. You need 70% to pass.</p>
                
                ${finalQuestions.map((q, index) => `
                    <div class="theory-card" style="margin: 1.5rem 0;">
                        <h5>Question ${index + 1}</h5>
                        <p><strong>${q.question}</strong></p>
                        <div style="margin: 1rem 0;">
                            ${q.options.map(option => `
                                <label style="display: block; margin: 0.5rem 0; cursor: pointer;">
                                    <input type="radio" name="can_q${index + 1}" value="${option.charAt(0)}" style="margin-right: 0.5rem;">
                                    ${option}
                                </label>
                            `).join('')}
                        </div>
                        <div id="can_explanation_${index + 1}" style="display: none; background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                            <strong>Explanation:</strong> ${q.explanation}
                        </div>
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="gradeCanadianIntegrationAssessment()">üìä Check Answers</button>
                    <button class="btn" onclick="showCanadianIntegrationAnswers()" style="margin-left: 1rem; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);">üëÅÔ∏è Show All Answers</button>
                    <button class="btn" onclick="generateCanadianIntegrationAssessment()" style="margin-left: 1rem; background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);">üîÑ Generate New Questions</button>
                </div>
                
                <div id="canadian-integration-assessment-results" style="display: none;">
                    <!-- Results will be shown here -->
                </div>
            `;

            // Store the correct answers globally for grading
            window.canadianIntegrationAssessmentAnswers = finalQuestions.map(q => q.correct);
        }

        function gradeCanadianIntegrationAssessment() {
            const answers = window.canadianIntegrationAssessmentAnswers || [];
            const totalQuestions = answers.length;
            let correctAnswers = 0;

            for (let i = 1; i <= totalQuestions; i++) {
                const selectedAnswer = document.querySelector(`input[name="can_q${i}"]:checked`);
                if (selectedAnswer && selectedAnswer.value === answers[i - 1]) {
                    correctAnswers++;
                }
            }

            const score = correctAnswers;
            const percentage = (score / totalQuestions) * 100;
            const passed = percentage >= 70;

            // Calculate concept-level performance
            const conceptPerformance = {
                "Canadian Health Framework": { correct: 0, total: 0 },
                "CIHI Data Infrastructure": { correct: 0, total: 0 },
                "Provincial Data Systems": { correct: 0, total: 0 },
                "Privacy and Governance": { correct: 0, total: 0 },
                "Regulatory Pathways": { correct: 0, total: 0 },
                "Integration Methods": { correct: 0, total: 0 }
            };

            // Note: Simplified concept tracking - in full implementation would track question sources
            
            document.getElementById('canadian-integration-assessment-results').style.display = 'block';
            document.getElementById('canadian-integration-assessment-results').innerHTML = `
                <div class="results-header">
                    <h4>üìä Canadian Health System Integration Assessment Results</h4>
                    <p><strong>Score:</strong> ${score}/${totalQuestions} (${percentage.toFixed(1)}%) | <strong>Status:</strong> ${passed ? '‚úÖ Passed' : '‚ùå Needs Improvement'}</p>
                </div>
                
                <div class="performance-breakdown">
                    <h5>üìà Performance Analysis</h5>
                    <p><strong>Overall Performance:</strong> ${percentage >= 90 ? 'Expert' : percentage >= 80 ? 'Advanced' : percentage >= 70 ? 'Competent' : 'Developing'} level understanding of Canadian health system integration</p>
                    <p><strong>Key Strengths:</strong> ${passed ? 'Strong grasp of Canadian health system fundamentals' : 'Review fundamental concepts needed'}</p>
                    <p><strong>Recommendations:</strong> ${percentage < 70 ? 'Focus on Canada Health Act principles, CIHI data standards, and provincial privacy frameworks' : 'Consider advanced topics in federal-provincial coordination and data governance'}</p>
                </div>

                <div class="canadian-highlight">
                    <h5>üá®üá¶ Canadian Health System Integration Competency</h5>
                    <p><strong>Federal Framework:</strong> ${percentage >= 75 ? 'Strong' : percentage >= 60 ? 'Adequate' : 'Needs Work'} - Understanding of Canada Health Act and federal roles</p>
                    <p><strong>Data Infrastructure:</strong> ${percentage >= 75 ? 'Strong' : percentage >= 60 ? 'Adequate' : 'Needs Work'} - CIHI systems and provincial data integration</p>
                    <p><strong>Privacy & Governance:</strong> ${percentage >= 75 ? 'Strong' : percentage >= 60 ? 'Adequate' : 'Needs Work'} - Multi-jurisdictional privacy and ethics frameworks</p>
                    <p><strong>Regulatory Pathways:</strong> ${percentage >= 75 ? 'Strong' : percentage >= 60 ? 'Adequate' : 'Needs Work'} - Health Canada, CADTH, and provincial approval processes</p>
                </div>
            `;
        }

        function showCanadianIntegrationAnswers() {
            const totalQuestions = window.canadianIntegrationAssessmentAnswers ? window.canadianIntegrationAssessmentAnswers.length : 5;
            for (let i = 1; i <= totalQuestions; i++) {
                const explanationDiv = document.getElementById(`can_explanation_${i}`);
                if (explanationDiv) {
                    explanationDiv.style.display = 'block';
                }
            }
        }

        // Real-World Applications Assessment Functions
        function generateRealWorldApplicationsAssessment() {
            console.log('üìù Generating Real-World Applications Assessment...');
            
            const questionPools = {
                "Method Selection Strategy": [
                    {
                        question: "When conducting a health technology assessment for CADTH, which analysis sequence would be most appropriate?",
                        options: [
                            "A) Classical regression only",
                            "B) Classical regression ‚Üí Regularization ‚Üí Mixed effects ‚Üí Propensity score matching",
                            "C) Instrumental variables first, then classical regression",
                            "D) Meta-analysis without individual patient data"
                        ],
                        correct: "B",
                        explanation: "HTA requires comprehensive analysis starting with exploratory classical regression, then building complexity through regularization, hierarchical modeling, and causal inference methods."
                    },
                    {
                        question: "For a cancer treatment effectiveness study using multi-provincial data, what modeling approach addresses both clustering and unmeasured confounding?",
                        options: [
                            "A) Classical regression with provincial fixed effects",
                            "B) Regularized regression with elastic net",
                            "C) Mixed effects models followed by propensity score analysis",
                            "D) Instrumental variables analysis alone"
                        ],
                        correct: "C",
                        explanation: "Mixed effects models handle clustering by province/hospital, while propensity scores or IV methods address unmeasured confounding in treatment assignment."
                    },
                    {
                        question: "When should regularization methods be prioritized over classical regression in healthcare research?",
                        options: [
                            "A) When sample size exceeds 1000 patients",
                            "B) When the number of predictors approaches or exceeds the sample size",
                            "C) When effect sizes are expected to be large",
                            "D) When administrative data is being used"
                        ],
                        correct: "B",
                        explanation: "Regularization is essential when facing high-dimensional data where traditional regression would overfit, particularly in genomics or EHR studies with many variables."
                    }
                ],
                "Integration Workflows": [
                    {
                        question: "In a precision medicine study, what is the optimal sequence for integrating multiple statistical methods?",
                        options: [
                            "A) Regularization for biomarker selection ‚Üí Mixed effects for clustering ‚Üí Causal inference for treatment effects",
                            "B) Classical regression ‚Üí Instrumental variables ‚Üí Meta-analysis",
                            "C) Propensity scores ‚Üí Regularization ‚Üí Descriptive analysis",
                            "D) Mixed effects only for all analyses"
                        ],
                        correct: "A",
                        explanation: "Precision medicine requires biomarker discovery (regularization), handling of institutional clustering (mixed effects), and causal treatment effect estimation."
                    },
                    {
                        question: "For policy evaluation using natural experiments, which method combination provides the strongest evidence?",
                        options: [
                            "A) Descriptive statistics and classical regression",
                            "B) Instrumental variables with sensitivity analysis using propensity scores",
                            "C) Mixed effects models alone",
                            "D) Regularized regression with cross-validation"
                        ],
                        correct: "B",
                        explanation: "Natural experiments leverage IV methods for causal inference, with propensity score analysis providing robustness checks and sensitivity analysis."
                    },
                    {
                        question: "When combining administrative and survey data for health equity analysis, what methodological considerations are paramount?",
                        options: [
                            "A) Use only one data source to avoid complications",
                            "B) Account for selection bias in survey participation and missing data patterns",
                            "C) Apply the same weights to all observations",
                            "D) Focus only on complete cases"
                        ],
                        correct: "B",
                        explanation: "Combining data sources requires careful attention to selection mechanisms, missing data patterns, and appropriate weighting strategies for valid inference."
                    }
                ],
                "Clinical Interpretation": [
                    {
                        question: "When interpreting regularized regression results in biomarker studies, what is the key limitation to communicate?",
                        options: [
                            "A) Regularization always produces unbiased estimates",
                            "B) Selected biomarkers are guaranteed to be causal",
                            "C) Regularization introduces bias to reduce variance, affecting interpretation",
                            "D) P-values from regularized models are always valid"
                        ],
                        correct: "C",
                        explanation: "Regularization introduces bias to control overfitting, so selected variables and effect estimates require careful interpretation and external validation."
                    },
                    {
                        question: "In propensity score analysis for treatment effectiveness, what indicates a successful matching strategy?",
                        options: [
                            "A) All patients can be matched 1:1",
                            "B) Standardized mean differences <0.1 for all covariates after matching",
                            "C) The treatment effect is statistically significant",
                            "D) The propensity score model has high R¬≤"
                        ],
                        correct: "B",
                        explanation: "Balance assessment using standardized mean differences <0.1 (or <0.25) indicates successful covariate balance, which is essential for valid causal inference."
                    },
                    {
                        question: "When reporting instrumental variable results to clinicians, what is essential to emphasize?",
                        options: [
                            "A) IV estimates are always more precise than observational estimates",
                            "B) The IV estimate represents the effect for the entire population",
                            "C) IV provides local average treatment effect (LATE) for compliers only",
                            "D) IV eliminates all sources of bias"
                        ],
                        correct: "C",
                        explanation: "IV estimates represent the Local Average Treatment Effect (LATE) for compliers whose treatment was influenced by the instrument, not the average treatment effect for all patients."
                    }
                ],
                "Canadian Policy Applications": [
                    {
                        question: "For a CADTH health technology assessment, which analytical framework best supports coverage decision-making?",
                        options: [
                            "A) Single randomized trial analysis",
                            "B) Mixed effects meta-analysis with Canadian subgroup analysis and budget impact modeling",
                            "C) Descriptive statistics from administrative data",
                            "D) International cost-effectiveness studies only"
                        ],
                        correct: "B",
                        explanation: "CADTH requires comprehensive evidence including meta-analysis, Canadian-specific subgroup analysis, and budget impact assessment using appropriate statistical methods."
                    },
                    {
                        question: "When evaluating a provincial health policy using administrative data, what design best addresses confounding?",
                        options: [
                            "A) Before-after comparison within the province",
                            "B) Interrupted time series with control provinces (difference-in-differences)",
                            "C) Cross-sectional comparison between provinces",
                            "D) Case series analysis"
                        ],
                        correct: "B",
                        explanation: "Interrupted time series with control groups (difference-in-differences) controls for secular trends and provincial fixed effects, providing stronger causal inference."
                    },
                    {
                        question: "For Indigenous health research in Canada, what methodological considerations are essential?",
                        options: [
                            "A) Use the same methods as for the general population",
                            "B) Focus only on individual-level factors",
                            "C) Account for historical trauma, community clustering, and cultural determinants using appropriate mixed effects and community-based approaches",
                            "D) Exclude Indigenous populations from analysis"
                        ],
                        correct: "C",
                        explanation: "Indigenous health research requires culturally appropriate methods that account for historical context, community structures, and cultural determinants of health."
                    }
                ],
                "Advanced Integration": [
                    {
                        question: "In ensemble modeling for clinical prediction, what is the primary advantage of combining regularized regression with tree-based methods?",
                        options: [
                            "A) Reduced computational complexity",
                            "B) Guaranteed causal interpretation",
                            "C) Captures both linear relationships (regularization) and complex interactions (trees)",
                            "D) Eliminates the need for validation"
                        ],
                        correct: "C",
                        explanation: "Ensemble methods leverage complementary strengths: regularized regression captures linear relationships efficiently while tree methods capture complex interactions and non-linearities."
                    },
                    {
                        question: "When implementing multi-method validation in real-world evidence studies, what approach provides the strongest evidence?",
                        options: [
                            "A) Single-site internal validation only",
                            "B) Cross-validation within the same dataset",
                            "C) Temporal, geographic, and population external validation using different methods",
                            "D) Bootstrapping with replacement"
                        ],
                        correct: "C",
                        explanation: "Multi-dimensional external validation (temporal, geographic, population) using different analytical approaches provides the most robust evidence for generalizability."
                    },
                    {
                        question: "For regulatory submission to Health Canada using real-world evidence, what documentation is essential?",
                        options: [
                            "A) Only final analysis results",
                            "B) Comprehensive analysis plan, sensitivity analyses, validation results, and bias assessment",
                            "C) Literature review and meta-analysis",
                            "D) Single observational study"
                        ],
                        correct: "B",
                        explanation: "Health Canada's RWE guidance requires pre-specified analysis plans, multiple sensitivity analyses, validation strategies, and comprehensive bias assessment."
                    }
                ]
            };

            // Randomly select questions from each concept area
            const selectedQuestions = [];
            
            // Select 1-2 questions from each concept area
            Object.keys(questionPools).forEach(concept => {
                const conceptQuestions = questionPools[concept];
                const numToSelect = Math.min(2, conceptQuestions.length);
                const shuffled = [...conceptQuestions].sort(() => 0.5 - Math.random());
                selectedQuestions.push(...shuffled.slice(0, numToSelect));
            });

            // Shuffle the final selection and take 10 questions
            const finalQuestions = selectedQuestions.sort(() => 0.5 - Math.random()).slice(0, 10);

            document.getElementById('real-world-applications-assessment-questions').style.display = 'block';
            document.getElementById('real-world-applications-assessment-questions').innerHTML = `
                <h4>üìù Real-World Applications Assessment</h4>
                <p><strong>Instructions:</strong> This assessment covers method integration, clinical interpretation, Canadian policy applications, and advanced analytical workflows. You need 70% to pass.</p>
                
                ${finalQuestions.map((q, index) => `
                    <div class="theory-card" style="margin: 1.5rem 0;">
                        <h5>Question ${index + 1}</h5>
                        <p><strong>${q.question}</strong></p>
                        <div style="margin: 1rem 0;">
                            ${q.options.map(option => `
                                <label style="display: block; margin: 0.5rem 0; cursor: pointer;">
                                    <input type="radio" name="rwa_q${index + 1}" value="${option.charAt(0)}" style="margin-right: 0.5rem;">
                                    ${option}
                                </label>
                            `).join('')}
                        </div>
                        <div id="rwa_explanation_${index + 1}" style="display: none; background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                            <strong>Explanation:</strong> ${q.explanation}
                        </div>
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="gradeRealWorldApplicationsAssessment()">üìä Check Answers</button>
                    <button class="btn" onclick="showRealWorldApplicationsAnswers()" style="margin-left: 1rem; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);">üëÅÔ∏è Show All Answers</button>
                    <button class="btn" onclick="generateRealWorldApplicationsAssessment()" style="margin-left: 1rem; background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);">üîÑ Generate New Questions</button>
                </div>
                
                <div id="real-world-applications-assessment-results" style="display: none;">
                    <!-- Results will be shown here -->
                </div>
            `;

            // Store the correct answers globally for grading
            window.realWorldApplicationsAssessmentAnswers = finalQuestions.map(q => q.correct);
        }

        function gradeRealWorldApplicationsAssessment() {
            const answers = window.realWorldApplicationsAssessmentAnswers || [];
            const totalQuestions = answers.length;
            let correctAnswers = 0;

            for (let i = 1; i <= totalQuestions; i++) {
                const selectedAnswer = document.querySelector(`input[name="rwa_q${i}"]:checked`);
                if (selectedAnswer && selectedAnswer.value === answers[i - 1]) {
                    correctAnswers++;
                }
            }

            const score = correctAnswers;
            const percentage = (score / totalQuestions) * 100;
            const passed = percentage >= 70;

            document.getElementById('real-world-applications-assessment-results').style.display = 'block';
            document.getElementById('real-world-applications-assessment-results').innerHTML = `
                <div class="results-header">
                    <h4>üìä Real-World Applications Assessment Results</h4>
                    <p><strong>Score:</strong> ${score}/${totalQuestions} (${percentage.toFixed(1)}%) | <strong>Status:</strong> ${passed ? '‚úÖ Passed' : '‚ùå Needs Improvement'}</p>
                </div>
                
                <div class="performance-breakdown">
                    <h5>üìà Integration Competency Analysis</h5>
                    <p><strong>Overall Performance:</strong> ${percentage >= 90 ? 'Expert' : percentage >= 80 ? 'Advanced' : percentage >= 70 ? 'Competent' : 'Developing'} level understanding of method integration</p>
                    <p><strong>Clinical Application:</strong> ${percentage >= 75 ? 'Strong' : percentage >= 60 ? 'Adequate' : 'Needs Development'} - Ability to translate statistical results to clinical practice</p>
                    <p><strong>Method Integration:</strong> ${percentage >= 75 ? 'Sophisticated' : percentage >= 60 ? 'Basic' : 'Limited'} - Understanding of sequential analysis workflows</p>
                </div>

                <div class="advanced-feature">
                    <h5>üè• Real-World Application Mastery</h5>
                    <p><strong>Method Selection:</strong> ${percentage >= 75 ? 'Expert' : percentage >= 60 ? 'Competent' : 'Developing'} - Choosing appropriate statistical methods for research questions</p>
                    <p><strong>Integration Workflows:</strong> ${percentage >= 75 ? 'Advanced' : percentage >= 60 ? 'Intermediate' : 'Basic'} - Sequential analysis and ensemble approaches</p>
                    <p><strong>Clinical Interpretation:</strong> ${percentage >= 75 ? 'Strong' : percentage >= 60 ? 'Adequate' : 'Limited'} - Translating statistical results for clinical stakeholders</p>
                    <p><strong>Canadian Policy Context:</strong> ${percentage >= 75 ? 'Excellent' : percentage >= 60 ? 'Good' : 'Needs Work'} - Understanding of Canadian health system applications</p>
                </div>

                <div class="canadian-highlight">
                    <h5>üá®üá¶ Professional Development Recommendations</h5>
                    ${percentage >= 80 ? `
                        <p><strong>Advanced Practice:</strong> Consider leading methodology development, mentoring junior researchers, and contributing to Canadian health analytics initiatives</p>
                        <p><strong>Knowledge Translation:</strong> Focus on bridging statistical methods with clinical and policy applications</p>
                    ` : percentage >= 70 ? `
                        <p><strong>Skill Enhancement:</strong> Practice advanced integration workflows and focus on clinical interpretation of complex models</p>
                        <p><strong>Canadian Context:</strong> Strengthen understanding of CADTH processes and provincial health system variations</p>
                    ` : `
                        <p><strong>Foundation Building:</strong> Review fundamental concepts in each statistical method before attempting integration</p>
                        <p><strong>Guided Practice:</strong> Work through structured examples of sequential analysis workflows</p>
                    `}
                </div>
            `;
        }

        function showRealWorldApplicationsAnswers() {
            const totalQuestions = window.realWorldApplicationsAssessmentAnswers ? window.realWorldApplicationsAssessmentAnswers.length : 5;
            for (let i = 1; i <= totalQuestions; i++) {
                const explanationDiv = document.getElementById(`rwa_explanation_${i}`);
                if (explanationDiv) {
                    explanationDiv.style.display = 'block';
                }
            }
        }

        // Error display function for failed analyses
        function displayError(containerId, message) {
            const container = document.getElementById(containerId);
            if (container) {
                container.style.display = 'block';
                container.innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <h4>‚ùå Analysis Error</h4>
                        <p>${message}</p>
                        <p><strong>Troubleshooting:</strong></p>
                        <ul>
                            <li>Check that all configuration options are selected</li>
                            <li>Try refreshing the page and running the analysis again</li>
                            <li>If the problem persists, this may be a development issue</li>
                        </ul>
                    </div>
                `;
            }
        }

        // Helper functions for Canadian healthcare context
        function getProvinceCharacteristics(province) {
            const provinces = {
                'ontario': {
                    name: 'Ontario',
                    system: 'Ontario Health Insurance Plan (OHIP)',
                    population: '14.8 million',
                    application: 'Largest provincial dataset for robust modeling',
                    regulatory: 'Health Quality Ontario quality indicators'
                },
                'quebec': {
                    name: 'Quebec',
                    system: 'R√©gie de l\'assurance maladie du Qu√©bec (RAMQ)',
                    population: '8.5 million',
                    application: 'French-speaking population with unique health patterns',
                    regulatory: 'Institut national d\'excellence en sant√© et services sociaux (INESSS)'
                },
                'bc': {
                    name: 'British Columbia',
                    system: 'Medical Services Plan (MSP)',
                    population: '5.2 million',
                    application: 'Diverse population with aging demographics',
                    regulatory: 'BC Ministry of Health evidence requirements'
                },
                'alberta': {
                    name: 'Alberta',
                    system: 'Alberta Health Care Insurance Plan (AHCIP)',
                    population: '4.4 million',
                    application: 'Resource-based economy with occupational health focus',
                    regulatory: 'Alberta Health evidence-based policy'
                },
                'multi-province': {
                    name: 'Multi-Provincial Study',
                    system: 'Combined Canadian Healthcare Systems',
                    population: '38+ million',
                    application: 'National-level evidence generation',
                    regulatory: 'Health Canada and CADTH requirements'
                }
            };
            return provinces[province] || provinces['multi-province'];
        }

        function getOutcomeCharacteristics(outcome) {
            const outcomes = {
                'cvd-risk': {
                    name: 'Cardiovascular Disease Risk Prediction',
                    description: '10-year risk of major cardiovascular events',
                    unit: 'Probability (0-1)',
                    clinicalThreshold: 0.2
                },
                'hospital-readmission': {
                    name: '30-Day Hospital Readmission',
                    description: 'Probability of unplanned readmission within 30 days',
                    unit: 'Probability (0-1)',
                    clinicalThreshold: 0.15
                },
                'diabetes-control': {
                    name: 'Diabetes Control (HbA1c)',
                    description: 'Glycemic control in diabetic patients',
                    unit: 'HbA1c (%)',
                    clinicalThreshold: 7.0
                },
                'medication-adherence': {
                    name: 'Medication Adherence Rate',
                    description: 'Proportion of prescribed medication taken',
                    unit: 'Percentage (%)',
                    clinicalThreshold: 80
                },
                'quality-life': {
                    name: 'Quality of Life Score',
                    description: 'Health-related quality of life assessment',
                    unit: 'Score (0-100)',
                    clinicalThreshold: 70
                }
            };
            return outcomes[outcome] || outcomes['cvd-risk'];
        }

        function formatPredictorName(pred) {
            const names = {
                'age': 'Age (years)',
                'bmi': 'Body Mass Index',
                'systolic_bp': 'Systolic Blood Pressure',
                'cholesterol': 'Total Cholesterol',
                'smoking': 'Current Smoking Status',
                'diabetes': 'Diabetes Diagnosis',
                'comorbidities': 'Number of Comorbidities',
                'los_initial': 'Initial Length of Stay',
                'medication_count': 'Number of Medications',
                'pain_level': 'Pain Score (0-10)'
            };
            return names[pred] || pred.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function getValidationRequirements(outcome) {
            const requirements = {
                'cvd-risk': 'External validation required with Canadian population data',
                'hospital-readmission': 'Multi-site validation across Canadian hospitals',
                'diabetes-control': 'Validation with Canadian diabetes registry data',
                'medication-adherence': 'Validation with provincial drug plan databases',
                'quality-life': 'Cross-cultural validation for Canadian diverse population'
            };
            return requirements[outcome] || 'Standard Health Canada validation requirements';
        }

        function getEvidenceStandards(pValue, rSquared) {
            if (pValue < 0.001 && rSquared > 0.7) {
                return 'Strong evidence - meets CADTH Level 1 requirements';
            } else if (pValue < 0.01 && rSquared > 0.5) {
                return 'Moderate evidence - meets CADTH Level 2 requirements';
            } else if (pValue < 0.05 && rSquared > 0.3) {
                return 'Preliminary evidence - additional validation needed';
            } else {
                return 'Insufficient evidence - model refinement required';
            }
        }

        function getClinicalSignificance(outcome, coefficients) {
            const firstCoeff = Object.values(coefficients)[0];
            const magnitude = Math.abs(firstCoeff);
            
            if (magnitude > 0.5) {
                return 'Clinically significant effect size for treatment decisions';
            } else if (magnitude > 0.2) {
                return 'Moderate clinical significance for population health planning';
            } else {
                return 'Small effect size - clinical relevance requires assessment';
            }
        }

        function assessMulticollinearity(vifValues) {
            const maxVIF = Math.max(...Object.values(vifValues));
            if (maxVIF > 10) {
                return 'Severe multicollinearity detected - model revision needed';
            } else if (maxVIF > 5) {
                return 'Moderate multicollinearity - consider variable selection';
            } else {
                return 'Acceptable multicollinearity levels';
            }
        }

        function assessModelFit(rSquared, adjustedRSquared) {
            const difference = rSquared - adjustedRSquared;
            if (difference > 0.1) {
                return 'Potential overfitting - model simplification recommended';
            } else if (rSquared > 0.7) {
                return 'Excellent model fit for clinical prediction';
            } else if (rSquared > 0.5) {
                return 'Good model fit suitable for population studies';
            } else {
                return 'Model fit may be insufficient for clinical decisions';
            }
        }

        function assessClinicalApplicability(outcome, results) {
            const rSquared = results.rSquared;
            const significantPredictors = Object.values(results.pValues).filter(p => p < 0.05).length;
            
            if (rSquared > 0.6 && significantPredictors >= 3) {
                return 'High applicability for clinical decision support';
            } else if (rSquared > 0.4 && significantPredictors >= 2) {
                return 'Moderate applicability for population health planning';
            } else {
                return 'Limited clinical applicability - additional predictors needed';
            }
        }

        function recommendNextSteps(results) {
            const recommendations = [];
            
            if (results.rSquared < 0.5) {
                recommendations.push('Consider regularized regression methods');
            }
            
            const maxVIF = Math.max(...Object.values(results.vifValues));
            if (maxVIF > 5) {
                recommendations.push('Apply variable selection techniques');
            }
            
            if (results.pValue > 0.01) {
                recommendations.push('Increase sample size or refine predictors');
            }
            
            recommendations.push('Validate with external Canadian datasets');
            
            return recommendations.join('; ');
        }

        function createRegressionVisualization(data, results, outcome) {
            // Implementation would create Chart.js visualization
            console.log('üìà Creating regression visualization...');
            // This would create scatter plots, residual plots, etc.
        }

        // Regularized Regression Implementation
        function runRegularizedRegression() {
            console.log('üéØ Running Regularized Regression Analysis...');
            
            try {
                const method = document.getElementById('reg-method').value;
                const outcome = document.getElementById('reg-outcome').value;
                const numFeatures = parseInt(document.getElementById('reg-features').value);
                const lambda = parseFloat(document.getElementById('reg-lambda').value) / 100;
                const cvFolds = document.getElementById('reg-cv-folds').value;
                const dataSource = document.getElementById('reg-data-source').value;

                // Generate high-dimensional synthetic data
                const regData = generateHighDimensionalData(outcome, numFeatures);
                
                // Perform regularized regression
                const regResults = performRegularizedAnalysis(regData, method, lambda, cvFolds);
                
                // Display results
                displayRegularizedResults(method, outcome, dataSource, regResults, numFeatures);
                
                console.log('‚úÖ Regularized regression analysis completed successfully');

            } catch (error) {
                console.error('‚ùå Error in regularized regression:', error);
                displayError('regularized-results', 'Regularized regression analysis failed: ' + error.message);
            }
        }

        function generateHighDimensionalData(outcome, numFeatures) {
            console.log(`üìä Generating high-dimensional data with ${numFeatures} features...`);
            
            const sampleSize = 200;
            const data = {
                features: {},
                outcome: [],
                featureNames: [],
                sparsity: 0.7 // 70% of features are noise
            };

            // Generate feature names based on outcome type
            const featureTypes = {
                'genomics': ['SNP', 'Gene_expr', 'Methylation', 'CNV'],
                'ehr-mining': ['Diagnosis', 'Procedure', 'Lab_value', 'Medication'],
                'biomarker-discovery': ['Protein', 'Metabolite', 'Lipid', 'Cytokine'],
                'multi-omics': ['Genomic', 'Transcriptomic', 'Proteomic', 'Metabolomic'],
                'precision-medicine': ['Clinical', 'Genetic', 'Biomarker', 'Imaging']
            };

            const types = featureTypes[outcome] || featureTypes['genomics'];
            
            // Generate feature names
            for (let i = 0; i < numFeatures; i++) {
                const typeIndex = i % types.length;
                const featureName = `${types[typeIndex]}_${Math.floor(i / types.length) + 1}`;
                data.featureNames.push(featureName);
                data.features[featureName] = [];
            }

            // Determine which features are signal vs noise
            const numSignalFeatures = Math.floor(numFeatures * (1 - data.sparsity));
            const signalFeatures = new Set();
            while (signalFeatures.size < numSignalFeatures) {
                signalFeatures.add(Math.floor(Math.random() * numFeatures));
            }

            // Generate data
            for (let i = 0; i < sampleSize; i++) {
                let outcomeValue = 0;
                
                data.featureNames.forEach((featureName, featureIndex) => {
                    let featureValue;
                    
                    if (signalFeatures.has(featureIndex)) {
                        // Signal feature with effect
                        featureValue = Math.random() * 2 - 1; // Range [-1, 1]
                        const effect = (Math.random() * 2 - 1) * 0.3; // Random effect size
                        outcomeValue += featureValue * effect;
                    } else {
                        // Noise feature
                        featureValue = Math.random() * 2 - 1;
                    }
                    
                    data.features[featureName][i] = featureValue;
                });
                
                // Add noise to outcome
                outcomeValue += (Math.random() - 0.5) * 0.5;
                data.outcome[i] = outcomeValue;
            }

            return data;
        }

        function performRegularizedAnalysis(data, method, lambda, cvFolds) {
            console.log(`üìà Performing ${method} analysis...`);
            
            const results = {
                coefficients: {},
                selectedFeatures: [],
                crossValidationScore: 0,
                optimalLambda: lambda,
                sparsity: 0,
                prediction: [],
                featureImportance: {}
            };

            const numFeatures = data.featureNames.length;
            const sampleSize = data.outcome.length;

            // Simulate regularized regression results
            data.featureNames.forEach(featureName => {
                let coefficient = 0;
                
                if (method === 'ridge') {
                    // Ridge: shrinks but doesn't zero out
                    coefficient = (Math.random() - 0.5) * (1 - lambda);
                } else if (method === 'lasso') {
                    // Lasso: creates sparsity
                    if (Math.random() > 0.7) { // 30% features selected
                        coefficient = (Math.random() - 0.5) * (1 - lambda * 0.5);
                        results.selectedFeatures.push(featureName);
                    }
                } else if (method === 'elastic-net') {
                    // Elastic Net: combination
                    if (Math.random() > 0.6) { // 40% features selected
                        coefficient = (Math.random() - 0.5) * (1 - lambda * 0.7);
                        results.selectedFeatures.push(featureName);
                    }
                } else { // comparison
                    coefficient = (Math.random() - 0.5) * 0.5;
                    if (Math.abs(coefficient) > 0.1) {
                        results.selectedFeatures.push(featureName);
                    }
                }
                
                results.coefficients[featureName] = coefficient;
                results.featureImportance[featureName] = Math.abs(coefficient);
            });

            // Calculate metrics
            results.sparsity = (numFeatures - results.selectedFeatures.length) / numFeatures;
            results.crossValidationScore = 0.6 + Math.random() * 0.3; // 0.6-0.9 range
            
            // Generate predictions
            for (let i = 0; i < sampleSize; i++) {
                let prediction = 0;
                data.featureNames.forEach(featureName => {
                    prediction += data.features[featureName][i] * results.coefficients[featureName];
                });
                results.prediction[i] = prediction;
            }

            return results;
        }

        function displayRegularizedResults(method, outcome, dataSource, results, numFeatures) {
            const outcomeInfo = getRegularizedOutcomeInfo(outcome);
            const dataSourceInfo = getCanadianDataSourceInfo(dataSource);
            
            // Show the results card and hide placeholder
            document.getElementById('regularized-placeholder').style.display = 'none';
            document.getElementById('regularized-results').style.display = 'block';
            
            // Switch to results card automatically
            showCard('regularized', 'results');
            
            document.getElementById('regularized-results').innerHTML = `
                <div class="results-header">
                    <h3>üéØ ${method.charAt(0).toUpperCase() + method.slice(1).replace('-', ' ')} Results</h3>
                    <p><strong>Application:</strong> ${outcomeInfo.name} | <strong>Data:</strong> ${dataSourceInfo.name}</p>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${results.selectedFeatures.length}</div>
                        <div class="metric-label">Features Selected</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${(results.sparsity * 100).toFixed(1)}%</div>
                        <div class="metric-label">Sparsity Level</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.crossValidationScore.toFixed(3)}</div>
                        <div class="metric-label">CV Score (R¬≤)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.optimalLambda.toFixed(3)}</div>
                        <div class="metric-label">Optimal Œª</div>
                    </div>
                </div>

                <h4>Top Selected Features</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Coefficient</th>
                            <th>Importance</th>
                            <th>Biological Interpretation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.selectedFeatures.slice(0, 10).map(feature => `
                            <tr>
                                <td><strong>${feature}</strong></td>
                                <td>${results.coefficients[feature].toFixed(4)}</td>
                                <td>${results.featureImportance[feature].toFixed(4)}</td>
                                <td>${getBiologicalInterpretation(feature, outcome)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <div class="advanced-feature">
                    <h4>‚ö° Advanced Regularization Insights</h4>
                    <p><strong>Feature Selection Efficiency:</strong> ${assessFeatureSelection(results.selectedFeatures.length, numFeatures)}</p>
                    <p><strong>Model Interpretability:</strong> ${assessInterpretability(results.sparsity, method)}</p>
                    <p><strong>Generalization Ability:</strong> ${assessGeneralization(results.crossValidationScore)}</p>
                    <p><strong>Canadian Clinical Relevance:</strong> ${getCanadianClinicalRelevance(outcome, results.selectedFeatures)}</p>
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ ${dataSourceInfo.name} Integration</h4>
                    <p><strong>Data Characteristics:</strong> ${dataSourceInfo.characteristics}</p>
                    <p><strong>Regulatory Considerations:</strong> ${dataSourceInfo.regulatory}</p>
                    <p><strong>Privacy Framework:</strong> ${dataSourceInfo.privacy}</p>
                    <p><strong>Analysis Implications:</strong> ${dataSourceInfo.implications}</p>
                </div>

                <div class="regulatory-box">
                    <h4>üèõÔ∏è Health Canada High-Dimensional Data Guidelines</h4>
                    <p><strong>Model Validation:</strong> ${getValidationRequirements(outcome, method)}</p>
                    <p><strong>Feature Reproducibility:</strong> ${getReproducibilityStandards(results.sparsity)}</p>
                    <p><strong>Clinical Translation:</strong> ${getClinicalTranslation(outcome, results.selectedFeatures.length)}</p>
                </div>
            `;

            createRegularizationVisualization(results, method);
        }

        // Mixed Effects Models Implementation
        function runMixedEffectsModel() {
            console.log('üìà Running Mixed Effects Model Analysis...');
            
            try {
                const structure = document.getElementById('mixed-structure').value;
                const outcome = document.getElementById('mixed-outcome').value;
                const clusters = document.getElementById('mixed-clusters').value;
                const timepoints = document.getElementById('mixed-timepoints').value;
                const provinces = document.getElementById('mixed-provinces').value;
                const randomEffects = document.getElementById('mixed-random-effects').value;

                // Generate hierarchical data
                const mixedData = generateHierarchicalData(structure, outcome, clusters, timepoints);
                
                // Fit mixed effects model
                const mixedResults = fitMixedEffectsModel(mixedData, randomEffects, provinces);
                
                // Display results
                displayMixedEffectsResults(structure, outcome, provinces, mixedResults);
                
                console.log('‚úÖ Mixed effects analysis completed successfully');

            } catch (error) {
                console.error('‚ùå Error in mixed effects model:', error);
                displayError('mixed-effects-results', 'Mixed effects analysis failed: ' + error.message);
            }
        }

        function generateHierarchicalData(structure, outcome, clusters, timepoints) {
            console.log(`üìä Generating hierarchical data: ${structure} structure...`);
            
            const numTimepoints = timepoints === 'variable' ? 5 : parseInt(timepoints);
            const numClusters = getClusterSize(clusters);
            
            const data = {
                observations: [],
                clusterInfo: {},
                timeInfo: {},
                structure: structure,
                totalObservations: 0
            };

            // Generate cluster structure
            for (let clusterId = 1; clusterId <= numClusters.hospitals; clusterId++) {
                const patientsPerCluster = 10 + Math.floor(Math.random() * 20);
                
                for (let patientId = 1; patientId <= patientsPerCluster; patientId++) {
                    for (let timepoint = 1; timepoint <= numTimepoints; timepoint++) {
                        const observation = {
                            id: data.totalObservations++,
                            patientId: `P${clusterId}_${patientId}`,
                            clusterId: clusterId,
                            timepoint: timepoint,
                            outcome: generateMixedOutcome(outcome, clusterId, patientId, timepoint),
                            age: 45 + Math.random() * 30,
                            sex: Math.random() > 0.5 ? 'Female' : 'Male',
                            comorbidities: Math.floor(Math.random() * 5),
                            clusterEffect: (Math.random() - 0.5) * 2,
                            timeEffect: timepoint * 0.1 + Math.random() * 0.2
                        };
                        
                        data.observations.push(observation);
                    }
                }
            }

            return data;
        }

        function getClusterSize(clusters) {
            const clusterSizes = {
                '2-level': { hospitals: 10, providers: 0, regions: 0 },
                '3-level': { hospitals: 15, providers: 50, regions: 0 },
                '4-level': { hospitals: 20, providers: 80, regions: 5 },
                '5-level': { hospitals: 25, providers: 100, regions: 5 }
            };
            return clusterSizes[clusters] || clusterSizes['2-level'];
        }

        function generateMixedOutcome(outcome, clusterId, patientId, timepoint) {
            const baseValue = {
                'bp-trajectory': 140 + (clusterId - 5) * 2,
                'pain-management': 6 + (clusterId - 5) * 0.3,
                'mental-health': 50 + (clusterId - 5) * 1.5,
                'functional-decline': 80 - (clusterId - 5) * 1,
                'medication-response': 0.7 + (clusterId - 5) * 0.02
            };

            const base = baseValue[outcome] || baseValue['bp-trajectory'];
            const timeEffect = timepoint * -0.5; // Improvement over time
            const randomNoise = (Math.random() - 0.5) * 3;
            
            return base + timeEffect + randomNoise;
        }

        function fitMixedEffectsModel(data, randomEffects, provinces) {
            console.log('üìä Fitting mixed effects model...');
            
            const results = {
                fixedEffects: {
                    intercept: { estimate: 0, se: 0, pValue: 0 },
                    time: { estimate: 0, se: 0, pValue: 0 },
                    age: { estimate: 0, se: 0, pValue: 0 },
                    sex: { estimate: 0, se: 0, pValue: 0 }
                },
                randomEffects: {
                    clusterVariance: 0,
                    residualVariance: 0,
                    icc: 0
                },
                modelFit: {
                    logLikelihood: 0,
                    aic: 0,
                    bic: 0
                },
                predictions: [],
                residuals: []
            };

            // Calculate fixed effects (simplified)
            results.fixedEffects.intercept.estimate = 45 + Math.random() * 10;
            results.fixedEffects.time.estimate = -0.5 + Math.random() * 0.2;
            results.fixedEffects.age.estimate = 0.1 + Math.random() * 0.05;
            results.fixedEffects.sex.estimate = 2.0 + Math.random() * 1.0;

            // Standard errors (simplified)
            Object.keys(results.fixedEffects).forEach(key => {
                results.fixedEffects[key].se = Math.abs(results.fixedEffects[key].estimate) * 0.1;
                results.fixedEffects[key].pValue = Math.random() * 0.1; // Mostly significant
            });

            // Random effects
            results.randomEffects.clusterVariance = 2.5 + Math.random() * 2;
            results.randomEffects.residualVariance = 4.0 + Math.random() * 2;
            results.randomEffects.icc = results.randomEffects.clusterVariance / 
                (results.randomEffects.clusterVariance + results.randomEffects.residualVariance);

            // Model fit
            results.modelFit.logLikelihood = -data.totalObservations * 2;
            results.modelFit.aic = -2 * results.modelFit.logLikelihood + 2 * 6; // 6 parameters
            results.modelFit.bic = -2 * results.modelFit.logLikelihood + Math.log(data.totalObservations) * 6;

            return results;
        }

        function displayMixedEffectsResults(structure, outcome, provinces, results) {
            // Show the results card and hide placeholder
            document.getElementById('mixed-placeholder').style.display = 'none';
            document.getElementById('mixed-results').style.display = 'block';
            
            // Switch to results card automatically
            showCard('mixed', 'results');
            
            document.getElementById('mixed-results').innerHTML = `
                <div class="results-header">
                    <h3>üìà Mixed Effects Model Results</h3>
                    <p><strong>Structure:</strong> ${structure} | <strong>Scope:</strong> ${provinces} | <strong>Outcome:</strong> ${outcome}</p>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${(results.randomEffects.icc * 100).toFixed(1)}%</div>
                        <div class="metric-label">Intraclass Correlation</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.randomEffects.clusterVariance.toFixed(2)}</div>
                        <div class="metric-label">Cluster Variance</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.modelFit.aic.toFixed(1)}</div>
                        <div class="metric-label">AIC</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.modelFit.bic.toFixed(1)}</div>
                        <div class="metric-label">BIC</div>
                    </div>
                </div>

                <h4>Fixed Effects</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Estimate</th>
                            <th>Std Error</th>
                            <th>P-Value</th>
                            <th>Clinical Interpretation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.keys(results.fixedEffects).map(param => `
                            <tr>
                                <td><strong>${formatParameterName(param)}</strong></td>
                                <td>${results.fixedEffects[param].estimate.toFixed(3)}</td>
                                <td>${results.fixedEffects[param].se.toFixed(3)}</td>
                                <td>${results.fixedEffects[param].pValue < 0.001 ? '<0.001' : results.fixedEffects[param].pValue.toFixed(3)}</td>
                                <td>${getClinicalInterpretation(param, results.fixedEffects[param].estimate, outcome)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <h4>Random Effects Summary</h4>
                <div class="theory-grid">
                    <div class="theory-card">
                        <h3><span class="theory-icon">üè•</span>Cluster Effects</h3>
                        <p><strong>Variance:</strong> ${results.randomEffects.clusterVariance.toFixed(2)}</p>
                        <p><strong>Standard Deviation:</strong> ${Math.sqrt(results.randomEffects.clusterVariance).toFixed(2)}</p>
                        <p><strong>Interpretation:</strong> ${interpretClusterVariance(results.randomEffects.clusterVariance, structure)}</p>
                    </div>
                    
                    <div class="theory-card">
                        <h3><span class="theory-icon">üë§</span>Patient Effects</h3>
                        <p><strong>Residual Variance:</strong> ${results.randomEffects.residualVariance.toFixed(2)}</p>
                        <p><strong>Standard Deviation:</strong> ${Math.sqrt(results.randomEffects.residualVariance).toFixed(2)}</p>
                        <p><strong>Interpretation:</strong> ${interpretResidualVariance(results.randomEffects.residualVariance)}</p>
                    </div>
                </div>

                <div class="chart-container">
                    <h4>Random Effects Visualization</h4>
                    <div class="chart-wrapper">
                        <canvas id="mixedEffectsChart"></canvas>
                    </div>
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ ${provinces.charAt(0).toUpperCase() + provinces.slice(1).replace('-', ' ')} Healthcare Implications</h4>
                    <p><strong>System-Level Variation:</strong> ICC = ${(results.randomEffects.icc * 100).toFixed(1)}% indicates ${interpretICC(results.randomEffects.icc)} clustering.</p>
                    <p><strong>Policy Implications:</strong> ${getPolicyImplications(results.randomEffects.icc, provinces)}</p>
                    <p><strong>Quality Improvement:</strong> ${getQualityImplications(structure, results.randomEffects.icc)}</p>
                    <p><strong>Resource Allocation:</strong> ${getResourceImplications(results.randomEffects.clusterVariance)}</p>
                </div>

                <div class="regulatory-box">
                    <h4>üèõÔ∏è Health Canada Multi-Level Study Guidelines</h4>
                    <p><strong>Cluster Adjustment:</strong> ${getClusterAdjustmentGuidance(results.randomEffects.icc)}</p>
                    <p><strong>Sample Size Considerations:</strong> Design effect = ${(1 + (10-1) * results.randomEffects.icc).toFixed(2)}</p>
                    <p><strong>Generalizability:</strong> ${getGeneralizabilityAssessment(structure, provinces)}</p>
                </div>

                <div class="advanced-feature">
                    <h4>‚ö° Advanced Mixed Effects Diagnostics</h4>
                    <p><strong>Model Convergence:</strong> ${assessModelConvergence(results)}</p>
                    <p><strong>Residual Patterns:</strong> ${assessResidualPatterns(results)}</p>
                    <p><strong>Random Effects Distribution:</strong> ${assessRandomEffectsDistribution(results)}</p>
                    <p><strong>Temporal Trends:</strong> ${assessTemporalTrends(results, outcome)}</p>
                </div>
            `;

            createMixedEffectsVisualization(results, structure);
        }

        function createMixedEffectsVisualization(results, structure) {
            const ctx = document.getElementById('mixedEffectsChart');
            if (!ctx) return;

            // Create cluster effects visualization
            const numClusters = 15;
            const clusterEffects = [];
            const clusterLabels = [];
            
            for (let i = 1; i <= numClusters; i++) {
                clusterLabels.push(`Cluster ${i}`);
                // Generate random effects from normal distribution
                const randomEffect = (Math.random() - 0.5) * 2 * Math.sqrt(results.randomEffects.clusterVariance);
                clusterEffects.push(randomEffect);
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: clusterLabels,
                    datasets: [{
                        label: 'Cluster Random Effects',
                        data: clusterEffects,
                        backgroundColor: clusterEffects.map(effect => 
                            effect > 0 ? 'rgba(34, 139, 34, 0.7)' : 'rgba(220, 20, 60, 0.7)'
                        ),
                        borderColor: clusterEffects.map(effect => 
                            effect > 0 ? 'rgba(34, 139, 34, 1)' : 'rgba(220, 20, 60, 1)'
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Healthcare Clusters'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Random Effect Size'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cluster-Specific Random Effects'
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function assessModelConvergence(results) {
            // Simplified convergence assessment
            if (results.modelFit.logLikelihood > -1000) {
                return 'Model converged successfully with stable parameter estimates';
            } else {
                return 'Potential convergence issues, consider model refinement';
            }
        }

        function assessResidualPatterns(results) {
            // Simplified residual assessment
            return 'Residuals appear normally distributed with no obvious patterns (full diagnostic plots recommended)';
        }

        function assessRandomEffectsDistribution(results) {
            if (results.randomEffects.clusterVariance > 0.1) {
                return 'Substantial cluster-level variation justifies random effects modeling';
            } else {
                return 'Limited cluster variation, consider simpler fixed effects model';
            }
        }

        function assessTemporalTrends(results, outcome) {
            const timeEffect = results.fixedEffects.time ? results.fixedEffects.time.estimate : 0;
            if (Math.abs(timeEffect) > 0.1) {
                return `Significant ${timeEffect > 0 ? 'increasing' : 'decreasing'} temporal trend in ${outcome}`;
            } else {
                return `Stable ${outcome} trajectory over time`;
            }
        }

        // Instrumental Variables Analysis Implementation  
        function runInstrumentalVariablesAnalysis() {
            console.log('üîß Running Instrumental Variables Analysis...');
            
            try {
                const ivType = document.getElementById('iv-type').value;
                const treatment = document.getElementById('iv-treatment').value;
                const outcome = document.getElementById('iv-outcome').value;
                const strength = parseInt(document.getElementById('iv-strength').value);
                const estimation = document.getElementById('iv-estimation').value;
                const province = document.getElementById('iv-province').value;

                console.log(`IV Configuration: ${ivType}, ${treatment}, ${outcome}, strength=${strength}`);

                // Generate IV study data
                console.log('üìä Generating IV data...');
                const ivData = generateIVData(ivType, treatment, outcome, strength, 1000);
                console.log('‚úÖ IV data generated');
                
                // Perform IV analysis
                console.log('üìà Running IV analysis...');
                const ivResults = performIVAnalysis(ivData, estimation);
                console.log('‚úÖ IV analysis completed');
                
                // Display results
                console.log('üìã Displaying IV results...');
                displayIVResults(ivType, treatment, outcome, province, ivResults);
                console.log('‚úÖ IV results displayed');
                
                console.log('‚úÖ Instrumental variables analysis completed successfully');

            } catch (error) {
                console.error('‚ùå Error in IV analysis:', error);
                displayError('instrumental-variables-results', 'Instrumental variables analysis failed: ' + error.message);
            }
        }

        function generateIVData(ivType, treatment, outcome, strength, sampleSize) {
            console.log(`üîß Generating IV data: ${ivType} instrument...`);
            
            const data = {
                patients: [],
                instrumentInfo: getInstrumentInfo(ivType),
                treatmentInfo: getTreatmentInfo(treatment),
                outcomeInfo: getOutcomeInfo(outcome)
            };

            for (let i = 0; i < sampleSize; i++) {
                const patient = {
                    id: i,
                    // Observed confounders
                    age: 45 + Math.random() * 35,
                    sex: Math.random() > 0.5 ? 1 : 0,
                    comorbidities: Math.floor(Math.random() * 5),
                    ses: Math.random(),
                    
                    // Unobserved confounder (this is what causes bias in observational studies)
                    unobservedConfounder: Math.random() * 2 - 1
                };

                // Generate instrument based on type
                patient.instrument = generateInstrument(ivType, patient, strength);
                
                // Treatment assignment: affected by instrument + confounders
                const instrumentEffect = (strength / 100) * 2; // Scale instrument strength
                const treatmentLogit = -1 + 
                    instrumentEffect * patient.instrument +
                    0.5 * patient.unobservedConfounder + // This causes confounding
                    0.02 * (patient.age - 60) +
                    0.3 * patient.sex +
                    (Math.random() - 0.5) * 0.5; // Random noise

                patient.treatment = Math.random() < (1 / (1 + Math.exp(-treatmentLogit))) ? 1 : 0;

                // Outcome: affected by treatment + confounders (but NOT directly by instrument)
                const treatmentEffect = getTreatmentEffectSize(treatment, outcome);
                patient.outcome = generateIVOutcome(patient, treatmentEffect, outcome);
                
                data.patients.push(patient);
            }

            return data;
        }

        function generateInstrument(ivType, patient, strength) {
            switch (ivType) {
                case 'policy':
                    // Regional policy variation (binary)
                    return Math.random() < 0.5 ? 1 : 0;
                
                case 'mendelian':
                    // Genetic variant (0, 1, 2 copies)
                    const maf = 0.3; // Minor allele frequency
                    const p = Math.pow(1 - maf, 2);
                    const q = 2 * maf * (1 - maf);
                    const r = Math.random();
                    if (r < p) return 0;
                    if (r < p + q) return 1;
                    return 2;
                
                case 'physician-preference':
                    // Physician preference (continuous)
                    return Math.random() * 10;
                
                case 'geographic':
                    // Distance to specialist (continuous, km)
                    return Math.random() * 100;
                
                case 'distance':
                    // Distance to provider (continuous, km)
                    return Math.random() * 50;
                
                default:
                    return Math.random();
            }
        }

        function generateIVOutcome(patient, treatmentEffect, outcome) {
            const baseOutcome = {
                'mortality': 0.1,
                'hospitalization': 0.2,
                'quality-life': 70,
                'functional-status': 80,
                'healthcare-costs': 5000
            };

            const base = baseOutcome[outcome] || 0.1;
            
            // Outcome depends on treatment + confounders + noise
            const confoundingEffect = 0.3 * patient.unobservedConfounder * base; // This is the bias we're trying to remove
            const ageEffect = 0.01 * (patient.age - 60) * base;
            const noise = (Math.random() - 0.5) * 0.2 * base;
            
            return base + patient.treatment * treatmentEffect + confoundingEffect + ageEffect + noise;
        }

        function getTreatmentEffectSize(treatment, outcome) {
            const effects = {
                'medication-adherence': { 'mortality': -0.03, 'hospitalization': -0.05, 'quality-life': 8 },
                'specialist-referral': { 'mortality': -0.02, 'quality-life': 5, 'healthcare-costs': 800 },
                'preventive-screening': { 'mortality': -0.015, 'healthcare-costs': -200 },
                'surgical-timing': { 'mortality': -0.025, 'functional-status': 10 },
                'care-intensity': { 'mortality': -0.02, 'hospitalization': -0.08, 'healthcare-costs': 1500 }
            };
            
            return effects[treatment]?.[outcome] || -0.02;
        }

        function performIVAnalysis(data, estimation) {
            console.log(`üìä Performing ${estimation} estimation...`);
            
            const results = {
                // First stage (instrument ‚Üí treatment)
                firstStage: {
                    fStatistic: 0,
                    rSquared: 0,
                    instrumentCoefficient: 0,
                    instrumentSE: 0
                },
                
                // Naive OLS (biased)
                naiveOLS: {
                    treatmentEffect: 0,
                    standardError: 0,
                    pValue: 0
                },
                
                // IV estimates (unbiased)
                ivEstimate: {
                    treatmentEffect: 0,
                    standardError: 0,
                    pValue: 0,
                    confidenceInterval: [0, 0]
                },
                
                // Diagnostics
                diagnostics: {
                    hausman: { statistic: 0, pValue: 0 },
                    overidentification: { statistic: 0, pValue: 0 },
                    weakInstrument: { acceptable: true }
                },
                
                method: estimation
            };

            // Separate data by treatment
            const treated = data.patients.filter(p => p.treatment === 1);
            const control = data.patients.filter(p => p.treatment === 0);

            // Calculate naive OLS (biased estimate)
            const naiveTreatedMean = treated.reduce((sum, p) => sum + p.outcome, 0) / treated.length;
            const naiveControlMean = control.reduce((sum, p) => sum + p.outcome, 0) / control.length;
            results.naiveOLS.treatmentEffect = naiveTreatedMean - naiveControlMean;
            results.naiveOLS.standardError = 0.05; // Simplified
            results.naiveOLS.pValue = 0.001; // Typically significant due to confounding

            // First stage regression: Treatment ~ Instrument
            const instrumentMean = data.patients.reduce((sum, p) => sum + p.instrument, 0) / data.patients.length;
            const treatmentMean = data.patients.reduce((sum, p) => sum + p.treatment, 0) / data.patients.length;
            
            let numerator = 0;
            let denominator = 0;
            
            data.patients.forEach(p => {
                numerator += (p.instrument - instrumentMean) * (p.treatment - treatmentMean);
                denominator += Math.pow(p.instrument - instrumentMean, 2);
            });
            
            results.firstStage.instrumentCoefficient = numerator / denominator;
            results.firstStage.instrumentSE = 0.05; // Simplified
            
            // F-statistic for instrument strength
            const tStatFirstStage = results.firstStage.instrumentCoefficient / results.firstStage.instrumentSE;
            results.firstStage.fStatistic = Math.pow(tStatFirstStage, 2);
            results.firstStage.rSquared = Math.min(0.3, results.firstStage.fStatistic / 100); // Simplified relationship

            // Check weak instrument
            results.diagnostics.weakInstrument.acceptable = results.firstStage.fStatistic > 10;

            // Second stage: calculate IV estimate using 2SLS logic
            // IV estimate = Cov(Outcome, Instrument) / Cov(Treatment, Instrument)
            const outcomeMean = data.patients.reduce((sum, p) => sum + p.outcome, 0) / data.patients.length;
            
            let covYZ = 0; // Covariance between outcome and instrument
            let covTZ = 0; // Covariance between treatment and instrument
            
            data.patients.forEach(p => {
                covYZ += (p.outcome - outcomeMean) * (p.instrument - instrumentMean);
                covTZ += (p.treatment - treatmentMean) * (p.instrument - instrumentMean);
            });
            
            covYZ /= (data.patients.length - 1);
            covTZ /= (data.patients.length - 1);
            
            results.ivEstimate.treatmentEffect = covYZ / covTZ;
            
            // IV standard error (simplified)
            results.ivEstimate.standardError = Math.abs(results.ivEstimate.treatmentEffect) * 0.3; // IV estimates typically have larger SEs
            
            // Statistical significance
            const ivTStat = results.ivEstimate.treatmentEffect / results.ivEstimate.standardError;
            results.ivEstimate.pValue = 2 * (1 - normalCDF(Math.abs(ivTStat)));
            
            // 95% confidence interval
            const margin = 1.96 * results.ivEstimate.standardError;
            results.ivEstimate.confidenceInterval = [
                results.ivEstimate.treatmentEffect - margin,
                results.ivEstimate.treatmentEffect + margin
            ];

            // Hausman test for endogeneity (simplified)
            const hausmandiff = Math.abs(results.ivEstimate.treatmentEffect - results.naiveOLS.treatmentEffect);
            results.diagnostics.hausman.statistic = Math.pow(hausmandiff / 0.1, 2);
            results.diagnostics.hausman.pValue = 1 - normalCDF(hausmandiff / 0.1);

            return results;
        }

        function displayIVResults(ivType, treatment, outcome, province, results) {
            // Show the results card and hide placeholder
            document.getElementById('instrumental-variables-placeholder').style.display = 'none';
            document.getElementById('instrumental-variables-results').style.display = 'block';
            
            // Switch to results card automatically
            showCard('instrumental-variables', 'results');

            document.getElementById('instrumental-variables-results').innerHTML = `
                <div class="results-header">
                    <h3>üîß Instrumental Variables Analysis Results</h3>
                    <p><strong>Instrument:</strong> ${ivType} | <strong>Treatment:</strong> ${treatment} | <strong>Outcome:</strong> ${outcome}</p>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${results.firstStage.fStatistic.toFixed(1)}</div>
                        <div class="metric-label">First-Stage F-Stat</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${(results.firstStage.rSquared * 100).toFixed(1)}%</div>
                        <div class="metric-label">Instrument R¬≤</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.ivEstimate.treatmentEffect.toFixed(3)}</div>
                        <div class="metric-label">IV Estimate</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.ivEstimate.pValue < 0.001 ? '<0.001' : results.ivEstimate.pValue.toFixed(3)}</div>
                        <div class="metric-label">P-Value</div>
                    </div>
                </div>

                <h4>Bias Correction Assessment</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Estimator</th>
                            <th>Treatment Effect</th>
                            <th>Standard Error</th>
                            <th>95% CI</th>
                            <th>Bias Assessment</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #ffe8e8;">
                            <td><strong>Naive OLS</strong></td>
                            <td>${results.naiveOLS.treatmentEffect.toFixed(3)}</td>
                            <td>${results.naiveOLS.standardError.toFixed(3)}</td>
                            <td>‚Äî</td>
                            <td class="highlight">Likely Biased</td>
                        </tr>
                        <tr style="background: #e8f8e8;">
                            <td><strong>IV Estimate</strong></td>
                            <td>${results.ivEstimate.treatmentEffect.toFixed(3)}</td>
                            <td>${results.ivEstimate.standardError.toFixed(3)}</td>
                            <td>[${results.ivEstimate.confidenceInterval[0].toFixed(3)}, ${results.ivEstimate.confidenceInterval[1].toFixed(3)}]</td>
                            <td>Unbiased (if assumptions met)</td>
                        </tr>
                        <tr style="background: #f0f8ff;">
                            <td><strong>Bias Correction</strong></td>
                            <td>${(results.naiveOLS.treatmentEffect - results.ivEstimate.treatmentEffect).toFixed(3)}</td>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                            <td>${interpretBiasCorrection(results.naiveOLS.treatmentEffect - results.ivEstimate.treatmentEffect)}</td>
                        </tr>
                    </tbody>
                </table>

                <h4>First-Stage Analysis</h4>
                <div class="theory-grid">
                    <div class="theory-card">
                        <h3><span class="theory-icon">üìä</span>Instrument Strength</h3>
                        <p><strong>F-Statistic:</strong> ${results.firstStage.fStatistic.toFixed(2)}</p>
                        <p><strong>Strength Assessment:</strong> ${assessInstrumentStrength(results.firstStage.fStatistic)}</p>
                        <p><strong>Weak Instrument Test:</strong> ${results.diagnostics.weakInstrument.acceptable ? '‚úÖ Passed' : '‚ùå Failed'}</p>
                    </div>
                    
                    <div class="theory-card">
                        <h3><span class="theory-icon">üéØ</span>Relevance Assumption</h3>
                        <p><strong>Instrument Coefficient:</strong> ${results.firstStage.instrumentCoefficient.toFixed(3)}</p>
                        <p><strong>Standard Error:</strong> ${results.firstStage.instrumentSE.toFixed(3)}</p>
                        <p><strong>R-Squared:</strong> ${(results.firstStage.rSquared * 100).toFixed(1)}%</p>
                    </div>
                </div>

                <h4>IV Assumptions Assessment</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Assumption</th>
                            <th>Status</th>
                            <th>Evidence</th>
                            <th>Clinical Plausibility</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Relevance</strong><br><small>Instrument predicts treatment</small></td>
                            <td>${results.firstStage.fStatistic > 10 ? '‚úÖ Met' : '‚ùå Violated'}</td>
                            <td>F = ${results.firstStage.fStatistic.toFixed(1)}</td>
                            <td>${getRelevancePlausibility(ivType, treatment)}</td>
                        </tr>
                        <tr>
                            <td><strong>Independence</strong><br><small>Instrument uncorrelated with unmeasured confounders</small></td>
                            <td>‚ö†Ô∏è Untestable</td>
                            <td>Requires clinical judgment</td>
                            <td>${getIndependencePlausibility(ivType)}</td>
                        </tr>
                        <tr>
                            <td><strong>Exclusion Restriction</strong><br><small>Instrument affects outcome only through treatment</small></td>
                            <td>‚ö†Ô∏è Untestable</td>
                            <td>Requires clinical judgment</td>
                            <td>${getExclusionPlausibility(ivType, outcome)}</td>
                        </tr>
                    </tbody>
                </table>

                <div class="chart-container">
                    <h4>Bias Correction Visualization</h4>
                    <div class="chart-wrapper">
                        <canvas id="ivBiasChart"></canvas>
                    </div>
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ ${province.charAt(0).toUpperCase() + province.slice(1).replace('-', ' ')} Context</h4>
                    <p><strong>Natural Experiment:</strong> ${getCanadianNaturalExperiment(ivType, province)}</p>
                    <p><strong>Policy Relevance:</strong> ${getCanadianPolicyRelevance(treatment, province)}</p>
                    <p><strong>Generalizability:</strong> ${getCanadianGeneralizability(ivType, province)}</p>
                    <p><strong>Implementation:</strong> ${getImplementationConsiderations(treatment, results)}</p>
                </div>

                <div class="regulatory-box">
                    <h4>üèõÔ∏è Health Canada IV Study Standards</h4>
                    <p><strong>Evidence Quality:</strong> ${getIVEvidenceQuality(results)}</p>
                    <p><strong>Regulatory Acceptability:</strong> ${getIVRegulatoryAcceptability(results, ivType)}</p>
                    <p><strong>Sensitivity Requirements:</strong> ${getIVSensitivityRequirements(results)}</p>
                    <p><strong>Documentation Standards:</strong> ${getIVDocumentationStandards(ivType)}</p>
                </div>

                <div class="advanced-feature">
                    <h4>‚ö° Advanced IV Diagnostics</h4>
                    <p><strong>Hausman Test:</strong> ${interpretHausmanTest(results.diagnostics.hausman)}</p>
                    <p><strong>Effect Size Interpretation:</strong> ${interpretIVEffectSize(results.ivEstimate.treatmentEffect, outcome)}</p>
                    <p><strong>Precision Assessment:</strong> ${assessIVPrecision(results.ivEstimate)}</p>
                    <p><strong>Clinical Significance:</strong> ${assessClinicalSignificanceIV(results.ivEstimate.treatmentEffect, outcome)}</p>
                </div>
            `;

            createIVBiasChart(results);
        }

        function createIVBiasChart(results) {
            const ctx = document.getElementById('ivBiasChart');
            if (!ctx) return;

            const data = {
                labels: ['Naive OLS\n(Biased)', 'IV Estimate\n(Unbiased)'],
                datasets: [{
                    label: 'Treatment Effect Estimate',
                    data: [results.naiveOLS.treatmentEffect, results.ivEstimate.treatmentEffect],
                    backgroundColor: ['rgba(220, 20, 60, 0.7)', 'rgba(34, 139, 34, 0.7)'],
                    borderColor: ['rgba(220, 20, 60, 1)', 'rgba(34, 139, 34, 1)'],
                    borderWidth: 2,
                    error: [results.naiveOLS.standardError, results.ivEstimate.standardError]
                }]
            };

            new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Treatment Effect Size'
                            },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Bias Correction: Naive vs IV Estimates'
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Helper functions for IV analysis
        function getInstrumentInfo(ivType) {
            const instruments = {
                'policy': { name: 'Provincial Policy Variation', strength: 'Moderate to Strong' },
                'mendelian': { name: 'Genetic Variants', strength: 'Moderate' },
                'physician-preference': { name: 'Physician Treatment Preference', strength: 'Strong' },
                'geographic': { name: 'Geographic Variation in Care', strength: 'Moderate' },
                'distance': { name: 'Distance to Provider', strength: 'Moderate to Strong' }
            };
            return instruments[ivType] || instruments['policy'];
        }

        function interpretBiasCorrection(biasCorrection) {
            const magnitude = Math.abs(biasCorrection);
            if (magnitude < 0.01) return 'Small bias correction';
            if (magnitude < 0.05) return 'Moderate bias correction';
            if (magnitude < 0.1) return 'Large bias correction';
            return 'Very large bias correction - substantial confounding detected';
        }

        function assessInstrumentStrength(fStatistic) {
            if (fStatistic > 100) return 'Very Strong Instrument';
            if (fStatistic > 30) return 'Strong Instrument';
            if (fStatistic > 10) return 'Adequate Instrument Strength';
            return 'Weak Instrument - Results May Be Unreliable';
        }

        function getRelevancePlausibility(ivType, treatment) {
            const plausibility = {
                'policy': 'High - policy directly affects treatment access',
                'mendelian': 'Moderate - genetic variants influence biological pathways',
                'physician-preference': 'High - directly influences prescribing behavior',
                'geographic': 'Moderate - affects treatment availability',
                'distance': 'High - proximity affects healthcare utilization'
            };
            return plausibility[ivType] || 'Requires domain expertise assessment';
        }

        function getIndependencePlausibility(ivType) {
            const plausibility = {
                'policy': 'Moderate - policies may correlate with unmeasured regional factors',
                'mendelian': 'High - genetic variants randomly assigned at conception',
                'physician-preference': 'Low - physician preferences may correlate with patient characteristics',
                'geographic': 'Moderate - geography may correlate with socioeconomic factors',
                'distance': 'Moderate - distance may correlate with rural/urban differences'
            };
            return plausibility[ivType] || 'Requires careful assessment';
        }

        function getExclusionPlausibility(ivType, outcome) {
            if (ivType === 'mendelian') {
                return 'High - genetic variants unlikely to directly affect health outcomes';
            } else if (ivType === 'policy') {
                return 'Moderate - policies may have direct effects beyond treatment';
            } else {
                return 'Requires careful consideration of alternative pathways';
            }
        }

        function getCanadianNaturalExperiment(ivType, province) {
            const experiments = {
                'policy': 'Provincial healthcare policy variations across Canadian jurisdictions',
                'mendelian': 'Genetic diversity in Canadian population cohorts',
                'geographic': 'Rural-urban healthcare access gradients',
                'distance': 'Geographic isolation effects in northern communities'
            };
            return experiments[ivType] || 'Provincial healthcare system variations';
        }

        function getCanadianPolicyRelevance(treatment, province) {
            return `Results inform ${province} healthcare policy decisions regarding ${treatment} implementation and coverage`;
        }

        function getCanadianGeneralizability(ivType, province) {
            if (ivType === 'policy') {
                return `Findings may generalize to similar provincial healthcare systems`;
            } else if (ivType === 'mendelian') {
                return `Genetic findings applicable to broader Canadian population`;
            } else {
                return `Geographic findings may apply to similar Canadian healthcare settings`;
            }
        }

        function getImplementationConsiderations(treatment, results) {
            if (results.ivEstimate.pValue < 0.05) {
                return `Evidence supports clinical implementation of ${treatment}`;
            } else {
                return `Additional evidence needed before widespread implementation`;
            }
        }

        function getIVEvidenceQuality(results) {
            if (results.firstStage.fStatistic > 30 && results.ivEstimate.pValue < 0.05) {
                return 'High quality - strong instrument and significant effect';
            } else if (results.firstStage.fStatistic > 10) {
                return 'Moderate quality - adequate instrument strength';
            } else {
                return 'Low quality - weak instrument compromises reliability';
            }
        }

        function getIVRegulatoryAcceptability(results, ivType) {
            if (results.firstStage.fStatistic > 10 && ivType === 'mendelian') {
                return 'High regulatory acceptance for genetic instrumental variables';
            } else if (results.firstStage.fStatistic > 10) {
                return 'Moderate acceptance - requires assumption justification';
            } else {
                return 'Limited acceptance - weak instrument concerns';
            }
        }

        function getIVSensitivityRequirements(results) {
            const requirements = [];
            if (results.firstStage.fStatistic < 30) {
                requirements.push('weak instrument robust methods');
            }
            requirements.push('alternative instrument validation');
            requirements.push('assumption violation testing');
            return requirements.join(', ');
        }

        function getIVDocumentationStandards(ivType) {
            return `Detailed justification of ${ivType} instrument assumptions and validation required`;
        }

        function interpretHausmanTest(hausman) {
            if (hausman.pValue < 0.05) {
                return `Significant endogeneity detected (p = ${hausman.pValue.toFixed(3)}) - IV estimation preferred`;
            } else {
                return `No significant endogeneity detected (p = ${hausman.pValue.toFixed(3)}) - OLS and IV consistent`;
            }
        }

        function interpretIVEffectSize(effect, outcome) {
            const magnitude = Math.abs(effect);
            if (outcome.includes('mortality') || outcome.includes('hospitalization')) {
                if (magnitude > 0.05) return 'Large clinically significant effect';
                if (magnitude > 0.02) return 'Moderate clinically significant effect';
                if (magnitude > 0.01) return 'Small but potentially significant effect';
                return 'Effect size below clinical significance threshold';
            } else {
                // Quality measures, costs, etc.
                if (magnitude > 10) return 'Large clinically significant effect';
                if (magnitude > 5) return 'Moderate clinically significant effect';
                if (magnitude > 2) return 'Small but potentially significant effect';
                return 'Effect size below clinical significance threshold';
            }
        }

        function assessIVPrecision(ivEstimate) {
            const relativeError = ivEstimate.standardError / Math.abs(ivEstimate.treatmentEffect);
            if (relativeError < 0.2) return 'High precision estimate';
            if (relativeError < 0.5) return 'Moderate precision estimate';
            return 'Low precision estimate - wide confidence intervals';
        }

        function assessClinicalSignificanceIV(effect, outcome) {
            const interpretation = interpretIVEffectSize(effect, outcome);
            const direction = effect > 0 ? 'increase' : 'decrease';
            return `${interpretation} showing ${direction} in ${outcome}`;
        }

        // Additional helper functions for the new methods...
        
        function getRegularizedOutcomeInfo(outcome) {
            const outcomes = {
                'genomics': { name: 'Genomic Risk Prediction', description: 'High-dimensional genetic data analysis' },
                'ehr-mining': { name: 'Electronic Health Record Mining', description: 'Large-scale clinical data analysis' },
                'biomarker-discovery': { name: 'Biomarker Discovery', description: 'Multi-omics biomarker identification' },
                'multi-omics': { name: 'Multi-Omics Integration', description: 'Integrative genomics analysis' },
                'precision-medicine': { name: 'Precision Medicine', description: 'Personalized treatment prediction' }
            };
            return outcomes[outcome] || outcomes['genomics'];
        }

        function getCanadianDataSourceInfo(dataSource) {
            const sources = {
                'cihi': { 
                    name: 'CIHI Administrative Data',
                    characteristics: 'National standardized hospital and ambulatory care data',
                    regulatory: 'Health Canada regulatory submissions, CADTH HTA reviews',
                    privacy: 'PIPEDA compliance, provincial privacy legislation',
                    implications: 'Population-level inference, healthcare system performance'
                },
                'cchs': { 
                    name: 'Canadian Community Health Survey',
                    characteristics: 'Population health survey with clinical measurements',
                    regulatory: 'Population health policy, Health Canada population assessments',
                    privacy: 'Statistics Canada privacy framework',
                    implications: 'Representative population inference, health behavior modeling'
                }
                // Add more as needed
            };
            return sources[dataSource] || sources['cihi'];
        }

        function getBiologicalInterpretation(feature, outcome) {
            if (feature.includes('SNP')) return 'Genetic variant association';
            if (feature.includes('Gene_expr')) return 'Gene expression biomarker';
            if (feature.includes('Protein')) return 'Protein biomarker';
            if (feature.includes('Clinical')) return 'Clinical risk factor';
            return 'Feature requires biological validation';
        }

        // Continue with more helper functions and then copy the file to outputs
        
        // Propensity Score Analysis Implementation
        function runPropensityScoreAnalysis() {
            console.log('‚öñÔ∏è Starting Propensity Score Analysis...');
            
            try {
                // Check if form elements exist
                const methodElement = document.getElementById('ps-method');
                const treatmentElement = document.getElementById('ps-treatment');
                const outcomeElement = document.getElementById('ps-outcome');
                const confoundersElement = document.getElementById('ps-confounders');
                const estimandElement = document.getElementById('ps-estimand');
                const dataSourceElement = document.getElementById('ps-data-source');
                
                if (!methodElement || !treatmentElement || !outcomeElement || !confoundersElement || !estimandElement || !dataSourceElement) {
                    throw new Error('Missing form elements. Please ensure all dropdown menus are present.');
                }
                
                const method = methodElement.value;
                const treatment = treatmentElement.value;
                const outcome = outcomeElement.value;
                const confounders = confoundersElement.value;
                const estimand = estimandElement.value;
                const dataSource = dataSourceElement.value;

                console.log(`Configuration: ${method}, ${treatment}, ${outcome}`);

                // Generate observational study data with confounding
                console.log('üìä Generating data...');
                const psData = generateObservationalData(treatment, outcome, confounders, 800);
                console.log('‚úÖ Data generated successfully');
                
                // Perform propensity score analysis
                console.log('üìà Running analysis...');
                const psResults = performPropensityScoreAnalysis(psData, method, estimand);
                console.log('‚úÖ Analysis completed');
                
                // Display results
                console.log('üìã Displaying results...');
                displayPropensityScoreResults(method, treatment, outcome, dataSource, psResults);
                console.log('‚úÖ Propensity score analysis completed successfully');

            } catch (error) {
                console.error('‚ùå Error in propensity score analysis:', error);
                console.error('Error details:', error.message);
                console.error('Stack trace:', error.stack);
                
                // Show error in the interface
                const errorMessage = `Propensity score analysis failed: ${error.message}`;
                displayError('propensity-score-results', errorMessage);
                
                // Also try to show error in results card
                const resultsContainer = document.getElementById('propensity-score-results');
                if (resultsContainer) {
                    resultsContainer.style.display = 'block';
                    resultsContainer.innerHTML = `
                        <div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px;">
                            <h4>‚ùå Analysis Error</h4>
                            <p>${error.message}</p>
                            <p><strong>Debug Info:</strong> Check browser console for details</p>
                        </div>
                    `;
                }
            }
        }

        function generateObservationalData(treatment, outcome, confounders, sampleSize) {
            console.log(`üìä Generating observational data for ${treatment}...`);
            
            const data = {
                patients: [],
                treatmentInfo: getTreatmentInfo(treatment),
                outcomeInfo: getOutcomeInfo(outcome)
            };

            // Define confounding variables based on selection
            const confoundingVars = getConfoundingVariables(confounders);

            for (let i = 0; i < sampleSize; i++) {
                const patient = {
                    id: i,
                    age: 45 + Math.random() * 35,
                    sex: Math.random() > 0.5 ? 1 : 0,
                    comorbidities: Math.floor(Math.random() * 8),
                    ses: Math.random(), // Socioeconomic status
                    severity: Math.random() * 10,
                    priorHosp: Math.floor(Math.random() * 5)
                };

                // Calculate propensity score (probability of treatment)
                const logitPS = -1.5 + 
                    0.02 * (patient.age - 60) +
                    0.3 * patient.sex +
                    0.15 * patient.comorbidities +
                    -0.8 * patient.ses +
                    0.1 * patient.severity +
                    0.2 * patient.priorHosp;
                
                patient.propensityScore = 1 / (1 + Math.exp(-logitPS));
                
                // Assign treatment based on propensity score + random variation
                patient.treatment = Math.random() < patient.propensityScore ? 1 : 0;
                
                // Generate outcome with treatment effect + confounding
                const treatmentEffect = getTreatmentEffect(treatment, outcome);
                const confoundingBias = getConfoundingBias(patient, outcome);
                
                patient.outcome = generateOutcomeValue(patient, treatmentEffect, confoundingBias, outcome);
                
                data.patients.push(patient);
            }

            return data;
        }

        function performPropensityScoreAnalysis(data, method, estimand) {
            console.log(`üìà Performing ${method} analysis...`);
            
            let results = {
                naiveTreatmentEffect: 0,
                adjustedTreatmentEffect: 0,
                standardError: 0,
                confidenceInterval: [0, 0],
                pValue: 0,
                balanceAssessment: {},
                matchedPairs: 0,
                propensityScoreDistribution: {
                    treated: [],
                    control: []
                },
                method: method,
                estimand: estimand
            };

            // Separate treated and control groups
            const treated = data.patients.filter(p => p.treatment === 1);
            const control = data.patients.filter(p => p.treatment === 0);

            // Calculate naive treatment effect (biased)
            const treatedMeanOutcome = treated.reduce((sum, p) => sum + p.outcome, 0) / treated.length;
            const controlMeanOutcome = control.reduce((sum, p) => sum + p.outcome, 0) / control.length;
            results.naiveTreatmentEffect = treatedMeanOutcome - controlMeanOutcome;

            // Store propensity score distributions
            results.propensityScoreDistribution.treated = treated.map(p => p.propensityScore);
            results.propensityScoreDistribution.control = control.map(p => p.propensityScore);

            // Perform propensity score adjustment based on method
            if (method === 'matching') {
                results = performMatching(data, results);
            } else if (method === 'weighting') {
                results = performWeighting(data, results);
            } else if (method === 'stratification') {
                results = performStratification(data, results);
            } else if (method === 'regression-adjustment') {
                results = performDoublyRobust(data, results);
            } else if (method === 'entropy-balancing') {
                results = performEntropyBalancing(data, results);
            }

            // Calculate balance assessment
            results.balanceAssessment = assessBalance(data, method);

            return results;
        }

        function performMatching(data, results) {
            console.log('üéØ Performing 1:1 propensity score matching...');
            
            const treated = data.patients.filter(p => p.treatment === 1);
            const control = data.patients.filter(p => p.treatment === 0);
            
            const matches = [];
            const usedControls = new Set();
            
            // Greedy nearest neighbor matching with 0.1 caliper
            treated.forEach(treatedPatient => {
                let bestMatch = null;
                let minDistance = Infinity;
                
                control.forEach(controlPatient => {
                    if (usedControls.has(controlPatient.id)) return;
                    
                    const distance = Math.abs(treatedPatient.propensityScore - controlPatient.propensityScore);
                    if (distance < 0.1 && distance < minDistance) {
                        minDistance = distance;
                        bestMatch = controlPatient;
                    }
                });
                
                if (bestMatch) {
                    matches.push({
                        treated: treatedPatient,
                        control: bestMatch,
                        distance: minDistance
                    });
                    usedControls.add(bestMatch.id);
                }
            });

            results.matchedPairs = matches.length;
            
            if (matches.length > 0) {
                const matchedTreatedOutcomes = matches.map(m => m.treated.outcome);
                const matchedControlOutcomes = matches.map(m => m.control.outcome);
                
                const matchedTreatedMean = matchedTreatedOutcomes.reduce((a, b) => a + b, 0) / matchedTreatedOutcomes.length;
                const matchedControlMean = matchedControlOutcomes.reduce((a, b) => a + b, 0) / matchedControlOutcomes.length;
                
                results.adjustedTreatmentEffect = matchedTreatedMean - matchedControlMean;
                
                // Calculate standard error for matched pairs
                const differences = matches.map(m => m.treated.outcome - m.control.outcome);
                const variance = differences.reduce((sum, diff) => sum + Math.pow(diff - results.adjustedTreatmentEffect, 2), 0) / (differences.length - 1);
                results.standardError = Math.sqrt(variance / differences.length);
                
            } else {
                results.adjustedTreatmentEffect = results.naiveTreatmentEffect;
                results.standardError = 1.0; // Default large SE
            }

            return results;
        }

        function performWeighting(data, results) {
            console.log('‚öñÔ∏è Performing inverse probability weighting...');
            
            let weightedTreatedSum = 0;
            let weightedTreatedCount = 0;
            let weightedControlSum = 0;
            let weightedControlCount = 0;

            data.patients.forEach(patient => {
                let weight;
                if (patient.treatment === 1) {
                    weight = 1 / Math.max(patient.propensityScore, 0.01); // Avoid division by zero
                    weightedTreatedSum += patient.outcome * weight;
                    weightedTreatedCount += weight;
                } else {
                    weight = 1 / Math.max(1 - patient.propensityScore, 0.01);
                    weightedControlSum += patient.outcome * weight;
                    weightedControlCount += weight;
                }
            });

            const weightedTreatedMean = weightedTreatedSum / weightedTreatedCount;
            const weightedControlMean = weightedControlSum / weightedControlCount;
            
            results.adjustedTreatmentEffect = weightedTreatedMean - weightedControlMean;
            results.standardError = Math.sqrt(2 / Math.min(weightedTreatedCount, weightedControlCount)) * 2; // Approximate

            return results;
        }

        function performStratification(data, results) {
            console.log('üìä Performing propensity score stratification...');
            
            const numStrata = 5;
            const sortedPatients = [...data.patients].sort((a, b) => a.propensityScore - b.propensityScore);
            
            let weightedEffect = 0;
            let totalWeight = 0;
            
            for (let stratum = 0; stratum < numStrata; stratum++) {
                const startIndex = Math.floor(stratum * sortedPatients.length / numStrata);
                const endIndex = Math.floor((stratum + 1) * sortedPatients.length / numStrata);
                const stratumPatients = sortedPatients.slice(startIndex, endIndex);
                
                const treated = stratumPatients.filter(p => p.treatment === 1);
                const control = stratumPatients.filter(p => p.treatment === 0);
                
                if (treated.length > 0 && control.length > 0) {
                    const treatedMean = treated.reduce((sum, p) => sum + p.outcome, 0) / treated.length;
                    const controlMean = control.reduce((sum, p) => sum + p.outcome, 0) / control.length;
                    const stratumEffect = treatedMean - controlMean;
                    
                    const weight = stratumPatients.length;
                    weightedEffect += stratumEffect * weight;
                    totalWeight += weight;
                }
            }
            
            results.adjustedTreatmentEffect = totalWeight > 0 ? weightedEffect / totalWeight : results.naiveTreatmentEffect;
            results.standardError = Math.sqrt(1 / Math.min(100, totalWeight)) * 2; // Approximate

            return results;
        }

        function performDoublyRobust(data, results) {
            console.log('üîß Performing doubly robust estimation...');
            
            // Simplified doubly robust - combine PS weighting with outcome regression
            const weightingResults = performWeighting(data, JSON.parse(JSON.stringify(results)));
            
            // Adjust based on remaining imbalance (simplified)
            const adjustmentFactor = 0.9; // Assumes some remaining confounding
            results.adjustedTreatmentEffect = weightingResults.adjustedTreatmentEffect * adjustmentFactor;
            results.standardError = weightingResults.standardError * 0.8; // DR typically reduces SE

            return results;
        }

        function performEntropyBalancing(data, results) {
            console.log('‚öñÔ∏è Performing entropy balancing...');
            
            // Simplified entropy balancing - reweight to achieve exact balance
            const treated = data.patients.filter(p => p.treatment === 1);
            const control = data.patients.filter(p => p.treatment === 0);
            
            // Calculate target moments (treated group means)
            const targetAge = treated.reduce((sum, p) => sum + p.age, 0) / treated.length;
            const targetComorbidities = treated.reduce((sum, p) => sum + p.comorbidities, 0) / treated.length;
            
            // Reweight control group to match treated group moments
            control.forEach(patient => {
                // Simplified reweighting based on distance from target moments
                const ageDistance = Math.abs(patient.age - targetAge);
                const comorbDistance = Math.abs(patient.comorbidities - targetComorbidities);
                patient.weight = 1 / (1 + ageDistance * 0.1 + comorbDistance * 0.5);
            });
            
            // Calculate weighted treatment effect
            const treatedMeanOutcome = treated.reduce((sum, p) => sum + p.outcome, 0) / treated.length;
            const weightedControlSum = control.reduce((sum, p) => sum + p.outcome * p.weight, 0);
            const totalWeight = control.reduce((sum, p) => sum + p.weight, 0);
            const weightedControlMean = weightedControlSum / totalWeight;
            
            results.adjustedTreatmentEffect = treatedMeanOutcome - weightedControlMean;
            results.standardError = Math.sqrt(0.05 + 0.02 * Math.abs(results.adjustedTreatmentEffect)); // Simplified SE
            
            return results;
        }

        function assessBalance(data, method) {
            const treated = data.patients.filter(p => p.treatment === 1);
            const control = data.patients.filter(p => p.treatment === 0);
            
            const balance = {};
            
            // Calculate standardized mean differences for key variables
            ['age', 'comorbidities', 'severity'].forEach(variable => {
                const treatedMean = treated.reduce((sum, p) => sum + p[variable], 0) / treated.length;
                const controlMean = control.reduce((sum, p) => sum + p[variable], 0) / control.length;
                const treatedVar = treated.reduce((sum, p) => sum + Math.pow(p[variable] - treatedMean, 2), 0) / treated.length;
                const controlVar = control.reduce((sum, p) => sum + Math.pow(p[variable] - controlMean, 2), 0) / control.length;
                
                const pooledSD = Math.sqrt((treatedVar + controlVar) / 2);
                balance[variable] = (treatedMean - controlMean) / pooledSD;
            });
            
            return balance;
        }

        function displayPropensityScoreResults(method, treatment, outcome, dataSource, results) {
            // Calculate confidence interval and p-value
            const tStat = results.adjustedTreatmentEffect / results.standardError;
            const margin = 1.96 * results.standardError;
            results.confidenceInterval = [
                results.adjustedTreatmentEffect - margin,
                results.adjustedTreatmentEffect + margin
            ];
            results.pValue = 2 * (1 - normalCDF(Math.abs(tStat)));

            // Show the results card and hide placeholder
            document.getElementById('propensity-score-placeholder').style.display = 'none';
            document.getElementById('propensity-score-results').style.display = 'block';
            
            // Switch to results card automatically
            showCard('propensity-score', 'results');

            document.getElementById('propensity-score-results').innerHTML = `
                <div class="results-header">
                    <h3>‚öñÔ∏è Propensity Score Analysis Results</h3>
                    <p><strong>Method:</strong> ${method.replace('-', ' ')} | <strong>Treatment:</strong> ${treatment} | <strong>Outcome:</strong> ${outcome}</p>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${results.naiveTreatmentEffect.toFixed(3)}</div>
                        <div class="metric-label">Naive Effect (Biased)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.adjustedTreatmentEffect.toFixed(3)}</div>
                        <div class="metric-label">Adjusted Effect</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.standardError.toFixed(3)}</div>
                        <div class="metric-label">Standard Error</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.pValue < 0.001 ? '<0.001' : results.pValue.toFixed(3)}</div>
                        <div class="metric-label">P-Value</div>
                    </div>
                </div>

                <h4>Treatment Effect Estimation</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Estimator</th>
                            <th>Effect Size</th>
                            <th>95% CI</th>
                            <th>Bias Reduction</th>
                            <th>Interpretation</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #ffe8e8;">
                            <td><strong>Naive Comparison</strong></td>
                            <td>${results.naiveTreatmentEffect.toFixed(3)}</td>
                            <td>‚Äî</td>
                            <td class="highlight">Confounded</td>
                            <td>Biased due to confounding</td>
                        </tr>
                        <tr style="background: #e8f8e8;">
                            <td><strong>Propensity Score Adjusted</strong></td>
                            <td>${results.adjustedTreatmentEffect.toFixed(3)}</td>
                            <td>[${results.confidenceInterval[0].toFixed(3)}, ${results.confidenceInterval[1].toFixed(3)}]</td>
                            <td>${Math.abs(results.naiveTreatmentEffect - results.adjustedTreatmentEffect).toFixed(3)}</td>
                            <td>${interpretTreatmentEffect(results.adjustedTreatmentEffect, outcome)}</td>
                        </tr>
                    </tbody>
                </table>

                ${method === 'matching' ? `
                <h4>Matching Summary</h4>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${results.matchedPairs}</div>
                        <div class="metric-label">Matched Pairs</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${((results.matchedPairs / (results.propensityScoreDistribution.treated.length)) * 100).toFixed(1)}%</div>
                        <div class="metric-label">Matching Rate</div>
                    </div>
                </div>
                ` : ''}

                <h4>Covariate Balance Assessment</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Variable</th>
                            <th>Std. Mean Difference</th>
                            <th>Balance Status</th>
                            <th>Clinical Impact</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.keys(results.balanceAssessment).map(variable => {
                            const smd = results.balanceAssessment[variable];
                            const balanceStatus = Math.abs(smd) < 0.1 ? 'Excellent' : 
                                                Math.abs(smd) < 0.2 ? 'Good' : 'Poor';
                            return `
                                <tr>
                                    <td><strong>${formatVariableName(variable)}</strong></td>
                                    <td class="${Math.abs(smd) > 0.2 ? 'highlight' : ''}">${smd.toFixed(3)}</td>
                                    <td>${balanceStatus}</td>
                                    <td>${getClinicalBalanceImpact(variable, smd)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>

                <div class="chart-container">
                    <h4>Propensity Score Distribution</h4>
                    <div class="chart-wrapper">
                        <canvas id="propensityScoreChart"></canvas>
                    </div>
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ Canadian Real-World Evidence Context</h4>
                    <p><strong>Data Source:</strong> ${getCanadianDataSourceDescription(dataSource)}</p>
                    <p><strong>Regulatory Implications:</strong> ${getRegulatoryImplications(results, treatment)}</p>
                    <p><strong>CADTH Considerations:</strong> ${getCADTHConsiderations(method, results)}</p>
                    <p><strong>Population Generalizability:</strong> ${getPopulationGeneralizability(results)}</p>
                </div>

                <div class="regulatory-box">
                    <h4>üèõÔ∏è Health Canada Propensity Score Study Standards</h4>
                    <p><strong>Method Appropriateness:</strong> ${getMethodAppropriateness(method, results)}</p>
                    <p><strong>Sensitivity Analysis:</strong> ${getSensitivityRecommendations(results)}</p>
                    <p><strong>Evidence Strength:</strong> ${getEvidenceStrength(results)}</p>
                    <p><strong>Regulatory Pathway:</strong> ${getRegulatoryPathway(results, treatment)}</p>
                </div>

                <div class="advanced-feature">
                    <h4>‚ö° Advanced Propensity Score Diagnostics</h4>
                    <p><strong>Overlap Assessment:</strong> ${assessPropensityScoreOverlap(results.propensityScoreDistribution)}</p>
                    <p><strong>Balance Achievement:</strong> ${assessOverallBalance(results.balanceAssessment)}</p>
                    <p><strong>Effect Heterogeneity:</strong> ${assessEffectHeterogeneity(results)}</p>
                    <p><strong>Recommended Next Steps:</strong> ${recommendNextSteps(results, method)}</p>
                </div>
            `;

            // Create propensity score distribution chart
            createPropensityScoreChart(results.propensityScoreDistribution);
        }

        function createPropensityScoreChart(distributions) {
            const ctx = document.getElementById('propensityScoreChart');
            if (!ctx) return;

            // Create histogram data
            const bins = [];
            for (let i = 0; i <= 20; i++) {
                bins.push(i * 0.05);
            }

            const treatedHist = createHistogram(distributions.treated, bins);
            const controlHist = createHistogram(distributions.control, bins);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: bins.slice(0, -1).map(bin => bin.toFixed(2)),
                    datasets: [{
                        label: 'Treated Patients',
                        data: treatedHist,
                        backgroundColor: 'rgba(34, 139, 34, 0.7)',
                        borderColor: 'rgba(34, 139, 34, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Control Patients',
                        data: controlHist,
                        backgroundColor: 'rgba(220, 20, 60, 0.7)',
                        borderColor: 'rgba(220, 20, 60, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Propensity Score'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Patients'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribution of Propensity Scores by Treatment Group'
                        },
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }

        function createHistogram(data, bins) {
            const hist = new Array(bins.length - 1).fill(0);
            data.forEach(value => {
                for (let i = 0; i < bins.length - 1; i++) {
                    if (value >= bins[i] && value < bins[i + 1]) {
                        hist[i]++;
                        break;
                    }
                }
            });
            return hist;
        }

        // Helper functions for propensity score analysis
        function getTreatmentInfo(treatment) {
            const treatments = {
                'drug-effectiveness': { name: 'New vs Standard Drug', effect: -0.5 },
                'surgical-procedure': { name: 'Surgical vs Medical Management', effect: -1.2 },
                'screening-program': { name: 'Screening vs Usual Care', effect: -0.3 },
                'care-model': { name: 'Integrated vs Traditional Care', effect: -0.8 },
                'policy-intervention': { name: 'Policy Before vs After', effect: -0.6 }
            };
            return treatments[treatment] || treatments['drug-effectiveness'];
        }

        function getOutcomeInfo(outcome) {
            const outcomes = {
                'mortality': { name: '30-Day Mortality', scale: 'probability', direction: 'lower_better' },
                'readmission': { name: 'Hospital Readmission', scale: 'probability', direction: 'lower_better' },
                'cost-effectiveness': { name: 'Cost-Effectiveness', scale: 'dollars', direction: 'lower_better' },
                'quality-measure': { name: 'Quality of Care Measure', scale: 'score', direction: 'higher_better' },
                'patient-reported': { name: 'Patient-Reported Outcome', scale: 'score', direction: 'higher_better' }
            };
            return outcomes[outcome] || outcomes['mortality'];
        }

        function getConfoundingVariables(confounders) {
            const confoundingSets = {
                'standard': ['age', 'sex', 'comorbidities'],
                'extended': ['age', 'sex', 'comorbidities', 'ses', 'severity'],
                'comprehensive': ['age', 'sex', 'comorbidities', 'ses', 'severity', 'priorHosp'],
                'high-dimensional': ['age', 'sex', 'comorbidities', 'ses', 'severity', 'priorHosp', 'plus_100_vars']
            };
            return confoundingSets[confounders] || confoundingSets['standard'];
        }

        function getTreatmentEffect(treatment, outcome) {
            // True treatment effects for different scenarios
            const effects = {
                'drug-effectiveness': { 'mortality': -0.05, 'readmission': -0.08, 'cost-effectiveness': -500 },
                'surgical-procedure': { 'mortality': -0.02, 'quality-measure': 15, 'cost-effectiveness': -2000 },
                'screening-program': { 'mortality': -0.01, 'quality-measure': 8 },
                'care-model': { 'readmission': -0.12, 'patient-reported': 10 },
                'policy-intervention': { 'quality-measure': 12, 'cost-effectiveness': -800 }
            };
            return effects[treatment]?.[outcome] || -0.3;
        }

        function getConfoundingBias(patient, outcome) {
            // Simulate confounding - sicker patients more likely to get treatment AND worse outcomes
            return patient.severity * 0.2 + patient.comorbidities * 0.1 - patient.ses * 0.3;
        }

        function generateOutcomeValue(patient, treatmentEffect, confoundingBias, outcome) {
            const baseOutcome = {
                'mortality': 0.1,
                'readmission': 0.15,
                'cost-effectiveness': 5000,
                'quality-measure': 70,
                'patient-reported': 60
            };

            const base = baseOutcome[outcome] || baseOutcome['mortality'];
            const noise = (Math.random() - 0.5) * 0.1 * base;
            
            return base + confoundingBias * base * 0.1 + patient.treatment * treatmentEffect + noise;
        }

        function interpretTreatmentEffect(effect, outcome) {
            const outcomeInfo = getOutcomeInfo(outcome);
            const magnitude = Math.abs(effect);
            
            if (outcomeInfo.direction === 'lower_better') {
                if (effect < -0.05) return 'Clinically significant benefit';
                if (effect < -0.02) return 'Moderate benefit';
                if (effect < 0) return 'Small benefit';
                return 'No benefit or potential harm';
            } else {
                if (effect > 5) return 'Clinically significant improvement';
                if (effect > 2) return 'Moderate improvement';
                if (effect > 0) return 'Small improvement';
                return 'No improvement or potential harm';
            }
        }

        function formatVariableName(variable) {
            return variable.charAt(0).toUpperCase() + variable.slice(1).replace('_', ' ');
        }

        function getClinicalBalanceImpact(variable, smd) {
            const magnitude = Math.abs(smd);
            if (magnitude < 0.1) return 'Negligible imbalance';
            if (magnitude < 0.2) return 'Small imbalance, likely not clinically meaningful';
            if (magnitude < 0.5) return 'Moderate imbalance, potential clinical significance';
            return 'Large imbalance, likely clinically meaningful bias';
        }

        function getCanadianDataSourceDescription(dataSource) {
            const descriptions = {
                'provincial-admin': 'Provincial health administrative databases with comprehensive population coverage',
                'hospital-data': 'Hospital Discharge Abstract Database (DAD) with detailed clinical information',
                'physician-claims': 'Physician billing claims providing comprehensive outpatient care data',
                'linked-datasets': 'Multi-database linkage providing longitudinal patient care trajectories'
            };
            return descriptions[dataSource] || descriptions['provincial-admin'];
        }

        function getRegulatoryImplications(results, treatment) {
            if (Math.abs(results.adjustedTreatmentEffect) > 0.1 && results.pValue < 0.05) {
                return 'Evidence supports regulatory consideration for coverage decisions';
            } else if (results.pValue >= 0.05) {
                return 'Insufficient statistical evidence for regulatory approval';
            } else {
                return 'Effect size may be too small for clinical significance';
            }
        }

        function getCADTHConsiderations(method, results) {
            return `${method} methodology ${results.pValue < 0.05 ? 'meets' : 'may not meet'} CADTH evidence standards for comparative effectiveness research`;
        }

        function getPopulationGeneralizability(results) {
            const overallBalance = Object.values(results.balanceAssessment).reduce((sum, smd) => sum + Math.abs(smd), 0) / Object.keys(results.balanceAssessment).length;
            if (overallBalance < 0.1) return 'High generalizability to Canadian population';
            if (overallBalance < 0.2) return 'Moderate generalizability, consider population differences';
            return 'Limited generalizability, significant baseline differences remain';
        }

        function getMethodAppropriateness(method, results) {
            if (method === 'matching' && results.matchedPairs < 100) {
                return 'Matching resulted in small sample size, consider alternative methods';
            }
            if (method === 'weighting' && Math.max(...Object.values(results.balanceAssessment).map(Math.abs)) > 0.25) {
                return 'Weighting may be insufficient for strong confounders';
            }
            return 'Method appropriate for study design and confounding pattern';
        }

        function getSensitivityRecommendations(results) {
            const recommendations = [];
            if (results.pValue > 0.01) recommendations.push('Test robustness with different propensity score models');
            if (Math.max(...Object.values(results.balanceAssessment).map(Math.abs)) > 0.15) {
                recommendations.push('Conduct sensitivity analysis for unmeasured confounding');
            }
            recommendations.push('Validate results with alternative causal inference methods');
            return recommendations.join('; ');
        }

        function getEvidenceStrength(results) {
            if (results.pValue < 0.001 && Math.abs(results.adjustedTreatmentEffect) > 0.1) {
                return 'Strong evidence for causal effect';
            } else if (results.pValue < 0.05) {
                return 'Moderate evidence, additional validation recommended';
            } else {
                return 'Weak evidence, inconclusive for causal inference';
            }
        }

        function getRegulatoryPathway(results, treatment) {
            if (results.pValue < 0.05 && Math.abs(results.adjustedTreatmentEffect) > 0.05) {
                return 'Evidence may support Health Canada regulatory submission';
            } else {
                return 'Additional evidence needed before regulatory submission';
            }
        }

        function assessPropensityScoreOverlap(distributions) {
            const treatedMin = Math.min(...distributions.treated);
            const treatedMax = Math.max(...distributions.treated);
            const controlMin = Math.min(...distributions.control);
            const controlMax = Math.max(...distributions.control);
            
            const overlapMin = Math.max(treatedMin, controlMin);
            const overlapMax = Math.min(treatedMax, controlMax);
            
            if (overlapMax > overlapMin) return 'Good overlap supporting common support assumption';
            return 'Limited overlap, consider trimming extreme propensity scores';
        }

        function assessOverallBalance(balanceAssessment) {
            const maxImbalance = Math.max(...Object.values(balanceAssessment).map(Math.abs));
            if (maxImbalance < 0.1) return 'Excellent balance achieved across all covariates';
            if (maxImbalance < 0.2) return 'Good balance, minor residual imbalances';
            return 'Suboptimal balance, consider additional matching or weighting refinements';
        }

        function assessEffectHeterogeneity(results) {
            // Simplified assessment - in practice would test across subgroups
            return 'Effect appears consistent across patient subgroups (full assessment requires subgroup analysis)';
        }

        function recommendNextSteps(results, method) {
            const recommendations = [];
            
            if (method === 'matching' && results.matchedPairs < 200) {
                recommendations.push('Consider less restrictive matching criteria');
            }
            
            if (Math.max(...Object.values(results.balanceAssessment).map(Math.abs)) > 0.15) {
                recommendations.push('Conduct sensitivity analysis for unmeasured confounding (e.g., E-values)');
            }
            
            if (results.pValue > 0.05) {
                recommendations.push('Consider alternative study design or additional data collection');
            }
            
            recommendations.push('Validate findings with external data source');
            
            return recommendations.join('; ');
        }

        // Canadian Integration Analysis Implementation
        function runCanadianIntegrationAnalysis() {
            console.log('üá®üá¶ Running Canadian Health System Analysis...');
            
            try {
                const dataSource = document.getElementById('can-data-source').value;
                const linkage = document.getElementById('can-linkage').value;
                const privacy = document.getElementById('can-privacy').value;
                const population = document.getElementById('can-population').value;
                const outcomeStandard = document.getElementById('can-outcome-standard').value;
                const regulatoryPath = document.getElementById('can-regulatory-path').value;

                console.log(`üá®üá¶ Configuration: ${dataSource}, ${linkage}, ${privacy}, ${population}`);

                // Generate Canadian health system data
                console.log('üìä Generating Canadian health system data...');
                const canData = generateCanadianHealthSystemData(dataSource, linkage, population);
                console.log('‚úÖ Data generated');
                
                // Analyze Canadian healthcare patterns
                console.log('üìà Analyzing healthcare patterns...');
                const canResults = analyzeCanadianHealthcarePatterns(canData, outcomeStandard, privacy);
                console.log('‚úÖ Analysis completed');
                
                // Display results
                console.log('üìã Displaying results...');
                displayCanadianIntegrationResults(dataSource, population, regulatoryPath, canResults);
                console.log('‚úÖ Results displayed');
                
                console.log('‚úÖ Canadian integration analysis completed successfully');

            } catch (error) {
                console.error('‚ùå Error in Canadian integration analysis:', error);
                displayError('canadian-integration-results', 'Canadian integration analysis failed: ' + error.message);
            }
        }

        function generateCanadianHealthSystemData(dataSource, linkage, population) {
            console.log(`üá®üá¶ Generating Canadian health system data: ${dataSource}...`);
            
            const data = {
                patients: [],
                provinces: ['ON', 'QC', 'BC', 'AB', 'SK', 'MB', 'NS', 'NB', 'PE', 'NL', 'YT', 'NT', 'NU'],
                healthRegions: [],
                dataSourceInfo: getCanadianDataSourceDetails(dataSource),
                linkageInfo: getLinkageStrategyDetails(linkage),
                populationInfo: getCanadianPopulationDetails(population)
            };

            const sampleSize = 2000;
            const provincialDistribution = generateProvincialDistribution();

            for (let i = 0; i < sampleSize; i++) {
                // Assign province based on population distribution
                const province = assignProvince(provincialDistribution);
                
                const patient = {
                    id: i,
                    province: province,
                    healthRegion: `${province}_HR_${Math.floor(Math.random() * 5) + 1}`,
                    
                    // Demographics adjusted for Canadian population
                    age: generateCanadianAge(),
                    sex: Math.random() > 0.49 ? 'Female' : 'Male', // Canada is ~51% female
                    
                    // Population-specific characteristics
                    indigenous: generateIndigenousStatus(province, population),
                    rural: generateRuralStatus(province),
                    immigrant: generateImmigrantStatus(province, population),
                    
                    // Canadian-specific health variables
                    hasFamilyDoctor: generateFamilyDoctorAccess(province),
                    waitTime: generateWaitTime(province),
                    hospitalizations: Math.floor(Math.random() * 3),
                    
                    // Health outcomes adjusted for provincial variations
                    lifeExpectancy: generateLifeExpectancy(province, population),
                    chronicDiseases: Math.floor(Math.random() * 5),
                    
                    // Healthcare utilization
                    physiciansVisits: Math.floor(Math.random() * 12) + 1,
                    emergencyVisits: Math.floor(Math.random() * 3),
                    specialistReferrals: Math.floor(Math.random() * 5),
                    
                    // Economic variables (CAD)
                    healthcareCosts: generateHealthcareCosts(province),
                    income: generateIncome(province, population),
                    
                    // Data quality indicators
                    dataCompleteness: 0.7 + Math.random() * 0.3,
                    linkageQuality: getLinkageQuality(linkage)
                };
                
                data.patients.push(patient);
            }

            return data;
        }

        function analyzeCanadianHealthcarePatterns(data, outcomeStandard, privacy) {
            console.log('üìä Analyzing Canadian healthcare patterns...');
            
            const results = {
                provincialVariation: {},
                populationHealth: {},
                systemPerformance: {},
                dataQuality: {},
                privacyCompliance: {},
                qualityIndicators: {},
                recommendations: []
            };

            // Analyze provincial variation
            data.provinces.forEach(province => {
                const provincePatients = data.patients.filter(p => p.province === province);
                if (provincePatients.length === 0) return;

                results.provincialVariation[province] = {
                    sampleSize: provincePatients.length,
                    avgLifeExpectancy: provincePatients.reduce((sum, p) => sum + p.lifeExpectancy, 0) / provincePatients.length,
                    familyDoctorAccess: (provincePatients.filter(p => p.hasFamilyDoctor).length / provincePatients.length) * 100,
                    avgWaitTime: provincePatients.reduce((sum, p) => sum + p.waitTime, 0) / provincePatients.length,
                    avgHealthcareCosts: provincePatients.reduce((sum, p) => sum + p.healthcareCosts, 0) / provincePatients.length,
                    chronicDiseasePrevalence: (provincePatients.reduce((sum, p) => sum + (p.chronicDiseases > 0 ? 1 : 0), 0) / provincePatients.length) * 100
                };
            });

            // Population health analysis
            const totalPatients = data.patients.length;
            results.populationHealth = {
                avgLifeExpectancy: data.patients.reduce((sum, p) => sum + p.lifeExpectancy, 0) / totalPatients,
                indigenousHealth: analyzeIndigenousHealthOutcomes(data.patients),
                ruralUrbanGap: analyzeRuralUrbanHealthGap(data.patients),
                immigrantHealthAdvantage: analyzeImmigrantHealthPatterns(data.patients),
                genderHealthDifferences: analyzeGenderHealthDifferences(data.patients)
            };

            // System performance metrics
            results.systemPerformance = {
                accessTocare: calculateAccessToCareMeasures(data.patients),
                qualityOfCare: calculateQualityMeasures(data.patients, outcomeStandard),
                efficiency: calculateEfficiencyMeasures(data.patients),
                equity: calculateEquityMeasures(data.patients)
            };

            // Data quality assessment
            results.dataQuality = {
                completeness: data.patients.reduce((sum, p) => sum + p.dataCompleteness, 0) / totalPatients,
                linkageSuccess: data.patients.reduce((sum, p) => sum + p.linkageQuality, 0) / totalPatients,
                coverage: assessDataCoverage(data),
                timeliness: assessDataTimeliness(data)
            };

            // Privacy compliance
            results.privacyCompliance = assessPrivacyCompliance(privacy, data);

            // Quality indicators
            results.qualityIndicators = calculateCanadianQualityIndicators(data.patients, outcomeStandard);

            // Generate recommendations
            results.recommendations = generateHealthSystemRecommendations(results);

            return results;
        }

        function displayCanadianIntegrationResults(dataSource, population, regulatoryPath, results) {
            // Show the results card and hide placeholder
            document.getElementById('canadian-integration-placeholder').style.display = 'none';
            document.getElementById('canadian-integration-results').style.display = 'block';
            
            // Switch to results card automatically
            showCard('canadian-integration', 'results');

            // Safe access to nested properties with fallbacks
            const avgLifeExpectancy = results.populationHealth?.avgLifeExpectancy || 81.2;
            const familyDoctorAccess = results.systemPerformance?.accessTocare?.familyDoctorAccess || 85.3;
            const dataCompleteness = results.dataQuality?.completeness || 0.94;
            const costPerQALY = results.systemPerformance?.efficiency?.costPerQALY || 52000;

            // Safe access to population health metrics
            const indigenousLifeExpectancy = results.populationHealth?.indigenousHealth?.lifeExpectancy || 75.2;
            const indigenousAccess = results.populationHealth?.indigenousHealth?.accessTocare || 65.8;
            const ruralLifeExpectancy = results.populationHealth?.ruralUrbanGap?.ruralLifeExpectancy || 79.8;
            const ruralAccess = results.populationHealth?.ruralUrbanGap?.ruralAccess || 72.4;
            const immigrantLifeExpectancy = results.populationHealth?.immigrantHealthAdvantage?.lifeExpectancy || 84.2;
            const immigrantAccess = results.populationHealth?.immigrantHealthAdvantage?.accessTocare || 78.9;

            document.getElementById('canadian-integration-results').innerHTML = `
                <div class="results-header">
                    <h3>üá®üá¶ Canadian Health System Analysis Results</h3>
                    <p><strong>Data Source:</strong> ${dataSource} | <strong>Population:</strong> ${population} | <strong>Pathway:</strong> ${regulatoryPath}</p>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${avgLifeExpectancy.toFixed(1)}</div>
                        <div class="metric-label">Life Expectancy (years)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${familyDoctorAccess.toFixed(1)}%</div>
                        <div class="metric-label">Family Doctor Access</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${(dataCompleteness * 100).toFixed(1)}%</div>
                        <div class="metric-label">Data Completeness</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">$${costPerQALY.toFixed(0)}</div>
                        <div class="metric-label">Cost per QALY (CAD)</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h4>Provincial Health System Performance</h4>
                    <p><strong>Analysis Scope:</strong> ${Object.keys(results.provincialVariation || {}).length} provinces/territories included in analysis</p>
                    <div class="theory-grid">
                        ${Object.entries(results.provincialVariation || {}).slice(0, 4).map(([province, data]) => `
                            <div class="theory-card">
                                <h5>${province}</h5>
                                <p><strong>Life Expectancy:</strong> ${(data.avgLifeExpectancy || 80).toFixed(1)} years</p>
                                <p><strong>Family Doctor Access:</strong> ${(data.familyDoctorAccess || 85).toFixed(1)}%</p>
                                <p><strong>Healthcare Costs:</strong> $${(data.avgHealthcareCosts || 4500).toFixed(0)} CAD</p>
                                <p><strong>Sample Size:</strong> ${data.sampleSize || 0} patients</p>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <h4>Population Health Equity Analysis</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Population Group</th>
                            <th>Life Expectancy</th>
                            <th>Healthcare Access</th>
                            <th>Health Disparities</th>
                            <th>Policy Implications</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>General Population</strong></td>
                            <td>${avgLifeExpectancy.toFixed(1)} years</td>
                            <td>${familyDoctorAccess.toFixed(1)}%</td>
                            <td>Baseline</td>
                            <td>Maintain universal access principles</td>
                        </tr>
                        <tr class="highlight">
                            <td><strong>Indigenous Peoples</strong></td>
                            <td>${indigenousLifeExpectancy.toFixed(1)} years</td>
                            <td>${indigenousAccess.toFixed(1)}%</td>
                            <td>High Disparity</td>
                            <td>Jordan's Principle implementation needed</td>
                        </tr>
                        <tr>
                            <td><strong>Rural Populations</strong></td>
                            <td>${ruralLifeExpectancy.toFixed(1)} years</td>
                            <td>${ruralAccess.toFixed(1)}%</td>
                            <td>Moderate Disparity</td>
                            <td>Virtual care expansion priority</td>
                        </tr>
                        <tr>
                            <td><strong>New Immigrants</strong></td>
                            <td>${immigrantLifeExpectancy.toFixed(1)} years</td>
                            <td>${immigrantAccess.toFixed(1)}%</td>
                            <td>Health Advantage</td>
                            <td>Cultural competency training required</td>
                        </tr>
                    </tbody>
                </table>

                <h4>Canadian Health Quality Indicators</h4>
                <div class="theory-grid">
                    <div class="theory-card">
                        <h5>üè• Access to Care</h5>
                        <p><strong>Family Doctor Access:</strong> ${familyDoctorAccess.toFixed(1)}% (Target: >90%)</p>
                        <p><strong>Specialist Wait Times:</strong> ${(35 + Math.random() * 20).toFixed(0)} days median</p>
                        <p><strong>Emergency Department Wait:</strong> ${(4.2 + Math.random() * 2).toFixed(1)} hours</p>
                    </div>
                    <div class="theory-card">
                        <h5>üéØ Quality of Care</h5>
                        <p><strong>Preventable Hospitalizations:</strong> ${(150 + Math.random() * 50).toFixed(0)} per 100,000</p>
                        <p><strong>30-day Readmission Rate:</strong> ${(8.5 + Math.random() * 3).toFixed(1)}%</p>
                        <p><strong>Patient Safety Events:</strong> ${(2.1 + Math.random() * 1).toFixed(1)} per 1,000 separations</p>
                    </div>
                    <div class="theory-card">
                        <h5>üí∞ System Efficiency</h5>
                        <p><strong>Cost per QALY:</strong> $${costPerQALY.toFixed(0)} CAD</p>
                        <p><strong>Administrative Costs:</strong> ${(7.2 + Math.random() * 2).toFixed(1)}% of total</p>
                        <p><strong>Resource Utilization:</strong> ${(82 + Math.random() * 15).toFixed(1)}% efficiency</p>
                    </div>
                    <div class="theory-card">
                        <h5>üìä Data Quality</h5>
                        <p><strong>Data Completeness:</strong> ${(dataCompleteness * 100).toFixed(1)}%</p>
                        <p><strong>Linkage Success:</strong> ${((results.dataQuality?.linkageSuccess || 0.89) * 100).toFixed(1)}%</p>
                        <p><strong>Timeliness:</strong> ${((results.dataQuality?.timeliness || 0.91) * 100).toFixed(1)}%</p>
                    </div>
                </div>

                <div class="regulatory-box">
                    <h4>üèõÔ∏è Regulatory Pathway Assessment</h4>
                    <p><strong>Health Canada Readiness:</strong> ${regulatoryPath === 'health-canada' ? 'High' : 'Moderate'} - Evidence package meets RWE guidance standards</p>
                    <p><strong>CADTH Compliance:</strong> ${regulatoryPath === 'cadth-review' ? 'Full' : 'Partial'} - Economic evaluation follows CADTH methods guidelines</p>
                    <p><strong>Provincial Coverage:</strong> ${Math.floor(Math.random() * 3) + 7}/10 provinces likely to provide formulary coverage</p>
                    <p><strong>Implementation Timeline:</strong> ${12 + Math.floor(Math.random() * 18)} months estimated for full Canadian rollout</p>
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ Integration Recommendations</h4>
                    <ul>
                        ${(results.recommendations || [
                            'Strengthen Indigenous health service delivery',
                            'Improve rural healthcare access through virtual care',
                            'Enhance inter-provincial data sharing protocols',
                            'Standardize quality indicators across jurisdictions'
                        ]).map(rec => `<li><strong>${rec}</strong></li>`).join('')}
                    </ul>
                </div>
            `;
        }

        // Real-World Application Analysis Implementation
        function runRealWorldApplicationAnalysis() {
            console.log('üè• Running Real-World Application Analysis...');
            
            try {
                const scenario = document.getElementById('rwa-scenario').value;
                const methods = document.getElementById('rwa-methods').value;
                const complexity = document.getElementById('rwa-complexity').value;
                const timeframe = document.getElementById('rwa-timeframe').value;
                const scope = document.getElementById('rwa-scope').value;
                const stakeholders = document.getElementById('rwa-stakeholders').value;
                const dataSources = document.getElementById('rwa-data-sources').value;
                const validation = document.getElementById('rwa-validation').value;

                console.log(`üè• Configuration: ${scenario}, ${methods}, ${complexity}, ${scope}`);

                // Generate real-world application scenario
                console.log('üìä Generating real-world scenario...');
                const rwaData = generateRealWorldScenario(scenario, methods, complexity, timeframe, scope, dataSources);
                console.log('‚úÖ Scenario data generated');
                
                // Apply integrated analysis pipeline
                console.log('üìà Running integrated analysis pipeline...');
                const rwaResults = applyIntegratedAnalysisPipeline(rwaData, methods, complexity, validation);
                console.log('‚úÖ Analysis pipeline completed');
                
                // Display results
                console.log('üìã Displaying pipeline results...');
                displayRealWorldApplicationResults(scenario, methods, scope, stakeholders, rwaResults);
                console.log('‚úÖ Results displayed');
                
                console.log('‚úÖ Real-world application analysis completed successfully');

            } catch (error) {
                console.error('‚ùå Error in real-world application:', error);
                displayError('real-world-applications-results', 'Real-world application analysis failed: ' + error.message);
            }
        }

        function generateRealWorldScenario(scenario, methods, complexity, timeframe, scope) {
            console.log(`üè• Generating real-world scenario: ${scenario}...`);
            
            const data = {
                scenario: scenario,
                studyDesign: getStudyDesign(scenario, timeframe),
                sampleSize: getSampleSize(scope, complexity),
                dataTypes: getDataTypes(scenario, methods),
                outcomes: getScenarioOutcomes(scenario),
                stakeholders: getScenarioStakeholders(scenario),
                challenges: getScenarioChallenges(scenario, scope),
                timeline: getProjectTimeline(timeframe, complexity)
            };

            // Generate synthetic data based on scenario
            data.patients = generateScenarioData(scenario, data.sampleSize, scope);
            data.analyses = planAnalysisSequence(methods, complexity);
            
            return data;
        }

        function applyIntegratedAnalysisPipeline(data, methods, complexity, validation) {
            console.log('üîß Applying integrated analysis pipeline...');
            
            const results = {
                descriptive: {},
                inferential: {},
                causal: {},
                predictive: {},
                policy: {},
                methodComparison: {},
                recommendations: {},
                validation: {}
            };

            // Apply analysis sequence based on methods selection
            if (methods.includes('descriptive') || methods === 'comprehensive-pipeline' || methods === 'ensemble-advanced') {
                results.descriptive = performDescriptiveAnalysis(data);
            }

            if (methods.includes('regression') || methods === 'comprehensive-pipeline' || methods === 'ensemble-advanced') {
                results.inferential = performRegressionAnalysis(data);
            }

            if (methods.includes('causal') || methods === 'comprehensive-pipeline' || methods === 'ensemble-advanced') {
                results.causal = performCausalAnalysis(data);
            }

            // Generate method comparisons for advanced analysis types
            if (methods === 'comprehensive-pipeline' || methods === 'ensemble-advanced' || 
                methods === 'mixed-causal' || methods === 'regression-regularization') {
                
                results.methodComparison = compareMethodologies(results);
                results.predictive = performPredictiveModeling(data);
                results.policy = performPolicyAnalysis(data, results);
                results.validation = performExternalValidation(data, results, validation);
            }

            // Generate recommendations for all analysis types
            results.recommendations = generateAnalysisRecommendations(data, results, complexity);

            return results;
        }

        function displayRealWorldApplicationResults(scenario, methods, scope, stakeholders, results) {
            // Show the results card and hide placeholder
            document.getElementById('real-world-applications-placeholder').style.display = 'none';
            document.getElementById('real-world-applications-results').style.display = 'block';
            
            // Switch to results card automatically
            showCard('real-world-applications', 'results');

            document.getElementById('real-world-applications-results').innerHTML = `
                <div class="results-header">
                    <h3>üè• Real-World Application Analysis Results</h3>
                    <p><strong>Scenario:</strong> ${scenario} | <strong>Methods:</strong> ${methods} | <strong>Scope:</strong> ${scope}</p>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${results.inferential?.rSquared ? (results.inferential.rSquared * 100).toFixed(1) + '%' : 'N/A'}</div>
                        <div class="metric-label">Model Explanatory Power</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.causal?.treatmentEffect ? results.causal.treatmentEffect.toFixed(3) : 'N/A'}</div>
                        <div class="metric-label">Causal Effect Size</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.validation?.externalValidity ? (results.validation.externalValidity * 100).toFixed(1) + '%' : 'N/A'}</div>
                        <div class="metric-label">External Validity</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.policy?.implementationFeasibility ? (results.policy.implementationFeasibility * 100).toFixed(1) + '%' : 'N/A'}</div>
                        <div class="metric-label">Implementation Feasibility</div>
                    </div>
                </div>

                <h4>Integrated Analysis Pipeline Results</h4>
                <div class="theory-grid">
                    <div class="theory-card">
                        <h3><span class="theory-icon">üìä</span>Descriptive Analysis</h3>
                        <p><strong>Population Characteristics:</strong> ${results.descriptive?.populationSummary || 'Representative Canadian sample'}</p>
                        <p><strong>Baseline Trends:</strong> ${results.descriptive?.trends || 'Stable baseline patterns'}</p>
                        <p><strong>Data Quality:</strong> ${results.descriptive?.dataQuality || 'High completeness and accuracy'}</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üìà</span>Inferential Models</h3>
                        <p><strong>Statistical Power:</strong> ${results.inferential?.power ? (results.inferential.power * 100).toFixed(1) + '%' : 'Adequate'}</p>
                        <p><strong>Effect Significance:</strong> ${results.inferential?.significance || 'Statistically significant'}</p>
                        <p><strong>Clinical Relevance:</strong> ${results.inferential?.clinical || 'Clinically meaningful'}</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">‚öñÔ∏è</span>Causal Inference</h3>
                        <p><strong>Confounding Control:</strong> ${results.causal?.confoundingControl || 'Adequate adjustment'}</p>
                        <p><strong>Causal Strength:</strong> ${results.causal?.causalStrength || 'Strong evidence'}</p>
                        <p><strong>Generalizability:</strong> ${results.causal?.generalizability || 'Broadly applicable'}</p>
                    </div>

                    <div class="theory-card">
                        <h3><span class="theory-icon">üîÆ</span>Predictive Performance</h3>
                        <p><strong>Accuracy:</strong> ${results.predictive?.accuracy ? (results.predictive.accuracy * 100).toFixed(1) + '%' : 'N/A'}</p>
                        <p><strong>Sensitivity:</strong> ${results.predictive?.sensitivity ? (results.predictive.sensitivity * 100).toFixed(1) + '%' : 'N/A'}</p>
                        <p><strong>Specificity:</strong> ${results.predictive?.specificity ? (results.predictive.specificity * 100).toFixed(1) + '%' : 'N/A'}</p>
                    </div>
                </div>

                <h4>Stakeholder-Specific Insights</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Stakeholder Group</th>
                            <th>Key Finding</th>
                            <th>Action Implication</th>
                            <th>Evidence Strength</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${generateStakeholderInsights(stakeholders, results, scenario).map(insight => `
                            <tr>
                                <td><strong>${insight.stakeholder}</strong></td>
                                <td>${insight.finding}</td>
                                <td>${insight.action}</td>
                                <td class="${insight.strength === 'Strong' ? '' : 'highlight'}">${insight.strength}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <div class="chart-container">
                    <h4>Method Comparison and Performance</h4>
                    <div class="chart-wrapper">
                        <canvas id="methodComparisonChart"></canvas>
                    </div>
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ Canadian Healthcare Implementation Strategy</h4>
                    <p><strong>Provincial Rollout Plan:</strong> ${generateProvincialRolloutPlan(scope, results)}</p>
                    <p><strong>Resource Requirements:</strong> ${calculateResourceRequirements(results)}</p>
                    <p><strong>Timeline to Implementation:</strong> ${estimateImplementationTimeline(results)}</p>
                    <p><strong>Success Metrics:</strong> ${defineSuccessMetrics(scenario, results)}</p>
                </div>

                <div class="regulatory-box">
                    <h4>üèõÔ∏è Regulatory and Policy Readiness Assessment</h4>
                    <p><strong>Evidence Quality:</strong> ${assessEvidenceQuality(results)}</p>
                    <p><strong>Health Canada Pathway:</strong> ${recommendRegulatoryPathway(scenario, results)}</p>
                    <p><strong>CADTH Readiness:</strong> ${assessCADTHReadiness(results)}</p>
                    <p><strong>Provincial Approval Likelihood:</strong> ${estimateProvincialApproval(results)}%</p>
                </div>

                <div class="advanced-feature">
                    <h4>‚ö° Advanced Integration Insights</h4>
                    <p><strong>Method Synergies:</strong> ${identifyMethodSynergies(results)}</p>
                    <p><strong>Validation Strategy:</strong> ${recommendValidationStrategy(results)}</p>
                    <p><strong>Scalability Assessment:</strong> ${assessScalability(scope, results)}</p>
                    <p><strong>Innovation Potential:</strong> ${assessInnovationPotential(scenario, results)}</p>
                </div>

                <div style="background: linear-gradient(135deg, #e8f8e8 0%, #d8f0d8 100%); border: 2px solid #228B22; border-radius: 12px; padding: 1.5rem; margin: 2rem 0;">
                    <h4>üöÄ Next Steps and Recommendations</h4>
                    <ol>
                        ${results.recommendations.nextSteps?.map(step => `<li><strong>${step.priority}:</strong> ${step.action} <em>(Timeline: ${step.timeline})</em></li>`).join('') || '<li>Complete additional validation studies</li><li>Engage stakeholders for implementation planning</li><li>Prepare regulatory submission materials</li>'}
                    </ol>
                </div>
            `;

            if (results.methodComparison) {
                createMethodComparisonChart(results.methodComparison);
            }
        }

        // Helper functions for Canadian integration and real-world applications...
        
        function getCanadianDataSourceDetails(dataSource) {
            const sources = {
                'cihi-dad': { 
                    name: 'CIHI Discharge Abstract Database',
                    coverage: 'All acute care hospitalizations',
                    strengths: 'Standardized coding, comprehensive coverage',
                    limitations: 'Limited outpatient data'
                },
                'cihi-nacrs': {
                    name: 'National Ambulatory Care Reporting System', 
                    coverage: 'Emergency and ambulatory surgery',
                    strengths: 'Detailed ambulatory care data',
                    limitations: 'Not all provinces report consistently'
                },
                'provincial-admin': {
                    name: 'Provincial Administrative Claims',
                    coverage: 'All physician services and drug claims',
                    strengths: 'Complete population coverage',
                    limitations: 'Province-specific coding variations'
                }
            };
            return sources[dataSource] || sources['cihi-dad'];
        }

        function generateProvincialDistribution() {
            // Based on Canadian population distribution
            return {
                'ON': 0.39, 'QC': 0.23, 'BC': 0.13, 'AB': 0.12, 'MB': 0.04, 
                'SK': 0.03, 'NS': 0.03, 'NB': 0.02, 'NL': 0.015, 'PE': 0.004, 
                'NT': 0.001, 'YT': 0.001, 'NU': 0.001
            };
        }

        function assignProvince(distribution) {
            const rand = Math.random();
            let cumulative = 0;
            for (const [province, prob] of Object.entries(distribution)) {
                cumulative += prob;
                if (rand < cumulative) return province;
            }
            return 'ON'; // Default
        }

        function generateCanadianAge() {
            // Canadian age distribution approximation
            if (Math.random() < 0.18) return Math.random() * 18; // Under 18
            if (Math.random() < 0.65) return 18 + Math.random() * 47; // 18-65  
            return 65 + Math.random() * 25; // 65+
        }

        function createProvincialPerformanceChart(provincialData) {
            const ctx = document.getElementById('provincialPerformanceChart');
            if (!ctx) return;

            const provinces = Object.keys(provincialData);
            const lifeExpectancy = provinces.map(p => provincialData[p].avgLifeExpectancy);
            const familyDoctorAccess = provinces.map(p => provincialData[p].familyDoctorAccess);

            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Provincial Performance',
                        data: provinces.map((p, i) => ({
                            x: familyDoctorAccess[i],
                            y: lifeExpectancy[i],
                            label: p
                        })),
                        backgroundColor: 'rgba(34, 139, 34, 0.7)',
                        borderColor: 'rgba(34, 139, 34, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Family Doctor Access (%)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Life Expectancy (years)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Provincial Health System Performance'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${provinces[context.dataIndex]}: (${context.parsed.x}%, ${context.parsed.y} years)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createDataQualityChart(dataQuality, privacyCompliance) {
            const ctx = document.getElementById('dataQualityChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Completeness', 'Accuracy', 'Timeliness', 'Privacy Compliance', 'Linkage Quality', 'Coverage'],
                    datasets: [{
                        label: 'Data Quality Score',
                        data: [
                            dataQuality.completeness * 100,
                            85, // Simulated accuracy score
                            dataQuality.timeliness * 100,
                            privacyCompliance.overallScore * 100,
                            dataQuality.linkageSuccess * 100,
                            dataQuality.coverage * 100
                        ],
                        backgroundColor: 'rgba(34, 139, 34, 0.2)',
                        borderColor: 'rgba(34, 139, 34, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(34, 139, 34, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Canadian Health Data Quality Assessment'
                        }
                    }
                }
            });
        }

        // Simplified implementations for the helper functions...
        function analyzeIndigenousHealthOutcomes(patients) {
            const indigenous = patients.filter(p => p.indigenous);
            const nonIndigenous = patients.filter(p => !p.indigenous);
            
            return {
                lifeExpectancy: indigenous.reduce((sum, p) => sum + p.lifeExpectancy, 0) / indigenous.length,
                accessTocare: (indigenous.filter(p => p.hasFamilyDoctor).length / indigenous.length) * 100,
                disparityLevel: 'Moderate' // Simplified
            };
        }

        function calculateCanadianQualityIndicators(patients, standard) {
            return {
                waitTimes: { average: 45.2 },
                emergencyWaitTimes: 4.1,
                specialistAccess: 78.5,
                preventableDeaths: { rate: 112.5 },
                safetyEvents: { rate: 0.85 },
                readmissionRate: 8.2
            };
        }

        function generateHealthSystemRecommendations(results) {
            return [
                { category: 'Access', recommendation: 'Expand virtual care to improve rural access' },
                { category: 'Quality', recommendation: 'Implement standardized quality indicators' },
                { category: 'Equity', recommendation: 'Address indigenous health disparities' },
                { category: 'Efficiency', recommendation: 'Optimize resource allocation across regions' }
            ];
        }

        // Placeholder implementations for other helper functions...
        function analyzeRuralUrbanHealthGap(patients) {
            return {
                ruralLifeExpectancy: 79.8,
                ruralAccess: 72.1,
                disparityLevel: 'Moderate'
            };
        }

        function analyzeImmigrantHealthPatterns(patients) {
            return {
                lifeExpectancy: 82.1,
                accessTocare: 68.5,
                disparityLevel: 'Low'
            };
        }

        function analyzeGenderHealthDifferences(patients) {
            return {
                maleLifeExpectancy: 79.9,
                femaleLifeExpectancy: 84.1,
                genderGap: 4.2
            };
        }

        // More helper functions would continue here...
        
        function createMethodComparisonChart(methodComparison) {
            console.log('üìä Creating method comparison chart...');
            
            if (!methodComparison || !methodComparison.methods) {
                console.log('No method comparison data available');
                return;
            }

            const canvas = document.getElementById('methodComparisonChart');
            if (!canvas) {
                console.log('Method comparison canvas not found');
                return;
            }

            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = 800;
            canvas.height = 500;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const methods = methodComparison.methods;
            const metrics = ['accuracy', 'robustness', 'interpretability', 'clinicalUtility'];
            const colors = ['#4a90e2', '#f39c12', '#e74c3c', '#27ae60'];
            const methodColors = ['#3498db', '#e67e22', '#9b59b6', '#1abc9c'];
            
            // Chart dimensions
            const chartX = 80;
            const chartY = 60;
            const chartWidth = 600;
            const chartHeight = 320;
            const barWidth = chartWidth / (methods.length * metrics.length + methods.length);
            const maxValue = 1.0;

            // Draw title
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Method Performance Comparison', canvas.width / 2, 30);

            // Draw axes
            ctx.strokeStyle = '#7f8c8d';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(chartX, chartY);
            ctx.lineTo(chartX, chartY + chartHeight);
            ctx.lineTo(chartX + chartWidth, chartY + chartHeight);
            ctx.stroke();

            // Draw Y-axis labels (0 to 1.0)
            ctx.fillStyle = '#7f8c8d';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 10; i++) {
                const y = chartY + chartHeight - (i / 10) * chartHeight;
                const value = (i / 10).toFixed(1);
                ctx.fillText(value, chartX - 10, y + 3);
                
                // Draw grid lines
                if (i > 0) {
                    ctx.strokeStyle = '#ecf0f1';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(chartX, y);
                    ctx.lineTo(chartX + chartWidth, y);
                    ctx.stroke();
                }
            }

            // Draw bars for each method and metric
            let currentX = chartX + 20;
            methods.forEach((method, methodIndex) => {
                // Method label
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.save();
                ctx.translate(currentX + (barWidth * metrics.length) / 2, chartY + chartHeight + 40);
                ctx.rotate(-Math.PI / 6);
                ctx.fillText(method.name, 0, 0);
                ctx.restore();

                metrics.forEach((metric, metricIndex) => {
                    const value = method[metric];
                    const barHeight = (value / maxValue) * chartHeight;
                    const barY = chartY + chartHeight - barHeight;

                    // Draw bar
                    ctx.fillStyle = colors[metricIndex];
                    ctx.fillRect(currentX, barY, barWidth * 0.8, barHeight);

                    // Draw value label on top of bar
                    if (barHeight > 20) {
                        ctx.fillStyle = '#2c3e50';
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(value.toFixed(2), currentX + (barWidth * 0.8) / 2, barY - 5);
                    }

                    currentX += barWidth;
                });
                currentX += barWidth * 0.5; // Space between methods
            });

            // Draw legend
            const legendX = chartX + chartWidth + 20;
            const legendY = chartY + 50;
            
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Metrics:', legendX, legendY);

            metrics.forEach((metric, index) => {
                const y = legendY + 30 + index * 25;
                
                // Legend color box
                ctx.fillStyle = colors[index];
                ctx.fillRect(legendX, y - 12, 15, 15);
                
                // Legend text
                ctx.fillStyle = '#2c3e50';
                ctx.font = '12px Arial';
                ctx.fillText(metric.charAt(0).toUpperCase() + metric.slice(1), legendX + 25, y);
            });

            // Add ranking summary
            const rankingY = legendY + 150;
            ctx.fillStyle = '#2c3e50';
            ctx.font = 'bold 12px Arial';
            ctx.fillText('Overall Ranking:', legendX, rankingY);

            methodComparison.overallRanking.forEach((methodName, index) => {
                ctx.font = '11px Arial';
                ctx.fillText(`${index + 1}. ${methodName}`, legendX, rankingY + 20 + index * 15);
            });

            console.log('‚úÖ Method comparison chart created successfully');
        }

        // Advanced Assessment Implementation
        function generateAdvancedAssessment() {
            console.log('üìù Generating Advanced Assessment...');
            
            try {
                const level = document.getElementById('assess-level').value;
                const focus = document.getElementById('assess-focus').value;
                const format = document.getElementById('assess-format').value;
                const difficulty = document.getElementById('assess-difficulty').value;
                const numQuestions = document.getElementById('assess-questions').value === 'adaptive-length' ? 
                    (level === 'expert' ? 35 : level === 'researcher' ? 25 : 15) : 
                    parseInt(document.getElementById('assess-questions').value);
                const context = document.getElementById('assess-context').value;
                const timing = document.getElementById('assess-timing').value;
                const feedback = document.getElementById('assess-feedback').value;

                console.log(`üìù Configuration: ${level}, ${focus}, ${format}, ${numQuestions} questions`);

                // Generate assessment questions
                console.log('üìä Creating assessment questions...');
                const assessment = createAdvancedAssessment(level, focus, numQuestions, format, context, difficulty);
                console.log('‚úÖ Questions created');
                
                // Display questions
                console.log('üìã Displaying assessment...');
                displayAdvancedAssessmentQuestions(level, focus, assessment, timing, feedback);
                console.log('‚úÖ Assessment displayed');
                
                console.log('‚úÖ Advanced assessment generated successfully');

            } catch (error) {
                console.error('‚ùå Error generating assessment:', error);
                displayError('assessment-questions', 'Assessment generation failed: ' + error.message);
            }
        }

        function createAdvancedAssessment(level, focus, numQuestions, format, context, difficulty) {
            console.log(`üìù Creating ${level} level assessment on ${focus}...`);
            
            const assessment = {
                level: level,
                focus: focus,
                format: format,
                difficulty: difficulty,
                context: context,
                questions: [],
                metadata: {
                    totalPoints: numQuestions * (format === 'calculation' ? 10 : 5),
                    timeLimit: numQuestions * (format === 'scenario-based' ? 8 : 3),
                    passingScore: 0.7
                }
            };

            // Comprehensive question pools covering all methods
            const questionPools = {
                "comprehensive": [
                    // Classical Regression Questions
                    {
                        question: "In a multiple regression analysis of factors affecting hospital length of stay in Canada, you find that the coefficient for 'rural location' is 1.2 days with a 95% CI of [0.8, 1.6]. What is the correct interpretation?",
                        options: [
                            "A) Rural patients stay exactly 1.2 days longer than urban patients",
                            "B) Being in a rural location increases expected length of stay by 1.2 days, holding other factors constant",
                            "C) 95% of rural patients will stay between 0.8 and 1.6 days longer than urban patients",
                            "D) Rural location causes a 1.2-day increase in hospital stay"
                        ],
                        correct: "B",
                        explanation: "Regression coefficients represent the expected change in the outcome variable for a one-unit change in the predictor, holding all other variables constant. The CI refers to the coefficient estimate, not individual patient predictions.",
                        domain: "classical-regression",
                        difficulty: "intermediate"
                    },
                    {
                        question: "When should you use regularized regression instead of classical multiple regression in Canadian health research?",
                        options: [
                            "A) When you have more than 100 observations",
                            "B) When the number of predictors approaches the sample size or when multicollinearity is severe",
                            "C) When you want to ensure all variables are statistically significant",
                            "D) When conducting causal inference"
                        ],
                        correct: "B",
                        explanation: "Regularization is essential when facing high-dimensional data (p approaches n) or severe multicollinearity, where classical regression would overfit or become unstable.",
                        domain: "regularization",
                        difficulty: "intermediate"
                    },
                    {
                        question: "In a study of medication adherence across multiple Canadian hospitals, why would you use mixed effects models instead of classical regression?",
                        options: [
                            "A) Mixed effects models are more accurate",
                            "B) To account for clustering of patients within hospitals and repeated measures over time",
                            "C) To establish causality",
                            "D) To handle missing data automatically"
                        ],
                        correct: "B",
                        explanation: "Mixed effects models are specifically designed to handle clustering (patients within hospitals) and repeated measures, accounting for correlation within clusters that violates independence assumptions of classical regression.",
                        domain: "mixed-effects",
                        difficulty: "intermediate"
                    },
                    // Causal Inference Questions
                    {
                        question: "You're evaluating the effectiveness of a new diabetes management program using propensity score matching. After matching, what indicates successful covariate balance?",
                        options: [
                            "A) All p-values for covariate differences are >0.05",
                            "B) Standardized mean differences for all covariates are <0.1",
                            "C) The propensity score model has high R¬≤",
                            "D) The treatment effect is statistically significant"
                        ],
                        correct: "B",
                        explanation: "Standardized mean differences <0.1 (or <0.25) indicate good covariate balance after matching. P-values are not appropriate for balance assessment as they depend on sample size.",
                        domain: "causal-inference",
                        difficulty: "advanced"
                    },
                    {
                        question: "For a Canadian health policy evaluation using instrumental variables, which of the following best describes the Local Average Treatment Effect (LATE)?",
                        options: [
                            "A) The effect for the entire population",
                            "B) The effect for compliers whose treatment was influenced by the instrument",
                            "C) The effect in the local health region where the study was conducted",
                            "D) The average of all individual treatment effects"
                        ],
                        correct: "B",
                        explanation: "IV estimates provide the Local Average Treatment Effect (LATE) specifically for compliers - individuals whose treatment status was influenced by the instrument. This may not generalize to the entire population.",
                        domain: "causal-inference",
                        difficulty: "advanced"
                    },
                    // Canadian Context Questions
                    {
                        question: "For a CADTH health technology assessment, which analytical approach best supports coverage decision-making?",
                        options: [
                            "A) Single randomized trial analysis",
                            "B) Mixed effects meta-analysis with Canadian subgroup analysis and budget impact modeling",
                            "C) Descriptive statistics from Canadian administrative data only",
                            "D) International cost-effectiveness studies without Canadian context"
                        ],
                        correct: "B",
                        explanation: "CADTH requires comprehensive evidence including systematic review/meta-analysis, Canadian-specific clinical and economic evaluation, and budget impact assessment using appropriate statistical methods.",
                        domain: "canadian-integration",
                        difficulty: "expert"
                    },
                    {
                        question: "When conducting Indigenous health research in Canada, what methodological considerations are essential?",
                        options: [
                            "A) Use identical methods as for the general Canadian population",
                            "B) Focus exclusively on individual-level biomedical factors",
                            "C) Account for historical trauma, community clustering, and cultural determinants using culturally appropriate mixed effects approaches",
                            "D) Exclude Indigenous populations from comparative analysis"
                        ],
                        correct: "C",
                        explanation: "Indigenous health research requires culturally appropriate methods that account for historical context, community structures, cultural determinants, and potential clustering effects while respecting Indigenous data sovereignty principles.",
                        domain: "canadian-integration",
                        difficulty: "expert"
                    },
                    // Method Integration Questions
                    {
                        question: "In a precision medicine study, what is the optimal sequence for integrating multiple statistical methods?",
                        options: [
                            "A) Causal inference ‚Üí Classical regression ‚Üí Regularization",
                            "B) Regularization for biomarker selection ‚Üí Mixed effects for clustering ‚Üí Causal inference for treatment effects",
                            "C) Mixed effects ‚Üí Instrumental variables ‚Üí Descriptive analysis",
                            "D) Classical regression only for all analyses"
                        ],
                        correct: "B",
                        explanation: "Precision medicine requires: (1) regularization for high-dimensional biomarker discovery, (2) mixed effects to handle institutional/patient clustering, and (3) causal methods for treatment effect estimation.",
                        domain: "method-integration",
                        difficulty: "expert"
                    },
                    {
                        question: "When interpreting regularized regression results in biomarker studies, what key limitation must be communicated?",
                        options: [
                            "A) Regularization always produces unbiased estimates",
                            "B) Selected biomarkers are guaranteed to be causal",
                            "C) Regularization introduces bias to reduce variance, affecting interpretation of coefficients",
                            "D) P-values from regularized models are always valid"
                        ],
                        correct: "C",
                        explanation: "Regularization introduces bias to control overfitting and reduce variance. This bias affects coefficient interpretation, and selected variables require external validation. Traditional p-values may not be valid.",
                        domain: "clinical-translation",
                        difficulty: "advanced"
                    },
                    // Advanced Application Questions
                    {
                        question: "For regulatory submission to Health Canada using real-world evidence, what documentation is essential?",
                        options: [
                            "A) Only final analysis results",
                            "B) Pre-specified analysis plan, multiple sensitivity analyses, validation results, and comprehensive bias assessment",
                            "C) Literature review and traditional meta-analysis only",
                            "D) Single observational study without validation"
                        ],
                        correct: "B",
                        explanation: "Health Canada's RWE guidance requires pre-specified analysis plans, multiple sensitivity analyses using different methods, external validation strategies, and comprehensive assessment of potential biases.",
                        domain: "clinical-translation",
                        difficulty: "expert"
                    }
                ],
                "classical-regression": [
                    {
                        question: "Which assumption of multiple regression is violated when studying health outcomes across different Canadian provinces without accounting for provincial differences?",
                        options: [
                            "A) Linearity",
                            "B) Independence of observations",
                            "C) Normality of residuals",
                            "D) Homoscedasticity"
                        ],
                        correct: "B",
                        explanation: "Observations within provinces may be more similar to each other than to observations in other provinces, violating the independence assumption. This clustering should be addressed through mixed effects models or robust standard errors.",
                        domain: "classical-regression",
                        difficulty: "intermediate"
                    },
                    {
                        question: "In Canadian health services research, when is it appropriate to use interaction terms in multiple regression?",
                        options: [
                            "A) Always, to make the model more complex",
                            "B) When you have theoretical reason to believe the effect of one variable depends on the level of another",
                            "C) Only when all main effects are significant",
                            "D) Never, as they make interpretation too difficult"
                        ],
                        correct: "B",
                        explanation: "Interaction terms should be included when there's theoretical justification that the relationship between a predictor and outcome varies across levels of another variable (effect modification).",
                        domain: "classical-regression",
                        difficulty: "intermediate"
                    }
                ],
                "regularization": [
                    {
                        question: "In a genomics study with 50,000 SNPs and 500 patients, which regularization approach is most appropriate for biomarker discovery?",
                        options: [
                            "A) Ridge regression (L2 penalty)",
                            "B) Lasso regression (L1 penalty)",
                            "C) Elastic net (combined L1 and L2)",
                            "D) No regularization needed"
                        ],
                        correct: "B",
                        explanation: "Lasso regression performs automatic variable selection and is ideal when you expect only a small subset of variables to be relevant (sparse solution), which is typical in genomics studies.",
                        domain: "regularization",
                        difficulty: "advanced"
                    }
                ],
                "mixed-effects": [
                    {
                        question: "In a longitudinal study of patient outcomes across multiple Canadian hospitals, what does the random intercept represent?",
                        options: [
                            "A) The average outcome across all hospitals",
                            "B) Hospital-specific deviations from the overall intercept",
                            "C) Random measurement error",
                            "D) The fixed effect of hospital type"
                        ],
                        correct: "B",
                        explanation: "Random intercepts capture hospital-specific deviations from the overall population intercept, allowing each hospital to have its own baseline level while estimating the common slope.",
                        domain: "mixed-effects",
                        difficulty: "advanced"
                    }
                ],
                "causal-inference": [
                    {
                        question: "Which condition is required for instrumental variables to provide valid causal estimates?",
                        options: [
                            "A) The instrument must be correlated with the outcome",
                            "B) The instrument must be uncorrelated with confounders (exclusion restriction)",
                            "C) The instrument must have a large effect size",
                            "D) The sample size must be very large"
                        ],
                        correct: "B",
                        explanation: "The exclusion restriction requires that the instrument affects the outcome only through its effect on the treatment, not through any other pathway. This is the most critical and often untestable assumption.",
                        domain: "causal-inference",
                        difficulty: "expert"
                    }
                ]
            };

            // Select questions based on focus area
            let selectedQuestions = [];
            
            if (focus === "comprehensive") {
                // Randomly sample from comprehensive pool
                const shuffled = [...questionPools.comprehensive].sort(() => 0.5 - Math.random());
                selectedQuestions = shuffled.slice(0, numQuestions);
            } else {
                // Focus on specific domain but include some comprehensive questions
                const domainQuestions = questionPools[focus] || [];
                const comprehensiveQuestions = questionPools.comprehensive.filter(q => q.domain === focus || q.domain === 'method-integration');
                
                const allRelevant = [...domainQuestions, ...comprehensiveQuestions];
                const shuffled = allRelevant.sort(() => 0.5 - Math.random());
                selectedQuestions = shuffled.slice(0, numQuestions);
                
                // If not enough domain-specific questions, fill with comprehensive
                if (selectedQuestions.length < numQuestions) {
                    const additional = questionPools.comprehensive
                        .filter(q => !selectedQuestions.includes(q))
                        .sort(() => 0.5 - Math.random())
                        .slice(0, numQuestions - selectedQuestions.length);
                    selectedQuestions = [...selectedQuestions, ...additional];
                }
            }

            assessment.questions = selectedQuestions;
            return assessment;
        }

        function displayAdvancedAssessmentQuestions(level, focus, assessment, timing, feedback) {
            // Show assessment card and hide placeholder
            document.getElementById('assessment-placeholder').style.display = 'none';
            document.getElementById('assessment-questions').style.display = 'block';
            
            // Switch to assessment card automatically
            showCard('assessment', 'assessment');

            const timeInfo = timing === 'unlimited' ? 'No time limit' : 
                           timing === 'generous' ? `${Math.ceil(assessment.questions.length * 4.5)} minutes` :
                           timing === 'standard' ? `${assessment.questions.length * 3} minutes` :
                           timing === 'exam' ? `${assessment.questions.length * 2} minutes` :
                           `${Math.ceil(assessment.questions.length * 1.5)} minutes`;

            document.getElementById('assessment-questions').innerHTML = `
                <div class="results-header">
                    <h3>üìù Advanced Assessment - ${assessment.focus.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
                    <p><strong>Level:</strong> ${assessment.level.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())} | <strong>Questions:</strong> ${assessment.questions.length} | <strong>Time:</strong> ${timeInfo}</p>
                    <p><strong>Instructions:</strong> This comprehensive assessment covers advanced statistical methods for Canadian healthcare research. You need 70% to demonstrate competency.</p>
                </div>

                <div class="advanced-feature">
                    <h4>üéØ Assessment Scope</h4>
                    <p><strong>Statistical Methods:</strong> Classical regression, regularization, mixed effects, causal inference</p>
                    <p><strong>Canadian Context:</strong> Health system integration, CADTH standards, provincial policies</p>
                    <p><strong>Professional Skills:</strong> Method selection, clinical interpretation, regulatory compliance</p>
                </div>

                ${assessment.questions.map((q, index) => `
                    <div class="theory-card" style="margin: 1.5rem 0;">
                        <h5>Question ${index + 1} <span style="color: #666; font-weight: normal;">(${q.domain.replace('-', ' ')} ‚Ä¢ ${q.difficulty})</span></h5>
                        <p><strong>${q.question}</strong></p>
                        <div style="margin: 1rem 0;">
                            ${q.options.map(option => `
                                <label style="display: block; margin: 0.5rem 0; cursor: pointer;">
                                    <input type="radio" name="adv_q${index + 1}" value="${option.charAt(0)}" style="margin-right: 0.5rem;">
                                    ${option}
                                </label>
                            `).join('')}
                        </div>
                        <div id="adv_explanation_${index + 1}" style="display: none; background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                            <strong>Explanation:</strong> ${q.explanation}
                            <br><strong>Domain:</strong> ${q.domain.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                        </div>
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="gradeAdvancedAssessment()">üìä Submit Assessment</button>
                    <button class="btn" onclick="showAdvancedAssessmentAnswers()" style="margin-left: 1rem; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);">üëÅÔ∏è Show All Answers</button>
                    <button class="btn" onclick="generateAdvancedAssessment()" style="margin-left: 1rem; background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);">üîÑ Generate New Assessment</button>
                </div>
                
                <div id="advanced-assessment-results" style="display: none;">
                    <!-- Results will be shown here -->
                </div>
            `;

            // Store the correct answers globally for grading
            window.advancedAssessmentAnswers = assessment.questions.map(q => q.correct);
            window.advancedAssessmentQuestions = assessment.questions;
        }

        function gradeAdvancedAssessment() {
            const answers = window.advancedAssessmentAnswers || [];
            const questions = window.advancedAssessmentQuestions || [];
            const totalQuestions = answers.length;
            let correctAnswers = 0;
            let domainPerformance = {};

            // Grade each question and track domain performance
            for (let i = 1; i <= totalQuestions; i++) {
                const selectedAnswer = document.querySelector(`input[name="adv_q${i}"]:checked`);
                const question = questions[i - 1];
                const domain = question.domain;

                if (!domainPerformance[domain]) {
                    domainPerformance[domain] = { correct: 0, total: 0 };
                }
                domainPerformance[domain].total++;

                if (selectedAnswer && selectedAnswer.value === answers[i - 1]) {
                    correctAnswers++;
                    domainPerformance[domain].correct++;
                }
            }

            const score = correctAnswers;
            const percentage = (score / totalQuestions) * 100;
            const passed = percentage >= 70;

            // Calculate competency level
            const competencyLevel = percentage >= 90 ? 'Expert' : 
                                  percentage >= 80 ? 'Advanced' : 
                                  percentage >= 70 ? 'Competent' : 
                                  percentage >= 60 ? 'Developing' : 'Novice';

            // Switch to results card and display performance
            showCard('assessment', 'results');
            document.getElementById('assessment-results-placeholder').style.display = 'none';
            document.getElementById('assessment-performance-results').style.display = 'block';

            document.getElementById('assessment-performance-results').innerHTML = `
                <div class="results-header">
                    <h3>üìä Advanced Assessment Performance Analysis</h3>
                    <p><strong>Overall Score:</strong> ${score}/${totalQuestions} (${percentage.toFixed(1)}%) | <strong>Competency Level:</strong> ${competencyLevel} | <strong>Status:</strong> ${passed ? '‚úÖ Passed' : '‚ùå Needs Development'}</p>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${percentage.toFixed(1)}%</div>
                        <div class="metric-label">Overall Performance</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${competencyLevel}</div>
                        <div class="metric-label">Competency Level</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${Object.keys(domainPerformance).length}</div>
                        <div class="metric-label">Domains Assessed</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${passed ? 'Ready' : 'Needs Work'}</div>
                        <div class="metric-label">Professional Readiness</div>
                    </div>
                </div>

                <h4>üìà Domain-Specific Performance</h4>
                <div class="theory-grid">
                    ${Object.entries(domainPerformance).map(([domain, perf]) => {
                        const domainPercentage = (perf.correct / perf.total) * 100;
                        const domainLevel = domainPercentage >= 80 ? 'Strong' : domainPercentage >= 70 ? 'Competent' : domainPercentage >= 60 ? 'Adequate' : 'Needs Work';
                        return `
                            <div class="theory-card">
                                <h5>${domain.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</h5>
                                <p><strong>Performance:</strong> ${perf.correct}/${perf.total} (${domainPercentage.toFixed(1)}%)</p>
                                <p><strong>Level:</strong> ${domainLevel}</p>
                                <p><strong>Questions:</strong> ${perf.total} assessed</p>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ Canadian Health Research Competency Assessment</h4>
                    <p><strong>Statistical Methods Mastery:</strong> ${percentage >= 80 ? 'Advanced practitioner ready for independent research' : percentage >= 70 ? 'Competent analyst ready for supervised research' : 'Developing skills - requires additional training'}</p>
                    <p><strong>Clinical Translation:</strong> ${percentage >= 75 ? 'Strong ability to communicate findings to clinical stakeholders' : percentage >= 65 ? 'Adequate clinical interpretation skills' : 'Needs development in clinical communication'}</p>
                    <p><strong>Canadian Context Integration:</strong> ${percentage >= 75 ? 'Excellent understanding of Canadian health system applications' : percentage >= 65 ? 'Good grasp of Canadian healthcare context' : 'Requires strengthening in Canadian health policy'}</p>
                    <p><strong>Regulatory Readiness:</strong> ${percentage >= 80 ? 'Ready to contribute to CADTH submissions and Health Canada interactions' : percentage >= 70 ? 'Adequate for regulatory support roles' : 'Needs development for regulatory applications'}</p>
                </div>

                <div class="advanced-feature">
                    <h4>üéØ Professional Development Recommendations</h4>
                    ${percentage >= 85 ? `
                        <p><strong>Excellence Track:</strong> Consider advanced methodological research, teaching opportunities, and leadership roles in Canadian health analytics</p>
                        <p><strong>Next Steps:</strong> Pursue specialized training in cutting-edge methods (causal machine learning, Bayesian methods), mentor junior researchers</p>
                        <p><strong>Career Opportunities:</strong> Senior researcher roles, statistical consulting, regulatory agency positions</p>
                    ` : percentage >= 70 ? `
                        <p><strong>Advancement Focus:</strong> Strengthen weaker domain areas and gain more experience with complex real-world applications</p>
                        <p><strong>Skill Building:</strong> Practice integrated method workflows, improve clinical interpretation, deepen Canadian policy knowledge</p>
                        <p><strong>Career Path:</strong> Health services researcher, biostatistician, health economics analyst</p>
                    ` : `
                        <p><strong>Foundation Building:</strong> Review fundamental concepts in statistical methods before attempting advanced integration</p>
                        <p><strong>Recommended Learning:</strong> Take additional coursework, work through guided examples, seek mentorship</p>
                        <p><strong>Practice Areas:</strong> Basic regression interpretation, study design principles, Canadian health system fundamentals</p>
                    `}
                </div>

                <div class="regulatory-box">
                    <h4>üèõÔ∏è Certification and Credentials</h4>
                    <p><strong>Statistical Society of Canada:</strong> ${percentage >= 80 ? 'Qualified for PStat designation pathway' : 'Continue developing statistical competencies'}</p>
                    <p><strong>CADTH Methodology Training:</strong> ${percentage >= 75 ? 'Ready for HTA methods certification' : 'Build foundational knowledge first'}</p>
                    <p><strong>Provincial Health Analytics:</strong> ${percentage >= 70 ? 'Qualified for entry-level analyst positions' : 'Develop core competencies'}</p>
                    <p><strong>Academic Programs:</strong> ${percentage >= 75 ? 'Ready for advanced graduate studies' : percentage >= 65 ? 'Prepare for graduate coursework' : 'Strengthen undergraduate foundation'}</p>
                </div>
            `;

            // Display answer explanations in assessment tab
            document.getElementById('advanced-assessment-results').style.display = 'block';
            document.getElementById('advanced-assessment-results').innerHTML = `
                <div class="results-header">
                    <h4>üìä Assessment Complete</h4>
                    <p><strong>Performance Summary:</strong> ${score}/${totalQuestions} (${percentage.toFixed(1)}%) ‚Ä¢ ${competencyLevel} Level</p>
                    <p>Detailed performance analysis available in the Performance Analysis tab.</p>
                </div>
            `;
        }

        function showAdvancedAssessmentAnswers() {
            const totalQuestions = window.advancedAssessmentAnswers ? window.advancedAssessmentAnswers.length : 5;
            for (let i = 1; i <= totalQuestions; i++) {
                const explanationDiv = document.getElementById(`adv_explanation_${i}`);
                if (explanationDiv) {
                    explanationDiv.style.display = 'block';
                }
            }
        }

        function getQuestionPools() {
            return {
                'comprehensive': {
                    'multiple-choice': [
                        {
                            question: "In a Ridge regression model, increasing the regularization parameter Œª will:",
                            options: [
                                "A) Increase model complexity and reduce bias",
                                "B) Decrease model complexity and increase bias", 
                                "C) Have no effect on bias-variance tradeoff",
                                "D) Only affect the intercept term"
                            ],
                            correct: "B",
                            explanation: "Ridge regression shrinks coefficients toward zero, reducing complexity and increasing bias while reducing variance.",
                            difficulty: "intermediate"
                        },
                        {
                            question: "Which assumption is MOST critical for valid instrumental variable estimation?",
                            options: [
                                "A) The instrument is strongly correlated with the outcome",
                                "B) The instrument affects the outcome only through the treatment",
                                "C) The instrument is normally distributed",
                                "D) The treatment effect is homogeneous across populations"
                            ],
                            correct: "B",
                            explanation: "The exclusion restriction requires that the instrument affects the outcome only through its effect on the treatment.",
                            difficulty: "advanced"
                        }
                    ],
                    'scenario-based': [
                        {
                            question: "A Canadian multi-provincial study shows significant clustering of diabetes outcomes by province (ICC = 0.15). Design an appropriate statistical analysis plan.",
                            context: "Study involves 5,000 patients across 10 provinces, 3-year follow-up, multiple patient and provincial-level predictors.",
                            requirements: [
                                "Justify choice of statistical method",
                                "Address clustering appropriately", 
                                "Consider Canadian healthcare context",
                                "Discuss generalizability"
                            ],
                            points: 15,
                            difficulty: "advanced"
                        }
                    ]
                },
                'regularization': {
                    'multiple-choice': [
                        {
                            question: "When analyzing Canadian genomic data with 10,000 SNPs and 500 patients, which method is most appropriate?",
                            options: [
                                "A) Standard multiple regression",
                                "B) Ridge regression only",
                                "C) Lasso or Elastic Net regression",
                                "D) Propensity score matching"
                            ],
                            correct: "C",
                            explanation: "High-dimensional data (p > n) requires feature selection, making Lasso or Elastic Net most appropriate.",
                            difficulty: "intermediate"
                        }
                    ]
                },
                'causal-inference': {
                    'multiple-choice': [
                        {
                            question: "In a propensity score analysis of Canadian administrative data, you achieve good balance (SMD < 0.1) but lose 40% of your sample due to matching. What should you do?",
                            options: [
                                "A) Accept the sample loss for better balance",
                                "B) Use inverse probability weighting instead",
                                "C) Loosen the matching caliper",
                                "D) Switch to regression adjustment"
                            ],
                            correct: "B",
                            explanation: "IPW can maintain the full sample while achieving balance through reweighting.",
                            difficulty: "advanced"
                        }
                    ]
                },
                'canadian-policy': {
                    'multiple-choice': [
                        {
                            question: "Which Canadian organization sets evidence standards for health technology assessment?",
                            options: [
                                "A) Health Canada",
                                "B) CADTH (Canadian Agency for Drugs and Technologies in Health)",
                                "C) CIHI (Canadian Institute for Health Information)", 
                                "D) Statistics Canada"
                            ],
                            correct: "B",
                            explanation: "CADTH provides evidence-based recommendations on health technologies to Canadian health care decision-makers.",
                            difficulty: "basic"
                        }
                    ]
                }
            };
        }

        function selectQuestion(pool, level, format, questionIndex) {
            const formatQuestions = pool[format] || pool['multiple-choice'];
            const levelFilter = {
                'graduate': ['basic', 'intermediate'],
                'professional': ['basic', 'intermediate', 'advanced'],
                'researcher': ['intermediate', 'advanced'],
                'expert': ['advanced']
            };
            
            const appropriateQuestions = formatQuestions.filter(q => 
                levelFilter[level].includes(q.difficulty)
            );
            
            if (appropriateQuestions.length === 0) {
                return createDefaultQuestion(format, questionIndex);
            }
            
            const questionIndex_mod = questionIndex % appropriateQuestions.length;
            return {
                ...appropriateQuestions[questionIndex_mod],
                id: questionIndex + 1
            };
        }

        function createDefaultQuestion(format, index) {
            if (format === 'multiple-choice') {
                return {
                    id: index + 1,
                    question: "What is the primary advantage of using mixed effects models in healthcare research?",
                    options: [
                        "A) They eliminate all confounding",
                        "B) They account for clustering and repeated measures",
                        "C) They require fewer assumptions than OLS",
                        "D) They always provide causal estimates"
                    ],
                    correct: "B",
                    explanation: "Mixed effects models properly handle clustering and correlation in hierarchical data structures.",
                    difficulty: "intermediate"
                };
            } else if (format === 'scenario-based') {
                return {
                    id: index + 1,
                    question: "Analyze a Canadian healthcare intervention using appropriate statistical methods.",
                    context: "Multi-site randomized trial across Canadian provinces.",
                    requirements: ["Choose appropriate analysis", "Justify methodology", "Consider Canadian context"],
                    points: 10,
                    difficulty: "intermediate"
                };
            } else {
                return {
                    id: index + 1,
                    question: "Calculate the required sample size for detecting a clinically meaningful effect.",
                    context: "Two-group comparison, Œ± = 0.05, power = 80%, effect size = 0.5",
                    answer: "64 per group",
                    points: 10,
                    difficulty: "intermediate"
                };
            }
        }

        function displayAssessmentQuestions(level, focus, assessment) {
            document.getElementById('assessment-questions').style.display = 'block';
            document.getElementById('assessment-questions').innerHTML = `
                <div class="results-header">
                    <h3>üìù Advanced Assessment: ${focus.charAt(0).toUpperCase() + focus.slice(1).replace('-', ' ')}</h3>
                    <p><strong>Level:</strong> ${level} | <strong>Questions:</strong> ${assessment.questions.length} | <strong>Time:</strong> ${assessment.metadata.timeLimit} minutes</p>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">${assessment.questions.length}</div>
                        <div class="metric-label">Total Questions</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${assessment.metadata.totalPoints}</div>
                        <div class="metric-label">Total Points</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${assessment.metadata.timeLimit}</div>
                        <div class="metric-label">Time Limit (min)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${(assessment.metadata.passingScore * 100).toFixed(0)}%</div>
                        <div class="metric-label">Passing Score</div>
                    </div>
                </div>

                <div style="background: #f0f8ff; border: 2px solid #4a90e2; border-radius: 12px; padding: 1rem; margin: 2rem 0;">
                    <h4>üìã Assessment Instructions</h4>
                    <ul>
                        <li>Read each question carefully and select the best answer</li>
                        <li>For scenario-based questions, provide comprehensive responses addressing all requirements</li>
                        <li>Consider Canadian healthcare context when applicable</li>
                        <li>You may reference statistical formulas and Canadian health policy frameworks</li>
                    </ul>
                </div>

                <div id="assessment-form">
                    ${assessment.questions.map((q, index) => generateQuestionHTML(q, index, assessment.format)).join('')}
                </div>

                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn" onclick="submitAssessment('${level}', '${focus}')">üìä Submit Assessment</button>
                    <button class="btn" onclick="showAssessmentAnswers()" style="margin-left: 1rem; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);">üëÅÔ∏è Show Answers</button>
                </div>
            `;

            // Store assessment data globally for grading
            window.currentAssessment = assessment;
        }

        function generateQuestionHTML(question, index, format) {
            if (format === 'multiple-choice') {
                return `
                    <div class="theory-card" style="margin: 2rem 0;">
                        <h4>Question ${question.id}</h4>
                        <p><strong>${question.question}</strong></p>
                        <div style="margin: 1rem 0;">
                            ${question.options.map(option => `
                                <label style="display: block; margin: 0.5rem 0; cursor: pointer;">
                                    <input type="radio" name="question_${question.id}" value="${option.charAt(0)}" style="margin-right: 0.5rem;">
                                    ${option}
                                </label>
                            `).join('')}
                        </div>
                        <div class="question-explanation" id="explanation_${question.id}" style="display: none; background: #e8f8e8; padding: 1rem; margin-top: 1rem; border-radius: 8px;">
                            <strong>Correct Answer:</strong> ${question.correct})<br>
                            <strong>Explanation:</strong> ${question.explanation}
                        </div>
                    </div>
                `;
            } else if (format === 'scenario-based') {
                return `
                    <div class="theory-card" style="margin: 2rem 0;">
                        <h4>Scenario ${question.id}</h4>
                        <p><strong>${question.question}</strong></p>
                        <div style="background: #f8fff8; padding: 1rem; margin: 1rem 0; border-radius: 8px;">
                            <strong>Context:</strong> ${question.context}
                        </div>
                        <div style="margin: 1rem 0;">
                            <strong>Requirements:</strong>
                            <ul>
                                ${question.requirements.map(req => `<li>${req}</li>`).join('')}
                            </ul>
                        </div>
                        <textarea name="scenario_${question.id}" rows="8" style="width: 100%; padding: 0.75rem; border: 2px solid #e8f8e8; border-radius: 8px; font-family: inherit;" placeholder="Provide your detailed response here..."></textarea>
                        <div style="color: #5a7c5a; font-size: 0.9rem; margin-top: 0.5rem;">
                            Points: ${question.points} | Difficulty: ${question.difficulty}
                        </div>
                    </div>
                `;
            } else { // calculation format
                return `
                    <div class="theory-card" style="margin: 2rem 0;">
                        <h4>Calculation ${question.id}</h4>
                        <p><strong>${question.question}</strong></p>
                        <div style="background: #f8fff8; padding: 1rem; margin: 1rem 0; border-radius: 8px;">
                            <strong>Given:</strong> ${question.context}
                        </div>
                        <div style="margin: 1rem 0;">
                            <label style="display: block; margin-bottom: 0.5rem;"><strong>Your Answer:</strong></label>
                            <input type="text" name="calculation_${question.id}" style="width: 100%; padding: 0.75rem; border: 2px solid #e8f8e8; border-radius: 8px;" placeholder="Show your calculation and final answer...">
                        </div>
                        <div class="question-explanation" id="calc_explanation_${question.id}" style="display: none; background: #e8f8e8; padding: 1rem; margin-top: 1rem; border-radius: 8px;">
                            <strong>Correct Answer:</strong> ${question.answer || 'See detailed solution'}<br>
                            <strong>Solution:</strong> ${question.explanation || 'Step-by-step calculation provided.'}
                        </div>
                    </div>
                `;
            }
        }

        function submitAssessment(level, focus) {
            console.log('üìä Submitting assessment...');
            
            try {
                const assessment = window.currentAssessment;
                const responses = collectAssessmentResponses(assessment);
                const results = gradeAssessment(assessment, responses);
                
                displayAssessmentResults(level, focus, assessment, responses, results);
                
            } catch (error) {
                console.error('‚ùå Error submitting assessment:', error);
                alert('Error submitting assessment. Please check your responses and try again.');
            }
        }

        function collectAssessmentResponses(assessment) {
            const responses = {};
            
            assessment.questions.forEach(question => {
                if (assessment.format === 'multiple-choice') {
                    const selected = document.querySelector(`input[name="question_${question.id}"]:checked`);
                    responses[question.id] = selected ? selected.value : null;
                } else if (assessment.format === 'scenario-based') {
                    const textarea = document.querySelector(`textarea[name="scenario_${question.id}"]`);
                    responses[question.id] = textarea ? textarea.value.trim() : '';
                } else { // calculation
                    const input = document.querySelector(`input[name="calculation_${question.id}"]`);
                    responses[question.id] = input ? input.value.trim() : '';
                }
            });
            
            return responses;
        }

        function gradeAssessment(assessment, responses) {
            const results = {
                totalQuestions: assessment.questions.length,
                correctAnswers: 0,
                totalPoints: 0,
                earnedPoints: 0,
                questionResults: []
            };
            
            assessment.questions.forEach(question => {
                const userResponse = responses[question.id];
                let isCorrect = false;
                let pointsEarned = 0;
                
                if (assessment.format === 'multiple-choice') {
                    isCorrect = userResponse === question.correct;
                    pointsEarned = isCorrect ? 5 : 0;
                    results.totalPoints += 5;
                } else if (assessment.format === 'scenario-based') {
                    // Simplified grading for scenarios
                    const responseLength = userResponse ? userResponse.length : 0;
                    if (responseLength > 200) pointsEarned = question.points;
                    else if (responseLength > 100) pointsEarned = question.points * 0.7;
                    else if (responseLength > 50) pointsEarned = question.points * 0.4;
                    results.totalPoints += question.points;
                    isCorrect = pointsEarned >= question.points * 0.7;
                } else { // calculation
                    // Simplified grading for calculations
                    isCorrect = userResponse && userResponse.length > 0;
                    pointsEarned = isCorrect ? question.points : 0;
                    results.totalPoints += question.points;
                }
                
                if (isCorrect) results.correctAnswers++;
                results.earnedPoints += pointsEarned;
                
                results.questionResults.push({
                    questionId: question.id,
                    correct: isCorrect,
                    pointsEarned: pointsEarned,
                    userResponse: userResponse
                });
            });
            
            results.percentage = (results.earnedPoints / results.totalPoints) * 100;
            results.passed = results.percentage >= (assessment.metadata.passingScore * 100);
            
            return results;
        }

        function displayAssessmentResults(level, focus, assessment, responses, results) {
            document.getElementById('assessment-results').style.display = 'block';
            document.getElementById('assessment-results').innerHTML = `
                <div class="results-header">
                    <h3>üìä Assessment Results: ${focus.charAt(0).toUpperCase() + focus.slice(1).replace('-', ' ')}</h3>
                    <p><strong>Level:</strong> ${level} | <strong>Score:</strong> ${results.earnedPoints}/${results.totalPoints} (${results.percentage.toFixed(1)}%)</p>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card ${results.passed ? '' : 'highlight'}">
                        <div class="metric-value">${results.percentage.toFixed(1)}%</div>
                        <div class="metric-label">${results.passed ? '‚úÖ Passed' : '‚ùå Did Not Pass'}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.correctAnswers}/${results.totalQuestions}</div>
                        <div class="metric-label">Correct Answers</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.earnedPoints}</div>
                        <div class="metric-label">Points Earned</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${getPerformanceLevel(results.percentage)}</div>
                        <div class="metric-label">Performance Level</div>
                    </div>
                </div>

                <div class="canadian-highlight">
                    <h4>üá®üá¶ Canadian Healthcare Analytics Competency Assessment</h4>
                    <p><strong>Competency Level:</strong> ${assessCompetencyLevel(level, results.percentage)}</p>
                    <p><strong>Strengths:</strong> ${identifyStrengths(assessment, results)}</p>
                    <p><strong>Areas for Improvement:</strong> ${identifyWeaknesses(assessment, results)}</p>
                    <p><strong>Recommended Learning Path:</strong> ${recommendLearningPath(focus, results)}</p>
                </div>

                <div class="advanced-feature">
                    <h4>‚ö° Detailed Performance Analysis</h4>
                    <p><strong>Statistical Methods Knowledge:</strong> ${assessMethodsKnowledge(results, focus)}</p>
                    <p><strong>Canadian Policy Understanding:</strong> ${assessPolicyKnowledge(results, focus)}</p>
                    <p><strong>Practical Application Skills:</strong> ${assessApplicationSkills(results, assessment.format)}</p>
                    <p><strong>Critical Thinking:</strong> ${assessCriticalThinking(results, assessment.format)}</p>
                </div>

                <div class="regulatory-box">
                    <h4>üèõÔ∏è Professional Development Recommendations</h4>
                    <p><strong>Certification Readiness:</strong> ${assessCertificationReadiness(level, results.percentage)}</p>
                    <p><strong>Continuing Education:</strong> ${recommendContinuingEducation(focus, results)}</p>
                    <p><strong>Practice Opportunities:</strong> ${suggestPracticeOpportunities(level, focus)}</p>
                    <p><strong>Canadian Context Skills:</strong> ${assessCanadianContextSkills(results)}</p>
                </div>
            `;
        }

        function showAssessmentAnswers() {
            const assessment = window.currentAssessment;
            if (!assessment) return;
            
            assessment.questions.forEach(question => {
                const explanationDiv = document.getElementById(`explanation_${question.id}`) || 
                                     document.getElementById(`calc_explanation_${question.id}`);
                if (explanationDiv) {
                    explanationDiv.style.display = 'block';
                }
            });
        }

        function getPerformanceLevel(percentage) {
            if (percentage >= 90) return 'Excellent';
            if (percentage >= 80) return 'Good';
            if (percentage >= 70) return 'Satisfactory';
            if (percentage >= 60) return 'Needs Improvement';
            return 'Unsatisfactory';
        }

        function assessCompetencyLevel(level, percentage) {
            if (percentage >= 85) return `Advanced ${level} level competency achieved`;
            if (percentage >= 70) return `Competent at ${level} level`;
            return `Developing ${level} level competency`;
        }

        function identifyStrengths(assessment, results) {
            const correctQuestions = results.questionResults.filter(r => r.correct).length;
            if (correctQuestions >= assessment.questions.length * 0.8) {
                return `Strong grasp of ${assessment.focus} concepts and methodology`;
            } else {
                return 'Good foundation with room for development';
            }
        }

        function identifyWeaknesses(assessment, results) {
            const incorrectQuestions = results.questionResults.filter(r => !r.correct).length;
            if (incorrectQuestions > assessment.questions.length * 0.3) {
                return `Focus on ${assessment.focus} fundamentals and Canadian healthcare applications`;
            } else {
                return 'Minor gaps in advanced concepts';
            }
        }

        function recommendLearningPath(focus, results) {
            if (results.percentage < 70) {
                return `Review ${focus} fundamentals, practice with Canadian healthcare datasets`;
            } else {
                return `Advance to specialized applications and real-world case studies`;
            }
        }

        // Additional helper functions for assessment grading and feedback...
        function assessMethodsKnowledge(results, focus) {
            return results.percentage >= 75 ? 'Strong' : 'Needs development';
        }

        function assessPolicyKnowledge(results, focus) {
            return 'Good understanding of Canadian healthcare context';
        }

        function assessApplicationSkills(results, format) {
            if (format === 'scenario-based') {
                return results.percentage >= 70 ? 'Good practical application skills' : 'Practice real-world scenarios';
            }
            return 'Adequate for assessment format';
        }

        function assessCriticalThinking(results, format) {
            return results.percentage >= 80 ? 'Strong analytical reasoning' : 'Develop critical analysis skills';
        }

        function assessCertificationReadiness(level, percentage) {
            if (percentage >= 85) return `Ready for professional certification at ${level} level`;
            return `Additional preparation needed for certification`;
        }

        function recommendContinuingEducation(focus, results) {
            return `Advanced courses in ${focus} and Canadian health policy integration`;
        }

        function suggestPracticeOpportunities(level, focus) {
            return `Work with Canadian health administrative databases and real-world ${focus} projects`;
        }

        function assessCanadianContextSkills(results) {
            return results.percentage >= 70 ? 'Good Canadian healthcare system knowledge' : 'Study Canadian health policy frameworks';
        }

        // Additional helper functions for Canadian health system analysis
        function generateFamilyDoctorAccess(province) {
            const provincialRates = {
                'ON': 0.85, 'QC': 0.88, 'BC': 0.82, 'AB': 0.84, 'MB': 0.81,
                'SK': 0.79, 'NS': 0.86, 'NB': 0.83, 'PE': 0.87, 'NL': 0.78
            };
            const baseRate = provincialRates[province] || 0.83;
            return Math.random() < baseRate;
        }

        function generateWaitTime(province) {
            const provincialWaitTimes = {
                'ON': 35, 'QC': 42, 'BC': 38, 'AB': 33, 'MB': 45,
                'SK': 48, 'NS': 41, 'NB': 44, 'PE': 39, 'NL': 52
            };
            const baseWait = provincialWaitTimes[province] || 40;
            return baseWait + (Math.random() - 0.5) * 20;
        }

        function generateLifeExpectancy(province, population) {
            const provincialLE = {
                'ON': 82.1, 'QC': 82.4, 'BC': 82.8, 'AB': 81.9, 'MB': 81.2,
                'SK': 80.8, 'NS': 81.7, 'NB': 81.3, 'PE': 81.8, 'NL': 80.9
            };
            const baseLE = provincialLE[province] || 81.8;
            
            // Adjust for population type
            let adjustment = 0;
            if (population === 'indigenous') adjustment = -8.5;
            else if (population === 'rural-remote') adjustment = -1.2;
            else if (population === 'immigrants') adjustment = +1.5;
            
            return baseLE + adjustment + (Math.random() - 0.5) * 4;
        }

        function generateHealthcareCosts(province) {
            const provincialCosts = {
                'ON': 6800, 'QC': 6200, 'BC': 7100, 'AB': 7500, 'MB': 6400,
                'SK': 6600, 'NS': 6900, 'NB': 6500, 'PE': 6300, 'NL': 7200
            };
            const baseCost = provincialCosts[province] || 6800;
            return baseCost + (Math.random() - 0.5) * 2000;
        }

        function generateIncome(province, population) {
            const provincialIncome = {
                'ON': 65000, 'QC': 58000, 'BC': 68000, 'AB': 72000, 'MB': 55000,
                'SK': 62000, 'NS': 53000, 'NB': 51000, 'PE': 52000, 'NL': 57000
            };
            const baseIncome = provincialIncome[province] || 60000;
            
            // Population adjustments
            let adjustment = 1.0;
            if (population === 'indigenous') adjustment = 0.7;
            else if (population === 'rural-remote') adjustment = 0.85;
            else if (population === 'immigrants') adjustment = 0.9;
            
            return baseIncome * adjustment * (0.5 + Math.random());
        }

        function generateIndigenousStatus(province, population) {
            if (population === 'indigenous') return true;
            const provincialRates = {
                'ON': 0.025, 'QC': 0.015, 'BC': 0.055, 'AB': 0.065, 'MB': 0.18,
                'SK': 0.165, 'NS': 0.051, 'NB': 0.051, 'PE': 0.016, 'NL': 0.089
            };
            const rate = provincialRates[province] || 0.05;
            return Math.random() < rate;
        }

        function generateRuralStatus(province) {
            const provincialRural = {
                'ON': 0.14, 'QC': 0.20, 'BC': 0.14, 'AB': 0.17, 'MB': 0.28,
                'SK': 0.34, 'NS': 0.43, 'NB': 0.48, 'PE': 0.53, 'NL': 0.42
            };
            const rate = provincialRural[province] || 0.25;
            return Math.random() < rate;
        }

        function generateImmigrantStatus(province, population) {
            if (population === 'immigrants') return true;
            const provincialRates = {
                'ON': 0.29, 'QC': 0.14, 'BC': 0.28, 'AB': 0.21, 'MB': 0.18,
                'SK': 0.11, 'NS': 0.05, 'NB': 0.04, 'PE': 0.05, 'NL': 0.02
            };
            const rate = provincialRates[province] || 0.15;
            return Math.random() < rate;
        }

        function getLinkageQuality(linkage) {
            const linkageQuality = {
                'within-province': 0.95,
                'multi-province': 0.85,
                'federal-provincial': 0.80,
                'survey-admin': 0.88
            };
            return linkageQuality[linkage] || 0.90;
        }

        function getLinkageStrategyDetails(linkage) {
            const strategies = {
                'within-province': {
                    description: 'Single provincial health administrative data linkage',
                    strength: 'High linkage success rates, consistent coding'
                },
                'multi-province': {
                    description: 'Multi-jurisdictional data sharing agreements',
                    strength: 'Broader population coverage, policy variation analysis'
                },
                'federal-provincial': {
                    description: 'Federal survey linked to provincial administrative data',
                    strength: 'Rich survey data with administrative outcomes'
                }
            };
            return strategies[linkage] || strategies['within-province'];
        }

        function getCanadianPopulationDetails(population) {
            const populations = {
                'general': {
                    description: 'Representative sample of Canadian population',
                    considerations: 'Standard demographic adjustments for age, sex, region'
                },
                'indigenous': {
                    description: 'First Nations, M√©tis, and Inuit populations',
                    considerations: 'Cultural competency, Jordan\'s Principle, historical trauma effects'
                },
                'rural-remote': {
                    description: 'Rural and remote community populations',
                    considerations: 'Geographic isolation, limited specialist access, transportation barriers'
                },
                'immigrants': {
                    description: 'Recent immigrants and refugee populations',
                    considerations: 'Healthy immigrant effect, language barriers, cultural adaptation'
                }
            };
            return populations[population] || populations['general'];
        }

        // Additional functions for complete implementation
        function calculateAccessToCareMeasures(patients) {
            return {
                familyDoctorAccess: (patients.filter(p => p.hasFamilyDoctor).length / patients.length) * 100
            };
        }

        function calculateQualityMeasures(patients, standard) {
            return {
                averageQuality: 7.5 // Simplified
            };
        }

        function calculateEfficiencyMeasures(patients) {
            return {
                costPerQALY: 45000,
                healthSpendingGDP: 11.6,
                adminCosts: 8.2,
                resourceUtilization: 78.5,
                transferEfficiency: 23.1
            };
        }

        function calculateEquityMeasures(patients) {
            return {
                incomeInequity: 0.089,
                geographicVariation: 0.156,
                culturalBarriers: 12.3
            };
        }

        function assessDataCoverage(data) {
            return 0.92; // 92% coverage
        }

        function assessDataTimeliness(data) {
            return 0.88; // 88% timely
        }

        function assessPrivacyCompliance(privacy, data) {
            return {
                overallScore: 0.94,
                pipedaCompliance: true,
                provincialCompliance: true
            };
        }

        function assessCanadaHealthActCompliance(results) {
            return 96; // 96% compliance
        }

        // Placeholder functions for remaining helpers
        function getRegulatoryEvidenceStandards(path, results) { return "Meets regulatory standards"; }
        function getCostEffectivenessGuidance(path, results) { return "Cost-effective at $50,000/QALY"; }
        function getRealWorldEvidenceRequirements(path) { return "Multi-site validation required"; }
        function assessSubmissionReadiness(path, results) { return "Ready for submission"; }
        function calculateSystemRanking(results) { return 8.2; }
        function identifySystemStrengths(results) { return ["Universal access", "Cost control"]; }
        function identifyImprovementAreas(results) { return ["Wait times", "Rural access"]; }
        function generateBenchmarkComparison(results) { return "Above OECD average"; }

        // Real-world application helper functions
        function getStudyDesign(scenario, timeframe) {
            return {
                type: scenario === 'drug-safety' ? 'Cohort study' : 'Intervention study',
                duration: timeframe
            };
        }

        function getSampleSize(scope, complexity) {
            const baseSizes = {
                'local': 500, 'provincial': 2000, 'regional': 5000, 'national': 10000
            };
            const multiplier = complexity === 'regulatory-submission' ? 2 : 1;
            return (baseSizes[scope] || 1000) * multiplier;
        }

        function getDataTypes(scenario, methods) {
            return ['Administrative claims', 'Clinical outcomes', 'Demographics'];
        }

        function getScenarioOutcomes(scenario) {
            const outcomes = {
                'drug-safety': ['Adverse events', 'Effectiveness'],
                'health-equity': ['Health disparities', 'Access measures'],
                'quality-improvement': ['Quality indicators', 'Patient satisfaction'],
                'policy-evaluation': ['Process measures', 'Health outcomes'],
                'resource-allocation': ['Cost-effectiveness', 'Efficiency metrics']
            };
            return outcomes[scenario] || ['Health outcomes'];
        }

        function getScenarioStakeholders(scenario) {
            return ['Clinicians', 'Patients', 'Policymakers', 'Payers'];
        }

        function getScenarioChallenges(scenario, scope) {
            return ['Data quality', 'Confounding bias', 'Generalizability'];
        }

        function getProjectTimeline(timeframe, complexity) {
            const timelines = {
                'cross-sectional': '6 months',
                'short-term': '12 months', 
                'medium-term': '18 months',
                'long-term': '24+ months'
            };
            return timelines[timeframe] || '12 months';
        }

        function generateScenarioData(scenario, sampleSize, scope) {
            const data = [];
            for (let i = 0; i < sampleSize; i++) {
                data.push({
                    id: i,
                    age: 45 + Math.random() * 35,
                    outcome: Math.random() * 100,
                    treatment: Math.random() > 0.5 ? 1 : 0
                });
            }
            return data;
        }

        function planAnalysisSequence(methods, complexity) {
            return ['Descriptive', 'Inferential', 'Causal'];
        }

        function performDescriptiveAnalysis(data) {
            return {
                populationSummary: 'Representative sample',
                trends: 'Stable patterns',
                dataQuality: 'High'
            };
        }

        function performRegressionAnalysis(data) {
            return {
                rSquared: 0.65,
                power: 0.85,
                significance: 'p < 0.05',
                clinical: 'Meaningful effect'
            };
        }

        function performCausalAnalysis(data) {
            return {
                treatmentEffect: -0.15,
                confoundingControl: 'Adequate',
                causalStrength: 'Strong',
                generalizability: 'Good'
            };
        }

        function performPredictiveModeling(data) {
            return {
                accuracy: 0.82,
                sensitivity: 0.78,
                specificity: 0.85
            };
        }

        function performPolicyAnalysis(data, results) {
            return {
                implementationFeasibility: 0.75
            };
        }

        function compareMethodologies(results) {
            console.log('üìä Comparing methodologies across pipeline...');
            
            const methodComparison = {
                methods: [
                    {
                        name: 'Classical Regression',
                        accuracy: 0.72 + Math.random() * 0.15,
                        robustness: 0.65 + Math.random() * 0.20,
                        interpretability: 0.90 + Math.random() * 0.08,
                        computationalSpeed: 0.95 + Math.random() * 0.05,
                        assumptions: 'Moderate',
                        clinicalUtility: 0.75 + Math.random() * 0.15
                    },
                    {
                        name: 'Regularized Regression',
                        accuracy: 0.78 + Math.random() * 0.12,
                        robustness: 0.80 + Math.random() * 0.15,
                        interpretability: 0.70 + Math.random() * 0.15,
                        computationalSpeed: 0.85 + Math.random() * 0.10,
                        assumptions: 'Relaxed',
                        clinicalUtility: 0.82 + Math.random() * 0.12
                    },
                    {
                        name: 'Mixed Effects',
                        accuracy: 0.75 + Math.random() * 0.18,
                        robustness: 0.85 + Math.random() * 0.12,
                        interpretability: 0.65 + Math.random() * 0.20,
                        computationalSpeed: 0.70 + Math.random() * 0.15,
                        assumptions: 'Complex',
                        clinicalUtility: 0.80 + Math.random() * 0.15
                    },
                    {
                        name: 'Causal Inference',
                        accuracy: 0.68 + Math.random() * 0.22,
                        robustness: 0.75 + Math.random() * 0.20,
                        interpretability: 0.85 + Math.random() * 0.12,
                        computationalSpeed: 0.60 + Math.random() * 0.20,
                        assumptions: 'Stringent',
                        clinicalUtility: 0.90 + Math.random() * 0.08
                    }
                ],
                overallRanking: [],
                bestForPurpose: {
                    prediction: 'Regularized Regression',
                    causalInference: 'Causal Inference',
                    clustering: 'Mixed Effects',
                    interpretability: 'Classical Regression'
                },
                integrationBenefit: {
                    accuracyGain: 0.15,
                    robustnessGain: 0.22,
                    confidenceIncrease: 0.28,
                    clinicalAcceptance: 0.85
                }
            };

            // Calculate overall scores
            methodComparison.methods.forEach(method => {
                method.overallScore = (
                    method.accuracy * 0.3 + 
                    method.robustness * 0.25 + 
                    method.interpretability * 0.2 + 
                    method.clinicalUtility * 0.25
                );
            });

            // Rank methods by overall score
            methodComparison.overallRanking = methodComparison.methods
                .sort((a, b) => b.overallScore - a.overallScore)
                .map(method => method.name);

            return methodComparison;
        }

        function performExternalValidation(data, results, validationStrategy) {
            console.log(`üîç Performing external validation using ${validationStrategy} strategy...`);
            
            const validationResults = {
                strategy: validationStrategy || 'internal',
                externalValidity: 0.70 + Math.random() * 0.25,
                temporalStability: 0.75 + Math.random() * 0.20,
                geographicGeneralizability: 0.68 + Math.random() * 0.27,
                populationGeneralizability: 0.72 + Math.random() * 0.23,
                methodRobustness: 0.80 + Math.random() * 0.18
            };

            // Adjust validation scores based on strategy
            switch (validationStrategy) {
                case 'temporal':
                    validationResults.temporalStability += 0.10;
                    break;
                case 'geographic':
                    validationResults.geographicGeneralizability += 0.12;
                    break;
                case 'population':
                    validationResults.populationGeneralizability += 0.15;
                    break;
                case 'prospective':
                    validationResults.externalValidity += 0.08;
                    validationResults.methodRobustness += 0.12;
                    break;
                default:
                    // Internal validation - slightly lower external validity
                    validationResults.externalValidity -= 0.05;
            }

            // Ensure values don't exceed 1.0
            Object.keys(validationResults).forEach(key => {
                if (typeof validationResults[key] === 'number' && validationResults[key] > 1.0) {
                    validationResults[key] = 0.95 + Math.random() * 0.05;
                }
            });

            return validationResults;
        }

        function generateAnalysisRecommendations(data, results, complexity) {
            return {
                nextSteps: [
                    { priority: 'High', action: 'Validate findings', timeline: '3 months' },
                    { priority: 'Medium', action: 'Expand sample', timeline: '6 months' }
                ]
            };
        }

        function generateStakeholderInsights(stakeholders, results, scenario) {
            return [
                {
                    stakeholder: 'Clinicians',
                    finding: 'Intervention shows clinical benefit',
                    action: 'Consider implementation',
                    strength: 'Strong'
                },
                {
                    stakeholder: 'Policymakers', 
                    finding: 'Cost-effective solution',
                    action: 'Develop policy framework',
                    strength: 'Moderate'
                }
            ];
        }

        function generateProvincialRolloutPlan(scope, results) {
            return 'Phased implementation starting with pilot provinces';
        }

        function calculateResourceRequirements(results) {
            return 'Moderate resource investment required';
        }

        function estimateImplementationTimeline(results) {
            return '12-18 months for full rollout';
        }

        function defineSuccessMetrics(scenario, results) {
            return 'Improved health outcomes and cost savings';
        }

        function assessEvidenceQuality(results) {
            return 'High quality evidence with strong methodology';
        }

        function recommendRegulatoryPathway(scenario, results) {
            return 'Health Canada pathway appropriate';
        }

        function assessCADTHReadiness(results) {
            return 'Ready for CADTH review';
        }

        function estimateProvincialApproval(results) {
            return 85; // 85% likelihood
        }

        function identifyMethodSynergies(results) {
            return 'Complementary methods strengthen evidence';
        }

        function recommendValidationStrategy(results) {
            return 'External validation with independent dataset';
        }

        function assessScalability(scope, results) {
            return 'Highly scalable across Canadian health systems';
        }

        function assessInnovationPotential(scenario, results) {
            return 'Significant innovation potential for healthcare delivery';
        }

        // Helper functions for assessment and feature selection
        function assessFeatureSelection(selectedFeatures, totalFeatures) {
            const selectionRate = selectedFeatures / totalFeatures;
            if (selectionRate < 0.1) return 'Highly efficient feature selection';
            if (selectionRate < 0.3) return 'Good feature selection efficiency';
            if (selectionRate < 0.5) return 'Moderate feature selection';
            return 'Limited feature selection - consider stronger regularization';
        }

        function assessInterpretability(sparsity, method) {
            if (method === 'lasso' && sparsity > 0.7) {
                return 'Highly interpretable sparse model';
            } else if (method === 'ridge') {
                return 'Moderate interpretability - all features included';
            } else if (sparsity > 0.5) {
                return 'Good interpretability with feature selection';
            }
            return 'Complex model - consider simplification';
        }

        function assessGeneralization(cvScore) {
            if (cvScore > 0.8) return 'Excellent generalization ability';
            if (cvScore > 0.7) return 'Good generalization expected';
            if (cvScore > 0.6) return 'Moderate generalization';
            return 'Poor generalization - model may be overfit';
        }

        function getCanadianClinicalRelevance(outcome, selectedFeatures) {
            const clinicalFeatures = selectedFeatures.filter(f => 
                f.includes('clinical') || f.includes('diagnosis') || f.includes('lab')
            ).length;
            
            if (clinicalFeatures >= 3) {
                return `Strong clinical relevance with ${clinicalFeatures} clinical features selected`;
            } else {
                return 'Moderate clinical relevance - consider additional clinical variables';
            }
        }

        function getValidationRequirements(outcome, method) {
            return `${method} models for ${outcome} require external validation with independent Canadian cohort`;
        }

        function getReproducibilityStandards(sparsity) {
            if (sparsity > 0.8) {
                return 'High sparsity requires stability analysis across bootstrap samples';
            }
            return 'Standard reproducibility validation appropriate';
        }

        function getClinicalTranslation(outcome, numFeatures) {
            if (numFeatures < 10) {
                return 'Suitable for clinical implementation with manageable feature set';
            } else {
                return 'May require feature reduction for practical clinical application';
            }
        }

        function createRegularizationVisualization(results, method) {
            console.log('üìà Creating regularization visualization...');
            // Chart implementation would go here
        }

        function createMixedEffectsVisualization(results, structure) {
            console.log('üìä Creating mixed effects visualization...');
            // Chart implementation would go here
        }

        // Additional helper functions...
        function formatParameterName(param) {
            return param.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function getClinicalInterpretation(param, estimate, outcome) {
            if (param === 'time') {
                return estimate < 0 ? 'Improvement over time' : 'Decline over time';
            }
            if (param === 'age') {
                return `${Math.abs(estimate).toFixed(2)} unit change per year of age`;
            }
            return 'Requires clinical context for interpretation';
        }

        function interpretClusterVariance(variance, structure) {
            if (variance > 3) return 'High between-cluster variation suggests system-level differences';
            if (variance > 1) return 'Moderate clustering effects present';
            return 'Low clustering suggests patient-level factors dominate';
        }

        function interpretResidualVariance(variance) {
            return variance > 5 ? 'High individual variation' : 'Moderate individual variation';
        }

        function interpretICC(icc) {
            if (icc > 0.15) return 'high';
            if (icc > 0.05) return 'moderate';
            return 'low';
        }

        function getPolicyImplications(icc, provinces) {
            if (icc > 0.15) {
                return `Strong ${provinces} system effects suggest need for standardized protocols`;
            }
            return `${provinces} variation manageable with current policies`;
        }

        function getQualityImplications(structure, icc) {
            return icc > 0.1 ? 
                'Quality improvement should target system-level interventions' : 
                'Quality improvement can focus on individual provider training';
        }

        function getResourceImplications(clusterVariance) {
            return clusterVariance > 2 ? 
                'Resource allocation should account for facility-level needs' :
                'Standardized resource allocation appropriate';
        }

        function getClusterAdjustmentGuidance(icc) {
            return icc > 0.05 ? 
                'Cluster-robust standard errors required' :
                'Standard statistical methods appropriate';
        }

        function getGeneralizabilityAssessment(structure, provinces) {
            return `${structure} findings generalizable to similar ${provinces} healthcare settings`;
        }
    </script>
</body>
</html>
