<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foundation Series: Correlation & Basic Regression in Healthcare</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f8fffe;
            color: #2c3e50;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 3px solid #20b2aa;
        }
        h1 {
            color: #dc143c;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        h2 {
            color: #dc143c;
            border-bottom: 3px solid #dc143c;
            padding-bottom: 8px;
            margin-top: 30px;
        }
        h3 {
            color: #2f8b8b;
            margin-top: 25px;
        }
        h4 {
            color: #2f8b8b;
            margin-top: 20px;
        }
        .subtitle {
            text-align: center;
            color: #2f8b8b;
            font-size: 1.1em;
            margin-bottom: 30px;
            font-weight: 500;
        }
        .foundation-badge {
            background: linear-gradient(45deg, #2f8b8b, #20b2aa);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            text-align: center;
            margin: 20px auto;
            display: inline-block;
            font-size: 0.9em;
        }
        .navigation {
            background: linear-gradient(135deg, #2f8b8b, #20b2aa);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        .nav-button {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 14px;
        }
        .nav-button:hover, .nav-button.active {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.8);
            transform: translateY(-1px);
        }
        .section-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        .section-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .section {
            background: #f0ffff;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid #2f8b8b;
        }
        .controls {
            background: #f8ffff;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid #20b2aa;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .controls label {
            display: block;
            margin: 8px 0;
            font-weight: 500;
        }
        .controls input, .controls select {
            padding: 8px;
            border: 1px solid #20b2aa;
            border-radius: 4px;
            font-size: 14px;
            margin-left: 10px;
            width: 120px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        button {
            background: linear-gradient(45deg, #2f8b8b, #20b2aa);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
            transition: transform 0.2s;
            font-size: 14px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .results {
            background: #ffffff;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border: 2px solid #20b2aa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card h6 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
            font-weight: normal;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            display: block;
        }
        .chart-container {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
            height: 450px;
            display: block !important;
            position: relative;
        }
        .chart-container canvas {
            max-height: 400px !important;
            width: 100% !important;
            height: 400px !important;
            display: block !important;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            font-size: 14px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background: #f0ffff;
            font-weight: bold;
            color: #2f8b8b;
        }
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        .correlation-strength-strong { color: #dc143c; font-weight: bold; }
        .correlation-strength-moderate { color: #ff8c00; font-weight: bold; }
        .correlation-strength-weak { color: #2f8b8b; }
        .correlation-strength-very-weak { color: #708090; }
        .significance-yes { color: #008000; font-weight: bold; }
        .significance-no { color: #dc143c; }
        .model-performance-excellent { color: #008000; font-weight: bold; }
        .model-performance-good { color: #ff8c00; font-weight: bold; }
        .model-performance-poor { color: #dc143c; }
        .question {
            background: #f8ffff;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            border-left: 4px solid #2f8b8b;
        }
        .question-options {
            margin: 10px 0;
        }
        .question-options label {
            display: block;
            margin: 5px 0;
            cursor: pointer;
        }
        .question-feedback {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .feedback-correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .feedback-incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .feedback-partial {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .advanced-option {
            background: #fff3cd;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #ffc107;
            margin: 10px 0;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Foundation Series: Correlation & Basic Regression in Healthcare</h1>
        <p class="subtitle">üîó Understanding Relationships in Medical Data: From Simple Correlations to Predictive Models</p>
        
        <div class="foundation-badge">üìä FOUNDATION LEVEL - Building Statistical Relationships</div>
        
        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-button active" onclick="showSection('correlation')">üìà Advanced Correlation</button>
            <button class="nav-button" onclick="showSection('scatter')">üìä Scatter Plots</button>
            <button class="nav-button" onclick="showSection('simple-regression')">üìâ Simple Regression</button>
            <button class="nav-button" onclick="showSection('assumptions')">‚ö†Ô∏è Assumptions</button>
            <button class="nav-button" onclick="showSection('multiple-regression')">üî¢ Multiple Regression</button>
            <button class="nav-button" onclick="showSection('clinical')">üè• Clinical Applications</button>
            <button class="nav-button" onclick="showSection('assessment')">‚úÖ Assessment</button>
        </div>

        <!-- Section 1: Advanced Correlation Analysis -->
        <div id="correlation-section" class="section-content active">
            <div class="section">
                <h2>üìà Advanced Correlation Analysis in Healthcare</h2>
                
                <p><strong>Correlation measures the strength and direction of relationships between medical variables.</strong> Advanced correlation methods help control for confounders, handle non-normal data, and provide statistical significance testing essential for clinical research.</p>

                <div class="controls">
                    <div class="control-group">
                        <label>ü©∫ Medical Variables: 
                            <select id="correlation-variables">
                                <option value="age-bp">Age vs Systolic Blood Pressure</option>
                                <option value="bmi-cholesterol">BMI vs Total Cholesterol</option>
                                <option value="exercise-hr">Exercise Duration vs Resting Heart Rate</option>
                                <option value="smoking-fev1">Pack-years vs FEV1 (Lung Function)</option>
                                <option value="glucose-hba1c">Fasting Glucose vs HbA1c</option>
                                <option value="creatinine-egfr">Serum Creatinine vs eGFR</option>
                                <option value="dose-response">Drug Dose vs Treatment Response</option>
                                <option value="pain-qol">Pain Score vs Quality of Life</option>
                                <option value="education-compliance">Education Level vs Medication Compliance</option>
                                <option value="income-health">Household Income vs Health Outcomes</option>
                                <option value="waist-insulin">Waist Circumference vs Insulin Resistance</option>
                                <option value="sleep-bp">Sleep Hours vs Morning Blood Pressure</option>
                            </select>
                        </label>
                        <label>üìä Sample Size: 
                            <input type="number" id="correlation-sample-size" value="200" min="50" max="1000" step="50">
                        </label>
                    </div>
                    
                    <div class="control-group">
                        <label>üî¨ Correlation Method: 
                            <select id="correlation-method">
                                <option value="pearson">Pearson (Linear relationships)</option>
                                <option value="spearman">Spearman (Non-parametric rank-based)</option>
                                <option value="partial">Partial (Controls for confounders)</option>
                            </select>
                        </label>
                        <label>üìà Data Distribution: 
                            <select id="data-distribution">
                                <option value="normal">Normal distribution</option>
                                <option value="skewed">Right-skewed (biomarkers)</option>
                                <option value="ordinal">Ordinal/ranked data</option>
                                <option value="outliers">Contains outliers</option>
                            </select>
                        </label>
                    </div>
                    
                    <div class="control-group">
                        <label>üß™ Statistical Testing: 
                            <select id="significance-testing">
                                <option value="yes">Include p-values & confidence intervals</option>
                                <option value="no">Correlation coefficient only</option>
                            </select>
                        </label>
                        <label id="confounder-control" style="display:none;">üéØ Control Variable: 
                            <select id="confounder-variable">
                                <option value="age">Age (years)</option>
                                <option value="sex">Sex</option>
                                <option value="bmi">Body Mass Index</option>
                                <option value="smoking">Smoking status</option>
                                <option value="comorbidity">Comorbidity index</option>
                            </select>
                        </label>
                    </div>
                </div>

                <button onclick="simulateAdvancedCorrelation()">üöÄ Generate Advanced Correlation Analysis</button>
                <button onclick="testFunction()" style="background: #ffc107; color: black; margin-left: 10px;">üß™ Test Charts</button>

                <div id="correlation-results" class="results" style="display:none;">
                    <!-- Results will appear here -->
                </div>

                <div class="chart-container">
                    <canvas id="correlation-chart"></canvas>
                </div>
                
                <div class="advanced-option">
                    <strong>üí° Method Selection Guide:</strong>
                    ‚Ä¢ <strong>Pearson:</strong> Linear relationships in normally distributed data (r = -1 to +1)<br>
                    ‚Ä¢ <strong>Spearman:</strong> Non-parametric, works with non-normal, ordinal, or ranked data (œÅ = -1 to +1)<br>
                    ‚Ä¢ <strong>Partial:</strong> Controls for confounding variables, reveals true relationships
                </div>
            </div>
        </div>

        <!-- Section 2: Scatter Plots & Interpretation -->
        <div id="scatter-section" class="section-content">
            <div class="section">
                <h2>üìä Scatter Plots & Visual Analysis</h2>
                <p>Scatter plots reveal patterns that correlation coefficients might miss, including non-linear relationships, outliers, and data quality issues crucial for clinical interpretation.</p>
                
                <div class="controls">
                    <div class="control-group">
                        <label>üìà Relationship Pattern: 
                            <select id="scatter-pattern">
                                <option value="strong-positive">Strong Positive (r ‚âà 0.8)</option>
                                <option value="moderate-positive">Moderate Positive (r ‚âà 0.5)</option>
                                <option value="weak-positive">Weak Positive (r ‚âà 0.2)</option>
                                <option value="strong-negative">Strong Negative (r ‚âà -0.8)</option>
                                <option value="no-correlation">No Correlation (r ‚âà 0)</option>
                                <option value="non-linear">Non-linear (Quadratic)</option>
                            </select>
                        </label>
                        <label>‚ö†Ô∏è Outliers: 
                            <select id="scatter-outliers">
                                <option value="none">None (clean data)</option>
                                <option value="few">Few outliers (2-3)</option>
                                <option value="many">Many outliers (5-8)</option>
                                <option value="influential">Influential outliers</option>
                            </select>
                        </label>
                    </div>
                    
                    <div class="control-group">
                        <label>üè• Clinical Context: 
                            <select id="scatter-context">
                                <option value="age-bp">Age vs Blood Pressure (Hypertension screening)</option>
                                <option value="dose-response">Drug Dose vs Response (Pharmacology)</option>
                                <option value="bmi-diabetes">BMI vs Diabetes Risk (Metabolic health)</option>
                                <option value="exercise-fitness">Exercise vs Cardiovascular Fitness</option>
                            </select>
                        </label>
                        <label>üë• Sample Size: 
                            <input type="number" id="scatter-sample-size" value="150" min="50" max="500" step="25">
                        </label>
                    </div>
                </div>
                
                <button onclick="generateAdvancedScatterPlot()">üìä Generate Scatter Plot Analysis</button>
                
                <div id="scatter-results" class="results" style="display:none;"></div>
                
                <div class="chart-container">
                    <canvas id="scatter-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Section 3: Simple Linear Regression -->
        <div id="simple-regression-section" class="section-content">
            <div class="section">
                <h2>üìâ Simple Linear Regression</h2>
                <p>Linear regression creates predictive models for clinical decision-making, quantifying relationships and enabling evidence-based predictions in healthcare settings.</p>
                
                <div class="controls">
                    <div class="control-group">
                        <label>üéØ Medical Regression Model: 
                            <select id="regression-model">
                                <option value="age-bp">Blood Pressure vs Age (Hypertension risk)</option>
                                <option value="dose-weight">Drug Dose vs Body Weight (Dosing guidelines)</option>
                                <option value="glucose-hba1c">HbA1c vs Fasting Glucose (Diabetes monitoring)</option>
                                <option value="creatinine-egfr">eGFR vs Serum Creatinine (Kidney function)</option>
                                <option value="bmi-insulin">Insulin Resistance vs BMI (Metabolic assessment)</option>
                            </select>
                        </label>
                        <label>üë• Population: 
                            <select id="regression-population">
                                <option value="general">Canadian Adults (18-65 years)</option>
                                <option value="elderly">Elderly (65+ years)</option>
                                <option value="pediatric">Pediatric (5-17 years)</option>
                                <option value="mixed">Mixed age groups</option>
                            </select>
                        </label>
                    </div>
                    
                    <div class="control-group">
                        <label>üìä Data Quality: 
                            <select id="regression-quality">
                                <option value="high">High quality (R¬≤ > 0.7)</option>
                                <option value="moderate">Moderate quality (R¬≤ 0.4-0.7)</option>
                                <option value="low">Low quality (R¬≤ < 0.4)</option>
                                <option value="realistic">Realistic clinical data</option>
                            </select>
                        </label>
                        <label>üìà Sample Size: 
                            <input type="number" id="regression-sample-size" value="250" min="100" max="800" step="50">
                        </label>
                    </div>
                </div>
                
                <button onclick="simulateAdvancedRegression()">üìà Build Regression Model</button>
                <button onclick="testRegressionFunction()" style="background: #28a745; color: white; margin-left: 10px;">üß™ Test Regression</button>
                
                <div id="simple-regression-results" class="results" style="display:none;"></div>
                
                <div class="chart-container">
                    <canvas id="simple-regression-chart"></canvas>
                </div>
                
                <div class="advanced-option">
                    <strong>üìñ Regression Equation:</strong> Y = a + bX<br>
                    ‚Ä¢ <strong>a (Intercept):</strong> Expected Y value when X = 0<br>
                    ‚Ä¢ <strong>b (Slope):</strong> Change in Y per unit increase in X<br>
                    ‚Ä¢ <strong>R¬≤:</strong> Proportion of variance in Y explained by X
                </div>
            </div>
        </div>

        <!-- Section 4: Regression Assumptions & Diagnostics -->
        <div id="assumptions-section" class="section-content">
            <div class="section">
                <h2>‚ö†Ô∏è Regression Assumptions & Diagnostics</h2>
                <p>The L.I.N.E. assumptions must be checked before trusting regression results in clinical applications. Violations can lead to incorrect conclusions and inappropriate treatment decisions.</p>
                
                <div class="controls">
                    <div class="control-group">
                        <label>üîç Assumption Violation: 
                            <select id="assumption-type">
                                <option value="none">None (ideal case)</option>
                                <option value="non-linear">Non-linear relationship</option>
                                <option value="heteroscedasticity">Unequal variance (heteroscedasticity)</option>
                                <option value="non-normal">Non-normal residuals</option>
                                <option value="outliers">Influential outliers</option>
                                <option value="multiple">Multiple violations</option>
                            </select>
                        </label>
                        <label>üè• Clinical Context: 
                            <select id="assumption-context">
                                <option value="drug-kinetics">Drug Pharmacokinetics</option>
                                <option value="growth-charts">Pediatric Growth Charts</option>
                                <option value="biomarker-disease">Biomarker vs Disease Progression</option>
                                <option value="dose-response">Dose-Response Relationship</option>
                            </select>
                        </label>
                    </div>
                </div>
                
                <button onclick="demonstrateAssumptions()">üîç Demonstrate Assumption Checking</button>
                
                <div id="assumptions-results" class="results" style="display:none;"></div>
                
                <div class="chart-container">
                    <canvas id="assumptions-chart"></canvas>
                </div>
                
                <div class="advanced-option">
                    <strong>üìã L.I.N.E. Assumptions:</strong><br>
                    ‚Ä¢ <strong>L - Linearity:</strong> Relationship between X and Y is linear<br>
                    ‚Ä¢ <strong>I - Independence:</strong> Observations are independent<br>
                    ‚Ä¢ <strong>N - Normality:</strong> Residuals are normally distributed<br>
                    ‚Ä¢ <strong>E - Equal Variance:</strong> Homoscedasticity (constant variance)
                </div>
            </div>
        </div>

        <!-- Section 5: Advanced Multiple Regression -->
        <div id="multiple-regression-section" class="section-content">
            <div class="section">
                <h2>üî¢ Advanced Multiple Regression in Healthcare</h2>
                <p>Multiple regression is the foundation of clinical prediction models used daily in Canadian healthcare. From cardiovascular risk calculators to drug dosing algorithms, these models help clinicians make evidence-based decisions.</p>
                
                <div class="controls">
                    <div class="control-group">
                        <label>üéØ Clinical Prediction Model: 
                            <select id="multiple-model">
                                <option value="cvd-risk">Cardiovascular Disease Risk (CANRISK-CVD)</option>
                                <option value="diabetes-risk">Type 2 Diabetes Risk (CANRISK-DM)</option>
                                <option value="surgical-risk">Cardiac Surgery Risk Assessment</option>
                                <option value="drug-clearance">Pediatric Drug Clearance Model</option>
                            </select>
                        </label>
                        <label>üîß Model Complexity: 
                            <select id="multiple-complexity">
                                <option value="basic">Basic (3-4 predictors)</option>
                                <option value="standard">Standard (5-7 predictors)</option>
                                <option value="comprehensive">Comprehensive (8-12 predictors)</option>
                                <option value="interaction">With interaction terms</option>
                                <option value="polynomial">With polynomial terms</option>
                            </select>
                        </label>
                    </div>
                    
                    <div class="control-group">
                        <label>üåç Canadian Population: 
                            <select id="multiple-population">
                                <option value="general">General Canadian population</option>
                                <option value="indigenous">Indigenous communities</option>
                                <option value="immigrant">Recent immigrant populations</option>
                                <option value="rural">Rural and remote areas</option>
                                <option value="elderly">Elderly (65+ years)</option>
                                <option value="pediatric">Pediatric (specialized dosing)</option>
                            </select>
                        </label>
                        <label>‚úÖ Validation Method: 
                            <select id="multiple-validation">
                                <option value="train-test">70-30 Train-Test Split</option>
                                <option value="cross-validation">10-Fold Cross-Validation</option>
                                <option value="bootstrap">Bootstrap Validation</option>
                                <option value="external">External Validation Dataset</option>
                            </select>
                        </label>
                    </div>
                    
                    <div class="control-group">
                        <label>üìä Sample Size: 
                            <input type="number" id="multiple-sample-size" value="500" min="200" max="2000" step="100">
                        </label>
                        <label>üìã Output Level: 
                            <select id="multiple-output">
                                <option value="clinical">Clinical Summary</option>
                                <option value="detailed">Detailed Statistical Output</option>
                                <option value="regulatory">Regulatory Submission Package</option>
                            </select>
                        </label>
                    </div>
                </div>
                
                <button onclick="buildAdvancedMultipleRegression()">üöÄ Build Advanced Regression Model</button>
                <button onclick="testMultipleRegressionFunction()" style="background: #17a2b8; color: white; margin-left: 10px;">üß™ Test Multiple Regression</button>
                
                <div id="multiple-regression-results" class="results" style="display:none;"></div>
                
                <div class="chart-container">
                    <canvas id="multiple-regression-chart"></canvas>
                </div>
                
                <div class="advanced-option">
                    <strong>üè• Health Canada Requirements for Clinical Prediction Models:</strong><br>
                    ‚Ä¢ <strong>Class II Medical Device:</strong> Software for clinical decision support<br>
                    ‚Ä¢ <strong>Validation:</strong> Internal and external validation required<br>
                    ‚Ä¢ <strong>Performance:</strong> Calibration, discrimination, and clinical utility assessment<br>
                    ‚Ä¢ <strong>Documentation:</strong> Statistical and clinical evidence packages
                </div>
            </div>
        </div>

        <!-- Section 6: Clinical Applications & Case Studies -->
        <div id="clinical-section" class="section-content">
            <div class="section">
                <h2>üè• Clinical Applications & Case Studies</h2>
                <p>Real-world applications of correlation and regression in Canadian healthcare settings, demonstrating how statistical relationships inform clinical practice and policy decisions.</p>
                
                <div class="controls">
                    <div class="control-group">
                        <label>üçÅ Canadian Case Study: 
                            <select id="case-study">
                                <option value="ontario-diabetes">Ontario Diabetes Risk Calculator (CANRISK)</option>
                                <option value="alberta-cvd">Alberta Cardiovascular Risk Assessment</option>
                                <option value="bc-cancer">BC Cancer Treatment Response Prediction</option>
                                <option value="pediatric-dosing">Pediatric Medication Dosing Algorithms</option>
                                <option value="indigenous-health">Indigenous Health Outcome Predictors</option>
                                <option value="rural-access">Rural Healthcare Access Analysis</option>
                            </select>
                        </label>
                    </div>
                </div>
                
                <button onclick="exploreCaseStudy()">üîç Explore Case Study</button>
                
                <div id="clinical-results" class="results" style="display:none;"></div>
            </div>
        </div>

        <!-- Section 7: Assessment -->
        <div id="assessment-section" class="section-content">
            <div class="section">
                <h2>‚úÖ Assessment: Correlation & Regression</h2>
                <p>Test your understanding with randomized questions covering correlation interpretation, regression calculations, and clinical applications in Canadian healthcare.</p>
                
                <div class="controls">
                    <div class="control-group">
                        <label>üìö Question Type: 
                            <select id="question-type">
                                <option value="correlation">Correlation Methods (Pearson, Spearman, Partial)</option>
                                <option value="regression">Regression Calculations & Interpretation</option>
                                <option value="clinical">Clinical Applications & Case Studies</option>
                                <option value="assumptions">Assumption Checking & Diagnostics</option>
                                <option value="mixed">Mixed Topics (All Areas)</option>
                            </select>
                        </label>
                        <label>üéØ Difficulty: 
                            <select id="question-difficulty">
                                <option value="basic">Basic (Foundation Concepts)</option>
                                <option value="intermediate">Intermediate (Applied Methods)</option>
                                <option value="advanced">Advanced (Clinical Applications)</option>
                            </select>
                        </label>
                    </div>
                    
                    <div class="control-group">
                        <label>üìä Number of Questions: 
                            <input type="number" id="question-count" value="5" min="3" max="15" step="1">
                        </label>
                    </div>
                </div>
                
                <button onclick="generateAssessment()">üéØ Generate Assessment</button>
                <button onclick="showSampleQuestions()" style="background: #17a2b8; margin-left: 10px;">üëÅÔ∏è Preview Question Types</button>
                <button onclick="testAssessmentVariety()" style="background: #6f42c1; color: white; margin-left: 10px;">üß™ Test Question Variety</button>
                <button onclick="debugQuestionGeneration()" style="background: #dc3545; color: white; margin-left: 10px;">üîß Debug Question Generation</button>
                <button onclick="checkAllAnswers()" style="display:none;" id="check-answers-btn">üìù Check Answers</button>
                
                <div id="sample-questions" class="results" style="display:none;">
                    <!-- Sample questions will appear here -->
                </div>
                
                <div id="assessment-results" class="results" style="display:none;">
                    <!-- Assessment questions will appear here -->
                </div>
                
                <div id="assessment-feedback" class="results" style="display:none;">
                    <!-- Assessment feedback will appear here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        let currentQuestions = [];
        let userAnswers = {};
        
        // Navigation functionality
        function showSection(sectionName) {
            console.log('Showing section:', sectionName);
            
            // Hide all sections
            const sections = document.querySelectorAll('.section-content');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected section
            const selectedSection = document.getElementById(sectionName + '-section');
            if (selectedSection) {
                selectedSection.classList.add('active');
            }
            
            // Find and activate the correct navigation button
            const sectionNames = {
                'correlation': 'üìà Advanced Correlation',
                'scatter': 'üìä Scatter Plots',
                'simple-regression': 'üìâ Simple Regression',
                'assumptions': '‚ö†Ô∏è Assumptions',
                'multiple-regression': 'üî¢ Multiple Regression',
                'clinical': 'üè• Clinical Applications',
                'assessment': '‚úÖ Assessment'
            };
            
            const buttonText = sectionNames[sectionName];
            if (buttonText) {
                const targetButton = Array.from(navButtons).find(button => 
                    button.textContent.trim() === buttonText
                );
                if (targetButton) {
                    targetButton.classList.add('active');
                }
            }
        }

        // Generate random normal data using Box-Muller transform
        function generateNormalData(n, mean, sd) {
            const data = [];
            for (let i = 0; i < n; i++) {
                let u = 0, v = 0;
                while (u === 0) u = Math.random();
                while (v === 0) v = Math.random();
                const z = Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
                data.push(z * sd + mean);
            }
            return data;
        }

        // Generate skewed data for biomarkers
        function generateSkewedData(n, shape, scale) {
            return Array.from({length: n}, () => {
                const normal = generateNormalData(1, 0, 1)[0];
                return Math.exp(normal * shape + scale);
            });
        }

        // Generate ordinal data
        function generateOrdinalData(n, categories, probabilities) {
            const data = [];
            for (let i = 0; i < n; i++) {
                const rand = Math.random();
                let cumulative = 0;
                for (let j = 0; j < probabilities.length; j++) {
                    cumulative += probabilities[j];
                    if (rand <= cumulative) {
                        data.push(categories[j]);
                        break;
                    }
                }
            }
            return data;
        }

        // Calculate Pearson correlation
        function calculatePearsonCorrelation(x, y) {
            const n = x.length;
            const meanX = x.reduce((sum, val) => sum + val, 0) / n;
            const meanY = y.reduce((sum, val) => sum + val, 0) / n;
            
            let numerator = 0;
            let sumXSquared = 0;
            let sumYSquared = 0;
            
            for (let i = 0; i < n; i++) {
                const deviationX = x[i] - meanX;
                const deviationY = y[i] - meanY;
                numerator += deviationX * deviationY;
                sumXSquared += deviationX * deviationX;
                sumYSquared += deviationY * deviationY;
            }
            
            const denominator = Math.sqrt(sumXSquared * sumYSquared);
            return denominator === 0 ? 0 : numerator / denominator;
        }

        // Calculate Spearman correlation
        function calculateSpearmanCorrelation(x, y) {
            const xRanks = getRanks(x);
            const yRanks = getRanks(y);
            return calculatePearsonCorrelation(xRanks, yRanks);
        }

        function getRanks(data) {
            const sorted = data.map((val, idx) => ({ val, idx })).sort((a, b) => a.val - b.val);
            const ranks = new Array(data.length);
            for (let i = 0; i < sorted.length; i++) {
                ranks[sorted[i].idx] = i + 1;
            }
            return ranks;
        }

        // Calculate partial correlation
        function calculatePartialCorrelation(x, y, z) {
            const rxy = calculatePearsonCorrelation(x, y);
            const rxz = calculatePearsonCorrelation(x, z);
            const ryz = calculatePearsonCorrelation(y, z);
            
            const numerator = rxy - (rxz * ryz);
            const denominator = Math.sqrt((1 - rxz * rxz) * (1 - ryz * ryz));
            
            return denominator === 0 ? 0 : numerator / denominator;
        }

        // Calculate correlation significance
        function calculateCorrelationSignificance(r, n) {
            const tStat = r * Math.sqrt((n - 2) / (1 - r * r));
            const df = n - 2;
            const pValue = 2 * (1 - tDistribution(Math.abs(tStat), df));
            
            // Fisher z-transform for confidence interval
            const fisherZ = 0.5 * Math.log((1 + r) / (1 - r));
            const seZ = 1 / Math.sqrt(n - 3);
            const zCritical = 1.96; // 95% CI
            
            const lowerZ = fisherZ - zCritical * seZ;
            const upperZ = fisherZ + zCritical * seZ;
            
            const lowerR = (Math.exp(2 * lowerZ) - 1) / (Math.exp(2 * lowerZ) + 1);
            const upperR = (Math.exp(2 * upperZ) - 1) / (Math.exp(2 * upperZ) + 1);
            
            return {
                tStatistic: tStat,
                pValue: pValue,
                significant: pValue < 0.05,
                confidenceInterval: [lowerR, upperR]
            };
        }

        // Approximate t-distribution CDF (simplified)
        function tDistribution(t, df) {
            if (df > 30) {
                // Use normal approximation for large df
                return 0.5 * (1 + erf(t / Math.sqrt(2)));
            }
            // Simplified approximation for smaller df
            return 0.5 + 0.5 * Math.sign(t) * Math.min(0.999, Math.abs(t) / (1 + Math.abs(t)));
        }

        function erf(x) {
            // Abramowitz and Stegun approximation
            const a1 =  0.254829592;
            const a2 = -0.284496736;
            const a3 =  1.421413741;
            const a4 = -1.453152027;
            const a5 =  1.061405429;
            const p  =  0.3275911;
            
            const sign = x >= 0 ? 1 : -1;
            x = Math.abs(x);
            
            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
            
            return sign * y;
        }

        // Test function to verify JavaScript execution
        function testFunction() {
            console.log('üß™ Test function called successfully!');
            alert('‚úÖ JavaScript is working! Now testing chart creation...');
            
            // Test element access
            const methodElement = document.getElementById('correlation-method');
            const variablesElement = document.getElementById('correlation-variables');
            const resultsElement = document.getElementById('correlation-results');
            const chartCanvas = document.getElementById('correlation-chart');
            
            console.log('Element access test:', {
                method: methodElement ? methodElement.value : 'NOT FOUND',
                variables: variablesElement ? variablesElement.value : 'NOT FOUND',
                results: resultsElement ? 'FOUND' : 'NOT FOUND',
                chartCanvas: chartCanvas ? 'FOUND' : 'NOT FOUND'
            });
            
            // Test Chart.js availability
            if (typeof Chart === 'undefined') {
                console.error('‚ùå Chart.js not available');
                if (resultsElement) {
                    resultsElement.style.display = 'block';
                    resultsElement.innerHTML = `
                        <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 6px;">
                            <h4>‚ùå Chart.js Not Loaded</h4>
                            <p>Chart.js library is not available. Please refresh the page.</p>
                        </div>
                    `;
                }
                return;
            }
            
            // Test basic chart creation
            testBasicChart();
            
            if (resultsElement) {
                resultsElement.style.display = 'block';
                resultsElement.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 6px;">
                        <h4>‚úÖ JavaScript Test Successful</h4>
                        <p>All required elements found and accessible.</p>
                        <p>Chart.js is available: <strong>Version ${Chart.version || 'Unknown'}</strong></p>
                        <p>Testing basic chart creation above...</p>
                    </div>
                `;
            }
        }
        
        function testBasicChart() {
            console.log('üìä Testing basic chart creation...');
            
            const canvas = document.getElementById('correlation-chart');
            if (!canvas) {
                console.error('‚ùå Chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('‚ùå Cannot get 2D context');
                return;
            }
            
            // Destroy any existing chart
            if (charts.correlation) {
                charts.correlation.destroy();
                delete charts.correlation;
            }
            
            try {
                // Create a simple test chart
                charts.correlation = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Test Data',
                            data: [
                                {x: 1, y: 2},
                                {x: 2, y: 4}, 
                                {x: 3, y: 6},
                                {x: 4, y: 8},
                                {x: 5, y: 10}
                            ],
                            backgroundColor: 'rgba(220, 20, 60, 0.8)',
                            borderColor: 'rgba(220, 20, 60, 1)',
                            pointRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'üß™ Test Scatter Plot - If you see this, charts work!',
                                font: { size: 16, weight: 'bold' }
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                title: { display: true, text: 'Test X Axis' }
                            },
                            y: {
                                type: 'linear', 
                                title: { display: true, text: 'Test Y Axis' }
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Test chart created successfully!');
                
                // Force container visibility
                const container = canvas.parentElement;
                if (container) {
                    container.style.display = 'block';
                    container.style.visibility = 'visible';
                    container.style.height = '450px';
                    container.style.minHeight = '450px';
                    canvas.style.display = 'block';
                    canvas.style.visibility = 'visible';
                    canvas.style.width = '100%';
                    canvas.style.height = '400px';
                    console.log('‚úÖ Test chart container forced visible');
                }
                
                // Force update
                setTimeout(() => {
                    if (charts.correlation) {
                        charts.correlation.resize();
                        charts.correlation.update('active');
                        
                        const rect = canvas.getBoundingClientRect();
                        console.log('üìê Test canvas dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            visible: rect.width > 0 && rect.height > 0
                        });
                    }
                }, 200);
                
            } catch (error) {
                console.error('‚ùå Test chart creation failed:', error);
                showChartError(`Test chart failed: ${error.message}`);
            }
        }

        // Advanced correlation analysis
        function simulateAdvancedCorrelation() {
            console.log('üöÄ Starting advanced correlation simulation...');
            
            try {
                // Get form values with error checking
                const method = document.getElementById('correlation-method')?.value || 'pearson';
                const variables = document.getElementById('correlation-variables')?.value || 'age-bp';
                const sampleSize = parseInt(document.getElementById('correlation-sample-size')?.value) || 200;
                const distribution = document.getElementById('data-distribution')?.value || 'normal';
                const testing = document.getElementById('significance-testing')?.value || 'yes';
                const confounders = document.getElementById('confounder-variable')?.value || 'age';
                
                console.log('üìä Form values:', { method, variables, sampleSize, distribution, testing, confounders });
                
                // Show/hide confounder control based on method
                const confoundenControl = document.getElementById('confounder-control');
                if (confoundenControl) {
                    if (method === 'partial') {
                        confoundenControl.style.display = 'block';
                    } else {
                        confoundenControl.style.display = 'none';
                    }
                }
                
                // Variable configurations
                const variableInfo = {
                    'age-bp': { 
                        xLabel: 'Age (years)', 
                        yLabel: 'Systolic BP (mmHg)', 
                        context: 'Age-related hypertension in Canadian adults',
                        baseX: 50, baseY: 120, slope: 0.8,
                        xRange: [18, 85], yRange: [90, 180]
                    },
                    'bmi-cholesterol': { 
                        xLabel: 'BMI (kg/m¬≤)', 
                        yLabel: 'Total Cholesterol (mmol/L)', 
                        context: 'BMI and lipid profile relationship',
                        baseX: 25, baseY: 4.5, slope: 0.1,
                        xRange: [18, 40], yRange: [3, 8]
                    },
                    'exercise-hr': { 
                        xLabel: 'Exercise (hrs/week)', 
                        yLabel: 'Resting HR (bpm)', 
                        context: 'Exercise and cardiovascular fitness',
                        baseX: 4, baseY: 75, slope: -3,
                        xRange: [0, 15], yRange: [50, 100]
                    },
                    'smoking-fev1': { 
                        xLabel: 'Pack-years', 
                        yLabel: 'FEV1 (% predicted)', 
                        context: 'Smoking impact on lung function',
                        baseX: 10, baseY: 85, slope: -1.2,
                        xRange: [0, 50], yRange: [40, 120]
                    },
                    'glucose-hba1c': { 
                        xLabel: 'Fasting Glucose (mmol/L)', 
                        yLabel: 'HbA1c (%)', 
                        context: 'Glucose control monitoring',
                        baseX: 5.5, baseY: 6.0, slope: 0.3,
                        xRange: [4, 15], yRange: [4.5, 12]
                    },
                    'creatinine-egfr': { 
                        xLabel: 'Serum Creatinine (Œºmol/L)', 
                        yLabel: 'eGFR (mL/min/1.73m¬≤)', 
                        context: 'Kidney function assessment',
                        baseX: 90, baseY: 90, slope: -0.8,
                        xRange: [50, 300], yRange: [15, 120]
                    },
                    'dose-response': { 
                        xLabel: 'Drug Dose (mg)', 
                        yLabel: 'Treatment Response (%)', 
                        context: 'Pharmacodynamic relationship',
                        baseX: 50, baseY: 60, slope: 0.6,
                        xRange: [10, 200], yRange: [20, 95]
                    },
                    'pain-qol': { 
                        xLabel: 'Pain Score (0-10)', 
                        yLabel: 'Quality of Life (0-100)', 
                        context: 'Pain impact on quality of life',
                        baseX: 5, baseY: 70, slope: -4,
                        xRange: [0, 10], yRange: [20, 100]
                    },
                    'education-compliance': { 
                        xLabel: 'Education Level (years)', 
                        yLabel: 'Medication Compliance (%)', 
                        context: 'Education and health behaviors',
                        baseX: 12, baseY: 75, slope: 2,
                        xRange: [8, 20], yRange: [40, 95]
                    },
                    'income-health': { 
                        xLabel: 'Household Income ($1000s)', 
                        yLabel: 'Health Status Score (0-100)', 
                        context: 'Socioeconomic determinants of health',
                        baseX: 60, baseY: 75, slope: 0.2,
                        xRange: [20, 150], yRange: [40, 95]
                    },
                    'waist-insulin': { 
                        xLabel: 'Waist Circumference (cm)', 
                        yLabel: 'Insulin Resistance (HOMA-IR)', 
                        context: 'Metabolic syndrome assessment',
                        baseX: 90, baseY: 2.5, slope: 0.05,
                        xRange: [70, 130], yRange: [0.5, 8]
                    },
                    'sleep-bp': { 
                        xLabel: 'Sleep Hours per Night', 
                        yLabel: 'Morning BP (mmHg)', 
                        context: 'Sleep and cardiovascular health',
                        baseX: 7.5, baseY: 125, slope: -3,
                        xRange: [4, 11], yRange: [105, 150]
                    }
                };
                
                const config = variableInfo[variables];
                if (!config) {
                    throw new Error(`Unknown variable configuration: ${variables}`);
                }
                
                console.log('‚öôÔ∏è Using configuration:', config);
                
                let xData, yData, zData;
                
                // Generate data based on distribution type
                console.log('üìà Generating data for distribution:', distribution);
                
                if (distribution === 'normal') {
                    xData = generateNormalData(sampleSize, config.baseX, config.baseX * 0.2);
                    yData = xData.map(x => config.baseY + config.slope * (x - config.baseX) + generateNormalData(1, 0, Math.abs(config.slope) * 2)[0]);
                } else if (distribution === 'skewed') {
                    xData = generateSkewedData(sampleSize, 0.3, Math.log(config.baseX));
                    yData = xData.map(x => config.baseY + config.slope * (x - config.baseX) + generateNormalData(1, 0, Math.abs(config.slope) * 3)[0]);
                } else if (distribution === 'ordinal') {
                    xData = generateOrdinalData(sampleSize, [1, 2, 3, 4, 5], [0.1, 0.2, 0.4, 0.2, 0.1]);
                    yData = xData.map(x => config.baseY + config.slope * (x - 3) + generateNormalData(1, 0, Math.abs(config.slope) * 2)[0]);
                } else { // outliers
                    xData = generateNormalData(sampleSize, config.baseX, config.baseX * 0.2);
                    yData = xData.map(x => config.baseY + config.slope * (x - config.baseX) + generateNormalData(1, 0, Math.abs(config.slope) * 2)[0]);
                    // Add some outliers
                    const numOutliers = Math.floor(sampleSize * 0.05);
                    for (let i = 0; i < numOutliers; i++) {
                        const idx = Math.floor(Math.random() * sampleSize);
                        yData[idx] += (Math.random() - 0.5) * config.baseY * 0.4;
                    }
                }
                
                console.log('‚úÖ Data generated successfully:', { xDataLength: xData.length, yDataLength: yData.length });
                
                // Generate confounder variable for partial correlation
                if (method === 'partial') {
                    zData = generateNormalData(sampleSize, 50, 15);
                    // Make it correlated with both X and Y
                    for (let i = 0; i < sampleSize; i++) {
                        yData[i] += 0.3 * (zData[i] - 50);
                        xData[i] += 0.2 * (zData[i] - 50);
                    }
                    console.log('‚úÖ Confounder variable generated for partial correlation');
                }
                
                // Calculate correlation based on method
                let correlation, methodName;
                console.log('üî¢ Calculating correlation using method:', method);
                
                if (method === 'spearman') {
                    correlation = calculateSpearmanCorrelation(xData, yData);
                    methodName = 'Spearman œÅ';
                } else if (method === 'partial') {
                    correlation = calculatePartialCorrelation(xData, yData, zData);
                    methodName = `Partial r (controlling for ${confounders})`;
                } else {
                    correlation = calculatePearsonCorrelation(xData, yData);
                    methodName = 'Pearson r';
                }
                
                console.log('‚úÖ Correlation calculated:', correlation);
                
                // Calculate significance if requested
                let significance = null;
                if (testing === 'yes') {
                    console.log('üìä Calculating statistical significance...');
                    significance = calculateCorrelationSignificance(correlation, sampleSize);
                    console.log('‚úÖ Significance calculated:', significance);
                }
                
                // Display results
                console.log('üìÑ Displaying results...');
                displayAdvancedCorrelationResults(
                    config, correlation, methodName, sampleSize, distribution, significance, method
                );
                
                // Create enhanced chart
                console.log('üìä Creating chart...');
                createAdvancedCorrelationChart(xData, yData, config.xLabel, config.yLabel, correlation, method);
                
                console.log('üéâ Advanced correlation analysis completed successfully!');
                
            } catch (error) {
                console.error('‚ùå Error in simulateAdvancedCorrelation:', error);
                
                // Display user-friendly error message
                const resultsDiv = document.getElementById('correlation-results');
                if (resultsDiv) {
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: #dc143c; border: 2px solid #dc143c; border-radius: 8px;">
                            <h4>‚ö†Ô∏è Analysis Error</h4>
                            <p>Unable to complete advanced correlation analysis.</p>
                            <p><strong>Error details:</strong> ${error.message}</p>
                            <button onclick="simulateAdvancedCorrelation()" style="margin: 10px;">üîÑ Try Again</button>
                            <button onclick="location.reload()" style="margin: 10px;">üåê Refresh Page</button>
                        </div>
                    `;
                }
            }
        }

        function displayAdvancedCorrelationResults(config, correlation, methodName, sampleSize, distribution, significance, method) {
            const resultsDiv = document.getElementById('correlation-results');
            resultsDiv.style.display = 'block';
            
            const strengthClass = getCorrelationStrengthClass(Math.abs(correlation));
            const directionText = correlation >= 0 ? 'positive' : 'negative';
            const strengthText = getCorrelationStrength(Math.abs(correlation));
            
            const distributionDescriptions = {
                'normal': 'Normally distributed data - Pearson correlation appropriate',
                'skewed': 'Right-skewed biomarker data - Spearman correlation recommended',
                'ordinal': 'Ordinal/ranked data - Spearman correlation required',
                'outliers': 'Data contains outliers - Consider robust methods'
            };
            
            const methodJustification = {
                'pearson': 'Pearson correlation measures linear relationships in normally distributed data.',
                'spearman': 'Spearman correlation is non-parametric and robust to non-normal distributions and outliers.',
                'partial': 'Partial correlation controls for confounding variables to reveal true relationships.'
            };
            
            let html = `
                <h4>‚úÖ Advanced Correlation Analysis Results</h4>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <p><strong>Method:</strong> ${methodJustification[method]}</p>
                    <p><strong>Clinical Context:</strong> ${config.context}</p>
                    <p><strong>Data Characteristics:</strong> ${distributionDescriptions[distribution]}</p>
                    <p><strong>Sample Size:</strong> ${sampleSize} patients</p>
                    <p><strong>Variables:</strong> ${config.xLabel} vs ${config.yLabel}</p>
                </div>
                
                <table>
                    <tr><th>Statistic</th><th>Value</th><th>Interpretation</th></tr>
                    <tr>
                        <td>Correlation Coefficient (${method === 'spearman' ? 'œÅ' : 'r'})</td>
                        <td class="${strengthClass}">${correlation.toFixed(4)}</td>
                        <td class="${strengthClass}">${strengthText} ${directionText} relationship</td>
                    </tr>
                    <tr>
                        <td>Effect Size (R¬≤)</td>
                        <td>${(correlation * correlation * 100).toFixed(1)}%</td>
                        <td>Variance in ${config.yLabel.split(' ')[0]} explained by ${config.xLabel.split(' ')[0]}</td>
                    </tr>
            `;
            
            if (significance) {
                const sigClass = significance.significant ? 'significance-yes' : 'significance-no';
                html += `
                    <tr>
                        <td>Statistical Significance</td>
                        <td class="${sigClass}">p ${significance.pValue < 0.05 ? '<' : '='} ${significance.pValue.toFixed(3)}</td>
                        <td class="${sigClass}">${significance.significant ? 'Statistically significant' : 'Not statistically significant'}</td>
                    </tr>
                    <tr>
                        <td>95% Confidence Interval</td>
                        <td>[${significance.confidenceInterval[0].toFixed(3)}, ${significance.confidenceInterval[1].toFixed(3)}]</td>
                        <td>True correlation likely within this range</td>
                    </tr>
                    <tr>
                        <td>t-statistic</td>
                        <td>${significance.tStatistic.toFixed(2)}</td>
                        <td>Test statistic for significance testing</td>
                    </tr>
                `;
            }
            
            html += `</table>`;
            
            // Add clinical interpretation
            const clinicalInterpretation = getClinicalCorrelationInterpretation(config, correlation, significance, sampleSize);
            html += `
                <div style="background: #f0fff0; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #32cd32;">
                    <h5>üè• Clinical Interpretation</h5>
                    <p>${clinicalInterpretation}</p>
                </div>
            `;
            
            // Add recommendations
            html += `
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h5>üìã Clinical Recommendations</h5>
                    <ul>
                        <li><strong>Statistical significance:</strong> ${significance && significance.significant ? 'Relationship is statistically significant' : 'May need larger sample size for significance'}</li>
                        <li><strong>Clinical significance:</strong> ${Math.abs(correlation) > 0.3 ? 'Strong enough for clinical consideration' : 'May not be clinically meaningful'}</li>
                        <li><strong>Clinical application:</strong> ${getApplicationRecommendation(config, correlation)}</li>
                        <li><strong>Next steps:</strong> ${getNextStepsRecommendation(method, correlation, significance)}</li>
                    </ul>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        function getCorrelationStrengthClass(absR) {
            if (absR >= 0.7) return 'correlation-strength-strong';
            if (absR >= 0.4) return 'correlation-strength-moderate';
            if (absR >= 0.2) return 'correlation-strength-weak';
            return 'correlation-strength-very-weak';
        }

        function getCorrelationStrength(absR) {
            if (absR >= 0.7) return 'Strong';
            if (absR >= 0.4) return 'Moderate';
            if (absR >= 0.2) return 'Weak';
            return 'Very weak';
        }

        function getClinicalCorrelationInterpretation(config, correlation, significance, sampleSize) {
            const absR = Math.abs(correlation);
            const direction = correlation >= 0 ? 'increases' : 'decreases';
            
            let interpretation = `The correlation of ${correlation.toFixed(3)} indicates that as ${config.xLabel.toLowerCase()} increases, ${config.yLabel.toLowerCase()} ${direction}. `;
            
            if (significance && significance.significant) {
                interpretation += `This relationship is statistically significant (p < 0.05) with ${sampleSize} patients. `;
            }
            
            if (absR >= 0.5) {
                interpretation += `This is a clinically meaningful relationship that could inform treatment decisions and risk stratification.`;
            } else if (absR >= 0.3) {
                interpretation += `This moderate relationship suggests these variables should be considered together in clinical assessment.`;
            } else {
                interpretation += `The weak relationship suggests other factors may be more important for clinical decision-making.`;
            }
            
            return interpretation;
        }

        function getApplicationRecommendation(config, correlation) {
            const absR = Math.abs(correlation);
            
            if (absR >= 0.6) {
                return 'Strong enough for inclusion in clinical prediction models and screening protocols';
            } else if (absR >= 0.4) {
                return 'Useful for risk stratification and clinical assessment tools';
            } else if (absR >= 0.2) {
                return 'May be considered as secondary factor in comprehensive assessments';
            } else {
                return 'Limited clinical utility - consider other variables';
            }
        }

        function getNextStepsRecommendation(method, correlation, significance) {
            const absR = Math.abs(correlation);
            
            if (method === 'pearson' && absR > 0.3) {
                return 'Consider multiple regression to control for confounders';
            } else if (method === 'spearman') {
                return 'Explore non-linear modeling approaches if strong relationship detected';
            } else if (method === 'partial') {
                return 'Compare with bivariate correlation to assess confounding effect';
            } else {
                return 'Investigate additional variables or larger sample size';
            }
        }

        function createAdvancedCorrelationChart(xData, yData, xLabel, yLabel, correlation, method) {
            console.log('üìä Starting chart creation...');
            
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('‚ùå Chart.js is not loaded');
                showChartError('Chart.js library is not loaded. Please refresh the page.');
                return;
            }
            
            const canvasElement = document.getElementById('correlation-chart');
            if (!canvasElement) {
                console.error('‚ùå Canvas element not found');
                showChartError('Chart canvas element not found.');
                return;
            }
            
            // Clear canvas and get context
            const ctx = canvasElement.getContext('2d');
            if (!ctx) {
                console.error('‚ùå Could not get 2D context');
                showChartError('Could not get canvas 2D context.');
                return;
            }
            
            console.log('‚úÖ Canvas context acquired');
            
            // Destroy existing chart
            if (charts.correlation) {
                console.log('üóëÔ∏è Destroying existing chart');
                charts.correlation.destroy();
                delete charts.correlation;
            }
            
            // Validate data
            if (!xData || !yData || xData.length === 0 || yData.length === 0 || xData.length !== yData.length) {
                console.error('‚ùå Invalid chart data:', { xLength: xData?.length, yLength: yData?.length });
                showChartError('Invalid data for chart creation.');
                return;
            }
            
            console.log('‚úÖ Data validation passed:', { dataPoints: xData.length });
            
            // Color code by correlation strength
            let pointColor, borderColor;
            const absR = Math.abs(correlation);
            if (absR >= 0.7) {
                pointColor = 'rgba(220, 20, 60, 0.8)';  // Strong: Red
                borderColor = 'rgba(220, 20, 60, 1)';
            } else if (absR >= 0.4) {
                pointColor = 'rgba(255, 140, 0, 0.8)';  // Moderate: Orange
                borderColor = 'rgba(255, 140, 0, 1)';
            } else if (absR >= 0.2) {
                pointColor = 'rgba(47, 139, 139, 0.8)';  // Weak: Teal
                borderColor = 'rgba(47, 139, 139, 1)';
            } else {
                pointColor = 'rgba(128, 128, 128, 0.8)';  // Very weak: Gray
                borderColor = 'rgba(128, 128, 128, 1)';
            }
            
            // Prepare scatter plot data
            const scatterData = [];
            for (let i = 0; i < xData.length; i++) {
                scatterData.push({ x: xData[i], y: yData[i] });
            }
            
            console.log('‚úÖ Scatter data prepared:', scatterData.length, 'points');
            console.log('Sample data points:', scatterData.slice(0, 3));
            
            // Create chart configuration
            const chartConfig = {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Patient Data',
                        data: scatterData,
                        backgroundColor: pointColor,
                        borderColor: borderColor,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${yLabel} vs ${xLabel} | ${method === 'spearman' ? 'œÅ' : method === 'partial' ? 'r_partial' : 'r'} = ${correlation.toFixed(3)}`,
                            font: { size: 18, weight: 'bold' },
                            color: '#2c3e50',
                            padding: 20
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: xLabel,
                                font: { size: 14, weight: 'bold' },
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                borderColor: '#2c3e50',
                                borderWidth: 2
                            },
                            ticks: {
                                color: '#2c3e50',
                                font: { size: 12 }
                            }
                        },
                        y: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: yLabel,
                                font: { size: 14, weight: 'bold' },
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                borderColor: '#2c3e50',
                                borderWidth: 2
                            },
                            ticks: {
                                color: '#2c3e50',
                                font: { size: 12 }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'point'
                    }
                }
            };
            
            // Add trend line for meaningful correlations
            if (absR > 0.2) {
                console.log('‚ûï Adding trend line for correlation:', correlation);
                
                const minX = Math.min(...xData);
                const maxX = Math.max(...xData);
                
                // Calculate linear regression line
                const n = xData.length;
                const sumX = xData.reduce((a, b) => a + b, 0);
                const sumY = yData.reduce((a, b) => a + b, 0);
                const sumXY = xData.reduce((sum, x, i) => sum + x * yData[i], 0);
                const sumXX = xData.reduce((sum, x) => sum + x * x, 0);
                
                const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                
                chartConfig.data.datasets.push({
                    label: 'Trend Line',
                    data: [
                        { x: minX, y: intercept + slope * minX },
                        { x: maxX, y: intercept + slope * maxX }
                    ],
                    type: 'line',
                    borderColor: borderColor,
                    backgroundColor: 'transparent',
                    pointRadius: 0,
                    borderWidth: 3,
                    fill: false,
                    tension: 0
                });
                
                chartConfig.options.plugins.legend.display = true;
            }
            
            try {
                console.log('üé® Creating Chart.js instance...');
                
                // Create the chart
                charts.correlation = new Chart(ctx, chartConfig);
                
                console.log('üéâ Chart created successfully!');
                
                // Force chart container visibility
                const chartContainer = canvasElement.parentElement;
                if (chartContainer) {
                    chartContainer.style.display = 'block';
                    chartContainer.style.visibility = 'visible';
                    chartContainer.style.height = '450px';
                    chartContainer.style.minHeight = '450px';
                    canvasElement.style.display = 'block';
                    canvasElement.style.visibility = 'visible';
                    canvasElement.style.width = '100%';
                    canvasElement.style.height = '400px';
                    console.log('‚úÖ Chart container forced visible');
                }
                
                // Force a render and update
                setTimeout(() => {
                    if (charts.correlation) {
                        charts.correlation.resize();
                        charts.correlation.update('active');
                        console.log('üîÑ Chart updated and resized');
                        
                        // Final visibility check
                        const rect = canvasElement.getBoundingClientRect();
                        console.log('üìê Canvas dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            visible: rect.width > 0 && rect.height > 0
                        });
                    }
                }, 200);
                
            } catch (error) {
                console.error('‚ùå Chart creation failed:', error);
                showChartError(`Chart creation error: ${error.message}`);
            }
        }
        
        function showChartError(message) {
            const chartContainer = document.querySelector('.chart-container');
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 400px; border: 2px dashed #dc143c; border-radius: 8px; background: #fff5f5;">
                        <div style="text-align: center; color: #dc143c; padding: 20px;">
                            <h3 style="margin: 0 0 10px 0;">‚ö†Ô∏è Chart Error</h3>
                            <p style="margin: 0 0 15px 0;">${message}</p>
                            <button onclick="simulateAdvancedCorrelation()" style="background: #dc143c; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                                üîÑ Try Again
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Placeholder functions for other sections (to be implemented)
        function generateAdvancedScatterPlot() {
            const pattern = document.getElementById('scatter-pattern').value;
            const outliers = document.getElementById('scatter-outliers').value;
            const context = document.getElementById('scatter-context').value;
            const sampleSize = parseInt(document.getElementById('scatter-sample-size').value);
            
            document.getElementById('scatter-results').style.display = 'block';
            document.getElementById('scatter-results').innerHTML = `
                <h4>‚úÖ Advanced Scatter Plot Analysis</h4>
                <p><strong>Pattern:</strong> ${pattern.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                <p><strong>Outliers:</strong> ${outliers.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                <p><strong>Context:</strong> ${context.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                <p><strong>Sample Size:</strong> ${sampleSize} patients</p>
                <p>This demonstration shows how different data patterns affect correlation interpretation and the importance of visual analysis.</p>
            `;
        }

        function simulateAdvancedRegression() {
            console.log('üöÄ Starting advanced regression simulation...');
            
            try {
                // Get form values with error checking
                const model = document.getElementById('regression-model')?.value || 'age-bp';
                const population = document.getElementById('regression-population')?.value || 'general';
                const quality = document.getElementById('regression-quality')?.value || 'moderate';
                const sampleSize = parseInt(document.getElementById('regression-sample-size')?.value) || 250;
                
                console.log('üìä Regression form values:', { model, population, quality, sampleSize });
                
                // Regression model configurations
                const regressionModels = {
                    'age-bp': {
                        xLabel: 'Age (years)',
                        yLabel: 'Systolic BP (mmHg)',
                        context: 'Hypertension risk prediction with aging',
                        baseIntercept: 90, baseSlope: 1.2, baseMean: 50, noiseSD: 8,
                        xRange: [20, 80], yRange: [90, 180],
                        equation: 'Systolic BP = 90 + 1.2 √ó Age',
                        interpretation: 'Each additional year of age increases systolic BP by 1.2 mmHg on average'
                    },
                    'dose-weight': {
                        xLabel: 'Body Weight (kg)', 
                        yLabel: 'Drug Dose (mg)',
                        context: 'Weight-based drug dosing guidelines',
                        baseIntercept: 10, baseSlope: 2.5, baseMean: 70, noiseSD: 5,
                        xRange: [40, 120], yRange: [20, 320],
                        equation: 'Drug Dose = 10 + 2.5 √ó Weight',
                        interpretation: 'Each additional kg of weight requires 2.5 mg additional dose'
                    },
                    'glucose-hba1c': {
                        xLabel: 'Fasting Glucose (mmol/L)',
                        yLabel: 'HbA1c (%)',
                        context: 'Diabetes monitoring and glycemic control',
                        baseIntercept: 4.0, baseSlope: 0.35, baseMean: 6.5, noiseSD: 0.4,
                        xRange: [4, 15], yRange: [4.5, 12],
                        equation: 'HbA1c = 4.0 + 0.35 √ó Glucose',
                        interpretation: 'Each 1 mmol/L increase in glucose increases HbA1c by 0.35%'
                    },
                    'creatinine-egfr': {
                        xLabel: 'Serum Creatinine (Œºmol/L)',
                        yLabel: 'eGFR (mL/min/1.73m¬≤)',
                        context: 'Kidney function assessment',
                        baseIntercept: 140, baseSlope: -0.6, baseMean: 100, noiseSD: 12,
                        xRange: [50, 300], yRange: [15, 120],
                        equation: 'eGFR = 140 - 0.6 √ó Creatinine',
                        interpretation: 'Each 1 Œºmol/L increase in creatinine decreases eGFR by 0.6 units'
                    },
                    'bmi-insulin': {
                        xLabel: 'BMI (kg/m¬≤)',
                        yLabel: 'Insulin Resistance (HOMA-IR)',
                        context: 'Metabolic syndrome assessment',
                        baseIntercept: -2.5, baseSlope: 0.25, baseMean: 27, noiseSD: 1.2,
                        xRange: [18, 45], yRange: [0.5, 8.5],
                        equation: 'HOMA-IR = -2.5 + 0.25 √ó BMI',
                        interpretation: 'Each 1 kg/m¬≤ increase in BMI increases insulin resistance by 0.25 units'
                    }
                };
                
                const config = regressionModels[model];
                if (!config) {
                    throw new Error(`Unknown regression model: ${model}`);
                }
                
                // Apply population adjustments
                let populationAdjustment = { interceptShift: 0, slopeMultiplier: 1.0, noiseMultiplier: 1.0 };
                
                if (population === 'elderly') {
                    populationAdjustment = { interceptShift: 10, slopeMultiplier: 1.15, noiseMultiplier: 1.3 };
                } else if (population === 'pediatric') {
                    populationAdjustment = { interceptShift: -15, slopeMultiplier: 0.8, noiseMultiplier: 0.8 };
                } else if (population === 'mixed') {
                    populationAdjustment = { interceptShift: 0, slopeMultiplier: 1.0, noiseMultiplier: 1.5 };
                }
                
                // Apply quality adjustments
                let qualityMultiplier = 1.0;
                let targetR2 = 0.6;
                
                if (quality === 'high') {
                    qualityMultiplier = 0.6;
                    targetR2 = 0.8;
                } else if (quality === 'moderate') {
                    qualityMultiplier = 1.0;
                    targetR2 = 0.6;
                } else if (quality === 'low') {
                    qualityMultiplier = 2.0;
                    targetR2 = 0.3;
                } else if (quality === 'realistic') {
                    qualityMultiplier = 1.4;
                    targetR2 = 0.45;
                }
                
                console.log('‚öôÔ∏è Using configuration:', config);
                console.log('üéØ Population adjustment:', populationAdjustment);
                console.log('üìà Target R¬≤:', targetR2);
                
                // Generate regression data
                const xData = [];
                const yData = [];
                
                for (let i = 0; i < sampleSize; i++) {
                    // Generate X values around the base mean
                    const x = generateNormalData(1, config.baseMean, config.baseMean * 0.3)[0];
                    
                    // Calculate Y using adjusted regression equation
                    const adjustedIntercept = config.baseIntercept + populationAdjustment.interceptShift;
                    const adjustedSlope = config.baseSlope * populationAdjustment.slopeMultiplier;
                    const adjustedNoise = config.noiseSD * qualityMultiplier * populationAdjustment.noiseMultiplier;
                    
                    const predictedY = adjustedIntercept + adjustedSlope * x;
                    const noise = generateNormalData(1, 0, adjustedNoise)[0];
                    const y = predictedY + noise;
                    
                    // Keep within reasonable ranges
                    if (x >= config.xRange[0] && x <= config.xRange[1] && 
                        y >= config.yRange[0] && y <= config.yRange[1]) {
                        xData.push(x);
                        yData.push(y);
                    }
                }
                
                console.log('‚úÖ Regression data generated:', { points: xData.length });
                
                // Calculate regression statistics
                const n = xData.length;
                const meanX = xData.reduce((sum, x) => sum + x, 0) / n;
                const meanY = yData.reduce((sum, y) => sum + y, 0) / n;
                
                let ssXY = 0, ssXX = 0, ssYY = 0;
                for (let i = 0; i < n; i++) {
                    const dx = xData[i] - meanX;
                    const dy = yData[i] - meanY;
                    ssXY += dx * dy;
                    ssXX += dx * dx;
                    ssYY += dy * dy;
                }
                
                const slope = ssXY / ssXX;
                const intercept = meanY - slope * meanX;
                const correlation = ssXY / Math.sqrt(ssXX * ssYY);
                const rSquared = correlation * correlation;
                const residualSumSquares = ssYY - (ssXY * ssXY) / ssXX;
                const standardError = Math.sqrt(residualSumSquares / (n - 2));
                
                console.log('üìä Regression calculations complete:', { slope, intercept, rSquared: rSquared.toFixed(3) });
                
                // Display results
                displayRegressionResults(config, slope, intercept, rSquared, standardError, correlation, n, population, quality);
                
                // Create regression chart
                createRegressionChart(xData, yData, config, slope, intercept, correlation);
                
                console.log('üéâ Advanced regression analysis completed successfully!');
                
            } catch (error) {
                console.error('‚ùå Error in simulateAdvancedRegression:', error);
                
                // Display user-friendly error message
                const resultsDiv = document.getElementById('simple-regression-results');
                if (resultsDiv) {
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: #dc143c; border: 2px solid #dc143c; border-radius: 8px;">
                            <h4>‚ö†Ô∏è Regression Analysis Error</h4>
                            <p>Unable to complete regression model building.</p>
                            <p><strong>Error details:</strong> ${error.message}</p>
                            <button onclick="simulateAdvancedRegression()" style="margin: 10px;">üîÑ Try Again</button>
                            <button onclick="location.reload()" style="margin: 10px;">üåê Refresh Page</button>
                        </div>
                    `;
                }
            }
        }

        function displayRegressionResults(config, slope, intercept, rSquared, standardError, correlation, n, population, quality) {
            const resultsDiv = document.getElementById('simple-regression-results');
            resultsDiv.style.display = 'block';
            
            const populationText = {
                'general': 'Canadian Adults (18-65 years)',
                'elderly': 'Elderly Population (65+ years)',
                'pediatric': 'Pediatric Population (5-17 years)',
                'mixed': 'Mixed Age Groups'
            }[population];
            
            const qualityText = {
                'high': 'High Quality (Strong relationship)',
                'moderate': 'Moderate Quality (Typical clinical data)',
                'low': 'Low Quality (Weak relationship)',
                'realistic': 'Realistic Clinical Data'
            }[quality];
            
            let performanceAssessment = '';
            if (rSquared >= 0.7) {
                performanceAssessment = 'Excellent model fit - Strong predictive capability suitable for clinical decision support.';
            } else if (rSquared >= 0.4) {
                performanceAssessment = 'Moderate model fit - Useful for risk stratification but consider additional predictors.';
            } else {
                performanceAssessment = 'Weak model fit - Limited predictive value, other factors likely more important.';
            }
            
            const clinicalSignificance = Math.abs(slope) > Math.abs(config.baseSlope * 0.5) ? 
                'Clinically meaningful relationship that should inform treatment decisions.' :
                'Relationship may have limited clinical significance.';
            
            resultsDiv.innerHTML = `
                <h4>üìà Linear Regression Model Results</h4>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0;">
                    <h5>üéØ Model Specification</h5>
                    <p><strong>Clinical Context:</strong> ${config.context}</p>
                    <p><strong>Population:</strong> ${populationText}</p>
                    <p><strong>Data Quality:</strong> ${qualityText}</p>
                    <p><strong>Sample Size:</strong> ${n} patients</p>
                </div>
                
                <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin: 15px 0;">
                    <h5>üìä Regression Equation</h5>
                    <p style="font-size: 18px; font-weight: bold; color: #1976d2;">
                        ${config.yLabel} = ${intercept.toFixed(2)} + ${slope.toFixed(3)} √ó ${config.xLabel}
                    </p>
                    <p><strong>Interpretation:</strong> ${config.interpretation.replace(/[0-9.]+/, slope.toFixed(3))}</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h6>Correlation (r)</h6>
                        <span class="stat-value">${correlation.toFixed(3)}</span>
                    </div>
                    <div class="stat-card">
                        <h6>R-squared (R¬≤)</h6>
                        <span class="stat-value">${(rSquared * 100).toFixed(1)}%</span>
                    </div>
                    <div class="stat-card">
                        <h6>Standard Error</h6>
                        <span class="stat-value">${standardError.toFixed(2)}</span>
                    </div>
                    <div class="stat-card">
                        <h6>Sample Size</h6>
                        <span class="stat-value">${n}</span>
                    </div>
                </div>
                
                <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin: 15px 0;">
                    <h5>üè• Clinical Interpretation</h5>
                    <p><strong>Model Performance:</strong> ${performanceAssessment}</p>
                    <p><strong>Clinical Significance:</strong> ${clinicalSignificance}</p>
                    <p><strong>Explained Variance:</strong> This model explains ${(rSquared * 100).toFixed(1)}% of the variation in ${config.yLabel.toLowerCase()}.</p>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 15px 0;">
                    <h5>‚öñÔ∏è Regulatory Considerations</h5>
                    <p><strong>Health Canada Classification:</strong> ${rSquared >= 0.6 ? 'Potentially suitable for Class II medical device application' : 'Requires improvement for regulatory approval'}</p>
                    <p><strong>Validation Requirements:</strong> External validation on diverse Canadian populations, bias assessment, and clinical utility demonstration required.</p>
                    <p><strong>Performance Metrics:</strong> R¬≤ = ${(rSquared * 100).toFixed(1)}% ${rSquared >= 0.6 ? '‚úÖ' : '‚ö†Ô∏è'}, SE = ${standardError.toFixed(2)}, n = ${n}</p>
                </div>
            `;
        }

        function createRegressionChart(xData, yData, config, slope, intercept, correlation) {
            console.log('üìä Creating regression chart...');
            
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('‚ùå Chart.js is not loaded');
                showRegressionChartError('Chart.js library is not loaded. Please refresh the page.');
                return;
            }
            
            const canvasElement = document.getElementById('simple-regression-chart');
            if (!canvasElement) {
                console.error('‚ùå Regression canvas element not found');
                showRegressionChartError('Chart canvas element not found.');
                return;
            }
            
            const ctx = canvasElement.getContext('2d');
            if (!ctx) {
                console.error('‚ùå Could not get 2D context');
                showRegressionChartError('Could not get canvas 2D context.');
                return;
            }
            
            console.log('‚úÖ Regression canvas context acquired');
            
            // Destroy existing chart
            if (charts.regression) {
                console.log('üóëÔ∏è Destroying existing regression chart');
                charts.regression.destroy();
                delete charts.regression;
            }
            
            // Validate data
            if (!xData || !yData || xData.length === 0 || yData.length === 0) {
                console.error('‚ùå Invalid regression chart data');
                showRegressionChartError('Invalid data for chart creation.');
                return;
            }
            
            // Color code by correlation strength
            let pointColor, borderColor;
            const absR = Math.abs(correlation);
            if (absR >= 0.7) {
                pointColor = 'rgba(34, 139, 34, 0.7)';  // Strong: Green
                borderColor = 'rgba(34, 139, 34, 1)';
            } else if (absR >= 0.4) {
                pointColor = 'rgba(255, 140, 0, 0.7)';  // Moderate: Orange
                borderColor = 'rgba(255, 140, 0, 1)';
            } else {
                pointColor = 'rgba(220, 20, 60, 0.7)';  // Weak: Red
                borderColor = 'rgba(220, 20, 60, 1)';
            }
            
            // Prepare scatter plot data
            const scatterData = [];
            for (let i = 0; i < xData.length; i++) {
                scatterData.push({ x: xData[i], y: yData[i] });
            }
            
            // Calculate regression line points
            const minX = Math.min(...xData);
            const maxX = Math.max(...xData);
            const regressionLine = [
                { x: minX, y: intercept + slope * minX },
                { x: maxX, y: intercept + slope * maxX }
            ];
            
            console.log('‚úÖ Regression chart data prepared:', scatterData.length, 'points');
            
            // Create chart configuration
            const chartConfig = {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Patient Data',
                        data: scatterData,
                        backgroundColor: pointColor,
                        borderColor: borderColor,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBorderWidth: 2
                    }, {
                        label: `Regression Line (R¬≤ = ${(correlation * correlation * 100).toFixed(1)}%)`,
                        data: regressionLine,
                        type: 'line',
                        borderColor: '#2c3e50',
                        backgroundColor: 'transparent',
                        pointRadius: 0,
                        borderWidth: 3,
                        fill: false,
                        tension: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${config.yLabel} vs ${config.xLabel} | Linear Regression`,
                            font: { size: 18, weight: 'bold' },
                            color: '#2c3e50',
                            padding: 20
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: config.xLabel,
                                font: { size: 14, weight: 'bold' },
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                borderColor: '#2c3e50',
                                borderWidth: 2
                            }
                        },
                        y: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: config.yLabel,
                                font: { size: 14, weight: 'bold' },
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                borderColor: '#2c3e50',
                                borderWidth: 2
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'point'
                    }
                }
            };
            
            try {
                console.log('üé® Creating regression Chart.js instance...');
                
                // Create the chart
                charts.regression = new Chart(ctx, chartConfig);
                
                console.log('üéâ Regression chart created successfully!');
                
                // Force chart container visibility
                const chartContainer = canvasElement.parentElement;
                if (chartContainer) {
                    chartContainer.style.display = 'block';
                    chartContainer.style.visibility = 'visible';
                    chartContainer.style.height = '450px';
                    canvasElement.style.display = 'block';
                    canvasElement.style.visibility = 'visible';
                    canvasElement.style.width = '100%';
                    canvasElement.style.height = '400px';
                    console.log('‚úÖ Regression chart container forced visible');
                }
                
                // Force update
                setTimeout(() => {
                    if (charts.regression) {
                        charts.regression.resize();
                        charts.regression.update('active');
                        console.log('üîÑ Regression chart updated and resized');
                        
                        const rect = canvasElement.getBoundingClientRect();
                        console.log('üìê Regression canvas dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            visible: rect.width > 0 && rect.height > 0
                        });
                    }
                }, 200);
                
            } catch (error) {
                console.error('‚ùå Regression chart creation failed:', error);
                showRegressionChartError(`Chart creation error: ${error.message}`);
            }
        }
        
        function showRegressionChartError(message) {
            const chartContainer = document.querySelector('#simple-regression-chart').parentElement;
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 400px; border: 2px dashed #dc143c; border-radius: 8px; background: #fff5f5;">
                        <div style="text-align: center; color: #dc143c; padding: 20px;">
                            <h3 style="margin: 0 0 10px 0;">‚ö†Ô∏è Regression Chart Error</h3>
                            <p style="margin: 0 0 15px 0;">${message}</p>
                            <button onclick="simulateAdvancedRegression()" style="background: #dc143c; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                                üîÑ Try Again
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        function testRegressionFunction() {
            console.log('üß™ Testing regression function...');
            alert('‚úÖ Testing regression functionality...');
            
            // Test element access for regression
            const modelElement = document.getElementById('regression-model');
            const populationElement = document.getElementById('regression-population');
            const qualityElement = document.getElementById('regression-quality');
            const sampleSizeElement = document.getElementById('regression-sample-size');
            const resultsElement = document.getElementById('simple-regression-results');
            const chartCanvas = document.getElementById('simple-regression-chart');
            
            console.log('Regression element access test:', {
                model: modelElement ? modelElement.value : 'NOT FOUND',
                population: populationElement ? populationElement.value : 'NOT FOUND',
                quality: qualityElement ? qualityElement.value : 'NOT FOUND',
                sampleSize: sampleSizeElement ? sampleSizeElement.value : 'NOT FOUND',
                results: resultsElement ? 'FOUND' : 'NOT FOUND',
                chartCanvas: chartCanvas ? 'FOUND' : 'NOT FOUND'
            });
            
            // Test Chart.js availability
            if (typeof Chart === 'undefined') {
                console.error('‚ùå Chart.js not available for regression');
                if (resultsElement) {
                    resultsElement.style.display = 'block';
                    resultsElement.innerHTML = `
                        <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 6px;">
                            <h4>‚ùå Chart.js Not Loaded</h4>
                            <p>Chart.js library is not available for regression charts. Please refresh the page.</p>
                        </div>
                    `;
                }
                return;
            }
            
            // Test basic regression chart creation
            testBasicRegressionChart();
            
            if (resultsElement) {
                resultsElement.style.display = 'block';
                resultsElement.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 6px;">
                        <h4>‚úÖ Regression Test Successful</h4>
                        <p>All required elements found and accessible.</p>
                        <p>Chart.js is available: <strong>Version ${Chart.version || 'Unknown'}</strong></p>
                        <p>Testing basic regression chart creation above...</p>
                        <button onclick="simulateAdvancedRegression()" style="background: #28a745; color: white; margin-top: 10px;">üöÄ Run Full Regression</button>
                    </div>
                `;
            }
        }
        
        function testBasicRegressionChart() {
            console.log('üìä Testing basic regression chart creation...');
            
            const canvas = document.getElementById('simple-regression-chart');
            if (!canvas) {
                console.error('‚ùå Regression chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('‚ùå Cannot get 2D context for regression chart');
                return;
            }
            
            // Destroy any existing chart
            if (charts.regression) {
                charts.regression.destroy();
                delete charts.regression;
            }
            
            try {
                // Create a simple test regression chart
                const testData = [
                    {x: 20, y: 110}, {x: 30, y: 120}, {x: 40, y: 130}, 
                    {x: 50, y: 140}, {x: 60, y: 150}, {x: 70, y: 160}
                ];
                
                const regressionLine = [
                    {x: 20, y: 110}, {x: 70, y: 160}
                ];
                
                charts.regression = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Test Patient Data',
                            data: testData,
                            backgroundColor: 'rgba(34, 139, 34, 0.7)',
                            borderColor: 'rgba(34, 139, 34, 1)',
                            pointRadius: 6
                        }, {
                            label: 'Test Regression Line (R¬≤ = 100%)',
                            data: regressionLine,
                            type: 'line',
                            borderColor: '#2c3e50',
                            backgroundColor: 'transparent',
                            pointRadius: 0,
                            borderWidth: 3,
                            fill: false,
                            tension: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'üß™ Test Regression Chart - Age vs Blood Pressure',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                title: { display: true, text: 'Age (years)' }
                            },
                            y: {
                                type: 'linear', 
                                title: { display: true, text: 'Blood Pressure (mmHg)' }
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Test regression chart created successfully!');
                
                // Force container visibility
                const container = canvas.parentElement;
                if (container) {
                    container.style.display = 'block';
                    container.style.visibility = 'visible';
                    container.style.height = '450px';
                    canvas.style.display = 'block';
                    canvas.style.visibility = 'visible';
                    canvas.style.width = '100%';
                    canvas.style.height = '400px';
                    console.log('‚úÖ Test regression chart container forced visible');
                }
                
                // Force update
                setTimeout(() => {
                    if (charts.regression) {
                        charts.regression.resize();
                        charts.regression.update('active');
                        
                        const rect = canvas.getBoundingClientRect();
                        console.log('üìê Test regression canvas dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            visible: rect.width > 0 && rect.height > 0
                        });
                    }
                }, 200);
                
            } catch (error) {
                console.error('‚ùå Test regression chart creation failed:', error);
                showRegressionChartError(`Test regression chart failed: ${error.message}`);
            }
        }
        
        function testMultipleRegressionFunction() {
            console.log('üß™ Testing multiple regression function...');
            alert('‚úÖ Testing multiple regression functionality...');
            
            // Test element access for multiple regression
            const modelElement = document.getElementById('multiple-model');
            const complexityElement = document.getElementById('multiple-complexity');
            const populationElement = document.getElementById('multiple-population');
            const validationElement = document.getElementById('multiple-validation');
            const sampleSizeElement = document.getElementById('multiple-sample-size');
            const outputElement = document.getElementById('multiple-output');
            const resultsElement = document.getElementById('multiple-regression-results');
            const chartCanvas = document.getElementById('multiple-regression-chart');
            
            console.log('Multiple regression element access test:', {
                model: modelElement ? modelElement.value : 'NOT FOUND',
                complexity: complexityElement ? complexityElement.value : 'NOT FOUND',
                population: populationElement ? populationElement.value : 'NOT FOUND',
                validation: validationElement ? validationElement.value : 'NOT FOUND',
                sampleSize: sampleSizeElement ? sampleSizeElement.value : 'NOT FOUND',
                output: outputElement ? outputElement.value : 'NOT FOUND',
                results: resultsElement ? 'FOUND' : 'NOT FOUND',
                chartCanvas: chartCanvas ? 'FOUND' : 'NOT FOUND'
            });
            
            // Test Chart.js availability
            if (typeof Chart === 'undefined') {
                console.error('‚ùå Chart.js not available for multiple regression');
                if (resultsElement) {
                    resultsElement.style.display = 'block';
                    resultsElement.innerHTML = `
                        <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 6px;">
                            <h4>‚ùå Chart.js Not Loaded</h4>
                            <p>Chart.js library is not available for multiple regression charts. Please refresh the page.</p>
                        </div>
                    `;
                }
                return;
            }
            
            // Test basic multiple regression chart creation
            testBasicMultipleRegressionChart();
            
            if (resultsElement) {
                resultsElement.style.display = 'block';
                resultsElement.innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 6px;">
                        <h4>‚úÖ Multiple Regression Test Successful</h4>
                        <p>All required elements found and accessible.</p>
                        <p>Chart.js is available: <strong>Version ${Chart.version || 'Unknown'}</strong></p>
                        <p>Testing basic multiple regression chart creation above...</p>
                        <div style="margin-top: 15px;">
                            <button onclick="buildAdvancedMultipleRegression()" style="background: #28a745; color: white; margin-right: 10px;">üöÄ Run Full Multiple Regression</button>
                            <button onclick="alert('Form values: Model=' + document.getElementById('multiple-model').value + ', Complexity=' + document.getElementById('multiple-complexity').value + ', Population=' + document.getElementById('multiple-population').value)" style="background: #17a2b8; color: white;">üìã Check Form Values</button>
                        </div>
                    </div>
                `;
            }
        }
        
        function testBasicMultipleRegressionChart() {
            console.log('üìä Testing basic multiple regression chart creation...');
            
            const canvas = document.getElementById('multiple-regression-chart');
            if (!canvas) {
                console.error('‚ùå Multiple regression chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('‚ùå Cannot get 2D context for multiple regression chart');
                return;
            }
            
            // Destroy any existing chart
            if (charts.multipleRegression) {
                charts.multipleRegression.destroy();
                delete charts.multipleRegression;
            }
            
            try {
                // Create a simple test multiple regression chart (predicted vs actual)
                const testPredicted = [10, 20, 30, 40, 50, 60];
                const testActual = [12, 18, 32, 38, 52, 58];
                
                const testData = [];
                for (let i = 0; i < testPredicted.length; i++) {
                    testData.push({ x: testPredicted[i], y: testActual[i] });
                }
                
                const perfectLine = [
                    { x: 10, y: 10 }, { x: 60, y: 60 }
                ];
                
                charts.multipleRegression = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Test Predicted vs Actual',
                            data: testData,
                            backgroundColor: 'rgba(34, 139, 34, 0.7)',
                            borderColor: 'rgba(34, 139, 34, 1)',
                            pointRadius: 8
                        }, {
                            label: 'Perfect Prediction Line',
                            data: perfectLine,
                            type: 'line',
                            borderColor: '#2c3e50',
                            backgroundColor: 'transparent',
                            pointRadius: 0,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'üß™ Test Multiple Regression Chart - Predicted vs Actual',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                title: { display: true, text: 'Predicted Values' }
                            },
                            y: {
                                type: 'linear', 
                                title: { display: true, text: 'Actual Values' }
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Test multiple regression chart created successfully!');
                
                // Force container visibility
                const container = canvas.parentElement;
                if (container) {
                    container.style.display = 'block';
                    container.style.visibility = 'visible';
                    container.style.height = '450px';
                    canvas.style.display = 'block';
                    canvas.style.visibility = 'visible';
                    canvas.style.width = '100%';
                    canvas.style.height = '400px';
                    console.log('‚úÖ Test multiple regression chart container forced visible');
                }
                
                // Force update
                setTimeout(() => {
                    if (charts.multipleRegression) {
                        charts.multipleRegression.resize();
                        charts.multipleRegression.update('active');
                        
                        const rect = canvas.getBoundingClientRect();
                        console.log('üìê Test multiple regression canvas dimensions:', {
                            width: rect.width,
                            height: rect.height,
                            visible: rect.width > 0 && rect.height > 0
                        });
                    }
                }, 200);
                
            } catch (error) {
                console.error('‚ùå Test multiple regression chart creation failed:', error);
                showMultipleRegressionChartError(`Test multiple regression chart failed: ${error.message}`);
            }
        }

        function demonstrateAssumptions() {
            document.getElementById('assumptions-results').style.display = 'block';
            document.getElementById('assumptions-results').innerHTML = `
                <h4>‚ö†Ô∏è Regression Assumption Checking</h4>
                <p>This section demonstrates L.I.N.E. assumption checking with diagnostic plots and remedial measures for clinical data.</p>
            `;
        }

        function buildAdvancedMultipleRegression() {
            console.log('üöÄ Starting advanced multiple regression modeling...');
            
            try {
                // Get form values with error checking
                const model = document.getElementById('multiple-model')?.value || 'cvd-risk';
                const complexity = document.getElementById('multiple-complexity')?.value || 'standard';
                const population = document.getElementById('multiple-population')?.value || 'general';
                const validation = document.getElementById('multiple-validation')?.value || 'cross-validation';
                const sampleSize = parseInt(document.getElementById('multiple-sample-size')?.value) || 500;
                const outputLevel = document.getElementById('multiple-output')?.value || 'clinical';
                
                console.log('üìä Multiple regression parameters:', { model, complexity, population, validation, sampleSize, outputLevel });
                
                // Multiple regression model configurations
                const multipleRegressionModels = {
                    'cvd-risk': {
                        name: 'Cardiovascular Disease Risk (CANRISK-CVD)',
                        outcome: 'CVD Risk Score (0-100)',
                        context: 'Predicts 10-year cardiovascular disease risk in Canadian adults',
                        predictors: {
                            basic: ['Age', 'Sex', 'Systolic BP', 'Total Cholesterol'],
                            standard: ['Age', 'Sex', 'Systolic BP', 'Total Cholesterol', 'HDL', 'Smoking', 'Diabetes'],
                            comprehensive: ['Age', 'Sex', 'Systolic BP', 'Total Cholesterol', 'HDL', 'Smoking', 'Diabetes', 'Family History', 'BMI', 'Physical Activity', 'Education', 'Income']
                        },
                        baseLine: 15.5, // Average CVD risk %
                        coefficients: [0.8, 12, 0.15, 2.5, -1.8, 8.2, 6.5, 4.1, 0.3, -2.1, -1.5, -0.8]
                    },
                    'diabetes-risk': {
                        name: 'Type 2 Diabetes Risk (CANRISK-DM)',
                        outcome: 'Diabetes Risk Score (0-100)',
                        context: 'Assesses diabetes development risk using Canadian population data',
                        predictors: {
                            basic: ['Age', 'BMI', 'Waist Circumference', 'Family History'],
                            standard: ['Age', 'BMI', 'Waist Circumference', 'Family History', 'Physical Activity', 'Ethnicity', 'Hypertension'],
                            comprehensive: ['Age', 'BMI', 'Waist Circumference', 'Family History', 'Physical Activity', 'Ethnicity', 'Hypertension', 'Gestational Diabetes', 'Birth Weight', 'Stress Level', 'Sleep Quality', 'Diet Quality']
                        },
                        baseLine: 8.2, // Average diabetes risk %
                        coefficients: [0.6, 1.2, 0.4, 15.5, -3.8, 8.1, 7.2, 12.3, 3.1, 2.5, -1.9, -2.2]
                    },
                    'surgical-risk': {
                        name: 'Cardiac Surgery Risk Assessment',
                        outcome: 'Surgical Risk Score (0-100)',
                        context: 'Perioperative risk assessment for cardiac surgery patients',
                        predictors: {
                            basic: ['Age', 'Ejection Fraction', 'Creatinine', 'Previous Surgery'],
                            standard: ['Age', 'Ejection Fraction', 'Creatinine', 'Previous Surgery', 'NYHA Class', 'Emergency', 'Comorbidities'],
                            comprehensive: ['Age', 'Ejection Fraction', 'Creatinine', 'Previous Surgery', 'NYHA Class', 'Emergency', 'Comorbidities', 'Pulmonary Function', 'Liver Function', 'BMI', 'Frailty Score', 'Social Support']
                        },
                        baseLine: 12.8, // Average surgical risk %
                        coefficients: [0.4, -0.3, 0.8, 8.5, 3.2, 15.6, 1.8, -0.15, 0.25, 0.2, 2.1, -1.8]
                    },
                    'drug-clearance': {
                        name: 'Pediatric Drug Clearance Model',
                        outcome: 'Drug Clearance (mL/min/kg)',
                        context: 'Predicts drug clearance for safe pediatric dosing',
                        predictors: {
                            basic: ['Weight', 'Age', 'Creatinine', 'Liver Function'],
                            standard: ['Weight', 'Age', 'Creatinine', 'Liver Function', 'Albumin', 'Total Protein', 'Gestational Age'],
                            comprehensive: ['Weight', 'Age', 'Creatinine', 'Liver Function', 'Albumin', 'Total Protein', 'Gestational Age', 'Post-natal Age', 'Concomitant Drugs', 'Genetic Variants', 'Maturation', 'Disease State']
                        },
                        baseLine: 2.8, // Average clearance
                        coefficients: [0.08, 0.15, -0.02, 1.2, 0.8, 0.6, 0.12, 0.18, -0.25, 0.35, 0.22, -0.15]
                    }
                };
                
                const config = multipleRegressionModels[model];
                if (!config) {
                    throw new Error(`Unknown multiple regression model: ${model}`);
                }
                
                // Get appropriate predictors based on complexity
                let predictors = config.predictors.basic;
                if (complexity === 'standard') predictors = config.predictors.standard;
                else if (complexity === 'comprehensive') predictors = config.predictors.comprehensive;
                else if (complexity === 'interaction') {
                    predictors = config.predictors.standard;
                    predictors.push('Age√óSex', 'BMI√óSmoking'); // Add interaction terms
                }
                else if (complexity === 'polynomial') {
                    predictors = config.predictors.standard;
                    predictors.push('Age¬≤', 'BP¬≤'); // Add polynomial terms
                }
                
                console.log('‚öôÔ∏è Using predictors:', predictors);
                
                // Apply population adjustments
                let populationMultipliers = { risk: 1.0, variance: 1.0 };
                
                if (population === 'indigenous') {
                    populationMultipliers = { risk: 1.25, variance: 1.4 }; // Higher risk, more variation
                } else if (population === 'immigrant') {
                    populationMultipliers = { risk: 0.85, variance: 1.6 }; // Lower average risk but more heterogeneous
                } else if (population === 'rural') {
                    populationMultipliers = { risk: 1.15, variance: 1.3 }; // Slightly higher risk
                } else if (population === 'elderly') {
                    populationMultipliers = { risk: 2.1, variance: 1.8 }; // Much higher risk
                } else if (population === 'pediatric') {
                    populationMultipliers = { risk: 0.3, variance: 2.2 }; // Lower baseline, high variation
                }
                
                // Generate realistic multiple regression data
                console.log('üìà Generating multiple regression dataset...');
                
                const data = [];
                const outcomes = [];
                
                for (let i = 0; i < sampleSize; i++) {
                    const patientData = {};
                    let linearCombination = config.baseLine * populationMultipliers.risk;
                    
                    // Generate predictor values and calculate linear combination
                    predictors.forEach((predictor, idx) => {
                        let value;
                        const coef = config.coefficients[idx] || 1.0;
                        
                        // Generate realistic values based on predictor type
                        if (predictor.includes('Age')) value = 25 + Math.random() * 50;
                        else if (predictor.includes('Sex')) value = Math.random() > 0.5 ? 1 : 0;
                        else if (predictor.includes('BP')) value = 110 + Math.random() * 40;
                        else if (predictor.includes('BMI')) value = 20 + Math.random() * 15;
                        else if (predictor.includes('Weight')) value = 15 + Math.random() * 40; // Pediatric
                        else if (predictor.includes('Creatinine')) value = 60 + Math.random() * 80;
                        else if (predictor.includes('Cholesterol')) value = 3.5 + Math.random() * 2.5;
                        else if (predictor.includes('HDL')) value = 0.9 + Math.random() * 0.8;
                        else if (predictor.includes('Smoking') || predictor.includes('Diabetes') || predictor.includes('Hypertension')) value = Math.random() > 0.7 ? 1 : 0;
                        else if (predictor.includes('Family History')) value = Math.random() > 0.6 ? 1 : 0;
                        else if (predictor.includes('Physical Activity')) value = Math.random() * 10;
                        else if (predictor.includes('Education')) value = 8 + Math.random() * 12;
                        else if (predictor.includes('Income')) value = 30 + Math.random() * 100;
                        else if (predictor.includes('Waist')) value = 70 + Math.random() * 30;
                        else if (predictor.includes('Ejection Fraction')) value = 35 + Math.random() * 30;
                        else if (predictor.includes('NYHA')) value = 1 + Math.floor(Math.random() * 4);
                        else if (predictor.includes('√ó')) { // Interaction terms
                            const terms = predictor.split('√ó');
                            value = (patientData[terms[0]] || 0) * (patientData[terms[1]] || 0);
                        }
                        else if (predictor.includes('¬≤')) { // Polynomial terms
                            const baseVar = predictor.replace('¬≤', '');
                            value = Math.pow(patientData[baseVar] || 0, 2);
                        }
                        else value = Math.random() * 10; // Generic predictor
                        
                        patientData[predictor] = value;
                        linearCombination += coef * value;
                    });
                    
                    // Add population-adjusted noise
                    const noise = generateNormalData(1, 0, 5 * populationMultipliers.variance)[0];
                    const outcome = Math.max(0, Math.min(100, linearCombination + noise));
                    
                    data.push(patientData);
                    outcomes.push(outcome);
                }
                
                console.log('‚úÖ Multiple regression data generated:', { patients: data.length, predictors: predictors.length });
                
                // Calculate multiple regression statistics
                const stats = calculateMultipleRegressionStats(data, outcomes, predictors, config.coefficients);
                
                console.log('üìä Multiple regression statistics calculated:', { rSquared: stats.rSquared.toFixed(3), adjustedR2: stats.adjustedR2.toFixed(3) });
                
                // Perform validation
                const validationResults = performValidation(data, outcomes, predictors, validation, sampleSize);
                
                console.log('‚úÖ Validation completed:', { method: validation, performance: validationResults.performance });
                
                // Display results based on output level
                displayMultipleRegressionResults(config, predictors, stats, validationResults, population, outputLevel);
                
                // Create multiple regression visualizations
                createMultipleRegressionChart(data, outcomes, predictors, stats, config);
                
                console.log('üéâ Advanced multiple regression modeling completed successfully!');
                
            } catch (error) {
                console.error('‚ùå Error in buildAdvancedMultipleRegression:', error);
                
                // Display user-friendly error message
                const resultsDiv = document.getElementById('multiple-regression-results');
                if (resultsDiv) {
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: #dc143c; border: 2px solid #dc143c; border-radius: 8px;">
                            <h4>‚ö†Ô∏è Multiple Regression Error</h4>
                            <p>Unable to complete multiple regression modeling.</p>
                            <p><strong>Error details:</strong> ${error.message}</p>
                            <button onclick="buildAdvancedMultipleRegression()" style="margin: 10px;">üîÑ Try Again</button>
                            <button onclick="location.reload()" style="margin: 10px;">üåê Refresh Page</button>
                        </div>
                    `;
                }
            }
        }

        function calculateMultipleRegressionStats(data, outcomes, predictors, trueCoefficients) {
            const n = data.length;
            const p = predictors.length;
            
            // Create design matrix X and outcome vector y
            const X = [];
            const y = outcomes;
            
            // Add intercept column and predictor columns
            for (let i = 0; i < n; i++) {
                const row = [1]; // Intercept
                predictors.forEach(predictor => {
                    row.push(data[i][predictor] || 0);
                });
                X.push(row);
            }
            
            // Calculate means
            const yMean = y.reduce((sum, val) => sum + val, 0) / n;
            const predictorMeans = predictors.map(predictor => 
                data.reduce((sum, row) => sum + (row[predictor] || 0), 0) / n
            );
            
            // Calculate sum of squares
            const totalSS = y.reduce((sum, val) => sum + Math.pow(val - yMean, 2), 0);
            
            // Simple approximation for multiple regression coefficients
            // (In practice, would use matrix operations: (X'X)^-1 X'y)
            const coefficients = [yMean - predictorMeans.reduce((sum, mean, idx) => sum + (trueCoefficients[idx] || 1) * mean, 0)];
            coefficients.push(...predictors.map((_, idx) => (trueCoefficients[idx] || 1) + (Math.random() - 0.5) * 0.2));
            
            // Calculate predicted values and residuals
            const predicted = [];
            const residuals = [];
            
            for (let i = 0; i < n; i++) {
                let pred = coefficients[0]; // Intercept
                predictors.forEach((predictor, idx) => {
                    pred += coefficients[idx + 1] * (data[i][predictor] || 0);
                });
                predicted.push(pred);
                residuals.push(y[i] - pred);
            }
            
            // Calculate R-squared and adjusted R-squared
            const residualSS = residuals.reduce((sum, res) => sum + res * res, 0);
            const rSquared = 1 - (residualSS / totalSS);
            const adjustedR2 = 1 - ((1 - rSquared) * (n - 1)) / (n - p - 1);
            
            // Calculate standard errors and t-statistics
            const mse = residualSS / (n - p - 1);
            const rmse = Math.sqrt(mse);
            
            // Calculate F-statistic for overall model significance
            const modelSS = totalSS - residualSS;
            const fStatistic = (modelSS / p) / (residualSS / (n - p - 1));
            const pValueOverall = fStatistic > 2.5 ? 0.001 : 0.08; // Simplified
            
            return {
                coefficients,
                rSquared,
                adjustedR2,
                rmse,
                fStatistic,
                pValueOverall,
                predicted,
                residuals,
                n,
                p
            };
        }

        function performValidation(data, outcomes, predictors, validationMethod, sampleSize) {
            let validationPerformance = {};
            
            if (validationMethod === 'train-test') {
                const trainSize = Math.floor(sampleSize * 0.7);
                validationPerformance = {
                    method: '70-30 Train-Test Split',
                    trainR2: 0.68 + Math.random() * 0.15,
                    testR2: 0.62 + Math.random() * 0.12,
                    rmse: 8.5 + Math.random() * 3.0,
                    notes: 'Model shows good generalization with minimal overfitting'
                };
            } else if (validationMethod === 'cross-validation') {
                validationPerformance = {
                    method: '10-Fold Cross-Validation',
                    meanR2: 0.65 + Math.random() * 0.10,
                    stdR2: 0.08 + Math.random() * 0.04,
                    rmse: 8.8 + Math.random() * 2.5,
                    notes: 'Stable performance across folds indicates robust model'
                };
            } else if (validationMethod === 'bootstrap') {
                validationPerformance = {
                    method: 'Bootstrap Validation (1000 samples)',
                    optimismCorrectedR2: 0.63 + Math.random() * 0.12,
                    optimism: 0.05 + Math.random() * 0.03,
                    rmse: 9.1 + Math.random() * 2.8,
                    notes: 'Bootstrap optimism correction provides unbiased performance estimate'
                };
            } else { // external
                validationPerformance = {
                    method: 'External Validation Dataset',
                    externalR2: 0.58 + Math.random() * 0.15,
                    calibration: 0.92 + Math.random() * 0.06,
                    discrimination: 0.74 + Math.random() * 0.08,
                    notes: 'Model performs well on independent dataset from different centers'
                };
            }
            
            return {
                performance: validationPerformance,
                healthCanadaCompliance: validationPerformance.method.includes('External') ? 'High' : 'Medium',
                recommendation: validationPerformance.method.includes('External') ? 'Suitable for regulatory submission' : 'Additional external validation recommended'
            };
        }
        
        function displayMultipleRegressionResults(config, predictors, stats, validationResults, population, outputLevel) {
            const resultsDiv = document.getElementById('multiple-regression-results');
            resultsDiv.style.display = 'block';
            
            const populationText = {
                'general': 'General Canadian Population',
                'indigenous': 'Indigenous Communities',
                'immigrant': 'Recent Immigrant Populations',
                'rural': 'Rural and Remote Areas',
                'elderly': 'Elderly Population (65+ years)',
                'pediatric': 'Pediatric Population (Specialized Dosing)'
            }[population];
            
            let html = `
                <h4>üî¢ ${config.name}</h4>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0;">
                    <h5>üéØ Model Specification</h5>
                    <p><strong>Clinical Application:</strong> ${config.context}</p>
                    <p><strong>Target Population:</strong> ${populationText}</p>
                    <p><strong>Outcome Variable:</strong> ${config.outcome}</p>
                    <p><strong>Sample Size:</strong> ${stats.n} patients</p>
                    <p><strong>Number of Predictors:</strong> ${stats.p} variables</p>
                </div>
            `;
            
            if (outputLevel === 'clinical') {
                html += `
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin: 15px 0;">
                        <h5>üìä Clinical Performance Summary</h5>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h6>Model Fit (R¬≤)</h6>
                                <span class="stat-value">${(stats.rSquared * 100).toFixed(1)}%</span>
                            </div>
                            <div class="stat-card">
                                <h6>Prediction Error</h6>
                                <span class="stat-value">¬±${stats.rmse.toFixed(1)}</span>
                            </div>
                            <div class="stat-card">
                                <h6>Model Significance</h6>
                                <span class="stat-value">${stats.pValueOverall < 0.05 ? 'Yes' : 'No'}</span>
                            </div>
                            <div class="stat-card">
                                <h6>Validation Method</h6>
                                <span class="stat-value">${validationResults.performance.method.split(' ')[0]}</span>
                            </div>
                        </div>
                        <p><strong>Clinical Interpretation:</strong> This model explains ${(stats.rSquared * 100).toFixed(1)}% of the variation in ${config.outcome.toLowerCase()}. 
                        ${stats.rSquared >= 0.7 ? 'Excellent predictive capability suitable for clinical decision support.' : 
                          stats.rSquared >= 0.5 ? 'Good predictive capability useful for risk stratification.' : 
                          'Moderate predictive capability - consider additional predictors or alternative modeling approaches.'}</p>
                    </div>
                `;
            } else if (outputLevel === 'detailed') {
                html += `
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin: 15px 0;">
                        <h5>üìà Detailed Statistical Results</h5>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h6>R-squared</h6>
                                <span class="stat-value">${(stats.rSquared * 100).toFixed(2)}%</span>
                            </div>
                            <div class="stat-card">
                                <h6>Adjusted R¬≤</h6>
                                <span class="stat-value">${(stats.adjustedR2 * 100).toFixed(2)}%</span>
                            </div>
                            <div class="stat-card">
                                <h6>RMSE</h6>
                                <span class="stat-value">${stats.rmse.toFixed(3)}</span>
                            </div>
                            <div class="stat-card">
                                <h6>F-statistic</h6>
                                <span class="stat-value">${stats.fStatistic.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <h6>Model Coefficients:</h6>
                        <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Predictor</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Coefficient</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Interpretation</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;"><strong>Intercept</strong></td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${stats.coefficients[0].toFixed(3)}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">Baseline ${config.outcome.toLowerCase()}</td>
                                </tr>
                `;
                
                predictors.forEach((predictor, idx) => {
                    const coef = stats.coefficients[idx + 1];
                    const interpretation = Math.abs(coef) > 1 ? 'Strong predictor' : Math.abs(coef) > 0.1 ? 'Moderate predictor' : 'Weak predictor';
                    html += `
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px;">${predictor}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${coef.toFixed(3)}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${interpretation}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else { // regulatory
                html += `
                    <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 15px 0;">
                        <h5>‚öñÔ∏è Regulatory Submission Package</h5>
                        <p><strong>Health Canada Classification:</strong> ${stats.rSquared >= 0.6 && validationResults.healthCanadaCompliance === 'High' ? 'Class II Medical Device - Ready for submission' : 'Requires additional validation'}</p>
                        <p><strong>Validation Status:</strong> ${validationResults.healthCanadaCompliance}</p>
                        <p><strong>Recommendation:</strong> ${validationResults.recommendation}</p>
                        
                        <h6>Required Documentation:</h6>
                        <ul>
                            <li>‚úÖ Statistical Analysis Plan</li>
                            <li>‚úÖ Model Development Dataset</li>
                            <li>${validationResults.performance.method.includes('External') ? '‚úÖ' : '‚ö†Ô∏è'} External Validation Study</li>
                            <li>‚úÖ Clinical Utility Assessment</li>
                            <li>‚úÖ Risk-Benefit Analysis</li>
                            <li>${stats.rSquared >= 0.6 ? '‚úÖ' : '‚ö†Ô∏è'} Performance Specifications Met</li>
                        </ul>
                        
                        <h6>Performance Metrics for Regulatory Review:</h6>
                        <p>‚Ä¢ <strong>Discrimination:</strong> R¬≤ = ${(stats.rSquared * 100).toFixed(1)}% (Target: ‚â•60%)</p>
                        <p>‚Ä¢ <strong>Calibration:</strong> ${validationResults.performance.calibration ? (validationResults.performance.calibration * 100).toFixed(1) + '% slope' : 'RMSE = ' + stats.rmse.toFixed(1)}</p>
                        <p>‚Ä¢ <strong>Clinical Utility:</strong> ${stats.rSquared >= 0.6 ? 'Demonstrated improvement over standard care' : 'Requires clinical utility studies'}</p>
                    </div>
                `;
            }
            
            // Validation Results
            html += `
                <div style="background: #e0f2f1; padding: 20px; border-radius: 8px; margin: 15px 0;">
                    <h5>‚úÖ Validation Results</h5>
                    <p><strong>Method:</strong> ${validationResults.performance.method}</p>
                    <p><strong>Performance:</strong> 
            `;
            
            if (validationResults.performance.trainR2) {
                html += `Training R¬≤ = ${(validationResults.performance.trainR2 * 100).toFixed(1)}%, Testing R¬≤ = ${(validationResults.performance.testR2 * 100).toFixed(1)}%`;
            } else if (validationResults.performance.meanR2) {
                html += `Mean R¬≤ = ${(validationResults.performance.meanR2 * 100).toFixed(1)}% ¬± ${(validationResults.performance.stdR2 * 100).toFixed(1)}%`;
            } else if (validationResults.performance.optimismCorrectedR2) {
                html += `Optimism-corrected R¬≤ = ${(validationResults.performance.optimismCorrectedR2 * 100).toFixed(1)}%`;
            } else {
                html += `External R¬≤ = ${(validationResults.performance.externalR2 * 100).toFixed(1)}%`;
            }
            
            html += `</p>
                    <p><strong>Notes:</strong> ${validationResults.performance.notes}</p>
                </div>
            `;
            
            // Predictors List
            html += `
                <div style="background: #f3e5f5; padding: 20px; border-radius: 8px; margin: 15px 0;">
                    <h5>üìã Model Predictors</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                        ${predictors.map((predictor, idx) => {
                            const coef = stats.coefficients[idx + 1];
                            const importance = Math.abs(coef) > 1 ? 'High' : Math.abs(coef) > 0.1 ? 'Medium' : 'Low';
                            const color = importance === 'High' ? '#dc3545' : importance === 'Medium' ? '#fd7e14' : '#6c757d';
                            return `
                                <div style="background: white; padding: 10px; border-radius: 4px; border-left: 3px solid ${color};">
                                    <strong>${predictor}</strong><br>
                                    <small>Coefficient: ${coef.toFixed(3)} | Importance: ${importance}</small>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        function createMultipleRegressionChart(data, outcomes, predictors, stats, config) {
            console.log('üìä Creating multiple regression visualization...');
            
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('‚ùå Chart.js is not loaded');
                showMultipleRegressionChartError('Chart.js library is not loaded. Please refresh the page.');
                return;
            }
            
            const canvasElement = document.getElementById('multiple-regression-chart');
            if (!canvasElement) {
                console.error('‚ùå Multiple regression canvas element not found');
                showMultipleRegressionChartError('Chart canvas element not found.');
                return;
            }
            
            const ctx = canvasElement.getContext('2d');
            if (!ctx) {
                console.error('‚ùå Could not get 2D context');
                showMultipleRegressionChartError('Could not get canvas 2D context.');
                return;
            }
            
            console.log('‚úÖ Multiple regression canvas context acquired');
            
            // Destroy existing chart
            if (charts.multipleRegression) {
                console.log('üóëÔ∏è Destroying existing multiple regression chart');
                charts.multipleRegression.destroy();
                delete charts.multipleRegression;
            }
            
            // Create predicted vs actual scatter plot
            const scatterData = [];
            for (let i = 0; i < outcomes.length; i++) {
                scatterData.push({ 
                    x: stats.predicted[i], 
                    y: outcomes[i] 
                });
            }
            
            // Color code by prediction accuracy
            let pointColor, borderColor;
            if (stats.rSquared >= 0.7) {
                pointColor = 'rgba(34, 139, 34, 0.7)';  // Excellent: Green
                borderColor = 'rgba(34, 139, 34, 1)';
            } else if (stats.rSquared >= 0.5) {
                pointColor = 'rgba(255, 140, 0, 0.7)';  // Good: Orange
                borderColor = 'rgba(255, 140, 0, 1)';
            } else {
                pointColor = 'rgba(220, 20, 60, 0.7)';  // Poor: Red
                borderColor = 'rgba(220, 20, 60, 1)';
            }
            
            // Create perfect prediction line
            const minVal = Math.min(...stats.predicted, ...outcomes);
            const maxVal = Math.max(...stats.predicted, ...outcomes);
            const perfectLine = [
                { x: minVal, y: minVal },
                { x: maxVal, y: maxVal }
            ];
            
            console.log('‚úÖ Multiple regression chart data prepared:', scatterData.length, 'points');
            
            // Create chart configuration
            const chartConfig = {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Predicted vs Actual',
                        data: scatterData,
                        backgroundColor: pointColor,
                        borderColor: borderColor,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBorderWidth: 1
                    }, {
                        label: 'Perfect Prediction (y = x)',
                        data: perfectLine,
                        type: 'line',
                        borderColor: '#2c3e50',
                        backgroundColor: 'transparent',
                        pointRadius: 0,
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${config.name} | R¬≤ = ${(stats.rSquared * 100).toFixed(1)}%`,
                            font: { size: 16, weight: 'bold' },
                            color: '#2c3e50',
                            padding: 20
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: `Predicted ${config.outcome}`,
                                font: { size: 14, weight: 'bold' },
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                borderColor: '#2c3e50',
                                borderWidth: 2
                            }
                        },
                        y: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: `Actual ${config.outcome}`,
                                font: { size: 14, weight: 'bold' },
                                color: '#2c3e50'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                borderColor: '#2c3e50',
                                borderWidth: 2
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'point'
                    }
                }
            };
            
            try {
                console.log('üé® Creating multiple regression Chart.js instance...');
                
                // Create the chart
                charts.multipleRegression = new Chart(ctx, chartConfig);
                
                console.log('üéâ Multiple regression chart created successfully!');
                
                // Force chart container visibility
                const chartContainer = canvasElement.parentElement;
                if (chartContainer) {
                    chartContainer.style.display = 'block';
                    chartContainer.style.visibility = 'visible';
                    chartContainer.style.height = '450px';
                    canvasElement.style.display = 'block';
                    canvasElement.style.visibility = 'visible';
                    canvasElement.style.width = '100%';
                    canvasElement.style.height = '400px';
                    console.log('‚úÖ Multiple regression chart container forced visible');
                }
                
                // Force update
                setTimeout(() => {
                    if (charts.multipleRegression) {
                        charts.multipleRegression.resize();
                        charts.multipleRegression.update('active');
                        console.log('üîÑ Multiple regression chart updated and resized');
                    }
                }, 200);
                
            } catch (error) {
                console.error('‚ùå Multiple regression chart creation failed:', error);
                showMultipleRegressionChartError(`Chart creation error: ${error.message}`);
            }
        }
        
        function showMultipleRegressionChartError(message) {
            const chartContainer = document.querySelector('#multiple-regression-chart').parentElement;
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 400px; border: 2px dashed #dc143c; border-radius: 8px; background: #fff5f5;">
                        <div style="text-align: center; color: #dc143c; padding: 20px;">
                            <h3 style="margin: 0 0 10px 0;">‚ö†Ô∏è Multiple Regression Chart Error</h3>
                            <p style="margin: 0 0 15px 0;">${message}</p>
                            <button onclick="buildAdvancedMultipleRegression()" style="background: #dc143c; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                                üîÑ Try Again
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function exploreCaseStudy() {
            const caseStudy = document.getElementById('case-study').value;
            document.getElementById('clinical-results').style.display = 'block';
            
            const caseStudies = {
                'ontario-diabetes': {
                    title: 'Ontario Diabetes Risk Calculator (CANRISK)',
                    description: 'Population-based risk prediction model for Type 2 diabetes in Ontario.',
                    methods: 'Logistic regression with 8 risk factors, validated on 100,000+ patients',
                    results: 'AUC = 0.78, well-calibrated across diverse populations'
                },
                'alberta-cvd': {
                    title: 'Alberta Cardiovascular Risk Assessment',
                    description: 'Framingham-based model adapted for Alberta population demographics.',
                    methods: 'Cox proportional hazards modeling, 10-year follow-up',
                    results: 'C-statistic = 0.74, improved risk classification over global models'
                },
                'bc-cancer': {
                    title: 'BC Cancer Treatment Response Prediction',
                    description: 'Biomarker-based prediction of chemotherapy response in breast cancer.',
                    methods: 'Multiple logistic regression with genomic and clinical variables',
                    results: 'Sensitivity = 85%, Specificity = 72%, guides treatment selection'
                }
            };
            
            const study = caseStudies[caseStudy];
            if (study) {
                document.getElementById('clinical-results').innerHTML = `
                    <h4>üçÅ ${study.title}</h4>
                    <p><strong>Description:</strong> ${study.description}</p>
                    <p><strong>Methods:</strong> ${study.methods}</p>
                    <p><strong>Results:</strong> ${study.results}</p>
                    <div style="background: #e8f4fd; padding: 15px; border-radius: 6px; margin-top: 15px;">
                        <h5>Key Learning Points</h5>
                        <ul>
                            <li>Population-specific validation improves model performance</li>
                            <li>Regular model recalibration ensures continued accuracy</li>
                            <li>Integration with clinical workflows enhances adoption</li>
                            <li>Regulatory approval requires comprehensive documentation</li>
                        </ul>
                    </div>
                `;
            }
        }

        // Assessment functions
        function generateAssessment() {
            const questionType = document.getElementById('question-type').value;
            const difficulty = document.getElementById('question-difficulty').value;
            const count = parseInt(document.getElementById('question-count').value);
            
            currentQuestions = [];
            userAnswers = {};
            
            console.log(`üéØ Generating ${count} questions of type: ${questionType}, difficulty: ${difficulty}`);
            
            // Verify which question generation functions exist
            console.log('üîç Function availability check:', {
                generateCorrelationQuestion: typeof generateCorrelationQuestion,
                generateRegressionQuestion: typeof generateRegressionQuestion,
                generateClinicalQuestion: typeof generateClinicalQuestion,
                generateAssumptionQuestion: typeof generateAssumptionQuestion
            });
            
            // Generate questions based on type and difficulty
            for (let i = 0; i < count; i++) {
                try {
                    let question;
                    
                    console.log(`üìù Generating question ${i + 1} for type: ${questionType}`);
                    
                    if (questionType === 'mixed') {
                        // For mixed, randomly select from all types
                        const types = ['correlation', 'regression', 'clinical', 'assumptions'];
                        const randomType = types[Math.floor(Math.random() * types.length)];
                        console.log(`üé≤ Mixed mode: selected ${randomType} for question ${i + 1}`);
                        
                        if (randomType === 'correlation') {
                            question = generateCorrelationQuestion(difficulty, i);
                        } else if (randomType === 'regression') {
                            question = generateRegressionQuestion(difficulty, i);
                        } else if (randomType === 'clinical') {
                            question = generateClinicalQuestion(difficulty, i);
                        } else {
                            question = generateAssumptionQuestion(difficulty, i);
                        }
                    } else {
                        // Generate specific type
                        console.log(`üìã Specific mode: generating ${questionType} question`);
                        
                        if (questionType === 'correlation') {
                            question = generateCorrelationQuestion(difficulty, i);
                        } else if (questionType === 'regression') {
                            console.log('üîÑ Calling generateRegressionQuestion...');
                            question = generateRegressionQuestion(difficulty, i);
                            console.log('‚úÖ generateRegressionQuestion returned:', question ? 'SUCCESS' : 'FAILED');
                        } else if (questionType === 'clinical') {
                            console.log('üè• Calling generateClinicalQuestion...');
                            question = generateClinicalQuestion(difficulty, i);
                            console.log('‚úÖ generateClinicalQuestion returned:', question ? 'SUCCESS' : 'FAILED');
                        } else if (questionType === 'assumptions') {
                            console.log('‚ö†Ô∏è Calling generateAssumptionQuestion...');
                            question = generateAssumptionQuestion(difficulty, i);
                            console.log('‚úÖ generateAssumptionQuestion returned:', question ? 'SUCCESS' : 'FAILED');
                        } else {
                            console.error(`‚ùå Unknown question type: ${questionType}`);
                        }
                    }
                    
                    if (question) {
                        currentQuestions.push(question);
                        console.log(`‚úÖ Generated question ${i + 1}:`, {
                            type: questionType,
                            questionPreview: question.question.substring(0, 80) + '...',
                            hasOptions: question.options ? question.options.length : 'N/A',
                            hasExplanation: !!question.explanation
                        });
                    } else {
                        console.error(`‚ùå Question ${i + 1} generation failed - returned null/undefined`);
                    }
                } catch (error) {
                    console.error(`‚ùå Error generating question ${i + 1}:`, error);
                    console.error('Stack trace:', error.stack);
                }
            }
            
            console.log(`üéâ Successfully generated ${currentQuestions.length} questions`);
            console.log('üìä Question breakdown by actual content:');
            
            // Analyze what types of questions were actually generated
            const questionAnalysis = currentQuestions.map((q, idx) => {
                let detectedType = 'unknown';
                const questionText = q.question.toLowerCase();
                
                if (questionText.includes('pearson') || questionText.includes('spearman') || questionText.includes('partial') || questionText.includes('correlation')) {
                    detectedType = 'correlation';
                } else if (questionText.includes('regression') || questionText.includes('equation') || questionText.includes('dose') || questionText.includes('r¬≤') || questionText.includes('r-squared')) {
                    detectedType = 'regression';
                } else if (questionText.includes('canadian') || questionText.includes('clinical') || questionText.includes('health canada') || questionText.includes('indigenous')) {
                    detectedType = 'clinical';
                } else if (questionText.includes('assumption') || questionText.includes('linearity') || questionText.includes('residual') || questionText.includes('normality')) {
                    detectedType = 'assumptions';
                }
                
                return { index: idx + 1, requestedType: questionType, detectedType, preview: q.question.substring(0, 50) };
            });
            
            questionAnalysis.forEach(analysis => {
                console.log(`Question ${analysis.index}: Requested=${analysis.requestedType}, Detected=${analysis.detectedType}, Preview="${analysis.preview}..."`);
            });
            
            displayAssessment();
        }

        function generateCorrelationQuestion(difficulty, index) {
            // Ensure better distribution - cycle through all question types
            const questionTypes = ['pearson', 'spearman', 'partial', 'method-selection', 'interpretation'];
            const questionType = questionTypes[index % questionTypes.length];
            
            console.log(`Generating correlation question ${index + 1}: ${questionType} (difficulty: ${difficulty})`);
            
            if (questionType === 'pearson') {
                const correlations = [0.12, 0.34, 0.67, 0.89, -0.23, -0.56, -0.78];
                const r = correlations[Math.floor(Math.random() * correlations.length)];
                
                if (difficulty === 'basic') {
                    return {
                        id: index,
                        type: 'multiple-choice',
                        question: `A Pearson correlation coefficient of r = ${r} indicates:`,
                        options: [
                            `Strong ${r > 0 ? 'positive' : 'negative'} relationship`,
                            `Moderate ${r > 0 ? 'positive' : 'negative'} relationship`,
                            `Weak ${r > 0 ? 'positive' : 'negative'} relationship`,
                            'No relationship'
                        ],
                        correct: Math.abs(r) >= 0.7 ? 0 : Math.abs(r) >= 0.3 ? 1 : Math.abs(r) >= 0.1 ? 2 : 3,
                        explanation: `r = ${r} indicates a ${getCorrelationStrength(Math.abs(r)).toLowerCase()} ${r > 0 ? 'positive' : 'negative'} relationship. Pearson correlation measures linear relationships in normally distributed data.`
                    };
                } else {
                    const n = 50 + Math.floor(Math.random() * 200);
                    const pValue = Math.abs(r) * Math.sqrt((n-2)/(1-r*r)) > 2 ? 0.03 : 0.12;
                    
                    return {
                        id: index,
                        type: 'multiple-choice',
                        question: `In a study of ${n} patients, Pearson r = ${r} with p = ${pValue.toFixed(3)}. What can you conclude?`,
                        options: [
                            'Statistically significant and clinically meaningful',
                            'Statistically significant but not clinically meaningful',
                            'Not statistically significant but clinically meaningful',
                            'Neither statistically nor clinically significant'
                        ],
                        correct: pValue < 0.05 ? (Math.abs(r) >= 0.3 ? 0 : 1) : (Math.abs(r) >= 0.3 ? 2 : 3),
                        explanation: `With p = ${pValue.toFixed(3)}, the result is ${pValue < 0.05 ? '' : 'not '}statistically significant. Clinical significance depends on effect size (r¬≤ = ${(r*r*100).toFixed(1)}%).`
                    };
                }
            } else if (questionType === 'spearman') {
                const scenarios = [
                    { context: 'pain scores (0-10 ordinal scale) and quality of life ratings', method: 'Spearman' },
                    { context: 'patient satisfaction rankings and treatment adherence', method: 'Spearman' },
                    { context: 'disease severity stages (mild/moderate/severe) and biomarker levels', method: 'Spearman' },
                    { context: 'education level categories and health literacy scores', method: 'Spearman' }
                ];
                const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
                
                return {
                    id: index,
                    type: 'multiple-choice',
                    question: `When analyzing the relationship between ${scenario.context}, which correlation method is most appropriate?`,
                    options: [
                        'Pearson correlation (assumes normal distribution)',
                        'Spearman correlation (non-parametric, rank-based)',
                        'Partial correlation (controls for confounders)',
                        'All methods are equally appropriate'
                    ],
                    correct: 1,
                    explanation: 'Spearman correlation is most appropriate for ordinal data, non-normal distributions, or when the relationship may be monotonic but not necessarily linear. It ranks the data before calculating correlation.'
                };
            } else if (questionType === 'partial') {
                const confounders = ['age', 'sex', 'BMI', 'smoking status', 'comorbidity burden'];
                const confounder = confounders[Math.floor(Math.random() * confounders.length)];
                
                return {
                    id: index,
                    type: 'multiple-choice',
                    question: `You find r = 0.6 between exercise duration and blood pressure. After controlling for ${confounder} using partial correlation, r = 0.2. This suggests:`,
                    options: [
                        `The relationship is entirely explained by ${confounder}`,
                        `${confounder} is a significant confounder that was masking the true relationship`,
                        `${confounder} partially explains the relationship between exercise and blood pressure`,
                        'The original correlation was calculated incorrectly'
                    ],
                    correct: 2,
                    explanation: `The drop from r = 0.6 to r = 0.2 indicates that ${confounder} accounts for much of the original correlation, but a moderate relationship (r = 0.2) remains after controlling for this confounder.`
                };
            } else if (questionType === 'method-selection') {
                const dataTypes = [
                    { data: 'right-skewed biomarker concentrations', correct: 'Spearman', reason: 'non-parametric method for non-normal data' },
                    { data: 'normally distributed continuous variables', correct: 'Pearson', reason: 'appropriate for linear relationships in normal data' },
                    { data: 'ordinal pain scale ratings', correct: 'Spearman', reason: 'rank-based method for ordinal data' },
                    { data: 'age-adjusted analysis of drug efficacy', correct: 'Partial', reason: 'controls for the confounding effect of age' }
                ];
                const scenario = dataTypes[Math.floor(Math.random() * dataTypes.length)];
                
                return {
                    id: index,
                    type: 'multiple-choice',
                    question: `For analyzing ${scenario.data}, which correlation method is most appropriate?`,
                    options: [
                        'Pearson correlation',
                        'Spearman correlation', 
                        'Partial correlation',
                        'Any correlation method'
                    ],
                    correct: scenario.correct === 'Pearson' ? 0 : scenario.correct === 'Spearman' ? 1 : 2,
                    explanation: `${scenario.correct} correlation is most appropriate because it is the ${scenario.reason}.`
                };
            } else { // interpretation
                const rho = (Math.random() * 1.6 - 0.8); // -0.8 to 0.8
                
                return {
                    id: index,
                    type: 'multiple-choice',
                    question: `A Spearman correlation of œÅ = ${rho.toFixed(3)} between treatment adherence ranks and health outcome ranks indicates:`,
                    options: [
                        'A causal relationship between adherence and outcomes',
                        'Better adherence is associated with better health ranks',
                        'The relationship is definitely linear',
                        'Adherence causes improved health outcomes'
                    ],
                    correct: 1,
                    explanation: `Spearman correlation measures monotonic relationships between ranks. œÅ = ${rho.toFixed(3)} indicates ${rho > 0 ? 'better' : 'worse'} adherence ranks are associated with ${rho > 0 ? 'better' : 'worse'} outcome ranks, but correlation does not imply causation.`
                };
            }
        }

        function generateRegressionQuestion(difficulty, index) {
            const questionTypes = ['equation', 'interpretation', 'assumptions', 'multiple-regression'];
            const questionType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
            
            if (questionType === 'equation') {
                if (difficulty === 'basic') {
                    const slope = 2.5;
                    const intercept = 10;
                    const weight = 70;
                    
                    return {
                        id: index,
                        type: 'numeric',
                        question: `A drug dosing equation is: Dose (mg) = ${intercept} + ${slope} √ó Weight (kg). What dose should be given to a ${weight} kg patient?`,
                        answer: intercept + slope * weight,
                        tolerance: 1,
                        explanation: `Dose = ${intercept} + ${slope} √ó ${weight} = ${intercept + slope * weight} mg`
                    };
                } else {
                    const contexts = [
                        { equation: 'eGFR = 120 - 0.8 √ó Creatinine', x: 90, xUnit: 'Œºmol/L', yUnit: 'mL/min/1.73m¬≤' },
                        { equation: 'HbA1c = 4.5 + 0.3 √ó Glucose', x: 8, xUnit: 'mmol/L', yUnit: '%' },
                        { equation: 'Clearance = 0.5 + 0.08 √ó Weight', x: 60, xUnit: 'kg', yUnit: 'L/hr/kg' }
                    ];
                    const context = contexts[Math.floor(Math.random() * contexts.length)];
                    const parts = context.equation.split('=')[1].trim().split(/\s*[\+\-]\s*/);
                    const intercept = parseFloat(parts[0]);
                    const slope = parseFloat(parts[1].split('√ó')[0]);
                    const result = intercept + slope * context.x;
                    
                    return {
                        id: index,
                        type: 'numeric',
                        question: `Using the equation ${context.equation}, what is the predicted value when the predictor = ${context.x} ${context.xUnit}?`,
                        answer: result,
                        tolerance: 0.5,
                        explanation: `Substituting: ${intercept} + ${slope} √ó ${context.x} = ${result.toFixed(1)} ${context.yUnit}`
                    };
                }
            } else if (questionType === 'interpretation') {
                const rSquared = [0.25, 0.49, 0.64, 0.81][Math.floor(Math.random() * 4)];
                
                return {
                    id: index,
                    type: 'multiple-choice',
                    question: `In a clinical prediction model, R¬≤ = ${rSquared}. This means:`,
                    options: [
                        `${rSquared * 100}% of patients will have the predicted outcome`,
                        `${rSquared * 100}% correlation between predictors and outcome`,
                        `${rSquared * 100}% of variance in the outcome is explained by the model`,
                        `${rSquared * 100}% accuracy in clinical predictions`
                    ],
                    correct: 2,
                    explanation: `R¬≤ represents the proportion of variance in the dependent variable explained by the independent variable(s). It indicates model fit, not prediction accuracy or correlation.`
                };
            } else if (questionType === 'assumptions') {
                const violations = [
                    { violation: 'Residuals show a curved pattern', assumption: 'Linearity', remedy: 'polynomial terms or transformation' },
                    { violation: 'Residual variance increases with fitted values', assumption: 'Homoscedasticity', remedy: 'weighted least squares or transformation' },
                    { violation: 'Residuals are not normally distributed', assumption: 'Normality', remedy: 'robust regression or bootstrap methods' },
                    { violation: 'High leverage points affect the regression line', assumption: 'Independence', remedy: 'robust regression or outlier removal' }
                ];
                const violation = violations[Math.floor(Math.random() * violations.length)];
                
                return {
                    id: index,
                    type: 'multiple-choice',
                    question: `In regression diagnostics, you observe: "${violation.violation}". This violates which assumption?`,
                    options: [
                        'Linearity',
                        'Independence', 
                        'Normality',
                        'Homoscedasticity (Equal variance)'
                    ],
                    correct: violation.assumption === 'Linearity' ? 0 : violation.assumption === 'Independence' ? 1 : violation.assumption === 'Normality' ? 2 : 3,
                    explanation: `This violates the ${violation.assumption} assumption. Consider using ${violation.remedy} to address this issue.`
                };
            } else { // multiple-regression
                const models = [
                    { model: 'CVD risk', predictors: 'age, blood pressure, cholesterol, smoking', performance: '74%' },
                    { model: 'Drug clearance', predictors: 'weight, age, creatinine, liver function', performance: '68%' },
                    { model: 'Diabetes risk', predictors: 'BMI, family history, glucose, age', performance: '71%' }
                ];
                const model = models[Math.floor(Math.random() * models.length)];
                
                return {
                    id: index,
                    type: 'multiple-choice',
                    question: `A multiple regression model for ${model.model} using ${model.predictors} achieves ${model.performance} accuracy in cross-validation. For Health Canada approval as a Class II medical device, what is most important?`,
                    options: [
                        'Increase the accuracy to >90%',
                        'Add more predictor variables',
                        'Validate on external, diverse populations',
                        'Reduce the number of predictors'
                    ],
                    correct: 2,
                    explanation: `Health Canada requires external validation on diverse populations to ensure the model generalizes beyond the original development cohort. Clinical utility and bias assessment are more important than maximizing accuracy.`
                };
            }
        }

        function generateClinicalQuestion(difficulty, index) {
            const clinicalScenarios = [
                {
                    scenario: 'A physician wants to analyze the relationship between patient education level and medication adherence in a diverse urban clinic',
                    question: 'Which correlation method is most appropriate?',
                    options: [
                        'Pearson correlation (assumes education is normally distributed)',
                        'Spearman correlation (handles ordinal education categories)',
                        'Partial correlation (controls for age and income)',
                        'Simple linear regression (predicts adherence)'
                    ],
                    correct: 2,
                    explanation: 'Partial correlation would be most appropriate to control for confounders like age and income that could affect both education level and medication adherence.'
                },
                {
                    scenario: 'A Canadian health study finds r = 0.4 between household income and health outcomes across provinces',
                    question: 'This correlation suggests:',
                    options: [
                        'Income directly causes better health outcomes',
                        'There is a moderate association that warrants policy attention',
                        'The relationship is too weak to be meaningful',
                        'Income should be the primary focus of health interventions'
                    ],
                    correct: 1,
                    explanation: 'A moderate correlation (r = 0.4) indicates a meaningful association between socioeconomic status and health, supporting the importance of addressing social determinants of health in Canadian healthcare policy.'
                },
                {
                    scenario: 'In analyzing pain scores (0-10) and quality of life ratings (poor/fair/good/excellent) in chronic pain patients',
                    question: 'The most appropriate statistical approach is:',
                    options: [
                        'Pearson correlation (both variables are continuous)',
                        'Spearman correlation (quality of life is ordinal)',
                        'Linear regression (to predict quality of life)',
                        't-test (to compare pain groups)'
                    ],
                    correct: 1,
                    explanation: 'Spearman correlation is appropriate when one or both variables are ordinal. Quality of life ratings are ordinal categories, making Spearman the best choice.'
                },
                {
                    scenario: 'A prediction model for surgical complications uses age, BMI, comorbidities, and surgical complexity',
                    question: 'For Health Canada medical device approval, the model must demonstrate:',
                    options: [
                        'Perfect accuracy in the training dataset',
                        'Validation across diverse Canadian populations',
                        'Superiority to physician clinical judgment',
                        'Integration with existing hospital systems'
                    ],
                    correct: 1,
                    explanation: 'Health Canada requires validation across diverse populations to ensure the model performs equitably across different demographic groups and healthcare settings in Canada.'
                },
                {
                    scenario: 'Indigenous communities show different correlations between traditional risk factors and diabetes compared to the general population',
                    question: 'This finding suggests:',
                    options: [
                        'The risk factors are invalid for Indigenous populations',
                        'Population-specific models may be needed',
                        'The original correlation was calculated incorrectly',
                        'Indigenous populations have genetic immunity to diabetes'
                    ],
                    correct: 1,
                    explanation: 'Population-specific variations in correlations suggest that predictive models may need to be adapted or recalibrated for different populations to ensure equitable healthcare delivery.'
                }
            ];
            
            const scenario = clinicalScenarios[Math.floor(Math.random() * clinicalScenarios.length)];
            
            return {
                id: index,
                type: 'multiple-choice',
                question: scenario.scenario + ' ' + scenario.question,
                options: scenario.options,
                correct: scenario.correct,
                explanation: scenario.explanation
            };
        }

        function generateAssumptionQuestion(difficulty, index) {
            const assumptionScenarios = [
                {
                    scenario: 'Residual plots show a fan-shaped pattern with increasing variance',
                    violation: 'Homoscedasticity',
                    remedy: 'weighted least squares or log transformation'
                },
                {
                    scenario: 'Q-Q plot of residuals shows heavy tails and skewness',
                    violation: 'Normality',
                    remedy: 'bootstrap methods or robust regression'
                },
                {
                    scenario: 'Residuals vs fitted plot shows a U-shaped curve',
                    violation: 'Linearity',
                    remedy: 'polynomial terms or spline regression'
                },
                {
                    scenario: 'Cook\'s distance identifies several highly influential observations',
                    violation: 'Outliers/Leverage',
                    remedy: 'robust regression or careful outlier assessment'
                }
            ];
            
            const scenario = assumptionScenarios[Math.floor(Math.random() * assumptionScenarios.length)];
            
            return {
                id: index,
                type: 'multiple-choice',
                question: `In regression diagnostics: ${scenario.scenario}. What does this indicate?`,
                options: [
                    'The model is perfectly valid',
                    `Violation of ${scenario.violation} - consider ${scenario.remedy}`,
                    'The sample size is too small',
                    'The wrong variables were selected'
                ],
                correct: 1,
                explanation: `${scenario.scenario.replace(/^./, scenario.scenario[0].toUpperCase())} indicates a violation of the ${scenario.violation} assumption. This can be addressed using ${scenario.remedy}.`
            };
        }

        function displayAssessment() {
            const resultsDiv = document.getElementById('assessment-results');
            resultsDiv.style.display = 'block';
            
            let html = '<h4>üìö Assessment Questions</h4>';
            
            currentQuestions.forEach((question, index) => {
                html += `<div class="question" id="question-${question.id}">`;
                html += `<h5>Question ${index + 1}</h5>`;
                html += `<p>${question.question}</p>`;
                
                if (question.type === 'multiple-choice') {
                    html += '<div class="question-options">';
                    question.options.forEach((option, optIndex) => {
                        html += `
                            <label>
                                <input type="radio" name="question-${question.id}" value="${optIndex}">
                                ${option}
                            </label>
                        `;
                    });
                    html += '</div>';
                } else if (question.type === 'numeric') {
                    html += `<input type="number" id="answer-${question.id}" step="0.1" placeholder="Enter your answer">`;
                }
                
                html += '</div>';
            });
            
            html += '<div style="text-align: center; margin: 20px 0;">';
            html += '<button onclick="checkAllAnswers()" id="check-answers-btn">üìù Check All Answers</button>';
            html += '</div>';
            
            resultsDiv.innerHTML = html;
        }
        
        function testAssessmentVariety() {
            console.log('üß™ Testing assessment question variety...');
            
            const resultsDiv = document.getElementById('sample-questions');
            resultsDiv.style.display = 'block';
            
            let html = '<h4>üß™ Assessment Question Variety Test</h4>';
            html += '<p>Generating 10 sample correlation questions to demonstrate variety:</p>';
            
            // Generate 10 sample questions to show variety
            for (let i = 0; i < 10; i++) {
                try {
                    const question = generateCorrelationQuestion('basic', i);
                    const questionTypes = ['pearson', 'spearman', 'partial', 'method-selection', 'interpretation'];
                    const expectedType = questionTypes[i % questionTypes.length];
                    
                    let questionTypeColor = '';
                    if (question.question.toLowerCase().includes('pearson')) {
                        questionTypeColor = '#dc3545'; // Red for Pearson
                    } else if (question.question.toLowerCase().includes('spearman')) {
                        questionTypeColor = '#28a745'; // Green for Spearman
                    } else if (question.question.toLowerCase().includes('partial')) {
                        questionTypeColor = '#007bff'; // Blue for Partial
                    } else if (question.question.toLowerCase().includes('method') || question.question.toLowerCase().includes('appropriate')) {
                        questionTypeColor = '#fd7e14'; // Orange for Method Selection
                    } else {
                        questionTypeColor = '#6f42c1'; // Purple for Interpretation
                    }
                    
                    html += `
                        <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid ${questionTypeColor};">
                            <h6>Question ${i + 1} (Expected: ${expectedType})</h6>
                            <p><strong>Q:</strong> ${question.question}</p>
                            <p><strong>Type detected:</strong> 
                                <span style="color: ${questionTypeColor}; font-weight: bold;">
                                    ${question.question.toLowerCase().includes('pearson') ? 'Pearson' : 
                                      question.question.toLowerCase().includes('spearman') ? 'Spearman' :
                                      question.question.toLowerCase().includes('partial') ? 'Partial' :
                                      question.question.toLowerCase().includes('method') || question.question.toLowerCase().includes('appropriate') ? 'Method Selection' :
                                      'Interpretation/Other'}
                                </span>
                            </p>
                        </div>
                    `;
                } catch (error) {
                    html += `
                        <div style="background: #f8d7da; padding: 15px; margin: 10px 0; border-radius: 8px;">
                            <h6>Question ${i + 1} - Error</h6>
                            <p>Error generating question: ${error.message}</p>
                        </div>
                    `;
                }
            }
            
            html += `
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h5>‚úÖ Question Distribution Summary</h5>
                    <p>The assessment now cycles through all correlation types:</p>
                    <ul>
                        <li><span style="color: #dc3545;">‚óè</span> <strong>Pearson</strong> - Questions 1, 6 (coefficient interpretation, significance testing)</li>
                        <li><span style="color: #28a745;">‚óè</span> <strong>Spearman</strong> - Questions 2, 7 (ordinal data, non-parametric methods)</li>
                        <li><span style="color: #007bff;">‚óè</span> <strong>Partial</strong> - Questions 3, 8 (controlling for confounders)</li>
                        <li><span style="color: #fd7e14;">‚óè</span> <strong>Method Selection</strong> - Questions 4, 9 (which correlation to use when)</li>
                        <li><span style="color: #6f42c1;">‚óè</span> <strong>Interpretation</strong> - Questions 5, 10 (understanding correlation meaning)</li>
                    </ul>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="document.getElementById('sample-questions').style.display='none'">‚úñÔ∏è Close Test</button>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }
        
        function debugQuestionGeneration() {
            console.log('üîß Starting question generation debug...');
            
            const resultsDiv = document.getElementById('sample-questions');
            resultsDiv.style.display = 'block';
            
            let html = '<h4>üîß Question Generation Debug Results</h4>';
            
            // Test each question generation function
            const testResults = [];
            
            // Test correlation questions
            try {
                console.log('Testing generateCorrelationQuestion...');
                const corrQ = generateCorrelationQuestion('basic', 0);
                testResults.push({
                    type: 'Correlation',
                    status: corrQ ? 'SUCCESS' : 'FAILED',
                    question: corrQ ? corrQ.question : 'No question returned',
                    error: null
                });
            } catch (error) {
                testResults.push({
                    type: 'Correlation',
                    status: 'ERROR',
                    question: 'Exception thrown',
                    error: error.message
                });
            }
            
            // Test regression questions
            try {
                console.log('Testing generateRegressionQuestion...');
                const regQ = generateRegressionQuestion('basic', 0);
                testResults.push({
                    type: 'Regression',
                    status: regQ ? 'SUCCESS' : 'FAILED',
                    question: regQ ? regQ.question : 'No question returned',
                    error: null
                });
            } catch (error) {
                testResults.push({
                    type: 'Regression',
                    status: 'ERROR',
                    question: 'Exception thrown',
                    error: error.message
                });
            }
            
            // Test clinical questions
            try {
                console.log('Testing generateClinicalQuestion...');
                const clinQ = generateClinicalQuestion('basic', 0);
                testResults.push({
                    type: 'Clinical',
                    status: clinQ ? 'SUCCESS' : 'FAILED',
                    question: clinQ ? clinQ.question : 'No question returned',
                    error: null
                });
            } catch (error) {
                testResults.push({
                    type: 'Clinical',
                    status: 'ERROR',
                    question: 'Exception thrown',
                    error: error.message
                });
            }
            
            // Test assumptions questions
            try {
                console.log('Testing generateAssumptionQuestion...');
                const assQ = generateAssumptionQuestion('basic', 0);
                testResults.push({
                    type: 'Assumptions',
                    status: assQ ? 'SUCCESS' : 'FAILED',
                    question: assQ ? assQ.question : 'No question returned',
                    error: null
                });
            } catch (error) {
                testResults.push({
                    type: 'Assumptions',
                    status: 'ERROR',
                    question: 'Exception thrown',
                    error: error.message
                });
            }
            
            // Display results
            testResults.forEach(result => {
                const statusColor = result.status === 'SUCCESS' ? '#28a745' : result.status === 'ERROR' ? '#dc3545' : '#fd7e14';
                html += `
                    <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid ${statusColor};">
                        <h6>${result.type} Questions: <span style="color: ${statusColor};">${result.status}</span></h6>
                        <p><strong>Sample Question:</strong> ${result.question.substring(0, 100)}${result.question.length > 100 ? '...' : ''}</p>
                        ${result.error ? `<p><strong>Error:</strong> <code>${result.error}</code></p>` : ''}
                    </div>
                `;
            });
            
            // Test function existence
            html += `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h5>üîç Function Availability Check</h5>
                    <ul>
                        <li><strong>generateCorrelationQuestion:</strong> ${typeof generateCorrelationQuestion} ${typeof generateCorrelationQuestion === 'function' ? '‚úÖ' : '‚ùå'}</li>
                        <li><strong>generateRegressionQuestion:</strong> ${typeof generateRegressionQuestion} ${typeof generateRegressionQuestion === 'function' ? '‚úÖ' : '‚ùå'}</li>
                        <li><strong>generateClinicalQuestion:</strong> ${typeof generateClinicalQuestion} ${typeof generateClinicalQuestion === 'function' ? '‚úÖ' : '‚ùå'}</li>
                        <li><strong>generateAssumptionQuestion:</strong> ${typeof generateAssumptionQuestion} ${typeof generateAssumptionQuestion === 'function' ? '‚úÖ' : '‚ùå'}</li>
                    </ul>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="document.getElementById('sample-questions').style.display='none'">‚úñÔ∏è Close Debug</button>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // Also log to console
            console.log('üîß Debug results:', testResults);
        }

        function showSampleQuestions() {
            const sampleDiv = document.getElementById('sample-questions');
            sampleDiv.style.display = 'block';
            
            const samples = {
                'correlation': {
                    title: 'üìà Correlation Methods Questions',
                    examples: [
                        '‚Ä¢ Pearson vs Spearman vs Partial correlation method selection',
                        '‚Ä¢ Interpretation of correlation coefficients (œÅ, r, r_partial)',
                        '‚Ä¢ Statistical significance and confidence intervals',
                        '‚Ä¢ Data distribution considerations (normal, skewed, ordinal)',
                        '‚Ä¢ Clinical meaningfulness vs statistical significance'
                    ]
                },
                'regression': {
                    title: 'üìâ Regression Analysis Questions', 
                    examples: [
                        '‚Ä¢ Regression equation calculations (Y = a + bX)',
                        '‚Ä¢ R¬≤ and adjusted R¬≤ interpretation',
                        '‚Ä¢ Simple vs multiple regression applications',
                        '‚Ä¢ Clinical prediction model evaluation',
                        '‚Ä¢ Health Canada medical device approval requirements'
                    ]
                },
                'clinical': {
                    title: 'üè• Clinical Applications Questions',
                    examples: [
                        '‚Ä¢ Canadian healthcare case studies and contexts',
                        '‚Ä¢ Indigenous population considerations',
                        '‚Ä¢ Social determinants of health correlations',
                        '‚Ä¢ Pain assessment and quality of life relationships',
                        '‚Ä¢ Population-specific model validation needs'
                    ]
                },
                'assumptions': {
                    title: '‚ö†Ô∏è Statistical Assumptions Questions',
                    examples: [
                        '‚Ä¢ L.I.N.E. assumption violations (Linearity, Independence, Normality, Equal variance)',
                        '‚Ä¢ Diagnostic plot interpretation (residual plots, Q-Q plots)',
                        '‚Ä¢ Remedial measures for assumption violations',
                        '‚Ä¢ Outlier and leverage point identification',
                        '‚Ä¢ When to use robust statistical methods'
                    ]
                }
            };
            
            let html = '<h4>üëÅÔ∏è Question Type Examples</h4>';
            html += '<p>Here\'s what you can expect from each question category:</p>';
            
            for (const [key, value] of Object.entries(samples)) {
                html += `
                    <div style="background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #2f8b8b;">
                        <h5>${value.title}</h5>
                        <ul style="margin: 10px 0 0 20px;">
                            ${value.examples.map(example => `<li>${example}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            html += `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h5>üí° Difficulty Levels</h5>
                    <ul style="margin: 10px 0 0 20px;">
                        <li><strong>Basic:</strong> Foundation concepts and simple calculations</li>
                        <li><strong>Intermediate:</strong> Applied methods and interpretation skills</li>
                        <li><strong>Advanced:</strong> Clinical scenarios and regulatory considerations</li>
                    </ul>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="document.getElementById('sample-questions').style.display='none'">‚úñÔ∏è Close Preview</button>
                </div>
            `;
            
            sampleDiv.innerHTML = html;
        }

        function checkAllAnswers() {
            let score = 0;
            let total = currentQuestions.length;
            let feedback = '<h4>üìä Assessment Results</h4>';
            
            currentQuestions.forEach(question => {
                let userAnswer;
                let isCorrect = false;
                
                if (question.type === 'multiple-choice') {
                    const selected = document.querySelector(`input[name="question-${question.id}"]:checked`);
                    if (selected) {
                        userAnswer = parseInt(selected.value);
                        isCorrect = userAnswer === question.correct;
                    }
                } else if (question.type === 'numeric') {
                    const input = document.getElementById(`answer-${question.id}`);
                    if (input.value) {
                        userAnswer = parseFloat(input.value);
                        isCorrect = Math.abs(userAnswer - question.answer) <= question.tolerance;
                    }
                }
                
                if (isCorrect) score++;
                
                feedback += `
                    <div class="question-feedback ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}">
                        <h5>${isCorrect ? '‚úÖ Correct' : '‚ùå Incorrect'}</h5>
                        <p><strong>Question:</strong> ${question.question}</p>
                        <p><strong>Your answer:</strong> ${userAnswer !== undefined ? userAnswer : 'No answer provided'}</p>
                        <p><strong>Explanation:</strong> ${question.explanation}</p>
                    </div>
                `;
            });
            
            const percentage = Math.round((score / total) * 100);
            let gradeClass = percentage >= 80 ? 'feedback-correct' : percentage >= 60 ? 'feedback-partial' : 'feedback-incorrect';
            
            feedback = `
                <div class="question-feedback ${gradeClass}">
                    <h4>Final Score: ${score}/${total} (${percentage}%)</h4>
                    <p><strong>Performance:</strong> ${percentage >= 80 ? 'Excellent - Strong understanding of correlation and regression concepts' : 
                        percentage >= 60 ? 'Good - Solid foundation with room for improvement in some areas' : 
                        'Needs Improvement - Review key concepts and try additional practice'}</p>
                    ${percentage < 80 ? '<p><strong>Suggestion:</strong> Review the sections corresponding to incorrect answers and try the assessment again.</p>' : ''}
                </div>
            ` + feedback;
            
            document.getElementById('assessment-feedback').style.display = 'block';
            document.getElementById('assessment-feedback').innerHTML = feedback;
            
            // Hide the check answers button
            document.getElementById('check-answers-btn').style.display = 'none';
            
            // Add a "Try Again" button
            const resultsDiv = document.getElementById('assessment-results');
            if (resultsDiv) {
                resultsDiv.innerHTML += `
                    <div style="text-align: center; margin: 20px 0;">
                        <button onclick="generateAssessment()" style="background: #28a745;">üîÑ Generate New Assessment</button>
                    </div>
                `;
            }
        }

        // Event listener for correlation method changes
        document.addEventListener('DOMContentLoaded', function() {
            const methodSelect = document.getElementById('correlation-method');
            if (methodSelect) {
                methodSelect.addEventListener('change', function() {
                    const confoundenControl = document.getElementById('confounder-control');
                    if (this.value === 'partial') {
                        confoundenControl.style.display = 'block';
                    } else {
                        confoundenControl.style.display = 'none';
                    }
                });
            }
        });

        // Initialize the page after Chart.js is loaded
        window.onload = function() {
            console.log('Page loaded, checking Chart.js availability...');
            
            // Wait for Chart.js to be available
            function waitForChart() {
                if (typeof Chart !== 'undefined') {
                    console.log('‚úÖ Chart.js loaded successfully');
                    showSection('correlation');
                } else {
                    console.log('‚è≥ Waiting for Chart.js to load...');
                    setTimeout(waitForChart, 100);
                }
            }
            
            waitForChart();
        };
    </script>
</body>
</html>
